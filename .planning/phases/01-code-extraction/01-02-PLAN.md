---
phase: 01-code-extraction
plan: 02
type: execute
---

<objective>
Extract core utility modules (history, logging, config) to the new repository.

Purpose: Establish the shared utility layer that all downloaders depend on.
Output: Working HistoryManager, LogStreamer, and SettingsManager in eclaim_core.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-extraction/01-01-SUMMARY.md

**Source files to extract:**
@utils/history_manager.py
@utils/log_stream.py
@utils/settings_manager.py

**Codebase conventions:**
@.planning/codebase/CONVENTIONS.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract HistoryManager to eclaim_core/history/</name>
  <files>
../eclaim-downloader-core/eclaim_core/history/manager.py
../eclaim-downloader-core/eclaim_core/history/__init__.py
  </files>
  <action>
Extract and refactor `utils/history_manager.py` to the core module.

Key changes:
1. Update imports to use `eclaim_core.types` for DownloadResult, DownloadType
2. Remove any pro-specific code (if any)
3. Keep atomic write with backup pattern
4. Add type hints throughout
5. Update docstrings to reference eclaim_core

The HistoryManager should:
- Load/save history from JSON files (download_history.json, stm_download_history.json)
- Add records from DownloadResult objects
- Check if file already downloaded (exists method)
- Get statistics (total files, size, by type, by scheme)
- Support filtering by date range, scheme

**manager.py structure:**
```python
"""
Download History Manager
Manages download history using JSON files with atomic writes.
"""

import json
import os
import shutil
import threading
from datetime import datetime
from typing import Dict, List, Optional, Any
from pathlib import Path

from ..types import DownloadResult, DownloadType, Scheme


class HistoryManager:
    """
    Manages download history using JSON files.
    Thread-safe with atomic writes and backup.
    """

    def __init__(
        self,
        rep_history_file: str = "download_history.json",
        stm_history_file: str = "stm_download_history.json"
    ):
        self.rep_history_file = rep_history_file
        self.stm_history_file = stm_history_file
        self._lock = threading.Lock()

    # ... rest of implementation from source file
```

Update `eclaim_core/history/__init__.py`:
```python
"""History management for download tracking."""
from .manager import HistoryManager

__all__ = ["HistoryManager"]
```
  </action>
  <verify>`cd ../eclaim-downloader-core && python -c "from eclaim_core.history import HistoryManager; hm = HistoryManager(); print('OK')"`</verify>
  <done>HistoryManager extracted and importable</done>
</task>

<task type="auto">
  <name>Task 2: Extract LogStreamer to eclaim_core/logging/</name>
  <files>
../eclaim-downloader-core/eclaim_core/logging/streamer.py
../eclaim-downloader-core/eclaim_core/logging/__init__.py
  </files>
  <action>
Extract and refactor `utils/log_stream.py` to the core module.

Key changes:
1. Keep JSON line format for log entries
2. Keep thread-safe write with lock
3. Add SSE stream generator method
4. Add type hints throughout
5. Make log file path configurable

**streamer.py structure:**
```python
"""
Real-time Log Streamer
JSON-based logging with SSE streaming support.
"""

import json
import os
import threading
from datetime import datetime
from typing import Generator, Optional
from pathlib import Path


class LogStreamer:
    """
    Real-time logging with JSON format.
    Supports SSE streaming for web UI.
    """

    def __init__(self, log_file: str = "logs/realtime.log"):
        self.log_file = log_file
        self._lock = threading.Lock()

        # Ensure log directory exists
        os.makedirs(os.path.dirname(log_file) or ".", exist_ok=True)

    def write(
        self,
        message: str,
        level: str = 'info',
        source: str = 'system'
    ) -> None:
        """Write log entry as JSON line."""
        entry = {
            "timestamp": datetime.now().isoformat(),
            "level": level,
            "source": source,
            "message": message
        }

        with self._lock:
            with open(self.log_file, 'a', encoding='utf-8') as f:
                f.write(json.dumps(entry, ensure_ascii=False) + '\n')

    def stream(self, tail: int = 100) -> Generator[str, None, None]:
        """Generator for SSE streaming."""
        # Read last N lines first
        try:
            with open(self.log_file, 'r', encoding='utf-8') as f:
                lines = f.readlines()[-tail:]
                for line in lines:
                    yield f"data: {line}\n\n"
        except FileNotFoundError:
            pass

        # Then stream new lines (for SSE endpoint)
        # Note: Actual SSE implementation needs file watching

    def clear(self) -> None:
        """Clear the log file."""
        with self._lock:
            open(self.log_file, 'w').close()

    def get_recent(self, lines: int = 100, level: Optional[str] = None) -> list:
        """Get recent log entries."""
        try:
            with open(self.log_file, 'r', encoding='utf-8') as f:
                all_lines = f.readlines()[-lines:]

            entries = []
            for line in all_lines:
                try:
                    entry = json.loads(line.strip())
                    if level is None or entry.get('level') == level:
                        entries.append(entry)
                except json.JSONDecodeError:
                    continue

            return entries
        except FileNotFoundError:
            return []
```

Update `eclaim_core/logging/__init__.py`:
```python
"""Logging infrastructure for real-time streaming."""
from .streamer import LogStreamer

__all__ = ["LogStreamer"]
```
  </action>
  <verify>`cd ../eclaim-downloader-core && python -c "from eclaim_core.logging import LogStreamer; ls = LogStreamer('test.log'); ls.write('test'); print('OK')"`</verify>
  <done>LogStreamer extracted and working</done>
</task>

<task type="auto">
  <name>Task 3: Extract SettingsManager to eclaim_core/config/</name>
  <files>
../eclaim-downloader-core/eclaim_core/config/settings.py
../eclaim-downloader-core/eclaim_core/config/__init__.py
../eclaim-downloader-core/eclaim_core/config/defaults.py
  </files>
  <action>
Extract and refactor `utils/settings_manager.py` to the core module.

Key changes:
1. Separate defaults into `defaults.py`
2. Support loading from JSON file and environment variables
3. Remove pro-specific settings (scheduler, import settings)
4. Keep only download-related settings for core module
5. Add type hints throughout

**defaults.py:**
```python
"""Default configuration values."""

DEFAULT_SETTINGS = {
    "eclaim_username": "",
    "eclaim_password": "",
    "download_dir": "./downloads",
    "log_file": "logs/realtime.log",
    "history_file": "download_history.json",
    "stm_history_file": "stm_download_history.json",
}
```

**settings.py:**
```python
"""
Settings Manager
Handles configuration loading from JSON and environment variables.
"""

import json
import os
from typing import Dict, Any, Optional
from pathlib import Path

from .defaults import DEFAULT_SETTINGS


class SettingsManager:
    """
    Manages application settings.
    Priority: settings.json > environment variables > defaults
    """

    def __init__(self, settings_file: str = "config/settings.json"):
        self.settings_file = settings_file
        self._settings: Dict[str, Any] = {}
        self.load()

    def load(self) -> None:
        """Load settings from file and environment."""
        # Start with defaults
        self._settings = DEFAULT_SETTINGS.copy()

        # Load from JSON file if exists
        if os.path.exists(self.settings_file):
            try:
                with open(self.settings_file, 'r', encoding='utf-8') as f:
                    file_settings = json.load(f)
                    self._settings.update(file_settings)
            except (json.JSONDecodeError, IOError):
                pass

        # Override with environment variables
        env_mapping = {
            "ECLAIM_USERNAME": "eclaim_username",
            "ECLAIM_PASSWORD": "eclaim_password",
            "DOWNLOAD_DIR": "download_dir",
        }
        for env_key, setting_key in env_mapping.items():
            if env_key in os.environ:
                self._settings[setting_key] = os.environ[env_key]

    def get(self, key: str, default: Any = None) -> Any:
        """Get a setting value."""
        return self._settings.get(key, default)

    def set(self, key: str, value: Any) -> None:
        """Set a setting value (in memory only)."""
        self._settings[key] = value

    def save(self) -> bool:
        """Save settings to JSON file."""
        try:
            os.makedirs(os.path.dirname(self.settings_file) or ".", exist_ok=True)
            with open(self.settings_file, 'w', encoding='utf-8') as f:
                # Don't save password to file
                save_settings = {k: v for k, v in self._settings.items()
                                if k != 'eclaim_password'}
                json.dump(save_settings, f, indent=2, ensure_ascii=False)
            return True
        except IOError:
            return False

    def get_credentials(self) -> tuple:
        """Get NHSO credentials."""
        return (
            self.get("eclaim_username", ""),
            self.get("eclaim_password", "")
        )

    @property
    def download_dir(self) -> str:
        """Get download directory path."""
        return self.get("download_dir", "./downloads")
```

Update `eclaim_core/config/__init__.py`:
```python
"""Configuration management."""
from .settings import SettingsManager
from .defaults import DEFAULT_SETTINGS

__all__ = ["SettingsManager", "DEFAULT_SETTINGS"]
```
  </action>
  <verify>`cd ../eclaim-downloader-core && python -c "from eclaim_core.config import SettingsManager; sm = SettingsManager(); print(sm.download_dir)"`</verify>
  <done>SettingsManager extracted and working</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `from eclaim_core.history import HistoryManager` works
- [ ] `from eclaim_core.logging import LogStreamer` works
- [ ] `from eclaim_core.config import SettingsManager` works
- [ ] HistoryManager can add and retrieve records
- [ ] LogStreamer can write and read logs
- [ ] SettingsManager loads from environment variables
</verification>

<success_criteria>
- All 3 utility modules extracted and working
- Type hints added throughout
- No dependencies on pro-specific code
- Ready for downloader extraction
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-extraction/01-02-SUMMARY.md`
</output>
