---
phase: 01-code-extraction
plan: 01
type: execute
---

<objective>
Create the `eclaim-downloader-core` repository with package structure and base classes.

Purpose: Establish the foundation for the FREE download module that can be used standalone or as a submodule.
Output: New GitHub repo with package structure, base classes, and enums ready for code extraction.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@SYSTEM_REDESIGN_SPEC.md

**Codebase context:**
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**Constraining decisions:**
- Module separation strategy: Git Submodule
- Package structure: `eclaim_core/{downloaders,auth,history,logging,config,api}`
- Python 3.10+ with type hints and dataclasses
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create GitHub repository and clone locally</name>
  <files>../eclaim-downloader-core/</files>
  <action>
Use `gh repo create` to create a new public repository named `eclaim-downloader-core` under the `aegisx-platform` organization. Then clone it to a sibling directory.

Commands:
```bash
gh repo create aegisx-platform/eclaim-downloader-core --public --description "E-Claim Download Core Module - Standalone download system for NHSO E-Claim data" --clone
```

If gh auth fails, create a checkpoint for user to authenticate.
  </action>
  <verify>Directory `../eclaim-downloader-core/` exists and is a git repo with remote configured</verify>
  <done>Repository created on GitHub and cloned locally</done>
</task>

<task type="auto">
  <name>Task 2: Create package directory structure</name>
  <files>
../eclaim-downloader-core/eclaim_core/__init__.py
../eclaim-downloader-core/eclaim_core/downloaders/__init__.py
../eclaim-downloader-core/eclaim_core/auth/__init__.py
../eclaim-downloader-core/eclaim_core/history/__init__.py
../eclaim-downloader-core/eclaim_core/logging/__init__.py
../eclaim-downloader-core/eclaim_core/config/__init__.py
../eclaim-downloader-core/cli/__init__.py
../eclaim-downloader-core/tests/__init__.py
  </files>
  <action>
Create the package structure with all necessary directories and `__init__.py` files.

Directory structure:
```
eclaim-downloader-core/
├── eclaim_core/
│   ├── __init__.py          # Package root, exports public API
│   ├── downloaders/
│   │   └── __init__.py      # Will export REPDownloader, STMDownloader, SMTFetcher
│   ├── auth/
│   │   └── __init__.py      # Will export session management
│   ├── history/
│   │   └── __init__.py      # Will export HistoryManager
│   ├── logging/
│   │   └── __init__.py      # Will export LogStreamer
│   └── config/
│       └── __init__.py      # Will export SettingsManager
├── cli/
│   └── __init__.py          # CLI tools package
├── tests/
│   └── __init__.py          # Test package
├── downloads/               # Default download directory (gitignored)
└── logs/                    # Log files (gitignored)
```

Each `__init__.py` should have a module docstring indicating purpose. Use empty `__init__.py` for now, will populate exports as modules are added.
  </action>
  <verify>All directories exist with __init__.py files: `find ../eclaim-downloader-core -name "__init__.py" | wc -l` returns 8+</verify>
  <done>Package structure created with all __init__.py files</done>
</task>

<task type="auto">
  <name>Task 3: Create base classes, enums, and type definitions</name>
  <files>
../eclaim-downloader-core/eclaim_core/types.py
../eclaim-downloader-core/eclaim_core/downloaders/base.py
  </files>
  <action>
Create the foundational type definitions and abstract base class.

**eclaim_core/types.py** - Enums and dataclasses:
```python
"""
E-Claim Core Type Definitions
Enums, dataclasses, and type aliases for the download system.
"""

from enum import Enum
from dataclasses import dataclass, field
from typing import Optional, Dict, Any, List
from datetime import datetime


class DownloadType(Enum):
    """Type of download operation"""
    REP = "rep"      # Representative (OP/IP/ORF)
    STM = "stm"      # Statement
    SMT = "smt"      # Budget (SMT API)


class FileType(Enum):
    """Type of downloaded file"""
    OP = "OP"
    IP = "IP"
    ORF = "ORF"
    IP_APPEAL = "IP_APPEAL"
    IP_APPEAL_NHSO = "IP_APPEAL_NHSO"
    STM_IP = "STM_IP"
    STM_OP = "STM_OP"


class Scheme(Enum):
    """Insurance scheme codes"""
    UCS = "ucs"      # Universal Coverage Scheme
    OFC = "ofc"      # Civil Servant Medical Benefit
    SSS = "sss"      # Social Security Scheme
    LGO = "lgo"      # Local Government Officers
    NHS = "nhs"      # National Health Security
    BKK = "bkk"      # Bangkok Metropolitan
    BMT = "bmt"      # Border Medical Treatment
    SRT = "srt"      # State Railway of Thailand


@dataclass
class DownloadResult:
    """Result of a single file download"""
    success: bool
    filename: str
    file_path: str
    file_size: int
    download_type: DownloadType
    file_type: Optional[FileType] = None
    scheme: Optional[Scheme] = None
    month: Optional[int] = None
    year: Optional[int] = None  # Buddhist Era
    error: Optional[str] = None
    url: Optional[str] = None
    download_date: datetime = field(default_factory=datetime.now)
    metadata: Dict[str, Any] = field(default_factory=dict)


@dataclass
class DownloadProgress:
    """Progress tracking for download operations"""
    total: int = 0
    downloaded: int = 0
    skipped: int = 0
    errors: int = 0
    current_file: Optional[str] = None
    is_running: bool = False
    started_at: Optional[datetime] = None

    @property
    def completed(self) -> int:
        return self.downloaded + self.skipped + self.errors

    @property
    def percent(self) -> float:
        if self.total == 0:
            return 0.0
        return (self.completed / self.total) * 100


@dataclass
class DownloadLink:
    """Represents a downloadable file link"""
    url: str
    filename: str
    file_type: Optional[FileType] = None
    scheme: Optional[Scheme] = None
    metadata: Dict[str, Any] = field(default_factory=dict)
```

**eclaim_core/downloaders/base.py** - Abstract base class:
```python
"""
Base Downloader Abstract Class
All downloaders inherit from this base class.
"""

from abc import ABC, abstractmethod
from typing import List, Optional, Dict, Any
import requests
import os

from ..types import DownloadType, DownloadResult, DownloadProgress, DownloadLink


class BaseDownloader(ABC):
    """
    Abstract base class for all downloaders.
    Provides common functionality for authentication, session management,
    and progress tracking.
    """

    def __init__(
        self,
        download_dir: str = "./downloads",
        history_manager: Optional[Any] = None,
        logger: Optional[Any] = None
    ):
        self.download_dir = download_dir
        self.history = history_manager
        self.logger = logger
        self.session: Optional[requests.Session] = None
        self._progress = DownloadProgress()

        # Ensure download directory exists
        os.makedirs(self.download_dir, exist_ok=True)

    @property
    @abstractmethod
    def download_type(self) -> DownloadType:
        """Return the type of downloader"""
        pass

    @abstractmethod
    def login(self, username: str, password: str) -> bool:
        """
        Authenticate with the remote system.

        Args:
            username: Login username
            password: Login password

        Returns:
            True if login successful, False otherwise
        """
        pass

    @abstractmethod
    def get_download_links(self, **kwargs) -> List[DownloadLink]:
        """
        Get list of available downloads.

        Returns:
            List of DownloadLink objects
        """
        pass

    @abstractmethod
    def download_file(self, link: DownloadLink) -> DownloadResult:
        """
        Download a single file.

        Args:
            link: DownloadLink object with URL and filename

        Returns:
            DownloadResult with success status and details
        """
        pass

    def download_all(self, links: List[DownloadLink]) -> List[DownloadResult]:
        """
        Download all files from links.

        Args:
            links: List of DownloadLink objects

        Returns:
            List of DownloadResult objects
        """
        from datetime import datetime

        results = []
        self._progress = DownloadProgress(
            total=len(links),
            is_running=True,
            started_at=datetime.now()
        )

        for link in links:
            self._progress.current_file = link.filename
            result = self.download_file(link)
            results.append(result)

            if result.success:
                self._progress.downloaded += 1
                if self.history:
                    self.history.add_record(result)
            elif result.error == "skipped":
                self._progress.skipped += 1
            else:
                self._progress.errors += 1

            self._log(
                f"{'Downloaded' if result.success else 'Failed'}: {link.filename}",
                level='success' if result.success else 'error'
            )

        self._progress.is_running = False
        self._progress.current_file = None
        return results

    @property
    def progress(self) -> DownloadProgress:
        """Get current download progress"""
        return self._progress

    def _log(self, message: str, level: str = 'info') -> None:
        """Log a message using the configured logger"""
        if self.logger:
            self.logger.write(message, level=level, source=self.download_type.value)

    def _create_session(self) -> requests.Session:
        """Create a new requests session with default headers"""
        session = requests.Session()
        session.headers.update({
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 Chrome/120.0.0.0',
            'Accept-Language': 'th-TH,th;q=0.9,en;q=0.8'
        })
        return session
```

Update `eclaim_core/__init__.py` to export these:
```python
"""
E-Claim Download Core Module
Standalone download system for NHSO E-Claim data.
"""

from .types import (
    DownloadType,
    FileType,
    Scheme,
    DownloadResult,
    DownloadProgress,
    DownloadLink,
)

__version__ = "0.1.0"
__all__ = [
    "DownloadType",
    "FileType",
    "Scheme",
    "DownloadResult",
    "DownloadProgress",
    "DownloadLink",
]
```
  </action>
  <verify>Python can import the module: `cd ../eclaim-downloader-core && python -c "from eclaim_core import DownloadType, Scheme, DownloadResult; print('OK')"`</verify>
  <done>Base classes and enums created, importable from eclaim_core</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] GitHub repo exists at `aegisx-platform/eclaim-downloader-core`
- [ ] Local clone exists at `../eclaim-downloader-core/`
- [ ] Package structure with 8+ `__init__.py` files
- [ ] `python -c "from eclaim_core import DownloadType"` works
- [ ] `python -c "from eclaim_core.downloaders.base import BaseDownloader"` works
</verification>

<success_criteria>
- Repository created on GitHub
- Package structure established
- Base classes and enums importable
- Ready for code extraction in subsequent plans
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-extraction/01-01-SUMMARY.md`
</output>
