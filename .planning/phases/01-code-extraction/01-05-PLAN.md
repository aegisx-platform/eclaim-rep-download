---
phase: 01-code-extraction
plan: 05
type: execute
---

<objective>
Extract SMT (Budget) fetcher and finalize the core package with packaging files.

Purpose: Complete the core module with SMTFetcher and make it installable via pip.
Output: Working SMTFetcher, CLI tool, pyproject.toml, and README.md.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-code-extraction/01-04-SUMMARY.md

**Source file to extract:**
@smt_budget_fetcher.py

**Pattern reference:**
Reference: ../eclaim-downloader-core/eclaim_core/downloaders/rep.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract SMTFetcher class</name>
  <files>
../eclaim-downloader-core/eclaim_core/downloaders/smt.py
../eclaim-downloader-core/eclaim_core/downloaders/__init__.py
  </files>
  <action>
Extract and refactor `smt_budget_fetcher.py` to create SMTFetcher class.

Key differences from REP/STM:
1. SMT uses a public API (no login required)
2. Returns JSON data, not Excel files
3. Can export to CSV or JSON
4. Different base class behavior needed

**smt.py structure:**
```python
"""
SMT (Budget) Fetcher
Fetches budget data from NHSO Smart Money Transfer (SMT) API.
No authentication required - public API.
"""

import os
import json
import csv
from typing import List, Optional, Dict, Any
from datetime import datetime
from dataclasses import dataclass
import requests

from .base import BaseDownloader
from ..types import DownloadType, DownloadResult, DownloadLink


@dataclass
class BudgetSummary:
    """Budget summary data from SMT API."""
    vendor_id: str
    vendor_name: str
    budget_year: int
    total_amount: float
    paid_amount: float
    remaining_amount: float
    items: List[Dict[str, Any]]
    fetched_at: datetime


class SMTFetcher(BaseDownloader):
    """
    Fetches budget data from NHSO SMT API.
    Public API - no authentication required.
    """

    API_URL = "https://smt.nhso.go.th/smtf/api/budgetreport/budgetSummaryByVendorReport/search"

    def __init__(
        self,
        vendor_id: str,
        zone_id: Optional[str] = None,
        province_id: Optional[str] = None,
        **kwargs
    ):
        super().__init__(**kwargs)
        self.vendor_id = vendor_id.zfill(10)  # Pad to 10 digits
        self.zone_id = zone_id
        self.province_id = province_id
        self._last_result: Optional[BudgetSummary] = None

    @property
    def download_type(self) -> DownloadType:
        return DownloadType.SMT

    def login(self, username: str = None, password: str = None) -> bool:
        """SMT API is public, no login needed."""
        self.session = self._create_session()
        self.session.headers.update({
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        })
        self._log("SMT API ready (no auth required)", level='info')
        return True

    def get_download_links(self, **kwargs) -> List[DownloadLink]:
        """
        SMT doesn't have downloadable files.
        Returns empty list - use fetch_budget() instead.
        """
        return []

    def download_file(self, link: DownloadLink) -> DownloadResult:
        """Not applicable for SMT - use fetch_budget() instead."""
        return DownloadResult(
            success=False,
            filename="",
            file_path="",
            file_size=0,
            download_type=self.download_type,
            error="Use fetch_budget() for SMT data"
        )

    def fetch_budget(
        self,
        start_date: str,  # dd/mm/yyyy Buddhist Era
        end_date: str,
        budget_source: str = "02"
    ) -> Optional[BudgetSummary]:
        """
        Fetch budget summary from SMT API.

        Args:
            start_date: Start date in dd/mm/yyyy format (Buddhist Era)
            end_date: End date in dd/mm/yyyy format (Buddhist Era)
            budget_source: Budget source code (default: "02")

        Returns:
            BudgetSummary object or None if failed
        """
        if not self.session:
            self.login()

        payload = {
            "budgetYear": "",
            "startDate": start_date,
            "endDate": end_date,
            "budgetSource": budget_source,
            "vendorSearchCondition": self.vendor_id
        }

        if self.zone_id:
            payload["zoneId"] = self.zone_id
        if self.province_id:
            payload["provinceId"] = self.province_id

        try:
            self._log(f"Fetching budget for vendor {self.vendor_id}", level='info')
            response = self.session.post(self.API_URL, json=payload, timeout=60)
            response.raise_for_status()

            data = response.json()

            # Parse response into BudgetSummary
            items = data.get('data', [])
            total_amount = sum(item.get('budgetAmount', 0) for item in items)
            paid_amount = sum(item.get('paidAmount', 0) for item in items)

            summary = BudgetSummary(
                vendor_id=self.vendor_id,
                vendor_name=items[0].get('vendorName', '') if items else '',
                budget_year=int(start_date.split('/')[-1]) if start_date else 0,
                total_amount=total_amount,
                paid_amount=paid_amount,
                remaining_amount=total_amount - paid_amount,
                items=items,
                fetched_at=datetime.now()
            )

            self._last_result = summary
            self._log(
                f"Fetched {len(items)} budget items, total: {total_amount:,.2f}",
                level='success'
            )

            return summary

        except requests.RequestException as e:
            self._log(f"API error: {e}", level='error')
            return None
        except (KeyError, ValueError) as e:
            self._log(f"Parse error: {e}", level='error')
            return None

    def export_csv(
        self,
        summary: Optional[BudgetSummary] = None,
        filename: Optional[str] = None
    ) -> Optional[str]:
        """
        Export budget data to CSV.

        Args:
            summary: BudgetSummary to export (uses last result if None)
            filename: Output filename (auto-generated if None)

        Returns:
            File path or None if failed
        """
        summary = summary or self._last_result
        if not summary:
            self._log("No data to export", level='error')
            return None

        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"smt_budget_{self.vendor_id}_{timestamp}.csv"

        file_path = os.path.join(self.download_dir, "exports", filename)
        os.makedirs(os.path.dirname(file_path), exist_ok=True)

        try:
            with open(file_path, 'w', newline='', encoding='utf-8-sig') as f:
                if summary.items:
                    writer = csv.DictWriter(f, fieldnames=summary.items[0].keys())
                    writer.writeheader()
                    writer.writerows(summary.items)

            self._log(f"Exported to {file_path}", level='success')
            return file_path

        except IOError as e:
            self._log(f"Export error: {e}", level='error')
            return None

    def export_json(
        self,
        summary: Optional[BudgetSummary] = None,
        filename: Optional[str] = None
    ) -> Optional[str]:
        """
        Export budget data to JSON.

        Args:
            summary: BudgetSummary to export (uses last result if None)
            filename: Output filename (auto-generated if None)

        Returns:
            File path or None if failed
        """
        summary = summary or self._last_result
        if not summary:
            self._log("No data to export", level='error')
            return None

        if not filename:
            timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
            filename = f"smt_budget_{self.vendor_id}_{timestamp}.json"

        file_path = os.path.join(self.download_dir, "exports", filename)
        os.makedirs(os.path.dirname(file_path), exist_ok=True)

        try:
            export_data = {
                "vendor_id": summary.vendor_id,
                "vendor_name": summary.vendor_name,
                "budget_year": summary.budget_year,
                "total_amount": summary.total_amount,
                "paid_amount": summary.paid_amount,
                "remaining_amount": summary.remaining_amount,
                "fetched_at": summary.fetched_at.isoformat(),
                "items": summary.items
            }

            with open(file_path, 'w', encoding='utf-8') as f:
                json.dump(export_data, f, indent=2, ensure_ascii=False)

            self._log(f"Exported to {file_path}", level='success')
            return file_path

        except IOError as e:
            self._log(f"Export error: {e}", level='error')
            return None

    def run(self, username: str = None, password: str = None) -> Dict[str, Any]:
        """
        Not applicable for SMT - use fetch_budget() directly.
        Provided for API compatibility with other downloaders.
        """
        self._log("Use fetch_budget() for SMT data", level='warning')
        return {'success': False, 'error': 'Use fetch_budget() method instead'}
```

Update `eclaim_core/downloaders/__init__.py`:
```python
"""Downloader implementations."""
from .base import BaseDownloader
from .rep import REPDownloader
from .stm import STMDownloader
from .smt import SMTFetcher, BudgetSummary

__all__ = [
    "BaseDownloader",
    "REPDownloader",
    "STMDownloader",
    "SMTFetcher",
    "BudgetSummary",
]
```
  </action>
  <verify>`cd ../eclaim-downloader-core && python -c "from eclaim_core.downloaders import SMTFetcher; f = SMTFetcher('10670'); print(f.download_type)"`</verify>
  <done>SMTFetcher class extracted and working</done>
</task>

<task type="auto">
  <name>Task 2: Create CLI tool and package files</name>
  <files>
../eclaim-downloader-core/cli/fetch_smt.py
../eclaim-downloader-core/pyproject.toml
../eclaim-downloader-core/requirements.txt
../eclaim-downloader-core/README.md
../eclaim-downloader-core/.gitignore
  </files>
  <action>
Create CLI tool for SMT and finalize package with pyproject.toml.

**cli/fetch_smt.py:**
```python
#!/usr/bin/env python3
"""
SMT Budget Fetch CLI Tool
Fetch budget data from NHSO SMT API.

Usage:
    python -m cli.fetch_smt --vendor-id 10670 --start 01/10/2568 --end 30/09/2569
    python -m cli.fetch_smt --vendor-id 10670 --fiscal-year 2569 --export csv
"""

import argparse
import sys
from datetime import datetime

from eclaim_core.downloaders import SMTFetcher
from eclaim_core.logging import LogStreamer


def parse_args():
    """Parse command line arguments."""
    parser = argparse.ArgumentParser(
        description="Fetch budget data from NHSO SMT API"
    )

    # Required
    parser.add_argument(
        '--vendor-id', '-v',
        required=True,
        help="Hospital vendor ID (will be padded to 10 digits)"
    )

    # Date options (either start/end or fiscal-year)
    date_group = parser.add_mutually_exclusive_group()
    date_group.add_argument(
        '--fiscal-year', '-y',
        type=int,
        help="Fiscal year in Buddhist Era (calculates Oct-Sep range)"
    )

    parser.add_argument(
        '--start', '-s',
        help="Start date (dd/mm/yyyy Buddhist Era)"
    )
    parser.add_argument(
        '--end', '-e',
        help="End date (dd/mm/yyyy Buddhist Era)"
    )

    # Export options
    parser.add_argument(
        '--export', '-x',
        choices=['csv', 'json', 'both'],
        help="Export format"
    )

    # Output options
    parser.add_argument(
        '--output-dir', '-o',
        default='./downloads',
        help="Output directory (default: ./downloads)"
    )
    parser.add_argument(
        '--quiet', '-q',
        action='store_true',
        help="Suppress output"
    )

    return parser.parse_args()


def fiscal_year_to_dates(fiscal_year: int) -> tuple:
    """Convert fiscal year to start/end dates."""
    # Fiscal year runs October to September
    start_year = fiscal_year - 1
    end_year = fiscal_year

    start_date = f"01/10/{start_year}"
    end_date = f"30/09/{end_year}"

    return start_date, end_date


def main():
    """Main entry point."""
    args = parse_args()

    # Initialize components
    logger = LogStreamer() if not args.quiet else None

    # Determine date range
    if args.fiscal_year:
        start_date, end_date = fiscal_year_to_dates(args.fiscal_year)
    elif args.start and args.end:
        start_date, end_date = args.start, args.end
    else:
        # Default to current fiscal year
        now = datetime.now()
        year_be = now.year + 543
        fiscal_year = year_be if now.month >= 10 else year_be
        start_date, end_date = fiscal_year_to_dates(fiscal_year)

    # Create fetcher
    fetcher = SMTFetcher(
        vendor_id=args.vendor_id,
        download_dir=args.output_dir,
        logger=logger
    )

    # Fetch data
    print(f"Fetching budget for vendor {fetcher.vendor_id}")
    print(f"Date range: {start_date} to {end_date}")
    print("-" * 40)

    summary = fetcher.fetch_budget(start_date, end_date)

    if not summary:
        print("Failed to fetch budget data")
        sys.exit(1)

    # Display summary
    print(f"Vendor: {summary.vendor_name}")
    print(f"Total Amount: {summary.total_amount:,.2f}")
    print(f"Paid Amount: {summary.paid_amount:,.2f}")
    print(f"Remaining: {summary.remaining_amount:,.2f}")
    print(f"Items: {len(summary.items)}")

    # Export if requested
    if args.export in ['csv', 'both']:
        csv_path = fetcher.export_csv()
        if csv_path:
            print(f"Exported CSV: {csv_path}")

    if args.export in ['json', 'both']:
        json_path = fetcher.export_json()
        if json_path:
            print(f"Exported JSON: {json_path}")


if __name__ == '__main__':
    main()
```

**pyproject.toml:**
```toml
[build-system]
requires = ["setuptools>=61.0", "wheel"]
build-backend = "setuptools.build_meta"

[project]
name = "eclaim-downloader-core"
version = "0.1.0"
description = "E-Claim Download Core Module - Standalone download system for NHSO E-Claim data"
readme = "README.md"
license = {text = "MIT"}
requires-python = ">=3.10"
authors = [
    {name = "AegisX Platform"}
]
keywords = ["nhso", "eclaim", "healthcare", "thailand", "download"]
classifiers = [
    "Development Status :: 4 - Beta",
    "Intended Audience :: Healthcare Industry",
    "License :: OSI Approved :: MIT License",
    "Operating System :: OS Independent",
    "Programming Language :: Python :: 3",
    "Programming Language :: Python :: 3.10",
    "Programming Language :: Python :: 3.11",
    "Programming Language :: Python :: 3.12",
]

dependencies = [
    "requests>=2.28.0",
    "beautifulsoup4>=4.11.0",
]

[project.optional-dependencies]
dev = [
    "pytest>=7.0.0",
    "pytest-cov>=4.0.0",
    "flake8>=6.0.0",
]

[project.urls]
Homepage = "https://github.com/aegisx-platform/eclaim-downloader-core"
Repository = "https://github.com/aegisx-platform/eclaim-downloader-core.git"

[project.scripts]
eclaim-download-rep = "cli.download_rep:main"
eclaim-download-stm = "cli.download_stm:main"
eclaim-fetch-smt = "cli.fetch_smt:main"

[tool.setuptools.packages.find]
include = ["eclaim_core*", "cli*"]
```

**requirements.txt:**
```
requests>=2.28.0
beautifulsoup4>=4.11.0
```

**README.md:**
```markdown
# E-Claim Downloader Core

Standalone download system for NHSO E-Claim data. Downloads OP/IP/ORF files and statement data from Thailand's National Health Security Office.

## Features

- **REP Download** - Download claim representative files (OP, IP, ORF)
- **STM Download** - Download payment statement files
- **SMT Fetch** - Fetch budget data from SMT API
- **History Tracking** - Prevent duplicate downloads
- **CLI Tools** - Command-line interface for all operations
- **REST API Ready** - Flask Blueprint for web integration

## Installation

```bash
pip install eclaim-downloader-core
```

Or install from source:

```bash
git clone https://github.com/aegisx-platform/eclaim-downloader-core.git
cd eclaim-downloader-core
pip install -e .
```

## Quick Start

### REP Download (OP/IP/ORF files)

```bash
# Set credentials
export ECLAIM_USERNAME=your_username
export ECLAIM_PASSWORD=your_password

# Download current month
python -m cli.download_rep

# Download specific month/year
python -m cli.download_rep --month 1 --year 2569 --schemes ucs ofc
```

### STM Download (Statement files)

```bash
python -m cli.download_stm --fiscal-year 2569 --schemes ucs
```

### SMT Fetch (Budget data)

```bash
python -m cli.fetch_smt --vendor-id 10670 --fiscal-year 2569 --export csv
```

## Python API

```python
from eclaim_core.downloaders import REPDownloader, STMDownloader, SMTFetcher
from eclaim_core.types import Scheme

# REP Download
downloader = REPDownloader(month=1, year=2569, schemes=[Scheme.UCS])
result = downloader.run(username="user", password="pass")

# SMT Fetch
fetcher = SMTFetcher(vendor_id="10670")
summary = fetcher.fetch_budget("01/10/2568", "30/09/2569")
fetcher.export_csv(summary)
```

## Configuration

Settings can be configured via:
1. `config/settings.json` file
2. Environment variables (`ECLAIM_USERNAME`, `ECLAIM_PASSWORD`, `DOWNLOAD_DIR`)

## License

MIT License - see LICENSE file for details.
```

**.gitignore:**
```
# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
build/
develop-eggs/
dist/
downloads/
eggs/
.eggs/
lib/
lib64/
parts/
sdist/
var/
wheels/
*.egg-info/
.installed.cfg
*.egg

# Virtual environments
venv/
ENV/
env/

# IDE
.idea/
.vscode/
*.swp
*.swo

# Project specific
downloads/
logs/
exports/
config/settings.json
*.log

# Testing
.pytest_cache/
.coverage
htmlcov/
```
  </action>
  <verify>
```bash
cd ../eclaim-downloader-core
python -m cli.fetch_smt --help
pip install -e . --dry-run
```
  </verify>
  <done>Package complete with CLI tools and pyproject.toml</done>
</task>

<task type="auto">
  <name>Task 3: Initial commit and push to GitHub</name>
  <files>../eclaim-downloader-core/</files>
  <action>
Commit all files and push to GitHub.

```bash
cd ../eclaim-downloader-core

# Stage all files
git add .

# Commit
git commit -m "feat: initial core module with downloaders and CLI tools

- REPDownloader: Download OP/IP/ORF files from NHSO
- STMDownloader: Download statement files
- SMTFetcher: Fetch budget data from SMT API
- CLI tools: download_rep, download_stm, fetch_smt
- Core utilities: HistoryManager, LogStreamer, SettingsManager
- Package ready for pip install

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"

# Push to GitHub
git push -u origin main
```
  </action>
  <verify>`cd ../eclaim-downloader-core && git log --oneline -1` shows the commit</verify>
  <done>Code committed and pushed to GitHub</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] SMTFetcher class imports correctly
- [ ] All 3 CLI tools show help
- [ ] `pip install -e .` works (dry-run)
- [ ] Git repository has all files committed
- [ ] GitHub repository has the code
</verification>

<success_criteria>
- All 3 downloaders extracted (REP, STM, SMT)
- All 3 CLI tools functional
- Package installable via pip
- Code pushed to GitHub
- Phase 1 complete
</success_criteria>

<output>
After completion, create `.planning/phases/01-code-extraction/01-05-SUMMARY.md` with:

# Phase 01 Plan 05: SMT Fetcher + Finalize Summary

**SMT fetcher extracted, package finalized, and pushed to GitHub.**

## Accomplishments

- SMTFetcher class for budget API
- CLI tool: fetch_smt.py
- pyproject.toml for pip installation
- README.md with usage documentation
- Initial commit pushed to GitHub

## Files Created

- `eclaim_core/downloaders/smt.py`
- `cli/fetch_smt.py`
- `pyproject.toml`
- `requirements.txt`
- `README.md`
- `.gitignore`

## Next Step

Phase 1 complete. Ready for Phase 2: API Development.

Run: `/gsd:plan-phase 02`
</output>
