name: Sync Deployment Branch

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  sync-deployment:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout deployment branch
        uses: actions/checkout@v4
        with:
          ref: deployment
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get release version
        id: version
        env:
          GITHUB_REF_VALUE: ${{ github.ref }}
        run: |
          VERSION="${GITHUB_REF_VALUE#refs/tags/}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Updating to version: $VERSION"

      - name: Update VERSION file
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: echo "$VERSION" > VERSION

      - name: Update docker-compose files
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          # Update all docker-compose files
          sed -i "s|ghcr.io/aegisx-platform/eclaim-rep-download:v[0-9.]*|ghcr.io/aegisx-platform/eclaim-rep-download:$VERSION|g" docker-compose.yml
          sed -i "s|ghcr.io/aegisx-platform/eclaim-rep-download:v[0-9.]*|ghcr.io/aegisx-platform/eclaim-rep-download:$VERSION|g" docker-compose-mysql.yml
          sed -i "s|ghcr.io/aegisx-platform/eclaim-rep-download:v[0-9.]*|ghcr.io/aegisx-platform/eclaim-rep-download:$VERSION|g" docker-compose-no-db.yml

          echo "âœ“ Updated docker-compose files to $VERSION"

      - name: Update schema files from main
        run: |
          # Fetch latest schema files from main branch
          git fetch origin main
          git checkout origin/main -- database/schema-postgresql-merged.sql
          git checkout origin/main -- database/schema-mysql-merged.sql

          echo "âœ“ Updated schema files from main branch"

      - name: Commit and push changes
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          git add VERSION docker-compose*.yml database/schema-*.sql
          
          # Use heredoc to avoid injection
          git commit -m "Update deployment to $VERSION" \
                     -m "Auto-sync from release $VERSION" \
                     -m "- Updated Docker image version" \
                     -m "- Updated schema files from main branch" \
                     -m "" \
                     -m "Pull command:" \
                     -m "  docker pull ghcr.io/aegisx-platform/eclaim-rep-download:$VERSION"

          git push origin deployment

          echo "âœ“ Deployment branch updated to $VERSION"

      - name: Create deployment summary
        env:
          VERSION: ${{ steps.version.outputs.VERSION }}
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY_EOF'
          ## Deployment Branch Updated ðŸš€

          The deployment branch has been automatically updated to **$VERSION**

          ### Users can now deploy with:
          ```bash
          git clone -b deployment https://github.com/aegisx-platform/eclaim-rep-download.git
          cd eclaim-rep-download
          docker-compose pull
          docker-compose up -d
          ```

          ### Changes:
          - Docker image: `ghcr.io/aegisx-platform/eclaim-rep-download:$VERSION`
          - Schema files updated from main branch
          SUMMARY_EOF
