name: Create Release

on:
  push:
    tags:
      - 'v*'  # Trigger on version tags (v1.0.0, v1.0.1, etc.)

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Fetch all history for changelog

      - name: Get version info
        id: version
        env:
          REF_NAME: ${{ github.ref_name }}
        run: |
          VERSION="${REF_NAME#v}"
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "TAG=${REF_NAME}" >> $GITHUB_OUTPUT

      - name: Get previous tag
        id: prev_tag
        run: |
          PREV_TAG=$(git describe --abbrev=0 --tags $(git rev-list --tags --skip=1 --max-count=1) 2>/dev/null || echo "")
          echo "PREV_TAG=${PREV_TAG}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        env:
          PREV_TAG: ${{ steps.prev_tag.outputs.PREV_TAG }}
          CURRENT_TAG: ${{ steps.version.outputs.TAG }}
          REPO: ${{ github.repository }}
        run: |
          echo "## What's Changed" > CHANGELOG.md
          echo "" >> CHANGELOG.md

          if [ -n "${PREV_TAG}" ]; then
            # Get commits since previous tag
            echo "### Commits" >> CHANGELOG.md
            git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "**Full Changelog**: https://github.com/${REPO}/compare/${PREV_TAG}...${CURRENT_TAG}" >> CHANGELOG.md
          else
            echo "Initial release" >> CHANGELOG.md
          fi

          echo "" >> CHANGELOG.md
          echo "---" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Docker Image" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "# Pull specific version" >> CHANGELOG.md
          echo "docker pull ghcr.io/${REPO}:${CURRENT_TAG}" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# Or use latest" >> CHANGELOG.md
          echo "docker pull ghcr.io/${REPO}:latest" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "## Quick Start" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo '```bash' >> CHANGELOG.md
          echo "# Using install script" >> CHANGELOG.md
          echo "curl -fsSL https://raw.githubusercontent.com/${REPO}/main/install.sh | bash" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "# Or manual setup" >> CHANGELOG.md
          echo "git clone https://github.com/${REPO}.git" >> CHANGELOG.md
          echo "cd eclaim-rep-download" >> CHANGELOG.md
          echo "cp .env.example .env" >> CHANGELOG.md
          echo "docker-compose up -d" >> CHANGELOG.md
          echo '```' >> CHANGELOG.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.TAG }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: ${{ contains(github.ref_name, '-rc') || contains(github.ref_name, '-beta') || contains(github.ref_name, '-alpha') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
