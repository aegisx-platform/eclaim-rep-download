{% extends "base.html" %}

{% block title %}Data Management - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Data Management</h2>
    <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• E-Claim: Download, Import, ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p>
</div>

<!-- Tab Navigation -->
<div class="bg-white rounded-t-lg shadow-md border-b">
    <nav class="flex" id="tab-nav">
        <button onclick="switchTab('download')" id="tab-download" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Download
        </button>
        <button onclick="switchTab('rep')" id="tab-rep" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            REP Files ({{ stats.total_files }})
        </button>
        <button onclick="switchTab('statement')" id="tab-statement" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Statement
        </button>
        <button onclick="switchTab('smt')" id="tab-smt" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Smart Money Transfer
        </button>
        <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Settings
        </button>
        <button onclick="switchTab('offices')" id="tab-offices" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            Health Offices
        </button>
    </nav>
</div>

<!-- Tab Content Container -->
<div class="bg-white rounded-b-lg shadow-md">

    <!-- ==================== DOWNLOAD TAB ==================== -->
    <div id="content-download" class="tab-content p-6">
        <!-- Data Type Selector -->
        <div class="mb-6">
            <div class="flex gap-2 p-1 bg-gray-100 rounded-lg inline-flex">
                <button onclick="switchDownloadType('rep')" id="dl-type-rep" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm bg-blue-600 text-white">
                    üìÑ REP Files
                </button>
                <button onclick="switchDownloadType('statement')" id="dl-type-statement" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                    üìä Statement
                </button>
                <button onclick="switchDownloadType('smt')" id="dl-type-smt" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                    üí∞ SMT Budget
                </button>
            </div>
        </div>

        <!-- Data Source Info -->
        <div id="dl-source-info" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm text-blue-800">
                    <span id="dl-source-label" class="font-medium">REP (Request for Electronic Payment)</span> -
                    <a id="dl-source-link" href="https://eclaim.nhso.go.th" target="_blank" class="underline hover:text-blue-600">eclaim.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- Download Form -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 id="dl-form-title" class="text-lg font-semibold mb-4 flex items-center text-blue-700">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP
            </h3>

            <div class="space-y-4">
                <!-- Basic Options: Year/Month -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="bulk-start-year" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="bulk-start-month" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>
                </div>

                <!-- Statement: Patient Type (hidden by default) -->
                <div id="dl-patient-type-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                    <select id="dl-patient-type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="op">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)</option>
                        <option value="ip">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IP)</option>
                    </select>
                </div>

                <!-- Statement: Single Scheme (hidden by default) -->
                <div id="dl-statement-scheme-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</label>
                    <select id="dl-statement-scheme" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="ucs">UCS (‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤)</option>
                        <option value="ofc">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</option>
                        <option value="sss">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                        <option value="lgo">LGO (‡∏≠‡∏õ‡∏ó.)</option>
                    </select>
                </div>

                <!-- SMT: Vendor ID (hidden by default) -->
                <div id="dl-vendor-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Vendor ID (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)</label>
                    <input type="text" id="dl-vendor-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670 ‡∏´‡∏£‡∏∑‡∏≠ 0000010670" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô SMT</p>
                </div>

                <!-- Advanced Settings (Collapsible) -->
                <details id="dl-advanced-settings" class="border border-gray-200 rounded-lg">
                    <summary class="px-4 py-3 cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-t-lg font-medium text-gray-700 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                    </summary>
                    <div class="p-4 space-y-4 border-t">
                        <!-- Date Range (REP only) -->
                        <div id="dl-date-range-section">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</label>
                            <div class="grid grid-cols-2 gap-4">
                                <select id="bulk-end-month" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                                    <option value="">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</option>
                                    <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                                    <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                                    <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                                    <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                                    <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                                    <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                                    <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                                </select>
                                <select id="bulk-end-year" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                                </select>
                            </div>
                        </div>

                        <!-- Insurance Schemes (REP only) -->
                        <div id="dl-schemes-section">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                            <div class="grid grid-cols-4 gap-2 text-sm">
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="ucs" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="ofc" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="sss" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="lgo" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">LGO (‡∏≠‡∏õ‡∏ó.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="nhs" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">NHS (‡∏™‡∏õ‡∏™‡∏ä.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="bkk" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">BKK (‡∏Å‡∏ó‡∏°.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="bmt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">BMT (‡∏Ç‡∏™‡∏°‡∏Å.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="srt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">SRT (‡∏£‡∏ü‡∏ó.)</span>
                                </label>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button type="button" onclick="selectAllSchemes('bulk')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button type="button" onclick="selectDefaultSchemes('bulk')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å)</button>
                            </div>
                        </div>

                        <!-- Auto Import -->
                        <div class="border-t pt-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="bulk-auto-import" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="ml-2 text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto-import)</span>
                            </label>
                        </div>
                    </div>
                </details>

                <!-- Estimate (REP only) -->
                <div id="dl-estimate-section" class="bg-gray-50 rounded-lg p-3">
                    <p id="bulk-estimate" class="text-sm text-gray-600"></p>
                </div>

                <!-- Download Button -->
                <button id="download-btn" onclick="downloadByType()" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white py-3 px-4 rounded-md font-medium transition-colors text-lg">
                    <svg id="download-icon" class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span id="download-btn-text">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </button>
            </div>
        </div>

        <!-- Bulk Progress -->
        <div id="bulk-progress" class="hidden mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-4">Downloading...</h3>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-blue-900 mb-2">
                    <span>Current: <span id="current-month" class="font-semibold"></span></span>
                    <span id="progress-count" class="font-semibold">0 / 0 months</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <span id="progress-percentage" class="text-lg font-bold text-blue-900">0%</span>
        </div>

        <!-- Scheduler Section (Collapsible) -->
        <details class="mt-6 border border-gray-200 rounded-lg">
            <summary class="p-4 cursor-pointer hover:bg-gray-50 rounded-lg flex items-center justify-between list-none">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-lg font-semibold text-gray-800">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto Schedule)</span>
                    <span id="schedule-summary" class="ml-3 text-sm text-gray-500"></span>
                </div>
                <div class="flex items-center gap-3">
                    <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                        <input type="checkbox" id="schedule-enabled" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                    <svg class="w-5 h-5 text-gray-400 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </summary>
            <div class="p-6 pt-2 border-t border-gray-100">
                <p class="text-sm text-gray-600 mb-4">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡πÇ‡∏î‡∏¢‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</p>

                <!-- Data Types Selection -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</label>
                    <div class="flex flex-wrap gap-3">
                        <label class="flex items-center cursor-pointer p-3 hover:bg-blue-50 rounded-lg border border-blue-200 bg-blue-50 schedule-type-label" id="label-type-rep">
                            <input type="checkbox" id="schedule-type-rep" class="w-4 h-4 text-blue-600 rounded" checked onchange="updateScheduleSchemeVisibility()">
                            <span class="ml-2 text-sm font-medium text-blue-700">üìÑ REP Files</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-3 hover:bg-purple-50 rounded-lg border border-purple-200 schedule-type-label" id="label-type-stm">
                            <input type="checkbox" id="schedule-type-stm" class="w-4 h-4 text-purple-600 rounded" onchange="updateScheduleSchemeVisibility()">
                            <span class="ml-2 text-sm font-medium text-purple-700">üìä UC Statement</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-3 hover:bg-green-50 rounded-lg border border-green-200 schedule-type-label" id="label-type-smt">
                            <input type="checkbox" id="schedule-type-smt" class="w-4 h-4 text-green-600 rounded" onchange="updateScheduleSchemeVisibility()">
                            <span class="ml-2 text-sm font-medium text-green-700">üí∞ SMT Budget</span>
                        </label>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</p>
                </div>

                <!-- Statement Info (UCS only) -->
                <div id="schedule-stm-info" class="mb-4 hidden">
                    <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm text-purple-800">
                            <strong>UC Statement</strong> - ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î UCS (‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                        </p>
                    </div>
                </div>

                <!-- Schedule Scheme Selection (for REP only) -->
                <div id="schedule-schemes-section" class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î (REP Files)
                        <span id="schemes-hint" class="text-xs font-normal text-gray-500 ml-2"></span>
                    </label>
                    <div class="grid grid-cols-4 gap-2 text-sm">
                        <!-- 4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å -->
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="ucs" class="w-4 h-4 text-purple-600 rounded" checked>
                            <span class="ml-2">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="ofc" class="w-4 h-4 text-purple-600 rounded" checked>
                            <span class="ml-2">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="sss" class="w-4 h-4 text-purple-600 rounded" checked>
                            <span class="ml-2">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="lgo" class="w-4 h-4 text-purple-600 rounded" checked>
                            <span class="ml-2">LGO (‡∏≠‡∏õ‡∏ó.)</span>
                        </label>
                        <!-- 4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° (REP ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô) -->
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item schedule-scheme-rep-only" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="nhs" class="w-4 h-4 text-purple-600 rounded">
                            <span class="ml-2">NHS (‡∏™‡∏õ‡∏™‡∏ä.)</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item schedule-scheme-rep-only" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="bkk" class="w-4 h-4 text-purple-600 rounded">
                            <span class="ml-2">BKK (‡∏Å‡∏ó‡∏°.)</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item schedule-scheme-rep-only" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="bmt" class="w-4 h-4 text-purple-600 rounded">
                            <span class="ml-2">BMT (‡∏Ç‡∏™‡∏°‡∏Å.)</span>
                        </label>
                        <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100 schedule-scheme-item schedule-scheme-rep-only" data-types="rep">
                            <input type="checkbox" name="schedule-schemes" value="srt" class="w-4 h-4 text-purple-600 rounded">
                            <span class="ml-2">SRT (‡∏£‡∏ü‡∏ó.)</span>
                        </label>
                    </div>
                </div>

                <!-- SMT Vendor ID (for SMT Budget only) -->
                <div id="schedule-smt-vendor-section" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Vendor ID ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö SMT Budget</label>
                    <input type="text" id="schedule-smt-vendor-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670 ‡∏´‡∏£‡∏∑‡∏≠ 0000010670"
                           class="w-full max-w-xs border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500">
                    <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô SMT (‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Settings ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)</p>
                </div>

                <!-- Schedule Times -->
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</label>
                    <div id="schedule-times-container" class="space-y-2">
                        <p class="text-sm text-gray-500" id="no-schedules-message">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ï‡∏±‡πâ‡∏á‡πÑ‡∏ß‡πâ</p>
                    </div>
                </div>

                <div class="flex items-center gap-3">
                    <button onclick="addScheduleTime()" class="bg-purple-600 hover:bg-purple-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                        + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                    </button>
                    <label class="flex items-center cursor-pointer">
                        <input type="checkbox" id="schedule-auto-import" class="w-4 h-4 text-purple-600 rounded">
                        <span class="ml-2 text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                    </label>
                    <button onclick="saveScheduleSettings()" class="bg-gray-600 hover:bg-gray-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                        ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                    </button>
                </div>

                <!-- Schedule Status -->
                <div id="schedule-status-box" class="mt-4 p-3 bg-gray-50 rounded-lg text-sm">
                    <span id="schedule-status">Loading...</span>
                </div>
            </div>
        </details>
    </div>

    <!-- ==================== REP FILES TAB ==================== -->
    <div id="content-rep" class="tab-content p-6 hidden">
        <!-- REP Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                REP Files (Request for Electronic Payment)
            </h2>
            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>REP</strong> (Request for Electronic Payment) ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå
                    ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏¢‡∏±‡∏á <strong>‡∏™‡∏õ‡∏™‡∏ä.</strong> (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥)
                    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                </p>
                <p class="text-xs text-blue-600 mt-1">
                    Data Source: <a href="https://eclaim.nhso.go.th" target="_blank" class="underline hover:text-blue-800">eclaim.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-blue-700">{{ stats.total_files }}</p>
                <p class="text-sm text-blue-600">Total Files</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-green-700">{{ stats.imported_count }}</p>
                <p class="text-sm text-green-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-yellow-700">{{ stats.not_imported_count }}</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-gray-700">{{ stats.total_size }}</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex flex-wrap items-end gap-4">
                <!-- Date Range Filter -->
                <div class="flex items-end gap-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏à‡∏≤‡∏Å</label>
                        <div class="flex gap-1">
                            <select id="filter-start-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                {% for date in available_dates %}
                                <option value="{{ date.month }},{{ date.year }}">{{ date.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <span class="text-gray-400 pb-1.5">-</span>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <div class="flex gap-1">
                            <select id="filter-end-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                {% for date in available_dates %}
                                <option value="{{ date.month }},{{ date.year }}" {% if loop.first %}selected{% endif %}>{{ date.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Scheme Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</label>
                    <select id="filter-scheme" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</option>
                        <option value="ucs">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</option>
                        <option value="ofc">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</option>
                        <option value="sss">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                        <option value="lgo">LGO (‡∏≠‡∏õ‡∏ó.)</option>
                        <option value="nhs">NHS (‡∏™‡∏õ‡∏™‡∏ä.)</option>
                        <option value="bkk">BKK (‡∏Å‡∏ó‡∏°.)</option>
                        <option value="bmt">BMT (‡∏Ç‡∏™‡∏°‡∏Å.)</option>
                        <option value="srt">SRT (‡∏£‡∏ü‡∏ó.)</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <div class="flex gap-1">
                        <button onclick="filterFilesStatus('all')" id="filter-all" class="file-filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="filterFilesStatus('imported')" id="filter-imported" class="file-filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button onclick="filterFilesStatus('pending')" id="filter-pending" class="file-filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <button onclick="applyFilesFilter()" class="bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-4 rounded-md font-medium text-sm">
                    ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                </button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á {{ files|length }} ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                {% if stats.not_imported_count > 0 %}
                <button onclick="importAllFiles()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ stats.not_imported_count }})
                </button>
                {% endif %}
                {% if files|length > 0 %}
                <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Filename</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="files-table-body">
                    {% for file in files %}
                    <tr class="hover:bg-gray-50 file-row" data-status="{% if file.imported %}imported{% else %}pending{% endif %}">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                {% if '_OP_' in file.filename %}
                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                {% elif '_IP_' in file.filename %}
                                <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                                {% elif '_ORF_' in file.filename %}
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                {% else %}
                                <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                                {% endif %}
                                <span class="text-sm font-medium text-gray-900">{{ file.filename }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ file.date_formatted }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ file.size_formatted }}</td>
                        <td class="px-4 py-3">
                            {% if file.imported %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Imported ({{ file.import_status.imported_records }})
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            {% if not file.imported %}
                            <button onclick="importFile('{{ file.filename }}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium mr-2">Import</button>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=file.filename) }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium mr-2">Download</a>
                            <button onclick="deleteFile('{{ file.filename }}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            No files found. Click Download tab to start downloading.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="mt-4 flex items-center justify-between">
            <p class="text-sm text-gray-600">Page {{ page }} of {{ total_pages }}</p>
            <div class="flex gap-2">
                {% if page > 1 %}
                <a href="?tab=files&page={{ page - 1 }}&month={{ filter_month }}&year={{ filter_year }}" class="px-3 py-1 border rounded text-sm">Previous</a>
                {% endif %}
                {% if page < total_pages %}
                <a href="?tab=files&page={{ page + 1 }}&month={{ filter_month }}&year={{ filter_year }}" class="px-3 py-1 border rounded text-sm">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>

    <!-- ==================== STATEMENT TAB ==================== -->
    <div id="content-statement" class="tab-content p-6 hidden">
        <!-- Statement Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Statement Files (UCS/OFC/SSS/LGO)
            </h2>
            <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                <p class="text-sm text-purple-800">
                    <strong>Statement</strong> ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.
                    ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IP) ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)
                </p>
                <p class="text-xs text-purple-600 mt-1">
                    Data Source: <a href="https://eclaim.nhso.go.th/webComponent/ucs/statementUCSAction.do" target="_blank" class="underline hover:text-purple-800">eclaim.nhso.go.th (Statement NHSO)</a>
                </p>
            </div>
        </div>

        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-purple-50 rounded-lg p-4 text-center">
                <p id="stm-stat-total" class="text-2xl font-bold text-purple-700">0</p>
                <p class="text-sm text-purple-600">Total Files</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="stm-stat-imported" class="text-2xl font-bold text-green-700">0</p>
                <p class="text-sm text-green-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p id="stm-stat-pending" class="text-2xl font-bold text-yellow-700">0</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="stm-stat-size" class="text-2xl font-bold text-gray-700">0 B</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div id="stm-file-count" class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                <button id="stm-import-all-btn" onclick="importAllStatementFiles()" class="hidden bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="stm-pending-count">0</span>)
                </button>
                <button id="stm-clear-btn" onclick="clearAllStatementFiles()" class="hidden bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- Statement Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FILENAME</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SIZE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="stm-file-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ==================== SMT TAB ==================== -->
    <div id="content-smt" class="tab-content p-6 hidden">
        <!-- SMT Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Smart Money Transfer Files (SMT Budget)
            </h2>
            <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800">
                    <strong>SMT</strong> (Smart Money Transfer) ‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏Å‡∏±‡∏ö E-Claim
                </p>
                <p class="text-xs text-green-600 mt-1">
                    Data Source: <a href="https://smt.nhso.go.th" target="_blank" class="underline hover:text-green-800">smt.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="smt-stat-total" class="text-2xl font-bold text-green-700">0</p>
                <p class="text-sm text-green-600">Total Files</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p id="smt-stat-imported" class="text-2xl font-bold text-blue-700">0</p>
                <p class="text-sm text-blue-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p id="smt-stat-pending" class="text-2xl font-bold text-yellow-700">0</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="smt-stat-size" class="text-2xl font-bold text-gray-700">0 B</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div id="smt-file-count" class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                <button id="smt-import-all-btn" onclick="importAllSmtFiles()" class="hidden bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="smt-pending-count">0</span>)
                </button>
                <button id="smt-clear-btn" onclick="clearAllSmtFiles()" class="hidden bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- SMT Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FILENAME</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SIZE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="smt-file-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ==================== SETTINGS TAB ==================== -->
    <div id="content-settings" class="tab-content p-6 hidden">
        <div class="max-w-2xl">
            <!-- Credentials Section -->
            <div class="border border-gray-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    E-Claim Credentials
                </h3>

                <form id="credentials-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="eclaim-username" name="eclaim_username" value="{{ settings.eclaim_username }}"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="eclaim-password" name="eclaim_password" value="{{ settings.eclaim_password }}"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:ring-2 focus:ring-blue-500" required>
                            <button type="button" onclick="togglePasswordVisibility('eclaim-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium">
                            Save Credentials
                        </button>
                        <button type="button" onclick="testConnection()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium">
                            Test Connection
                        </button>
                    </div>
                </form>

                <div id="connection-status" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>

            <!-- SMT Settings Section -->
            <div class="border border-gray-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Smart Money Transfer Settings
                </h3>
                <p class="text-sm text-gray-600 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.</p>

                <form id="smt-settings-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Vendor ID (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="smt-vendor-id" name="smt_vendor_id"
                               value="{{ settings.smt_vendor_id | default('') }}"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670 ‡∏´‡∏£‡∏∑‡∏≠ 0000010670"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 5 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ 10 ‡∏´‡∏•‡∏±‡∏Å (Vendor ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô SMT)</p>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="smt-auto-save" name="smt_auto_save_db"
                               {% if settings.smt_auto_save_db | default(true) %}checked{% endif %}
                               class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label for="smt-auto-save" class="ml-2 text-sm text-gray-700">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Database ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </label>
                    </div>

                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium">
                        Save SMT Settings
                    </button>
                </form>

                <div id="smt-settings-status" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>

            <!-- Database Info -->
            <div class="border border-gray-200 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    Database Status
                </h3>

                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Type</p>
                        <p class="font-medium">{{ db_info.type | default('PostgreSQL') }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Status</p>
                        <p class="font-medium text-green-600">Connected</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Claims Records</p>
                        <p class="font-medium">{{ db_info.claims_count | default(0) | number_format }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Budget Records</p>
                        <p class="font-medium">{{ db_info.budget_count | default(0) | number_format }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== HEALTH OFFICES TAB ==================== -->
    <div id="content-offices" class="tab-content p-6 hidden">
        <!-- Header and Source -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
                <span class="font-medium">Data Source:</span>
                <a href="https://hcode.moph.go.th/code/" target="_blank" class="underline hover:text-blue-600">
                    https://hcode.moph.go.th
                </a>
                - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="ho-stat-total" class="text-2xl font-bold text-gray-700">-</p>
                <p class="text-sm text-gray-600">Total Records</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p id="ho-stat-active" class="text-2xl font-bold text-blue-700">-</p>
                <p class="text-sm text-blue-600">Active</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="ho-stat-provinces" class="text-2xl font-bold text-green-700">-</p>
                <p class="text-sm text-green-600">Provinces</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4 text-center">
                <p id="ho-stat-hospitals" class="text-2xl font-bold text-purple-700">-</p>
                <p class="text-sm text-purple-600">Hospitals</p>
            </div>
        </div>

        <!-- Import Section -->
        <div class="border border-gray-200 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center text-green-700">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Import Health Offices Data
            </h3>

            <div class="grid grid-cols-2 gap-6">
                <!-- Upload Area -->
                <div class="border border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <input type="file" id="ho-import-file" accept=".xlsx,.xls" class="hidden" onchange="hoHandleFileSelect(this)">
                    <div id="ho-upload-area" onclick="document.getElementById('ho-import-file').click()" class="cursor-pointer">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-gray-600">Click to upload Excel file</p>
                        <p class="text-sm text-gray-400 mt-1">.xlsx from hcode.moph.go.th</p>
                    </div>
                    <div id="ho-file-selected" class="hidden">
                        <div class="flex items-center justify-center gap-2 text-green-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="ho-file-name">file.xlsx</span>
                        </div>
                    </div>
                </div>

                <!-- Import Options -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Import Mode</label>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ho-import-mode" value="upsert" checked class="w-4 h-4 text-blue-600">
                                <span class="ml-2">
                                    <span class="font-medium">Update/Insert</span>
                                    <span class="text-sm text-gray-500">- ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</span>
                                </span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ho-import-mode" value="replace" class="w-4 h-4 text-red-600">
                                <span class="ml-2">
                                    <span class="font-medium text-red-600">Clear & Replace</span>
                                    <span class="text-sm text-gray-500">- ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="hoImportData()" id="ho-btn-import" disabled
                                class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-2 px-4 rounded-md font-medium">
                            Import Data
                        </button>
                        <button onclick="hoClearAllData()"
                                class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium">
                            Clear All
                        </button>
                    </div>

                    <div id="ho-import-progress" class="hidden">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Importing...</span>
                            <span id="ho-import-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="ho-import-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="ho-import-result" class="hidden p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- Search and Data Table -->
        <div class="border border-gray-200 rounded-lg">
            <div class="p-4 border-b border-gray-200">
                <div class="grid grid-cols-5 gap-4">
                    <div class="col-span-2">
                        <input type="text" id="ho-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å..."
                               onkeyup="hoDebounceSearch()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <select id="ho-filter-province" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Provinces</option>
                    </select>
                    <select id="ho-filter-level" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Levels</option>
                    </select>
                    <select id="ho-per-page" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody id="ho-data-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>

            <div class="px-4 py-3 border-t border-gray-200 flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    <span id="ho-showing-count">0</span> of <span id="ho-total-count">0</span>
                </div>
                <div id="ho-pagination" class="flex gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div id="import-progress-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Importing Files to Database</h3>
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span id="import-progress-text">Preparing...</span>
                <span id="import-progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="import-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                <span id="import-file-count">0 / 0 files</span> |
                <span id="import-record-count">0 records</span>
            </div>
        </div>
        <div class="bg-gray-50 rounded p-3 mb-4">
            <div class="text-xs text-gray-500">Current File:</div>
            <div id="import-current-file" class="text-sm font-mono truncate">-</div>
        </div>
        <button onclick="closeImportModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
            Run in Background
        </button>
    </div>
</div>

<script>
let scheduleTimes = [];
let currentTab = 'download';

// Scheme selection helpers
function selectAllSchemes(prefix) {
    document.querySelectorAll('input[name="' + prefix + '-schemes"]').forEach(function(cb) {
        cb.checked = true;
    });
    updateBulkEstimate();
}

function selectDefaultSchemes(prefix) {
    var defaultSchemes = ['ucs', 'ofc', 'sss', 'lgo'];
    document.querySelectorAll('input[name="' + prefix + '-schemes"]').forEach(function(cb) {
        cb.checked = defaultSchemes.includes(cb.value);
    });
    updateBulkEstimate();
}

function getSelectedSchemes(prefix) {
    var schemes = [];
    document.querySelectorAll('input[name="' + prefix + '-schemes"]:checked').forEach(function(cb) {
        schemes.push(cb.value);
    });
    return schemes;
}

// Tab switching
function switchTab(tab) {
    currentTab = tab;
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(function(el) {
        el.classList.add('hidden');
    });
    // Show selected tab content
    document.getElementById('content-' + tab).classList.remove('hidden');

    // Update tab button styles
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-600', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    var activeBtn = document.getElementById('tab-' + tab);
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
    activeBtn.classList.add('border-blue-600', 'text-blue-600');

    // Load data for specific tabs
    if (tab === 'smt' && typeof loadSmtFiles === 'function') {
        loadSmtFiles();
    } else if (tab === 'statement' && typeof loadStatementFiles === 'function') {
        loadStatementFiles();
    }

    // Update URL without reload
    var url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);
}

// Initialize from URL params
function initFromUrl() {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab') || 'download';
    switchTab(tab);
}

// Year dropdowns
function populateYearDropdowns() {
    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;

    var yearSelects = ['bulk-start-year', 'bulk-end-year', 'smt-fiscal-year'];

    yearSelects.forEach(function(id) {
        var select = document.getElementById(id);
        if (!select) return;

        while (select.firstChild) select.removeChild(select.firstChild);

        for (var i = 0; i <= 8; i++) {
            var yearBE = currentYearBE - i;
            var option = document.createElement('option');
            option.value = yearBE;
            option.textContent = yearBE;
            if (i === 0) option.selected = true;
            select.appendChild(option);
        }
    });

    // Set current month for bulk download
    var bulkStartMonth = document.getElementById('bulk-start-month');
    var bulkEndMonth = document.getElementById('bulk-end-month');
    if (bulkStartMonth) bulkStartMonth.value = currentMonth;
    if (bulkEndMonth) bulkEndMonth.value = currentMonth;
}

// Update bulk estimate
function updateBulkEstimate() {
    var startMonth = parseInt(document.getElementById('bulk-start-month').value);
    var startYear = parseInt(document.getElementById('bulk-start-year').value);
    var endMonth = parseInt(document.getElementById('bulk-end-month').value);
    var endYear = parseInt(document.getElementById('bulk-end-year').value);

    var schemes = getSelectedSchemes('bulk');
    var numSchemes = schemes.length || 1;

    if (typeof calculateMonthsBetween === 'function') {
        var totalMonths = calculateMonthsBetween(startMonth, startYear, endMonth, endYear);
        var totalIterations = totalMonths * numSchemes;
        var estimatedMinutes = Math.ceil(totalIterations * 0.5); // ~30 sec per iteration
        document.getElementById('bulk-estimate').textContent =
            totalMonths + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô x ' + numSchemes + ' ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ = ' + totalIterations + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ' + estimatedMinutes + ' ‡∏ô‡∏≤‡∏ó‡∏µ)';
    }
}

// File filtering
function filterFilesStatus(status) {
    document.querySelectorAll('.file-filter-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    document.getElementById('filter-' + status).classList.remove('bg-gray-200', 'text-gray-700');
    document.getElementById('filter-' + status).classList.add('bg-blue-600', 'text-white');

    document.querySelectorAll('.file-row').forEach(function(row) {
        if (status === 'all') {
            row.style.display = '';
        } else {
            row.style.display = row.dataset.status === status ? '' : 'none';
        }
    });
}

function filterFilesByMonth() {
    // Legacy function - redirect to applyFilesFilter
    applyFilesFilter();
}

// Apply files filter with date range and scheme
function applyFilesFilter() {
    var startSelect = document.getElementById('filter-start-month');
    var endSelect = document.getElementById('filter-end-month');
    var schemeSelect = document.getElementById('filter-scheme');

    var params = new URLSearchParams();
    params.set('tab', 'rep');
    params.set('page', '1');

    // Date range
    if (startSelect && startSelect.value) {
        var startParts = startSelect.value.split(',');
        params.set('start_month', startParts[0]);
        params.set('start_year', startParts[1]);
    }
    if (endSelect && endSelect.value) {
        var endParts = endSelect.value.split(',');
        params.set('end_month', endParts[0]);
        params.set('end_year', endParts[1]);
    }

    // Scheme filter
    if (schemeSelect && schemeSelect.value) {
        params.set('scheme', schemeSelect.value);
    }

    window.location.href = '?' + params.toString();
}

// Password toggle
function togglePasswordVisibility(inputId) {
    var input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Schedule management
async function loadScheduleSettings() {
    try {
        var response = await fetch('/api/schedule');
        var data = await response.json();

        if (data.success) {
            document.getElementById('schedule-enabled').checked = data.settings.schedule_enabled;
            document.getElementById('schedule-auto-import').checked = data.settings.schedule_auto_import;
            scheduleTimes = data.settings.schedule_times || [];
            renderScheduleTimes();
            displayScheduleStatus(data.jobs);
            // Load schedule schemes
            setScheduleSchemes(data.settings.schedule_schemes);
            // Load data type checkboxes
            var typeRepCheckbox = document.getElementById('schedule-type-rep');
            var typeStmCheckbox = document.getElementById('schedule-type-stm');
            var typeSmtCheckbox = document.getElementById('schedule-type-smt');
            var smtVendorInput = document.getElementById('schedule-smt-vendor-id');

            if (typeRepCheckbox) {
                typeRepCheckbox.checked = data.settings.schedule_type_rep !== false; // Default true
            }
            if (typeStmCheckbox) {
                typeStmCheckbox.checked = data.settings.schedule_type_stm === true; // Default false
            }
            if (typeSmtCheckbox) {
                typeSmtCheckbox.checked = data.settings.schedule_type_smt === true; // Default false
            }
            if (smtVendorInput) {
                smtVendorInput.value = data.settings.schedule_smt_vendor_id || '';
            }

            // Update visibility based on loaded settings
            updateScheduleSchemeVisibility();
        }
    } catch (error) {
        console.error('Error loading schedule:', error);
    }
}

function renderScheduleTimes() {
    var container = document.getElementById('schedule-times-container');
    var msg = document.getElementById('no-schedules-message');

    // Remove existing schedule items
    var existingItems = container.querySelectorAll('.schedule-item');
    existingItems.forEach(function(el) { el.remove(); });

    if (scheduleTimes.length === 0) {
        msg.style.display = 'block';
        return;
    }

    msg.style.display = 'none';

    scheduleTimes.forEach(function(time, index) {
        var item = document.createElement('div');
        item.className = 'schedule-item flex items-center gap-2 p-2 bg-gray-50 rounded';

        // Hour input
        var hourInput = document.createElement('input');
        hourInput.type = 'number';
        hourInput.min = '0';
        hourInput.max = '23';
        hourInput.value = time.hour;
        hourInput.className = 'w-16 px-2 py-1 border rounded text-center text-sm';
        hourInput.onchange = function() { scheduleTimes[index].hour = parseInt(this.value); };

        var colon = document.createElement('span');
        colon.textContent = ':';

        // Minute input
        var minuteInput = document.createElement('input');
        minuteInput.type = 'number';
        minuteInput.min = '0';
        minuteInput.max = '59';
        minuteInput.value = String(time.minute).padStart(2, '0');
        minuteInput.className = 'w-16 px-2 py-1 border rounded text-center text-sm';
        minuteInput.onchange = function() { scheduleTimes[index].minute = parseInt(this.value); };

        var timeLabel = document.createElement('span');
        timeLabel.className = 'text-sm text-gray-500';
        timeLabel.textContent = '(' + String(time.hour).padStart(2, '0') + ':' + String(time.minute).padStart(2, '0') + ')';

        // Delete button
        var deleteBtn = document.createElement('button');
        deleteBtn.className = 'text-red-600 hover:text-red-800 ml-auto';
        deleteBtn.onclick = function() { removeScheduleTime(index); };

        var deleteIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        deleteIcon.setAttribute('class', 'w-4 h-4');
        deleteIcon.setAttribute('fill', 'none');
        deleteIcon.setAttribute('stroke', 'currentColor');
        deleteIcon.setAttribute('viewBox', '0 0 24 24');

        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M6 18L18 6M6 6l12 12');

        deleteIcon.appendChild(path);
        deleteBtn.appendChild(deleteIcon);

        item.appendChild(hourInput);
        item.appendChild(colon);
        item.appendChild(minuteInput);
        item.appendChild(timeLabel);
        item.appendChild(deleteBtn);

        container.appendChild(item);
    });
}

function addScheduleTime() {
    scheduleTimes.push({ hour: 9, minute: 0 });
    renderScheduleTimes();
}

function removeScheduleTime(index) {
    scheduleTimes.splice(index, 1);
    renderScheduleTimes();
}

function getScheduleSchemes() {
    var schemes = [];
    document.querySelectorAll('input[name="schedule-schemes"]:checked').forEach(function(cb) {
        schemes.push(cb.value);
    });
    return schemes;
}

function setScheduleSchemes(schemes) {
    if (!schemes || schemes.length === 0) {
        schemes = ['ucs', 'ofc', 'sss', 'lgo']; // Default
    }
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = schemes.includes(cb.value);
    });
}

function updateScheduleSchemeVisibility() {
    var typeRep = document.getElementById('schedule-type-rep');
    var typeStm = document.getElementById('schedule-type-stm');
    var typeSmt = document.getElementById('schedule-type-smt');

    var repSelected = typeRep && typeRep.checked;
    var stmSelected = typeStm && typeStm.checked;
    var smtSelected = typeSmt && typeSmt.checked;

    // Update label styles
    var labelRep = document.getElementById('label-type-rep');
    var labelStm = document.getElementById('label-type-stm');
    var labelSmt = document.getElementById('label-type-smt');

    if (labelRep) {
        labelRep.className = repSelected
            ? 'flex items-center cursor-pointer p-3 rounded-lg border border-blue-200 bg-blue-50 schedule-type-label'
            : 'flex items-center cursor-pointer p-3 hover:bg-blue-50 rounded-lg border border-gray-200 schedule-type-label';
    }
    if (labelStm) {
        labelStm.className = stmSelected
            ? 'flex items-center cursor-pointer p-3 rounded-lg border border-purple-200 bg-purple-50 schedule-type-label'
            : 'flex items-center cursor-pointer p-3 hover:bg-purple-50 rounded-lg border border-gray-200 schedule-type-label';
    }
    if (labelSmt) {
        labelSmt.className = smtSelected
            ? 'flex items-center cursor-pointer p-3 rounded-lg border border-green-200 bg-green-50 schedule-type-label'
            : 'flex items-center cursor-pointer p-3 hover:bg-green-50 rounded-lg border border-gray-200 schedule-type-label';
    }

    // Show/hide scheme section (only for REP - Statement is UCS only)
    var schemesSection = document.getElementById('schedule-schemes-section');
    if (schemesSection) {
        if (repSelected) {
            schemesSection.classList.remove('hidden');
        } else {
            schemesSection.classList.add('hidden');
        }
    }

    // Show/hide REP-only schemes (NHS, BKK, BMT, SRT)
    var repOnlySchemes = document.querySelectorAll('.schedule-scheme-rep-only');
    repOnlySchemes.forEach(function(el) {
        if (repSelected) {
            el.classList.remove('hidden');
        } else {
            el.classList.add('hidden');
            // Uncheck hidden checkboxes
            var cb = el.querySelector('input[type="checkbox"]');
            if (cb) cb.checked = false;
        }
    });

    // Update hint text
    var schemesHint = document.getElementById('schemes-hint');
    if (schemesHint) {
        if (repSelected) {
            schemesHint.textContent = '(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö REP Files)';
        } else {
            schemesHint.textContent = '';
        }
    }

    // Show Statement info (UCS only)
    var stmInfoSection = document.getElementById('schedule-stm-info');
    if (stmInfoSection) {
        if (stmSelected) {
            stmInfoSection.classList.remove('hidden');
        } else {
            stmInfoSection.classList.add('hidden');
        }
    }

    // Show/hide SMT vendor ID section
    var smtVendorSection = document.getElementById('schedule-smt-vendor-section');
    if (smtVendorSection) {
        if (smtSelected) {
            smtVendorSection.classList.remove('hidden');
        } else {
            smtVendorSection.classList.add('hidden');
        }
    }
}

async function saveScheduleSettings() {
    try {
        // Get data type checkboxes
        var typeRep = document.getElementById('schedule-type-rep');
        var typeStm = document.getElementById('schedule-type-stm');
        var typeSmt = document.getElementById('schedule-type-smt');
        var smtVendorInput = document.getElementById('schedule-smt-vendor-id');

        var scheduleTypeRep = typeRep ? typeRep.checked : true;
        var scheduleTypeStm = typeStm ? typeStm.checked : false;
        var scheduleTypeSmt = typeSmt ? typeSmt.checked : false;
        var smtVendorId = smtVendorInput ? smtVendorInput.value.trim() : '';

        // Validate at least one data type is selected when enabling
        var scheduleEnabled = document.getElementById('schedule-enabled').checked;
        if (scheduleEnabled && !scheduleTypeRep && !scheduleTypeStm && !scheduleTypeSmt) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            return;
        }

        // Validate schemes only if REP or Statement is selected
        var scheduleSchemes = getScheduleSchemes();
        if ((scheduleTypeRep || scheduleTypeStm) && scheduleSchemes.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥', 'error');
            return;
        }

        var response = await fetch('/api/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                schedule_enabled: scheduleEnabled,
                schedule_times: scheduleTimes,
                schedule_auto_import: document.getElementById('schedule-auto-import').checked,
                schedule_schemes: scheduleSchemes,
                schedule_type_rep: scheduleTypeRep,
                schedule_type_stm: scheduleTypeStm,
                schedule_type_smt: scheduleTypeSmt,
                schedule_smt_vendor_id: smtVendorId
            })
        });

        var result = await response.json();
        if (result.success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadScheduleSettings();
        } else {
            showToast(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
        }
    } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    }
}

function displayScheduleStatus(jobs) {
    var statusDiv = document.getElementById('schedule-status');
    if (!jobs || jobs.length === 0) {
        statusDiv.textContent = 'No scheduled jobs';
        return;
    }

    var jobsText = jobs.map(function(job) {
        var nextRun = job.next_run_time ? new Date(job.next_run_time).toLocaleString('th-TH') : 'N/A';
        return 'Next: ' + nextRun;
    }).join(' | ');

    statusDiv.textContent = jobsText;
}

// Credentials form
document.getElementById('credentials-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    var data = {
        eclaim_username: document.getElementById('eclaim-username').value,
        eclaim_password: document.getElementById('eclaim-password').value
    };

    try {
        var response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        var result = await response.json();
        if (result.success) {
            showToast('Settings saved!', 'success');
        } else {
            showToast(result.error || 'Failed to save', 'error');
        }
    } catch (error) {
        showToast('Error saving settings', 'error');
    }
});

async function testConnection() {
    var statusDiv = document.getElementById('connection-status');
    statusDiv.classList.remove('hidden');
    statusDiv.className = 'mt-4 p-3 rounded-lg bg-gray-100';
    statusDiv.textContent = 'Testing connection...';

    try {
        var response = await fetch('/api/settings/test-connection', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-800';
            statusDiv.textContent = result.message;
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
            statusDiv.textContent = result.error;
        }
    } catch (error) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
        statusDiv.textContent = 'Network error';
    }
}

// SMT Fetch
async function fetchSmtData() {
    var fiscalYear = document.getElementById('smt-fiscal-year').value;
    var month = document.getElementById('smt-month').value;

    try {
        showToast('Fetching SMT data...', 'info');

        // Build date range from fiscal year and month
        var startDate = null;
        var endDate = null;

        if (month) {
            // Calculate start and end date for specific month
            var monthInt = parseInt(month);
            var yearInt = parseInt(fiscalYear);
            // Thai fiscal year: Oct (yearBE-1) to Sep (yearBE)
            // So for month 10-12, use yearBE-1, for month 1-9, use yearBE
            var gregorianYear = monthInt >= 10 ? yearInt - 544 : yearInt - 543;
            var daysInMonth = new Date(gregorianYear, monthInt, 0).getDate();
            startDate = '01/' + String(monthInt).padStart(2, '0') + '/' + yearInt;
            endDate = String(daysInMonth).padStart(2, '0') + '/' + String(monthInt).padStart(2, '0') + '/' + yearInt;
        }

        var response = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                budget_year: fiscalYear,
                start_date: startDate,
                end_date: endDate,
                save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('SMT data fetched successfully! ' + (result.records || 0) + ' records', 'success');
            document.getElementById('smt-last-sync').textContent = new Date().toLocaleString('th-TH');
            document.getElementById('smt-record-count').textContent = result.records || 0;
        } else {
            showToast(result.error || 'Failed to fetch', 'error');
        }
    } catch (error) {
        console.error('SMT fetch error:', error);
        showToast('Error fetching SMT data: ' + error.message, 'error');
    }
}

// SMT Settings
async function saveSmtSettings(event) {
    event.preventDefault();

    var vendorId = document.getElementById('smt-vendor-id').value.trim();
    var autoSave = document.getElementById('smt-auto-save').checked;
    var statusDiv = document.getElementById('smt-settings-status');

    if (!vendorId) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
        statusDiv.textContent = 'Vendor ID is required';
        statusDiv.classList.remove('hidden');
        return;
    }

    try {
        var response = await fetch('/api/smt/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                smt_vendor_id: vendorId,
                smt_schedule_enabled: false,
                smt_schedule_times: [],
                smt_auto_save_db: autoSave
            })
        });
        var result = await response.json();

        if (result.success) {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-700';
            statusDiv.textContent = 'SMT settings saved successfully!';
            showToast('SMT settings saved!', 'success');
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
            statusDiv.textContent = result.error || 'Failed to save settings';
        }
        statusDiv.classList.remove('hidden');
    } catch (error) {
        console.error('SMT settings error:', error);
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
        statusDiv.textContent = 'Error: ' + error.message;
        statusDiv.classList.remove('hidden');
    }
}

async function loadSmtSettings() {
    try {
        var response = await fetch('/api/smt/settings');
        var result = await response.json();

        if (result.success && result.settings) {
            // Settings tab fields
            var vendorInput = document.getElementById('smt-vendor-id');
            var autoSaveInput = document.getElementById('smt-auto-save');
            // SMT tab field
            var vendorInputTab = document.getElementById('smt-vendor-id-input');

            if (vendorInput && result.settings.smt_vendor_id) {
                vendorInput.value = result.settings.smt_vendor_id;
            }
            if (vendorInputTab && result.settings.smt_vendor_id) {
                vendorInputTab.value = result.settings.smt_vendor_id;
            }
            if (autoSaveInput) {
                autoSaveInput.checked = result.settings.smt_auto_save_db !== false;
            }
        }
    } catch (error) {
        console.error('Failed to load SMT settings:', error);
    }
}

// Load SMT stats (record count and last sync time)
async function loadSmtStats() {
    try {
        var response = await fetch('/api/smt/stats');
        var result = await response.json();

        if (result.success) {
            var lastSyncEl = document.getElementById('smt-last-sync');
            var recordCountEl = document.getElementById('smt-record-count');

            if (lastSyncEl) {
                if (result.last_sync) {
                    lastSyncEl.textContent = new Date(result.last_sync).toLocaleString('th-TH');
                } else {
                    lastSyncEl.textContent = '-';
                }
            }
            if (recordCountEl) {
                recordCountEl.textContent = result.record_count ? result.record_count.toLocaleString() : '0';
            }
        }
    } catch (error) {
        console.error('Failed to load SMT stats:', error);
    }
}

// Clear SMT data
async function clearSmtData() {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
        return;
    }

    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
        return;
    }

    try {
        var response = await fetch('/api/smt/clear', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadSmtStats();
        } else {
            showToast(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    } catch (error) {
        console.error('Failed to clear SMT data:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Quick save vendor ID from SMT tab
async function saveSmtVendorId() {
    var vendorId = document.getElementById('smt-vendor-id-input').value.trim();

    if (!vendorId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Vendor ID', 'error');
        return;
    }

    try {
        var response = await fetch('/api/smt/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                smt_vendor_id: vendorId,
                smt_schedule_enabled: false,
                smt_schedule_times: [],
                smt_auto_save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('Vendor ID saved: ' + vendorId, 'success');
            // Sync to settings tab if it exists
            var settingsInput = document.getElementById('smt-vendor-id');
            if (settingsInput) settingsInput.value = vendorId;
        } else {
            showToast(result.error || 'Failed to save', 'error');
        }
    } catch (error) {
        console.error('Save vendor ID error:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== HEALTH OFFICES FUNCTIONS ====================
let hoCurrentPage = 1;
let hoSearchTimeout;

async function hoLoadStats() {
    try {
        var response = await fetch('/api/health-offices/stats');
        var result = await response.json();

        if (result.success) {
            var stats = result.stats;
            document.getElementById('ho-stat-total').textContent = stats.total.toLocaleString();

            var active = stats.by_status.find(function(s) { return s.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; });
            document.getElementById('ho-stat-active').textContent = active ? active.count.toLocaleString() : '0';
            document.getElementById('ho-stat-provinces').textContent = stats.provinces.length;
            document.getElementById('ho-stat-hospitals').textContent = stats.levels.length > 0 ? stats.levels.length + ' levels' : '0';

            hoPopulateFilter('ho-filter-province', stats.provinces);
            hoPopulateFilter('ho-filter-level', stats.levels);
        }
    } catch (e) {
        console.error('Error loading HO stats:', e);
    }
}

function hoPopulateFilter(elementId, options) {
    var select = document.getElementById(elementId);
    var firstOption = select.options[0];
    select.textContent = '';
    select.appendChild(firstOption);

    options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
    });
}

async function hoLoadData() {
    var search = document.getElementById('ho-search-input').value;
    var province = document.getElementById('ho-filter-province').value;
    var level = document.getElementById('ho-filter-level').value;
    var perPage = document.getElementById('ho-per-page').value;

    var params = new URLSearchParams();
    params.append('page', hoCurrentPage);
    params.append('per_page', perPage);
    if (search) params.append('search', search);
    if (province) params.append('province', province);
    if (level) params.append('level', level);

    try {
        var response = await fetch('/api/health-offices?' + params.toString());
        var result = await response.json();

        if (result.success) {
            hoRenderTable(result.data);
            document.getElementById('ho-showing-count').textContent = result.data.length;
            document.getElementById('ho-total-count').textContent = result.total.toLocaleString();
            hoRenderPagination(result.page, result.total_pages);
        }
    } catch (e) {
        console.error('Error loading HO data:', e);
    }
}

function hoRenderTable(data) {
    var tbody = document.getElementById('ho-data-tbody');
    tbody.textContent = '';

    if (!data || data.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 5;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = 'No data found';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    data.forEach(function(row) {
        var tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        // hcode5
        var td1 = document.createElement('td');
        td1.className = 'px-4 py-2 text-sm font-mono';
        td1.textContent = row.hcode5 || '-';
        tr.appendChild(td1);

        // name
        var td2 = document.createElement('td');
        td2.className = 'px-4 py-2 text-sm';
        td2.textContent = row.name || '-';
        tr.appendChild(td2);

        // hospital_level
        var td3 = document.createElement('td');
        td3.className = 'px-4 py-2 text-sm text-gray-600';
        td3.textContent = row.hospital_level || '-';
        tr.appendChild(td3);

        // province
        var td4 = document.createElement('td');
        td4.className = 'px-4 py-2 text-sm text-gray-600';
        td4.textContent = row.province || '-';
        tr.appendChild(td4);

        // status
        var td5 = document.createElement('td');
        td5.className = 'px-4 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-1 text-xs rounded-full ' +
            (row.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');
        statusSpan.textContent = row.status || '-';
        td5.appendChild(statusSpan);
        tr.appendChild(td5);

        tbody.appendChild(tr);
    });
}

function hoRenderPagination(page, totalPages) {
    var pagination = document.getElementById('ho-pagination');
    pagination.textContent = '';
    if (totalPages <= 1) return;

    function addBtn(text, pageNum, isActive) {
        var btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'px-3 py-1 border rounded text-sm ' + (isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-100');
        btn.onclick = function() { hoCurrentPage = pageNum; hoLoadData(); };
        pagination.appendChild(btn);
    }

    if (page > 1) addBtn('Prev', page - 1, false);
    for (var i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        addBtn(String(i), i, i === page);
    }
    if (page < totalPages) addBtn('Next', page + 1, false);
}

function hoDebounceSearch() {
    clearTimeout(hoSearchTimeout);
    hoSearchTimeout = setTimeout(function() {
        hoCurrentPage = 1;
        hoLoadData();
    }, 300);
}

function hoHandleFileSelect(input) {
    if (input.files && input.files[0]) {
        document.getElementById('ho-file-name').textContent = input.files[0].name;
        document.getElementById('ho-upload-area').classList.add('hidden');
        document.getElementById('ho-file-selected').classList.remove('hidden');
        document.getElementById('ho-btn-import').disabled = false;
    }
}

async function hoImportData() {
    var fileInput = document.getElementById('ho-import-file');
    if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select a file', 'error');
        return;
    }

    var mode = document.querySelector('input[name="ho-import-mode"]:checked').value;
    if (mode === 'replace' && !confirm('This will DELETE all existing data. Continue?')) return;

    var formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('mode', mode);

    document.getElementById('ho-btn-import').disabled = true;
    document.getElementById('ho-import-progress').classList.remove('hidden');
    document.getElementById('ho-import-result').classList.add('hidden');

    var progress = 0;
    var progressInterval = setInterval(function() {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        document.getElementById('ho-import-percent').textContent = Math.round(progress) + '%';
        document.getElementById('ho-import-bar').style.width = progress + '%';
    }, 500);

    try {
        var response = await fetch('/api/health-offices/import', {
            method: 'POST',
            body: formData
        });
        var result = await response.json();

        clearInterval(progressInterval);
        document.getElementById('ho-import-percent').textContent = '100%';
        document.getElementById('ho-import-bar').style.width = '100%';

        var resultDiv = document.getElementById('ho-import-result');
        resultDiv.textContent = '';

        if (result.success) {
            resultDiv.className = 'p-3 rounded-lg bg-green-100 text-green-800';
            resultDiv.textContent = 'Success! Imported: ' + result.imported.toLocaleString() +
                ' | Errors: ' + result.errors + ' | Time: ' + result.duration + 's';
            showToast('Import completed: ' + result.imported + ' records', 'success');
            hoLoadStats();
            hoLoadData();
        } else {
            resultDiv.className = 'p-3 rounded-lg bg-red-100 text-red-800';
            resultDiv.textContent = 'Error: ' + result.error;
            showToast('Import failed', 'error');
        }
        resultDiv.classList.remove('hidden');
    } catch (error) {
        clearInterval(progressInterval);
        showToast('Import error: ' + error.message, 'error');
    }

    document.getElementById('ho-btn-import').disabled = false;
    setTimeout(function() {
        document.getElementById('ho-import-progress').classList.add('hidden');
    }, 2000);
}

async function hoClearAllData() {
    if (!confirm('DELETE ALL health offices data? This cannot be undone.')) return;
    if (!confirm('Are you really sure?')) return;

    try {
        var response = await fetch('/api/health-offices/clear', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('All data cleared', 'success');
            hoLoadStats();
            hoLoadData();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== STATEMENT FUNCTIONS ====================

function initStatementYears() {
    var select = document.getElementById('stm-year');
    if (!select) return;

    var currentYear = new Date().getFullYear() + 543;
    select.textContent = '';

    for (var y = currentYear; y >= currentYear - 5; y--) {
        var option = document.createElement('option');
        option.value = y;
        option.textContent = '‡∏õ‡∏µ‡∏á‡∏ö ' + y;
        select.appendChild(option);
    }
}

async function downloadStatement() {
    var year = document.getElementById('stm-year').value;
    var month = document.getElementById('stm-month').value;
    var scheme = document.getElementById('stm-scheme').value;
    var personType = document.getElementById('stm-type').value;

    var resultDiv = document.getElementById('stm-download-result');
    resultDiv.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...';
    resultDiv.className = 'mt-4 p-3 rounded-lg bg-blue-100 text-blue-800';
    resultDiv.classList.remove('hidden');

    try {
        var response = await fetch('/api/stm/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                year: year,
                month: month || null,
                scheme: scheme,
                person_type: personType
            })
        });
        var result = await response.json();

        if (result.success) {
            resultDiv.textContent = result.message + ' - ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏µ‡πà Logs';
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-800';
            showToast('Statement download started', 'success');
            setTimeout(loadStatementFiles, 3000);
        } else {
            resultDiv.textContent = 'Error: ' + result.error;
            resultDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        resultDiv.textContent = 'Error: ' + error.message;
        resultDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
        showToast('Error: ' + error.message, 'error');
    }
}

async function loadStatementFiles() {
    const listDiv = document.getElementById('stm-file-list');
    listDiv.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>';

    try {
        const response = await fetch('/api/stm/stats');
        const result = await response.json();

        // Update stats
        document.getElementById('stm-stat-total').textContent = result.total_files || 0;
        document.getElementById('stm-stat-imported').textContent = result.imported_count || 0;
        document.getElementById('stm-stat-pending').textContent = result.pending_count || 0;
        document.getElementById('stm-stat-size').textContent = result.total_size || '0 B';
        document.getElementById('stm-file-count').textContent = `‡πÅ‡∏™‡∏î‡∏á ${result.total_files || 0} ‡πÑ‡∏ü‡∏•‡πå`;

        // Show/hide action buttons
        const importAllBtn = document.getElementById('stm-import-all-btn');
        const clearBtn = document.getElementById('stm-clear-btn');
        const pendingCountSpan = document.getElementById('stm-pending-count');

        if (result.pending_count > 0) {
            importAllBtn.classList.remove('hidden');
            pendingCountSpan.textContent = result.pending_count;
        } else {
            importAllBtn.classList.add('hidden');
        }

        if (result.total_files > 0) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }

        listDiv.innerHTML = '';

        if (result.success && result.files && result.files.length > 0) {
            result.files.forEach(function(f) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Filename
                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-3';
                nameCell.innerHTML = `<span class="text-blue-600">&#9679;</span> ${f.filename}`;
                row.appendChild(nameCell);

                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-4 py-3 text-gray-600';
                const modDate = new Date(f.modified);
                dateCell.textContent = modDate.toLocaleString('th-TH');
                row.appendChild(dateCell);

                // Size
                const sizeCell = document.createElement('td');
                sizeCell.className = 'px-4 py-3 text-gray-600';
                sizeCell.textContent = f.size_formatted;
                row.appendChild(sizeCell);

                // Status
                const statusCell = document.createElement('td');
                statusCell.className = 'px-4 py-3';
                if (f.is_imported) {
                    let statusInfo = 'Imported';
                    if (f.imported_records) {
                        statusInfo += ` (${f.imported_records} records)`;
                    }
                    if (f.file_type) {
                        statusInfo = f.file_type.replace('_STM', '') + ' - ' + statusInfo;
                    }
                    statusCell.innerHTML = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">${statusInfo}</span>`;
                } else if (f.status === 'failed') {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Failed</span>';
                } else if (f.status === 'processing') {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Processing...</span>';
                } else {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Pending</span>';
                }
                row.appendChild(statusCell);

                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-4 py-3 text-right space-x-2';

                if (!f.is_imported) {
                    const importBtn = document.createElement('a');
                    importBtn.href = '#';
                    importBtn.className = 'text-blue-600 hover:text-blue-800 text-sm';
                    importBtn.textContent = 'Import';
                    importBtn.onclick = (e) => { e.preventDefault(); importStatementFile(f.filename); };
                    actionsCell.appendChild(importBtn);
                }

                const downloadBtn = document.createElement('a');
                downloadBtn.href = `/downloads/${f.filename}`;
                downloadBtn.className = 'text-purple-600 hover:text-purple-800 text-sm ml-2';
                downloadBtn.textContent = 'Download';
                downloadBtn.target = '_blank';
                actionsCell.appendChild(downloadBtn);

                const deleteBtn = document.createElement('a');
                deleteBtn.href = '#';
                deleteBtn.className = 'text-red-600 hover:text-red-800 text-sm ml-2';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = (e) => { e.preventDefault(); deleteStatementFile(f.filename); };
                actionsCell.appendChild(deleteBtn);

                row.appendChild(actionsCell);
                listDiv.appendChild(row);
            });
        } else {
            listDiv.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No Statement files found</td></tr>';
        }
    } catch (error) {
        listDiv.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Error loading files: ${error.message}</td></tr>`;
    }
}

async function importStatementFile(filename) {
    if (!confirm(`Import file: ${filename}?`)) return;

    try {
        showToast('Importing...', 'info');
        const response = await fetch(`/api/stm/import/${encodeURIComponent(filename)}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            const records = result.claim_records || result.imported_records || 0;
            const fileType = result.file_type ? ` (${result.file_type})` : '';
            showToast(`Imported ${records} records${fileType}`, 'success');
            loadStatementFiles();
        } else {
            showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function deleteStatementFile(filename) {
    if (!confirm(`Delete file: ${filename}?`)) return;

    try {
        const response = await fetch(`/api/stm/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
        const result = await response.json();

        if (result.success) {
            showToast('File deleted', 'success');
            loadStatementFiles();
        } else {
            showToast('Delete failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function importAllStatementFiles() {
    if (!confirm('Import all pending Statement files?')) return;

    try {
        showToast('Importing all files...', 'info');
        const response = await fetch('/api/stm/import-all', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(`Imported ${result.success} files, ${result.skipped} skipped`, 'success');
            loadStatementFiles();
        } else {
            showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function clearAllStatementFiles() {
    if (!confirm('Delete ALL Statement files? This cannot be undone.')) return;

    try {
        const response = await fetch('/api/stm/clear', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            loadStatementFiles();
        } else {
            showToast('Clear failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== STM Schedule Functions ====================

function toggleStmSchedule() {
    const content = document.getElementById('stm-schedule-content');
    const arrow = document.getElementById('stm-schedule-arrow');
    content.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

function toggleStmScheduleEnabled() {
    const enabled = document.getElementById('stm-schedule-enabled').checked;
    // Just toggle the visual state, actual save happens on button click
}

async function loadStmScheduleSettings() {
    try {
        const response = await fetch('/api/stm/schedule');
        const result = await response.json();

        if (result.success) {
            // Set enabled toggle
            document.getElementById('stm-schedule-enabled').checked = result.stm_schedule_enabled;

            // Set schemes
            ['ucs', 'ofc', 'sss', 'lgo'].forEach(scheme => {
                const checkbox = document.getElementById('stm-scheme-' + scheme);
                if (checkbox) {
                    checkbox.checked = result.stm_schedule_schemes.includes(scheme);
                }
            });

            // Set auto import
            document.getElementById('stm-schedule-auto-import').checked = result.stm_schedule_auto_import;

            // Set times
            const timesContainer = document.getElementById('stm-schedule-times');
            timesContainer.innerHTML = '';
            if (result.stm_schedule_times && result.stm_schedule_times.length > 0) {
                result.stm_schedule_times.forEach(time => {
                    addStmScheduleTimeRow(time.hour, time.minute);
                });
            } else {
                addStmScheduleTimeRow(9, 0); // Default time
            }
        }
    } catch (error) {
        console.error('Error loading STM schedule settings:', error);
    }
}

function addStmScheduleTime() {
    addStmScheduleTimeRow(9, 0);
}

function addStmScheduleTimeRow(hour = 9, minute = 0) {
    const container = document.getElementById('stm-schedule-times');
    const row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    row.innerHTML = `
        <select class="stm-schedule-hour border rounded px-2 py-1 text-sm">
            ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === hour ? 'selected' : ''}>${String(i).padStart(2, '0')}</option>`).join('')}
        </select>
        <span>:</span>
        <select class="stm-schedule-minute border rounded px-2 py-1 text-sm">
            ${[0, 15, 30, 45].map(m => `<option value="${m}" ${m === minute ? 'selected' : ''}>${String(m).padStart(2, '0')}</option>`).join('')}
        </select>
        <span class="text-gray-500 text-sm">‡∏ô.</span>
        <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    container.appendChild(row);
}

async function saveStmSchedule() {
    try {
        const enabled = document.getElementById('stm-schedule-enabled').checked;
        const autoImport = document.getElementById('stm-schedule-auto-import').checked;

        // Get selected schemes
        const schemes = [];
        document.querySelectorAll('.stm-scheme-checkbox:checked').forEach(cb => {
            schemes.push(cb.value);
        });

        // Get times
        const times = [];
        document.querySelectorAll('#stm-schedule-times > div').forEach(row => {
            const hour = parseInt(row.querySelector('.stm-schedule-hour').value);
            const minute = parseInt(row.querySelector('.stm-schedule-minute').value);
            times.push({ hour, minute });
        });

        const response = await fetch('/api/stm/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stm_schedule_enabled: enabled,
                stm_schedule_times: times,
                stm_schedule_auto_import: autoImport,
                stm_schedule_schemes: schemes
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ STM ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function testStmSchedule() {
    if (!confirm('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ?')) return;

    try {
        showToast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info');
        const response = await fetch('/api/stm/schedule/test', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initFromUrl();
    populateYearDropdowns();
    initStatementYears();
    loadStatementFiles();
    loadScheduleSettings();
    loadStmScheduleSettings();
    loadSmtSettings();
    loadSmtStats();
    hoLoadStats();
    hoLoadData();

    // SMT settings form
    var smtForm = document.getElementById('smt-settings-form');
    if (smtForm) {
        smtForm.addEventListener('submit', saveSmtSettings);
    }

    // Bulk estimate listeners
    ['bulk-start-month', 'bulk-start-year', 'bulk-end-month', 'bulk-end-year'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', updateBulkEstimate);
    });

    // Scheme checkbox listeners for estimate update
    document.querySelectorAll('input[name="bulk-schemes"]').forEach(function(cb) {
        cb.addEventListener('change', updateBulkEstimate);
    });

    updateBulkEstimate();
});
</script>
{% endblock %}
