{% extends "base.html" %}

{% block title %}Data Management - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6 flex items-start justify-between">
    <div>
        <h2 class="text-3xl font-bold text-gray-800 mb-2">Data Management</h2>
        <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• E-Claim: Download, Import, ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p>
    </div>
    <div class="flex items-center gap-3">
        <!-- Sync Status Button -->
        <button onclick="syncSystemStatus()" id="btn-sync-status" class="flex items-center gap-2 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-sm font-medium transition-colors">
            <svg id="sync-icon" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            <span id="sync-btn-text">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö & Sync</span>
        </button>
    </div>
</div>

<!-- Sync Result Toast (Hidden by default) -->
<div id="sync-result-toast" class="hidden fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg border animate-slide-in">
    <div class="flex items-start gap-3">
        <div id="sync-toast-icon" class="flex-shrink-0 w-6 h-6"></div>
        <div class="flex-1">
            <p id="sync-toast-title" class="font-semibold text-sm"></p>
            <p id="sync-toast-message" class="text-sm mt-1"></p>
            <div id="sync-toast-details" class="mt-2 text-xs space-y-1"></div>
        </div>
        <button onclick="hideSyncToast()" class="flex-shrink-0 text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    </div>
</div>

<!-- Tab Navigation - Grouped -->
<div class="bg-white rounded-t-lg shadow-md border-b">
    <nav class="flex items-center" id="tab-nav">
        <!-- Download (Standalone) -->
        <button onclick="switchTab('download')" id="tab-download" class="tab-btn px-5 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600 flex items-center">
            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Download
        </button>

        <!-- Files Dropdown -->
        <div class="relative tab-dropdown" id="dropdown-files">
            <button onclick="toggleTabDropdown('files')" class="tab-group-btn px-5 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                Files
                <svg class="w-4 h-4 ml-1 dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div class="dropdown-menu hidden absolute left-0 top-full mt-0 w-48 bg-white rounded-b-lg shadow-lg border border-t-0 z-50">
                <button onclick="switchTab('rep'); closeAllDropdowns();" id="tab-rep" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-blue-500 mr-3"></span>
                    REP Files
                </button>
                <button onclick="switchTab('statement'); closeAllDropdowns();" id="tab-statement" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-green-500 mr-3"></span>
                    Statement
                </button>
                <button onclick="switchTab('smt'); closeAllDropdowns();" id="tab-smt" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-purple-500 mr-3"></span>
                    Smart Money Transfer
                </button>
            </div>
        </div>

        <!-- Admin Dropdown -->
        <div class="relative tab-dropdown" id="dropdown-admin">
            <button onclick="toggleTabDropdown('admin')" class="tab-group-btn px-5 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                Admin
                <svg class="w-4 h-4 ml-1 dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div class="dropdown-menu hidden absolute left-0 top-full mt-0 w-48 bg-white rounded-b-lg shadow-lg border border-t-0 z-50">
                <button onclick="switchTab('settings'); closeAllDropdowns();" id="tab-settings" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-gray-500 mr-3"></span>
                    Settings
                </button>
                <button onclick="switchTab('offices'); closeAllDropdowns();" id="tab-offices" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-teal-500 mr-3"></span>
                    Health Offices
                </button>
            </div>
        </div>

        <!-- Monitor Dropdown -->
        <div class="relative tab-dropdown" id="dropdown-monitor">
            <button onclick="toggleTabDropdown('monitor')" class="tab-group-btn px-5 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Monitor
                <svg class="w-4 h-4 ml-1 dropdown-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div class="dropdown-menu hidden absolute left-0 top-full mt-0 w-48 bg-white rounded-b-lg shadow-lg border border-t-0 z-50">
                <button onclick="switchTab('jobs'); closeAllDropdowns();" id="tab-jobs" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-amber-500 mr-3"></span>
                    Job History
                </button>
                <button onclick="switchTab('health'); closeAllDropdowns();" id="tab-health" class="tab-btn w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 flex items-center">
                    <span class="w-2 h-2 rounded-full bg-emerald-500 mr-3"></span>
                    System Health
                </button>
            </div>
        </div>

        <!-- Current Tab Indicator (shows which sub-tab is active) -->
        <div id="current-tab-indicator" class="ml-auto px-4 py-2 text-xs text-gray-400 hidden">
            <span id="current-tab-label"></span>
        </div>
    </nav>
</div>

<!-- Tab Content Container -->
<div class="bg-white rounded-b-lg shadow-md">

    <!-- ==================== DOWNLOAD TAB ==================== -->
    <div id="content-download" class="tab-content p-6">
        <!-- Update Status Overview -->
        <div class="mb-6">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-sm font-semibold text-gray-700 flex items-center">
                    <svg class="w-4 h-4 mr-1.5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </h3>
                <button onclick="loadUpdateStatus()" class="text-xs text-blue-600 hover:text-blue-800 flex items-center">
                    <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                </button>
            </div>
            <div id="update-status-grid" class="grid grid-cols-1 md:grid-cols-3 gap-3">
                <!-- REP Status Card -->
                <div id="status-card-rep" class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">üìÑ REP Files</span>
                        <span id="status-badge-rep" class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div class="flex justify-between">
                            <span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                            <span id="status-last-update-rep" class="font-medium text-gray-700">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå:</span>
                            <span id="status-file-count-rep" class="font-medium text-gray-700">-</span>
                        </div>
                        <div id="status-schemes-rep" class="mt-1 pt-1 border-t border-gray-200 hidden">
                            <div class="text-xs text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥:</div>
                            <div id="status-schemes-list-rep" class="flex flex-wrap gap-1"></div>
                        </div>
                    </div>
                </div>
                <!-- Statement Status Card -->
                <div id="status-card-stm" class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">üìä Statement</span>
                        <span id="status-badge-stm" class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div class="flex justify-between">
                            <span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                            <span id="status-last-update-stm" class="font-medium text-gray-700">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå:</span>
                            <span id="status-file-count-stm" class="font-medium text-gray-700">-</span>
                        </div>
                        <div id="status-schemes-stm" class="mt-1 pt-1 border-t border-gray-200 hidden">
                            <div class="text-xs text-gray-400 mb-1">‡∏£‡∏≤‡∏¢‡∏™‡∏¥‡∏ó‡∏ò‡∏¥:</div>
                            <div id="status-schemes-list-stm" class="flex flex-wrap gap-1"></div>
                        </div>
                    </div>
                </div>
                <!-- SMT Status Card -->
                <div id="status-card-smt" class="bg-gray-50 border border-gray-200 rounded-lg p-3">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-sm font-medium text-gray-700">üí∞ SMT Budget</span>
                        <span id="status-badge-smt" class="px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                    </div>
                    <div class="text-xs text-gray-500 space-y-1">
                        <div class="flex justify-between">
                            <span>‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î:</span>
                            <span id="status-last-update-smt" class="font-medium text-gray-700">-</span>
                        </div>
                        <div class="flex justify-between">
                            <span>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÑ‡∏ü‡∏•‡πå:</span>
                            <span id="status-file-count-smt" class="font-medium text-gray-700">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Data Type Selector -->
        <div class="mb-6">
            <div class="flex gap-2 p-1 bg-gray-100 rounded-lg inline-flex">
                <button onclick="switchDownloadType('rep')" id="dl-type-rep" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm bg-blue-600 text-white">
                    üìÑ REP Files
                </button>
                <button onclick="switchDownloadType('statement')" id="dl-type-statement" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                    üìä Statement
                </button>
                <button onclick="switchDownloadType('smt')" id="dl-type-smt" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                    üí∞ SMT Budget
                </button>
            </div>
        </div>

        <!-- Data Source Info -->
        <div id="dl-source-info" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm text-blue-800">
                    <span id="dl-source-label" class="font-medium">REP (Request for Electronic Payment)</span> -
                    <a id="dl-source-link" href="https://eclaim.nhso.go.th/webComponent/" target="_blank" class="underline hover:text-blue-600">eclaim.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- Download Form -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 id="dl-form-title" class="text-lg font-semibold mb-2 flex items-center text-blue-700">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP
            </h3>

            <!-- REP Download Hint -->
            <div id="dl-rep-hint" class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-lg text-sm text-amber-800">
                <p class="flex items-start">
                    <svg class="w-5 h-5 mr-2 mt-0.5 flex-shrink-0 text-amber-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    <span>
                        <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ‡∏£‡∏∞‡∏ö‡∏ö E-Claim ‡∏Ç‡∏≠‡∏á ‡∏™‡∏õ‡∏™‡∏ä. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                        ‡∏Ñ‡∏ß‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡∏¥‡∏î <strong>Auto Schedule</strong>
                        ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö download ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô
                    </span>
                </p>
            </div>

            <div class="space-y-4">
                <!-- Basic Options: Year/Month (REP/Statement only) -->
                <div id="dl-year-month-section" class="grid grid-cols-2 gap-4">
                    <div>
                        <label id="dl-year-label" class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ (‡∏û.‡∏®.)</label>
                        <select id="bulk-start-year" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="bulk-start-month" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="" id="opt-all-months">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>
                </div>

                <!-- Statement: Patient Type (hidden by default) -->
                <div id="dl-patient-type-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                    <select id="dl-patient-type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="op">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)</option>
                        <option value="ip">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IP)</option>
                    </select>
                </div>

                <!-- Statement: UCS only (no scheme selection needed) -->
                <div id="dl-statement-scheme-section" class="hidden">
                    <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm text-purple-800">
                            <strong>UC Statement</strong> - ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î UCS (‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                        </p>
                    </div>
                </div>

                <!-- Statement: Auto-import checkbox -->
                <div id="dl-statement-auto-import-section" class="hidden">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="dl-stm-auto-import" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                        <span class="text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span>
                    </label>
                </div>

                <!-- SMT: Full Options (hidden by default) -->
                <div id="dl-vendor-section" class="hidden space-y-4">
                    <!-- Vendor ID + Fiscal Year (same row) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vendor ID (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)</label>
                            <input type="text" id="dl-vendor-id" placeholder="‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ç‡∏ï</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                            <select id="dl-smt-fiscal-year" onchange="onSmtDownloadFiscalYearChange()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
                                <input type="date" id="dl-smt-start-date" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                                <input type="date" id="dl-smt-end-date" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">‡∏õ‡∏µ‡∏á‡∏ö: 1 ‡∏ï.‡∏Ñ. ‡∏ñ‡∏∂‡∏á 30 ‡∏Å.‡∏¢. (‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô = ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</p>
                    </div>

                    <!-- Scheme (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
                        <select id="dl-smt-scheme" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="UC">UC (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</option>
                            <option value="OF">OF (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</option>
                            <option value="SS">SS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                            <option value="LG">LG (‡∏≠‡∏õ‡∏ó.)</option>
                        </select>
                    </div>

                    <!-- Type (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="dl-smt-type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="OP">OP (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å)</option>
                            <option value="IP">IP (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô)</option>
                            <option value="PP">PP (‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô)</option>
                        </select>
                    </div>

                    <!-- SMT Auto Import -->
                    <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="dl-smt-auto-import" class="w-4 h-4 text-green-600 rounded mr-3" checked>
                            <div>
                                <span class="text-sm font-medium text-green-800">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                <p class="text-xs text-green-600 mt-0.5">Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Database ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Advanced Settings (Collapsible) -->
                <details id="dl-advanced-settings" class="border border-gray-200 rounded-lg">
                    <summary class="px-4 py-3 cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-t-lg font-medium text-gray-700 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                    </summary>
                    <div class="p-4 space-y-4 border-t">
                        <!-- Hidden date range inputs (not needed since "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" downloads full fiscal year) -->
                        <input type="hidden" id="bulk-end-month" value="">
                        <input type="hidden" id="bulk-end-year" value="">

                        <!-- Insurance Schemes (REP only) -->
                        <div id="dl-schemes-section">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                            <div class="grid grid-cols-4 gap-2 text-sm">
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="ucs" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="ofc" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="sss" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="lgo" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">LGO (‡∏≠‡∏õ‡∏ó.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="nhs" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">NHS (‡∏™‡∏õ‡∏™‡∏ä.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="bkk" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">BKK (‡∏Å‡∏ó‡∏°.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="bmt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">BMT (‡∏Ç‡∏™‡∏°‡∏Å.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="srt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">SRT (‡∏£‡∏ü‡∏ó.)</span>
                                </label>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button type="button" onclick="selectAllSchemes('bulk')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button type="button" onclick="selectDefaultSchemes('bulk')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å)</button>
                            </div>
                        </div>

                        <!-- Auto Import (REP only - Statement has its own checkbox) -->
                        <div id="dl-bulk-auto-import-section" class="border-t pt-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="bulk-auto-import" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="ml-2 text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto-import)</span>
                            </label>
                        </div>

                        <!-- Parallel Download (REP only) -->
                        <div id="dl-parallel-section" class="border-t pt-4">
                            <label class="flex items-center cursor-pointer mb-3">
                                <input type="checkbox" id="parallel-download" class="w-4 h-4 text-purple-600 rounded">
                                <span class="ml-2 text-sm text-gray-700">
                                    <span class="font-medium text-purple-700">Parallel Download</span>
                                    <span class="text-gray-500">(‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ~3x)</span>
                                </span>
                            </label>
                            <div id="parallel-workers-section" class="hidden ml-6 space-y-2">
                                <div class="flex items-center gap-3">
                                    <label class="text-xs text-gray-600">Workers:</label>
                                    <select id="parallel-workers" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                        <option value="2">2 (Safe)</option>
                                        <option value="3" selected>3 (Recommended)</option>
                                        <option value="4">4 (Fast)</option>
                                        <option value="5">5 (Aggressive)</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-500">
                                    ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≤‡∏¢ sessions ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô (‡∏õ‡∏•‡∏≠‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢ browser)
                                </p>
                            </div>
                        </div>

                        <!-- Clear Download History -->
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏•‡πâ‡∏≤‡∏á Download History</label>
                            <p class="text-xs text-gray-500 mb-3">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)</p>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="clearDownloadHistory('rep')" class="px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á REP History
                                </button>
                                <button type="button" onclick="clearDownloadHistory('stm')" class="px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á Statement History
                                </button>
                                <button type="button" onclick="clearDownloadHistory('smt')" class="px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á SMT History
                                </button>
                                <button type="button" onclick="clearDownloadHistory('all')" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                        </div>

                        <!-- Failed Downloads (Retry) -->
                        <div class="border-t pt-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700">Failed Downloads</label>
                                <button type="button" onclick="loadFailedDownloads()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ reset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</p>

                            <!-- Failed downloads count -->
                            <div id="failed-downloads-summary" class="mb-3 p-3 bg-gray-100 rounded-lg text-sm">
                                <span class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                            </div>

                            <!-- Failed downloads list (hidden by default) -->
                            <div id="failed-downloads-list" class="hidden mb-3 max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                                <!-- Populated by JavaScript -->
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="resetFailedDownloads('rep')" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-sm">
                                    Reset REP Failed
                                </button>
                                <button type="button" onclick="resetFailedDownloads('stm')" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-sm">
                                    Reset STM Failed
                                </button>
                                <button type="button" onclick="resetFailedDownloads()" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-sm">
                                    Reset All Failed
                                </button>
                                <button type="button" onclick="deleteFailedDownloads()" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">
                                    ‡∏•‡∏ö Failed ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Estimate (REP only) -->
                <div id="dl-estimate-section" class="bg-gray-50 rounded-lg p-3">
                    <p id="bulk-estimate" class="text-sm text-gray-600"></p>
                </div>

                <!-- Download Button -->
                <button id="download-btn" onclick="downloadByType()" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white py-3 px-4 rounded-md font-medium transition-colors text-lg">
                    <svg id="download-icon" class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span id="download-btn-text">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </button>
            </div>
        </div>

        <!-- Bulk Progress -->
        <div id="bulk-progress" class="hidden mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-blue-900">Downloading...</h3>
                <button id="cancel-download-btn" onclick="cancelBulkDownload()" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-md transition-colors flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                    ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                </button>
            </div>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-blue-900 mb-2">
                    <span>Current: <span id="current-month" class="font-semibold"></span></span>
                    <span id="progress-count" class="font-semibold">0 / 0 months</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <span id="progress-percentage" class="text-lg font-bold text-blue-900">0%</span>
        </div>

        <!-- Scheduler Section (Collapsible) - REDESIGNED UI -->
        <details class="mt-6 border border-gray-200 rounded-lg shadow-sm" open>
            <summary class="p-4 cursor-pointer hover:bg-gray-50 rounded-lg flex items-center justify-between list-none">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-lg font-semibold text-gray-800">Auto Schedule</span>
                    <span id="schedule-summary" class="ml-3 text-sm text-gray-500"></span>
                </div>
                <div class="flex items-center gap-3">
                    <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                        <input type="checkbox" id="schedule-enabled" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                    <svg class="w-5 h-5 text-gray-400 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </summary>
            <div class="p-5 pt-3 border-t border-gray-100 bg-gray-50/50">

                <!-- ===== STEP 1: Schedule Times ===== -->
                <div class="mb-5">
                    <div class="flex items-center mb-3">
                        <span class="w-7 h-7 rounded-full bg-purple-600 text-white text-sm font-bold flex items-center justify-center mr-2">1</span>
                        <span class="font-semibold text-gray-800">‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div id="schedule-times-container" class="flex flex-wrap gap-2 min-h-[40px] items-center">
                            <p class="text-sm text-gray-400" id="no-schedules-message">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>
                        <button onclick="addScheduleTime()" class="mt-3 inline-flex items-center text-purple-600 hover:text-purple-800 text-sm font-medium transition-colors">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                        </button>
                    </div>
                </div>

                <!-- ===== STEP 2: Data Types Selection (Card Based) ===== -->
                <div class="mb-5">
                    <div class="flex items-center mb-3">
                        <span class="w-7 h-7 rounded-full bg-purple-600 text-white text-sm font-bold flex items-center justify-center mr-2">2</span>
                        <span class="font-semibold text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span class="ml-2 text-xs text-gray-500">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</span>
                    </div>

                    <!-- REP Files Card -->
                    <div class="bg-white rounded-lg border border-gray-200 mb-3 overflow-hidden transition-all" id="card-type-rep">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleScheduleTypeCard('rep')">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">üìÑ</span>
                                <div>
                                    <span class="font-medium text-gray-800">REP Files</span>
                                    <span class="text-xs text-gray-500 ml-2">‡πÉ‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</span>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                                <input type="checkbox" id="schedule-type-rep" class="sr-only peer" checked onchange="updateScheduleCardState('rep')">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div id="rep-settings" class="px-4 pb-4 border-t border-gray-100 bg-blue-50/30">
                            <p class="text-xs text-gray-600 py-2 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î:</p>
                            <div class="grid grid-cols-4 gap-2 text-sm">
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="ucs" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">UCS</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="ofc" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">OFC</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="sss" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">SSS</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="lgo" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">LGO</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="nhs" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">NHS</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="bkk" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">BKK</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="bmt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">BMT</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="srt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">SRT</span>
                                </label>
                            </div>
                            <div class="mt-2 flex gap-2">
                                <button type="button" onclick="selectAllScheduleSchemes()" class="text-xs text-blue-600 hover:text-blue-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <span class="text-gray-300">|</span>
                                <button type="button" onclick="selectMainScheduleSchemes()" class="text-xs text-blue-600 hover:text-blue-800">4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å</button>
                                <span class="text-gray-300">|</span>
                                <button type="button" onclick="deselectAllScheduleSchemes()" class="text-xs text-gray-500 hover:text-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>
                    </div>

                    <!-- UC Statement Card -->
                    <div class="bg-white rounded-lg border border-gray-200 mb-3 overflow-hidden transition-all opacity-60" id="card-type-stm">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleScheduleTypeCard('stm')">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">üìä</span>
                                <div>
                                    <span class="font-medium text-gray-800">UC Statement</span>
                                    <span class="text-xs text-purple-600 ml-2 bg-purple-100 px-2 py-0.5 rounded">UCS ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                                <input type="checkbox" id="schedule-type-stm" class="sr-only peer" onchange="updateScheduleCardState('stm')">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <div id="stm-settings" class="px-4 pb-3 border-t border-gray-100 bg-purple-50/30 hidden">
                            <p class="text-xs text-purple-700 py-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î UCS (‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤)</p>
                        </div>
                    </div>

                    <!-- SMT Budget Card -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden transition-all opacity-60" id="card-type-smt">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleScheduleTypeCard('smt')">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">üí∞</span>
                                <div>
                                    <span class="font-medium text-gray-800">SMT Budget</span>
                                    <span class="text-xs text-gray-500 ml-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                                <input type="checkbox" id="schedule-type-smt" class="sr-only peer" onchange="updateScheduleCardState('smt')">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                        <div id="smt-settings" class="px-4 pb-3 border-t border-gray-100 bg-green-50/30 hidden">
                            <label class="block text-xs text-gray-600 py-2 mb-1">Vendor ID:</label>
                            <input type="text" id="schedule-smt-vendor-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670"
                                   class="w-full max-w-xs border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <p class="text-xs text-gray-500 mt-1">‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Settings ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</p>
                        </div>
                    </div>
                </div>

                <!-- ===== STEP 3: Options ===== -->
                <div class="mb-5">
                    <div class="flex items-center mb-3">
                        <span class="w-7 h-7 rounded-full bg-purple-600 text-white text-sm font-bold flex items-center justify-center mr-2">3</span>
                        <span class="font-semibold text-gray-800">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4 space-y-4">
                        <!-- Auto Import -->
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="schedule-auto-import" class="w-5 h-5 text-purple-600 rounded border-gray-300">
                            <span class="ml-3 text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                        </label>

                        <!-- Parallel Download (REP only) -->
                        <div class="border-t pt-4">
                            <label class="flex items-center cursor-pointer mb-3">
                                <input type="checkbox" id="schedule-parallel-download" class="w-5 h-5 text-purple-600 rounded border-gray-300" onchange="toggleScheduleParallelWorkers()">
                                <span class="ml-3 text-sm text-gray-700">
                                    <span class="font-medium text-purple-700">Parallel Download</span>
                                    <span class="text-gray-500">(‡πÄ‡∏£‡πá‡∏ß‡∏Ç‡∏∂‡πâ‡∏ô ~3x ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö REP)</span>
                                </span>
                            </label>
                            <div id="schedule-parallel-workers-section" class="hidden ml-8 space-y-2">
                                <div class="flex items-center gap-3">
                                    <label class="text-sm text-gray-600">Workers:</label>
                                    <select id="schedule-parallel-workers" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                                        <option value="2">2 (Safe)</option>
                                        <option value="3" selected>3 (Recommended)</option>
                                        <option value="4">4 (Fast)</option>
                                        <option value="5">5 (Aggressive)</option>
                                    </select>
                                </div>
                                <p class="text-xs text-gray-500">
                                    ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏≤‡∏¢ sessions ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Å‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î REP files (‡∏õ‡∏•‡∏≠‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏≤‡∏¢ browser)
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ===== Save Button ===== -->
                <button onclick="saveScheduleSettings()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-medium text-sm transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>

                <!-- ===== Status Summary ===== -->
                <div id="schedule-status-box" class="mt-4 p-4 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                        <span id="schedule-status" class="text-sm">Loading...</span>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- ==================== REP FILES TAB ==================== -->
    <div id="content-rep" class="tab-content p-6 hidden">
        <!-- REP Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                REP Files (Request for Electronic Payment)
            </h2>
            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>REP</strong> (Request for Electronic Payment) ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå
                    ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏¢‡∏±‡∏á <strong>‡∏™‡∏õ‡∏™‡∏ä.</strong> (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥)
                    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                </p>
                <p class="text-xs text-blue-600 mt-1">
                    Data Source: <a href="https://eclaim.nhso.go.th/webComponent/" target="_blank" class="underline hover:text-blue-800">eclaim.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- REP Sub-tabs -->
        <div class="flex space-x-2 mb-6">
            <button onclick="switchRepSubtab('files')" id="rep-subtab-btn-files" class="rep-subtab-btn px-4 py-2 rounded-md font-medium text-sm bg-blue-600 text-white">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button onclick="switchRepSubtab('database')" id="rep-subtab-btn-database" class="rep-subtab-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- ===== REP Files Sub-tab ===== -->
        <div id="rep-subtab-files">
        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-blue-700">{{ stats.total_files }}</p>
                <p class="text-sm text-blue-600">Total Files</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-green-700">{{ stats.imported_count }}</p>
                <p class="text-sm text-green-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-yellow-700">{{ stats.not_imported_count }}</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-gray-700">{{ stats.total_size }}</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- File Type Summary (Collapsible) -->
        <details class="mb-4 border border-gray-200 rounded-lg" id="file-type-details">
            <summary class="p-4 cursor-pointer hover:bg-gray-50 rounded-lg flex items-center justify-between list-none">
                <div class="flex items-center gap-2">
                    <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                    </svg>
                    <span class="font-semibold text-gray-800">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÑ‡∏ü‡∏•‡πå</span>
                    <span id="file-type-count-badge" class="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full">Loading...</span>
                </div>
                <svg class="w-5 h-5 text-gray-400 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </summary>
            <div class="p-4 pt-2 border-t border-gray-100">
                <div id="file-type-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                    <!-- Loading placeholder -->
                    <div class="animate-pulse bg-gray-100 rounded-lg p-3 h-20"></div>
                    <div class="animate-pulse bg-gray-100 rounded-lg p-3 h-20"></div>
                    <div class="animate-pulse bg-gray-100 rounded-lg p-3 h-20"></div>
                    <div class="animate-pulse bg-gray-100 rounded-lg p-3 h-20"></div>
                </div>
            </div>
        </details>

        <!-- Filter Section -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex flex-wrap items-end gap-4">
                <!-- Fiscal Year Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                    <select id="rep-filter-fiscal-year" onchange="onFiscalYearChange('rep')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm min-w-[100px]">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <!-- Will be populated by JS -->
                    </select>
                </div>

                <!-- Month Range Filter -->
                <div class="flex items-end gap-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å)</label>
                        <select id="rep-filter-start-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                    <span class="text-gray-400 pb-1.5">-</span>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <select id="rep-filter-end-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                </div>

                <!-- Scheme Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</label>
                    <select id="rep-filter-scheme" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</option>
                        <option value="ucs">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</option>
                        <option value="lgo">LGO (‡∏≠‡∏õ‡∏ó.)</option>
                        <option value="sss">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                        <option value="ofc">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</option>
                    </select>
                </div>

                <!-- File Type Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                    <select id="rep-filter-file-type" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="op">OP (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å)</option>
                        <option value="ip">IP (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô)</option>
                        <option value="orf">ORF (‡∏™‡πà‡∏á‡∏ï‡πà‡∏≠)</option>
                        <option value="appeal">Appeal (‡∏≠‡∏∏‡∏ó‡∏ò‡∏£‡∏ì‡πå)</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <div class="flex gap-1">
                        <button onclick="setRepStatusFilter('all')" id="rep-filter-status-all" class="rep-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="setRepStatusFilter('imported')" id="rep-filter-status-imported" class="rep-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button onclick="setRepStatusFilter('pending')" id="rep-filter-status-pending" class="rep-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <button onclick="applyRepFilter()" class="bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-4 rounded-md font-medium text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>

                <!-- Reset Button -->
                <button onclick="resetRepFilter()" class="text-gray-600 hover:text-gray-800 py-1.5 px-2 text-sm">
                    ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á {{ files|length }} ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                {% if stats.not_imported_count > 0 %}
                <button onclick="importAllFiles()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ stats.not_imported_count }})
                </button>
                {% endif %}
                {% if stats.total_files > 0 %}
                <button onclick="clearAllRepFiles()" class="bg-orange-500 hover:bg-orange-600 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå ({{ stats.total_files }})
                </button>
                <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Filename</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="files-table-body">
                    {% for file in files %}
                    <tr class="hover:bg-gray-50 file-row" data-status="{% if file.imported %}imported{% else %}pending{% endif %}">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                {% if '_OP_' in file.filename %}
                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                {% elif '_IP_' in file.filename %}
                                <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                                {% elif '_ORF_' in file.filename %}
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                {% else %}
                                <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                                {% endif %}
                                <span class="text-sm font-medium text-gray-900">{{ file.filename }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ file.date_formatted }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ file.size_formatted }}</td>
                        <td class="px-4 py-3">
                            {% if file.imported %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Imported ({{ file.import_status.imported_records }})
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            {% if not file.imported %}
                            <button onclick="importFile('{{ file.filename }}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium mr-2">Import</button>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=file.filename) }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium mr-2">Download</a>
                            <button onclick="deleteFile('{{ file.filename }}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            No files found. Click Download tab to start downloading.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="mt-4 flex items-center justify-between">
            <p class="text-sm text-gray-600">Page {{ page }} of {{ total_pages }}</p>
            <div class="flex gap-2">
                {% if page > 1 %}
                <a href="?tab=files&page={{ page - 1 }}&month={{ filter_month }}&year={{ filter_year }}" class="px-3 py-1 border rounded text-sm">Previous</a>
                {% endif %}
                {% if page < total_pages %}
                <a href="?tab=files&page={{ page + 1 }}&month={{ filter_month }}&year={{ filter_year }}" class="px-3 py-1 border rounded text-sm">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        </div>
        <!-- End REP Files Sub-tab -->

        <!-- ===== REP Database Sub-tab ===== -->
        <div id="rep-subtab-database" class="hidden">
            <!-- Help/Info Section -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm">
                        <p class="font-semibold text-blue-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Reconciliation (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î REP ‡∏Å‡∏±‡∏ö Statement)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-700">
                            <div>
                                <p class="font-medium mb-1">Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</p>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î REP ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab Statement)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ <strong>tran_id</strong> ‡πÄ‡∏õ‡πá‡∏ô key</li>
                                </ol>
                            </div>
                            <div>
                                <p class="font-medium mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</p>
                                <ul class="space-y-1 text-xs">
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">Matched</span> - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (tran_id ‡∏ï‡∏£‡∏á, ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á)</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs">Diff</span> - ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">REP Only</span> - ‡∏°‡∏µ‡πÉ‡∏ô REP ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô Statement (‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Statement)</li>
                                </ul>
                                <p class="mt-2 text-xs text-blue-600">
                                    <strong>Note:</strong> ‡∏´‡∏≤‡∏Å Statement ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "REP Only" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-total" class="text-2xl font-bold text-blue-700">0</p>
                    <p class="text-sm text-blue-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-matched" class="text-2xl font-bold text-green-700">0</p>
                    <p class="text-sm text-green-600">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Statement</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-diff" class="text-2xl font-bold text-yellow-700">0</p>
                    <p class="text-sm text-yellow-600">‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-unmatched" class="text-2xl font-bold text-red-700">0</p>
                    <p class="text-sm text-red-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô Statement</p>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-end gap-4">
                    <!-- View Mode -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                        <select id="rep-db-view-mode" onchange="loadRepDbRecords(1)" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="rep">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° REP No</option>
                            <option value="tran">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transaction</option>
                        </select>
                    </div>

                    <!-- Fiscal Year -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="rep-db-fiscal-year" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-28">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>

                    <!-- REP No Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">REP No</label>
                        <input type="text" id="rep-db-rep-no" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ REP" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="rep-db-status" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="matched">Matched</option>
                            <option value="diff_amount">Amount Diff</option>
                            <option value="rep_only">REP Only</option>
                        </select>
                    </div>

                    <!-- Search Button -->
                    <button onclick="loadRepDbRecords(1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <!-- Clear -->
                    <button onclick="clearRepDbFilter()" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 text-sm">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>

                    <!-- Actions -->
                    <div class="ml-auto flex gap-2">
                        <button onclick="refreshRepDbRecords()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button onclick="clearRepDatabase()" class="bg-red-100 hover:bg-red-200 text-red-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="flex items-center justify-between mb-2">
                <div id="rep-db-result-count" class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <!-- Database Table -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="rep-db-table-header">
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">REP No</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î REP</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î STM</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rep-db-records-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å Refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="rep-db-pagination" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    Page <span id="rep-db-current-page">1</span> of <span id="rep-db-total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadRepDbRecords(currentRepDbPage - 1)" id="rep-db-prev-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                    <button onclick="loadRepDbRecords(currentRepDbPage + 1)" id="rep-db-next-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
        <!-- End REP Database Sub-tab -->
    </div>

    <!-- ==================== STATEMENT TAB ==================== -->
    <div id="content-statement" class="tab-content p-6 hidden">
        <!-- Statement Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                UC Statement Files
            </h2>
            <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                <p class="text-sm text-purple-800">
                    <strong>Statement</strong> ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.
                    ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IP) ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)
                </p>
                <p class="text-xs text-purple-600 mt-1">
                    Data Source: <a href="https://eclaim.nhso.go.th/webComponent/ucs/statementUCSAction.do" target="_blank" class="underline hover:text-purple-800">eclaim.nhso.go.th (Statement NHSO)</a>
                </p>
            </div>
        </div>

        <!-- Statement Sub-tabs -->
        <div class="flex space-x-2 mb-6">
            <button onclick="switchStatementSubtab('files')" id="stm-subtab-btn-files" class="stm-subtab-btn px-4 py-2 rounded-md font-medium text-sm bg-purple-600 text-white">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button onclick="switchStatementSubtab('database')" id="stm-subtab-btn-database" class="stm-subtab-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- ===== Statement Files Sub-tab ===== -->
        <div id="stm-subtab-files">
        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-purple-50 rounded-lg p-4 text-center">
                <p id="stm-stat-total" class="text-2xl font-bold text-purple-700">0</p>
                <p class="text-sm text-purple-600">Total Files</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="stm-stat-imported" class="text-2xl font-bold text-green-700">0</p>
                <p class="text-sm text-green-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p id="stm-stat-pending" class="text-2xl font-bold text-yellow-700">0</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="stm-stat-size" class="text-2xl font-bold text-gray-700">0 B</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex flex-wrap items-end gap-4">
                <!-- Fiscal Year Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                    <select id="stm-filter-fiscal-year" onchange="onFiscalYearChange('stm')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm min-w-[100px]">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <!-- Will be populated by JS -->
                    </select>
                </div>

                <!-- Month Range Filter -->
                <div class="flex items-end gap-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å)</label>
                        <select id="stm-filter-start-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                    <span class="text-gray-400 pb-1.5">-</span>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <select id="stm-filter-end-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <div class="flex gap-1">
                        <button onclick="setStmStatusFilter('all')" id="stm-filter-status-all" class="stm-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-purple-600 text-white">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="setStmStatusFilter('imported')" id="stm-filter-status-imported" class="stm-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button onclick="setStmStatusFilter('pending')" id="stm-filter-status-pending" class="stm-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <button onclick="applyStmFilter()" class="bg-purple-600 hover:bg-purple-700 text-white py-1.5 px-4 rounded-md font-medium text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>

                <!-- Reset Button -->
                <button onclick="resetStmFilter()" class="text-gray-600 hover:text-gray-800 py-1.5 px-2 text-sm">
                    ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div id="stm-file-count" class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                <button id="stm-import-all-btn" onclick="importAllStatementFiles()" class="hidden bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="stm-pending-count">0</span>)
                </button>
                <button id="stm-clear-btn" onclick="clearAllStatementFiles()" class="hidden bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- Statement Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FILENAME</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SIZE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="stm-file-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>
        <!-- End Statement Files Sub-tab -->

        <!-- ===== Statement Database Sub-tab ===== -->
        <div id="stm-subtab-database" class="hidden">
            <!-- Help/Info Section -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm">
                        <p class="font-semibold text-blue-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Reconciliation (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î Statement ‡∏Å‡∏±‡∏ö REP)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-700">
                            <div>
                                <p class="font-medium mb-1">Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</p>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î REP ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab REP Files)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ <strong>tran_id</strong> ‡πÄ‡∏õ‡πá‡∏ô key</li>
                                </ol>
                            </div>
                            <div>
                                <p class="font-medium mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</p>
                                <ul class="space-y-1 text-xs">
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">Matched</span> - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (tran_id ‡∏ï‡∏£‡∏á, ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á)</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs">Diff</span> - ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">STM Only</span> - ‡∏°‡∏µ‡πÉ‡∏ô Statement ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô REP (‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ REP)</li>
                                </ul>
                                <p class="mt-2 text-xs text-blue-600">
                                    <strong>Note:</strong> ‡∏´‡∏≤‡∏Å REP ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "STM Only" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-total" class="text-2xl font-bold text-purple-700">0</p>
                    <p class="text-sm text-purple-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-matched" class="text-2xl font-bold text-green-700">0</p>
                    <p class="text-sm text-green-600">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö REP</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-diff" class="text-2xl font-bold text-yellow-700">0</p>
                    <p class="text-sm text-yellow-600">‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-unmatched" class="text-2xl font-bold text-red-700">0</p>
                    <p class="text-sm text-red-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô REP</p>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-end gap-4">
                    <!-- View Mode -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                        <select id="stm-db-view-mode" onchange="loadStmDbRecords(1)" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="rep">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° REP No</option>
                            <option value="tran">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transaction</option>
                        </select>
                    </div>

                    <!-- Fiscal Year -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="stm-db-fiscal-year" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-28">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>

                    <!-- REP No Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">REP No</label>
                        <input type="text" id="stm-db-rep-no" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ REP" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="stm-db-status" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="matched">Matched</option>
                            <option value="diff_amount">Amount Diff</option>
                            <option value="stm_only">STM Only</option>
                        </select>
                    </div>

                    <!-- Search Button -->
                    <button onclick="loadStmDbRecords(1)" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1.5 rounded text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <!-- Clear -->
                    <button onclick="clearStmDbFilter()" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 text-sm">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>

                    <!-- Actions -->
                    <div class="ml-auto flex gap-2">
                        <button onclick="refreshStmDbRecords()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button onclick="clearStmDatabase()" class="bg-red-100 hover:bg-red-200 text-red-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="flex items-center justify-between mb-2">
                <div id="stm-db-result-count" class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <!-- Database Table -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="stm-db-table-header">
                            <!-- Headers will be set by JS based on view mode -->
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">REP No</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î STM</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î REP</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stm-db-records-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å Refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="stm-db-pagination" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    Page <span id="stm-db-current-page">1</span> of <span id="stm-db-total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadStmDbRecords(currentStmDbPage - 1)" id="stm-db-prev-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                    <button onclick="loadStmDbRecords(currentStmDbPage + 1)" id="stm-db-next-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
        <!-- End Statement Database Sub-tab -->
    </div>

    <!-- ==================== SMT TAB ==================== -->
    <div id="content-smt" class="tab-content p-6 hidden">
        <!-- SMT Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Smart Money Transfer Files (SMT Budget)
            </h2>
            <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800">
                    <strong>SMT</strong> (Smart Money Transfer) ‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏Å‡∏±‡∏ö E-Claim
                </p>
                <p class="text-xs text-green-600 mt-1">
                    Data Source: <a href="https://smt.nhso.go.th" target="_blank" class="underline hover:text-green-800">smt.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- SMT Sub-tabs -->
        <div class="flex space-x-2 mb-6">
            <button onclick="switchSmtSubtab('files')" id="smt-subtab-btn-files" class="smt-subtab-btn px-4 py-2 rounded-md font-medium text-sm bg-green-600 text-white">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button onclick="switchSmtSubtab('database')" id="smt-subtab-btn-database" class="smt-subtab-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- ===== SMT Files Sub-tab ===== -->
        <div id="smt-subtab-files">
            <!-- File Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="smt-stat-total" class="text-2xl font-bold text-green-700">0</p>
                <p class="text-sm text-green-600">Total Files</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p id="smt-stat-imported" class="text-2xl font-bold text-blue-700">0</p>
                <p class="text-sm text-blue-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p id="smt-stat-pending" class="text-2xl font-bold text-yellow-700">0</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="smt-stat-size" class="text-2xl font-bold text-gray-700">0 B</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex flex-wrap items-end gap-4">
                <!-- Fiscal Year Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                    <select id="smt-filter-fiscal-year" onchange="onFiscalYearChange('smt')" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm min-w-[100px]">
                        <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <!-- Will be populated by JS -->
                    </select>
                </div>

                <!-- Month Range Filter -->
                <div class="flex items-end gap-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏à‡∏≤‡∏Å)</label>
                        <select id="smt-filter-start-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                    <span class="text-gray-400 pb-1.5">-</span>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <select id="smt-filter-end-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                        </select>
                    </div>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <div class="flex gap-1">
                        <button onclick="setSmtStatusFilter('all')" id="smt-filter-status-all" class="smt-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-green-600 text-white">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="setSmtStatusFilter('imported')" id="smt-filter-status-imported" class="smt-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button onclick="setSmtStatusFilter('pending')" id="smt-filter-status-pending" class="smt-status-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700 hover:bg-gray-300">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <button onclick="applySmtFilter()" class="bg-green-600 hover:bg-green-700 text-white py-1.5 px-4 rounded-md font-medium text-sm flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                    </svg>
                    ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                </button>

                <!-- Reset Button -->
                <button onclick="resetSmtFilter()" class="text-gray-600 hover:text-gray-800 py-1.5 px-2 text-sm">
                    ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï
                </button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div id="smt-file-count" class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                <button id="smt-import-all-btn" onclick="importAllSmtFiles()" class="hidden bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="smt-pending-count">0</span>)
                </button>
                <button id="smt-clear-btn" onclick="clearAllSmtFiles()" class="hidden bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm" title="‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- SMT Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FILENAME</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SIZE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="smt-file-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Files Pagination -->
        <div id="smt-files-pagination" class="mt-4 flex items-center justify-between hidden">
            <div class="text-sm text-gray-500">
                Page <span id="smt-files-page">1</span> of <span id="smt-files-total-pages">1</span>
            </div>
            <div class="flex gap-2">
                <button onclick="loadSmtFilesPage(currentSmtFilesPage - 1)" id="smt-files-prev" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                <button onclick="loadSmtFilesPage(currentSmtFilesPage + 1)" id="smt-files-next" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
        </div>
        <!-- End SMT Files Sub-tab -->

        <!-- ===== SMT Database Sub-tab ===== -->
        <div id="smt-subtab-database" class="hidden">
        <!-- Database Records Section -->
        <div>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    Database Records
                    <span id="smt-db-count" class="ml-2 text-sm font-normal text-gray-500">0 records</span>
                </h3>
                <div class="flex gap-2">
                    <button onclick="refreshSmtDbRecords()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-md text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <button onclick="clearSmtDatabase()" class="bg-red-100 hover:bg-red-200 text-red-700 py-1.5 px-3 rounded-md text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-end gap-4">
                    <!-- Fiscal Year -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="smt-db-fiscal-year" onchange="onSmtFiscalYearChange()" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
                        <input type="text" id="smt-db-start-date" placeholder="dd/mm/yyyy" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <input type="text" id="smt-db-end-date" placeholder="dd/mm/yyyy" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>

                    <!-- Search Button -->
                    <button onclick="loadSmtDbRecords(1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <!-- Clear Filter -->
                    <button onclick="clearSmtDbFilter()" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 text-sm">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>

                    <!-- Available Years Info -->
                    <div id="smt-db-years-info" class="ml-auto text-xs text-gray-500">
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô: <span id="smt-db-available-years">-</span>
                    </div>
                </div>
            </div>

            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Posting Date</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏≠‡∏ô</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ref Doc</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fund Group</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Imported</th>
                        </tr>
                    </thead>
                    <tbody id="smt-db-records" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="8" class="px-4 py-8 text-center text-gray-500">Click Refresh to load records</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="smt-db-pagination" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    Page <span id="smt-db-page">1</span> of <span id="smt-db-total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadSmtDbRecords(currentSmtDbPage - 1)" id="smt-db-prev" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                    <button onclick="loadSmtDbRecords(currentSmtDbPage + 1)" id="smt-db-next" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
        </div>
        <!-- End SMT Database Sub-tab -->
    </div>

    <!-- ==================== SETTINGS TAB ==================== -->
    <div id="content-settings" class="tab-content p-6 hidden">
        <div class="max-w-3xl">
            <!-- Multiple Credentials Section -->
            <div class="border border-gray-200 rounded-lg p-6 mb-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center">
                        <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                        </svg>
                        E-Claim Credentials
                    </h3>
                    <span id="credentials-count" class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full"></span>
                </div>

                <p class="text-sm text-gray-600 mb-4">
                    ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏∏‡πà‡∏°‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô ‡∏™‡∏õ‡∏™‡∏ä. block
                </p>

                <!-- Credentials List -->
                <div id="credentials-list" class="space-y-3 mb-4">
                    <!-- Credentials will be loaded here dynamically -->
                </div>

                <!-- Add New Credential Form -->
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÉ‡∏´‡∏°‡πà</h4>
                    <div class="grid grid-cols-12 gap-3">
                        <div class="col-span-4">
                            <input type="text" id="new-cred-username" placeholder="Username (‡πÄ‡∏•‡∏Ç‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô)"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="col-span-3">
                            <div class="relative">
                                <input type="password" id="new-cred-password" placeholder="Password"
                                       class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm pr-8 focus:ring-2 focus:ring-blue-500">
                                <button type="button" onclick="togglePasswordVisibility('new-cred-password')" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-gray-600">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        <div class="col-span-3">
                            <input type="text" id="new-cred-note" placeholder="‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </div>
                        <div class="col-span-2">
                            <button type="button" onclick="addCredential()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md text-sm font-medium">
                                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                </svg>
                                ‡πÄ‡∏û‡∏¥‡πà‡∏°
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Test Connection -->
                <div class="border-t border-gray-200 pt-4 mt-4">
                    <button type="button" onclick="testConnection()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                        </svg>
                        Test Connection (Random Account)
                    </button>
                </div>

                <div id="connection-status" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>

            <!-- SMT Settings Section -->
            <div class="border border-gray-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Smart Money Transfer Settings
                </h3>
                <p class="text-sm text-gray-600 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.</p>

                <form id="smt-settings-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Vendor ID (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="smt-vendor-id" name="smt_vendor_id"
                               value="{{ settings.smt_vendor_id | default('') }}"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670 ‡∏´‡∏£‡∏∑‡∏≠ 0000010670"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 5 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ 10 ‡∏´‡∏•‡∏±‡∏Å (Vendor ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô SMT)</p>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="smt-auto-save" name="smt_auto_save_db"
                               {% if settings.smt_auto_save_db | default(true) %}checked{% endif %}
                               class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label for="smt-auto-save" class="ml-2 text-sm text-gray-700">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Database ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </label>
                    </div>

                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium">
                        Save SMT Settings
                    </button>
                </form>

                <div id="smt-settings-status" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>

            <!-- Database Info -->
            <div class="border border-gray-200 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    Database Status
                </h3>

                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Type</p>
                        <p class="font-medium">{{ db_info.type | default('PostgreSQL') }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Status</p>
                        <p class="font-medium text-green-600">Connected</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Claims Records</p>
                        <p class="font-medium">{{ db_info.claims_count | default(0) | number_format }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Budget Records</p>
                        <p class="font-medium">{{ db_info.budget_count | default(0) | number_format }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== HEALTH OFFICES TAB ==================== -->
    <div id="content-offices" class="tab-content p-6 hidden">
        <!-- Header and Source -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
                <span class="font-medium">Data Source:</span>
                <a href="https://hcode.moph.go.th/code/" target="_blank" class="underline hover:text-blue-600">
                    https://hcode.moph.go.th
                </a>
                - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="ho-stat-total" class="text-2xl font-bold text-gray-700">-</p>
                <p class="text-sm text-gray-600">Total Records</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p id="ho-stat-active" class="text-2xl font-bold text-blue-700">-</p>
                <p class="text-sm text-blue-600">Active</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="ho-stat-provinces" class="text-2xl font-bold text-green-700">-</p>
                <p class="text-sm text-green-600">Provinces</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4 text-center">
                <p id="ho-stat-hospitals" class="text-2xl font-bold text-purple-700">-</p>
                <p class="text-sm text-purple-600">Hospitals</p>
            </div>
        </div>

        <!-- Import Section -->
        <div class="border border-gray-200 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center text-green-700">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Import Health Offices Data
            </h3>

            <div class="grid grid-cols-2 gap-6">
                <!-- Upload Area -->
                <div class="border border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <input type="file" id="ho-import-file" accept=".xlsx,.xls" class="hidden" onchange="hoHandleFileSelect(this)">
                    <div id="ho-upload-area" onclick="document.getElementById('ho-import-file').click()" class="cursor-pointer">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-gray-600">Click to upload Excel file</p>
                        <p class="text-sm text-gray-400 mt-1">.xlsx from hcode.moph.go.th</p>
                    </div>
                    <div id="ho-file-selected" class="hidden">
                        <div class="flex items-center justify-center gap-2 text-green-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="ho-file-name">file.xlsx</span>
                        </div>
                    </div>
                </div>

                <!-- Import Options -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Import Mode</label>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ho-import-mode" value="upsert" checked class="w-4 h-4 text-blue-600">
                                <span class="ml-2">
                                    <span class="font-medium">Update/Insert</span>
                                    <span class="text-sm text-gray-500">- ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</span>
                                </span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ho-import-mode" value="replace" class="w-4 h-4 text-red-600">
                                <span class="ml-2">
                                    <span class="font-medium text-red-600">Clear & Replace</span>
                                    <span class="text-sm text-gray-500">- ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="hoImportData()" id="ho-btn-import" disabled
                                class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-2 px-4 rounded-md font-medium">
                            Import Data
                        </button>
                        <button onclick="hoClearAllData()"
                                class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium">
                            Clear All
                        </button>
                    </div>

                    <div id="ho-import-progress" class="hidden">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Importing...</span>
                            <span id="ho-import-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="ho-import-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="ho-import-result" class="hidden p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- Search and Data Table -->
        <div class="border border-gray-200 rounded-lg">
            <div class="p-4 border-b border-gray-200">
                <div class="grid grid-cols-5 gap-4">
                    <div class="col-span-2">
                        <input type="text" id="ho-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å..."
                               onkeyup="hoDebounceSearch()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <select id="ho-filter-province" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Provinces</option>
                    </select>
                    <select id="ho-filter-level" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Levels</option>
                    </select>
                    <select id="ho-per-page" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody id="ho-data-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>

            <div class="px-4 py-3 border-t border-gray-200 flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    <span id="ho-showing-count">0</span> of <span id="ho-total-count">0</span>
                </div>
                <div id="ho-pagination" class="flex gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div id="import-progress-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Importing Files to Database</h3>
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span id="import-progress-text">Preparing...</span>
                <span id="import-progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="import-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                <span id="import-file-count">0 / 0 files</span> |
                <span id="import-record-count">0 records</span>
            </div>
        </div>
        <div class="bg-gray-50 rounded p-3 mb-4">
            <div class="text-xs text-gray-500">Current File:</div>
            <div id="import-current-file" class="text-sm font-mono truncate">-</div>
        </div>
        <button onclick="closeImportModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
            Run in Background
        </button>
    </div>
</div>

    <!-- ==================== JOB HISTORY TAB ==================== -->
    <div id="content-jobs" class="tab-content p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">Job History</h2>
                <p class="text-gray-600">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (Download, Import, Schedule)</p>
            </div>
            <button onclick="loadJobHistory()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                </svg>
                Refresh
            </button>
        </div>

        <!-- Job Stats Summary -->
        <div id="job-stats" class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                <p class="text-3xl font-bold text-blue-700" id="stats-total">-</p>
                <p class="text-sm text-blue-600">Total Jobs (7 days)</p>
            </div>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                <p class="text-3xl font-bold text-green-700" id="stats-completed">-</p>
                <p class="text-sm text-green-600">Completed</p>
            </div>
            <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                <p class="text-3xl font-bold text-red-700" id="stats-failed">-</p>
                <p class="text-sm text-red-600">Failed</p>
            </div>
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 text-center">
                <p class="text-3xl font-bold text-yellow-700" id="stats-running">-</p>
                <p class="text-sm text-yellow-600">Running</p>
            </div>
        </div>

        <!-- Filter -->
        <div class="flex flex-wrap gap-4 mb-4 items-center">
            <select id="job-filter-type" onchange="loadJobHistory()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                <option value="">All Types</option>
                <option value="download">Download</option>
                <option value="import">Import</option>
                <option value="schedule">Schedule</option>
            </select>
            <select id="job-filter-status" onchange="loadJobHistory()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
                <option value="">All Status</option>
                <option value="running">Running</option>
                <option value="completed">Completed</option>
                <option value="failed">Failed</option>
                <option value="cancelled">Cancelled</option>
            </select>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">From:</label>
                <input type="date" id="job-filter-date-from" onchange="loadJobHistory()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
            </div>
            <div class="flex items-center gap-2">
                <label class="text-sm text-gray-600">To:</label>
                <input type="date" id="job-filter-date-to" onchange="loadJobHistory()" class="border border-gray-300 rounded-md px-3 py-2 text-sm">
            </div>
            <button onclick="clearJobFilters()" class="text-sm text-blue-600 hover:text-blue-800 hover:underline">
                Clear Filters
            </button>
        </div>

        <!-- Jobs Table -->
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Started</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Duration</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Results</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Triggered By</th>
                    </tr>
                </thead>
                <tbody id="jobs-table-body" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="7" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ==================== SYSTEM HEALTH TAB ==================== -->
    <div id="content-health" class="tab-content p-6 hidden">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h2 class="text-2xl font-bold text-gray-800">System Health</h2>
                <p class="text-gray-600">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡∏∞‡∏ó‡∏£‡∏±‡∏û‡∏¢‡∏≤‡∏Å‡∏£</p>
            </div>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2 text-sm text-gray-600">
                    <input type="checkbox" id="health-auto-refresh" class="rounded" checked>
                    Auto-refresh (30s)
                </label>
                <button onclick="loadSystemHealth()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
        </div>

        <!-- Overall Status Banner -->
        <div id="health-overall-banner" class="mb-6 p-4 rounded-lg border-2 bg-gray-50 border-gray-200">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span id="health-overall-icon" class="text-3xl">‚è≥</span>
                    <div>
                        <p id="health-overall-status" class="text-lg font-semibold text-gray-700">Checking...</p>
                        <p id="health-overall-time" class="text-sm text-gray-500">-</p>
                    </div>
                </div>
                <div id="health-issues-badge" class="hidden px-3 py-1 rounded-full text-sm font-medium bg-red-100 text-red-700">
                    0 issues
                </div>
            </div>
        </div>

        <!-- Health Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <!-- Database -->
            <div id="health-card-database" class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">Database</span>
                    <span class="health-status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">-</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üóÑÔ∏è</span>
                    <span class="health-message text-sm text-gray-700">Checking...</span>
                </div>
            </div>

            <!-- Disk -->
            <div id="health-card-disk" class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">Disk Space</span>
                    <span class="health-status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">-</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üíæ</span>
                    <span class="health-message text-sm text-gray-700">Checking...</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                    <div class="health-progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Memory -->
            <div id="health-card-memory" class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">Memory</span>
                    <span class="health-status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">-</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üß†</span>
                    <span class="health-message text-sm text-gray-700">Checking...</span>
                </div>
                <div class="mt-2 w-full bg-gray-200 rounded-full h-2">
                    <div class="health-progress-bar bg-blue-600 h-2 rounded-full" style="width: 0%"></div>
                </div>
            </div>

            <!-- Processes -->
            <div id="health-card-processes" class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">Processes</span>
                    <span class="health-status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">-</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">‚öôÔ∏è</span>
                    <span class="health-message text-sm text-gray-700">Checking...</span>
                </div>
            </div>

            <!-- Jobs -->
            <div id="health-card-jobs" class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">Jobs (24h)</span>
                    <span class="health-status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">-</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìã</span>
                    <span class="health-message text-sm text-gray-700">Checking...</span>
                </div>
            </div>

            <!-- Files -->
            <div id="health-card-files" class="bg-white border rounded-lg p-4 shadow-sm">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-gray-600 font-medium">Downloaded Files</span>
                    <span class="health-status-badge px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">-</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-2xl">üìÅ</span>
                    <span class="health-message text-sm text-gray-700">Checking...</span>
                </div>
            </div>
        </div>

        <!-- Running Processes Details -->
        <div id="health-processes-detail" class="bg-white border rounded-lg p-4 shadow-sm hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-3">Running Processes</h3>
            <div id="health-processes-list" class="space-y-2">
                <!-- Processes will be listed here -->
            </div>
        </div>

        <!-- Stale PIDs Warning -->
        <div id="health-stale-pids" class="bg-yellow-50 border border-yellow-200 rounded-lg p-4 mt-4 hidden">
            <div class="flex items-start gap-3">
                <span class="text-xl">‚ö†Ô∏è</span>
                <div>
                    <p class="font-medium text-yellow-800">Stale PID Files Detected</p>
                    <p class="text-sm text-yellow-700">These processes may have crashed. Consider running System Sync to clean up.</p>
                    <p id="health-stale-list" class="text-sm font-mono text-yellow-600 mt-1"></p>
                    <button onclick="runSystemSync()" class="mt-2 px-3 py-1 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm">
                        Clean Up Stale PIDs
                    </button>
                </div>
            </div>
        </div>
    </div>

<style>
/* Spin animation for sync icon */
@keyframes spin {
    from { transform: rotate(0deg); }
    to { transform: rotate(360deg); }
}
.animate-spin {
    animation: spin 1s linear infinite;
}

/* Slide-in animation for toast */
@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateX(100%);
    }
    to {
        opacity: 1;
        transform: translateX(0);
    }
}
.animate-slide-in {
    animation: slideIn 0.3s ease-out;
}
</style>

<script>
let scheduleTimes = [];
let currentTab = 'download';

// ==================== System Sync Functions ====================

/**
 * Sync system status - check processes, reset stuck progress, sync files with history
 */
async function syncSystemStatus() {
    const btn = document.getElementById('btn-sync-status');
    const icon = document.getElementById('sync-icon');
    const btnText = document.getElementById('sync-btn-text');

    // Show loading state
    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    icon.classList.add('animate-spin');
    btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';

    try {
        const response = await fetch('/api/system/sync-status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        if (result.success) {
            showSyncToast(result);

            // Refresh page data if any changes were made
            const actionsCount = result.summary.processes_reset +
                               result.summary.files_added +
                               result.summary.files_removed;
            if (actionsCount > 0) {
                // Reload page after a short delay to reflect changes
                setTimeout(() => {
                    location.reload();
                }, 2000);
            }
        } else {
            showSyncToast({
                success: false,
                message: result.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£ sync'
            });
        }
    } catch (error) {
        console.error('Sync error:', error);
        showSyncToast({
            success: false,
            message: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö server ‡πÑ‡∏î‡πâ'
        });
    } finally {
        // Reset button state
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        icon.classList.remove('animate-spin');
        btnText.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö & Sync';
    }
}

/**
 * Show sync result toast notification
 */
function showSyncToast(result) {
    const toast = document.getElementById('sync-result-toast');
    const iconEl = document.getElementById('sync-toast-icon');
    const titleEl = document.getElementById('sync-toast-title');
    const messageEl = document.getElementById('sync-toast-message');
    const detailsEl = document.getElementById('sync-toast-details');

    // Determine toast style based on result
    const actionsCount = result.summary ?
        (result.summary.processes_reset + result.summary.files_added + result.summary.files_removed) : 0;

    if (result.success && actionsCount > 0) {
        // Changes were made
        toast.className = 'fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg border bg-green-50 border-green-200';
        iconEl.innerHTML = '<svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        titleEl.className = 'font-semibold text-sm text-green-800';
        titleEl.textContent = 'Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç';
        messageEl.className = 'text-sm mt-1 text-green-700';
    } else if (result.success) {
        // No changes needed
        toast.className = 'fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg border bg-blue-50 border-blue-200';
        iconEl.innerHTML = '<svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>';
        titleEl.className = 'font-semibold text-sm text-blue-800';
        titleEl.textContent = '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
        messageEl.className = 'text-sm mt-1 text-blue-700';
    } else {
        // Error
        toast.className = 'fixed top-4 right-4 z-50 max-w-md p-4 rounded-lg shadow-lg border bg-red-50 border-red-200';
        iconEl.innerHTML = '<svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>';
        titleEl.className = 'font-semibold text-sm text-red-800';
        titleEl.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î';
        messageEl.className = 'text-sm mt-1 text-red-700';
    }

    messageEl.textContent = result.message || '';

    // Build details section
    detailsEl.innerHTML = '';
    if (result.summary) {
        const summary = result.summary;
        if (summary.processes_reset > 0) {
            detailsEl.innerHTML += `<p class="text-gray-600">‚Ä¢ Reset ${summary.processes_reset} stuck process(es)</p>`;
        }
        if (summary.files_added > 0) {
            detailsEl.innerHTML += `<p class="text-gray-600">‚Ä¢ Added ${summary.files_added} file(s) to history</p>`;
        }
        if (summary.files_removed > 0) {
            detailsEl.innerHTML += `<p class="text-gray-600">‚Ä¢ Removed ${summary.files_removed} orphaned record(s)</p>`;
        }
        if (summary.files_synced > 0 && actionsCount === 0) {
            detailsEl.innerHTML += `<p class="text-gray-600">‚Ä¢ ${summary.files_synced} file(s) verified</p>`;
        }
    }

    // Show actions if any
    if (result.actions && result.actions.length > 0) {
        const processActions = result.actions.filter(a => a.type === 'process_check' && a.action !== 'none');
        if (processActions.length > 0) {
            const actionText = processActions.map(a => `${a.name}: ${a.status}`).join(', ');
            detailsEl.innerHTML += `<p class="text-gray-500 text-xs mt-1">Process: ${actionText}</p>`;
        }
    }

    // Show toast
    toast.classList.remove('hidden');

    // Auto-hide after 8 seconds
    setTimeout(hideSyncToast, 8000);
}

/**
 * Hide sync toast notification
 */
function hideSyncToast() {
    const toast = document.getElementById('sync-result-toast');
    toast.classList.add('hidden');
}

// ==================== End System Sync Functions ====================

// ==================== Update Status Functions ====================

/**
 * Load file update status from API
 */
async function loadUpdateStatus() {
    try {
        const response = await fetch('/api/files/update-status');
        const result = await response.json();

        if (result.success) {
            updateStatusCards(result);
        } else {
            console.error('Failed to load update status:', result.error);
            showStatusError();
        }
    } catch (error) {
        console.error('Error loading update status:', error);
        showStatusError();
    }
}

/**
 * Show error state in status cards
 */
function showStatusError() {
    ['rep', 'stm', 'smt'].forEach(type => {
        const badge = document.getElementById('status-badge-' + type);
        if (badge) {
            badge.textContent = 'Error';
            badge.className = 'px-2 py-0.5 text-xs rounded-full bg-red-100 text-red-600';
        }
    });
}

/**
 * Update status cards with API data
 */
function updateStatusCards(data) {
    const currentPeriod = data.current_period;
    const byType = data.by_type || {};

    // Month names in Thai
    const thaiMonths = ['', '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                       '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'];

    // Update each type card
    ['rep', 'stm', 'smt'].forEach(type => {
        const typeData = byType[type];
        const badge = document.getElementById('status-badge-' + type);
        const lastUpdate = document.getElementById('status-last-update-' + type);
        const fileCount = document.getElementById('status-file-count-' + type);
        const schemesDiv = document.getElementById('status-schemes-' + type);
        const schemesList = document.getElementById('status-schemes-list-' + type);

        if (!typeData) {
            // No data for this type
            if (badge) {
                badge.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                badge.className = 'px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-500';
            }
            if (lastUpdate) lastUpdate.textContent = '-';
            if (fileCount) fileCount.textContent = '0 ‡πÑ‡∏ü‡∏•‡πå';
            if (schemesDiv) schemesDiv.classList.add('hidden');
            return;
        }

        // Update file count
        if (fileCount) {
            fileCount.textContent = typeData.total_files.toLocaleString() + ' ‡πÑ‡∏ü‡∏•‡πå';
        }

        // Update last update time
        if (lastUpdate && typeData.last_update) {
            const date = new Date(typeData.last_update);
            const day = date.getDate();
            const month = thaiMonths[date.getMonth() + 1];
            const year = date.getFullYear() + 543;
            const hours = date.getHours().toString().padStart(2, '0');
            const mins = date.getMinutes().toString().padStart(2, '0');
            lastUpdate.textContent = day + ' ' + month + ' ' + year + ' ' + hours + ':' + mins;
        } else if (lastUpdate) {
            lastUpdate.textContent = '-';
        }

        // Update badge - check if any scheme is current month
        let hasCurrentMonth = false;
        let schemes = typeData.schemes || {};

        for (const schemeKey in schemes) {
            if (schemes[schemeKey].is_current_month) {
                hasCurrentMonth = true;
                break;
            }
        }

        if (badge) {
            if (hasCurrentMonth) {
                badge.textContent = '‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡πÅ‡∏•‡πâ‡∏ß';
                badge.className = 'px-2 py-0.5 text-xs rounded-full bg-green-100 text-green-700';
            } else if (typeData.total_files > 0) {
                badge.textContent = '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà';
                badge.className = 'px-2 py-0.5 text-xs rounded-full bg-amber-100 text-amber-700';
            } else {
                badge.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                badge.className = 'px-2 py-0.5 text-xs rounded-full bg-gray-200 text-gray-500';
            }
        }

        // Update schemes list (for REP and STM which have schemes)
        if (schemesDiv && schemesList && type !== 'smt' && Object.keys(schemes).length > 0) {
            schemesDiv.classList.remove('hidden');
            schemesList.innerHTML = '';

            // Sort schemes
            const sortedSchemes = Object.keys(schemes).sort();
            sortedSchemes.forEach(schemeKey => {
                const schemeData = schemes[schemeKey];
                const span = document.createElement('span');
                span.className = schemeData.is_current_month
                    ? 'px-1.5 py-0.5 rounded text-xs bg-green-100 text-green-700'
                    : 'px-1.5 py-0.5 rounded text-xs bg-gray-200 text-gray-600';
                span.textContent = schemeKey.toUpperCase();
                span.title = schemeData.file_count + ' ‡πÑ‡∏ü‡∏•‡πå';
                schemesList.appendChild(span);
            });
        } else if (schemesDiv) {
            schemesDiv.classList.add('hidden');
        }
    });
}

// ==================== End Update Status Functions ====================

// Number formatting helper
function formatNumber(num, decimals) {
    if (num === null || num === undefined) return '-';
    if (typeof decimals === 'number') {
        return parseFloat(num).toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    return parseFloat(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Scheme selection helpers
function selectAllSchemes(prefix) {
    document.querySelectorAll('input[name="' + prefix + '-schemes"]').forEach(function(cb) {
        cb.checked = true;
    });
    updateBulkEstimate();
}

function selectDefaultSchemes(prefix) {
    var defaultSchemes = ['ucs', 'ofc', 'sss', 'lgo'];
    document.querySelectorAll('input[name="' + prefix + '-schemes"]').forEach(function(cb) {
        cb.checked = defaultSchemes.includes(cb.value);
    });
    updateBulkEstimate();
}

function getSelectedSchemes(prefix) {
    var schemes = [];
    document.querySelectorAll('input[name="' + prefix + '-schemes"]:checked').forEach(function(cb) {
        schemes.push(cb.value);
    });
    return schemes;
}

// ==================== Filter Functions ====================

// Filter state for each tab
var filterState = {
    rep: { fiscalYear: '', startMonth: '', endMonth: '', scheme: '', fileType: '', status: 'all' },
    stm: { fiscalYear: '', startMonth: '', endMonth: '', status: 'all' },
    smt: { fiscalYear: '', startMonth: '', endMonth: '', status: 'all' }
};

/**
 * Get current fiscal year (Thai Buddhist Era)
 * Fiscal year runs Oct-Sep: if current month >= Oct, fiscal year = next year
 */
function getCurrentFiscalYear() {
    var now = new Date();
    var year = now.getFullYear() + 543; // Convert to BE
    var month = now.getMonth() + 1; // 1-12
    // If Oct-Dec, fiscal year is next year
    if (month >= 10) {
        return year + 1;
    }
    return year;
}

/**
 * Populate fiscal year dropdown with available years
 */
function populateFiscalYearDropdown(prefix) {
    var select = document.getElementById(prefix + '-filter-fiscal-year');
    if (!select) return;

    var currentFY = getCurrentFiscalYear();
    var options = '<option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>';

    // Show last 3 fiscal years + current
    for (var fy = currentFY; fy >= currentFY - 3; fy--) {
        options += '<option value="' + fy + '">‡∏õ‡∏µ‡∏á‡∏ö ' + fy + '</option>';
    }

    select.innerHTML = options;
}

/**
 * Handle fiscal year change - auto set start/end months
 */
function onFiscalYearChange(prefix) {
    var fySelect = document.getElementById(prefix + '-filter-fiscal-year');
    var startSelect = document.getElementById(prefix + '-filter-start-month');
    var endSelect = document.getElementById(prefix + '-filter-end-month');

    if (!fySelect || !startSelect || !endSelect) return;

    var fy = fySelect.value;

    if (fy) {
        // Set to fiscal year range: Oct - Sep
        startSelect.value = '10';
        endSelect.value = '9';
        filterState[prefix].fiscalYear = fy;
        filterState[prefix].startMonth = '10';
        filterState[prefix].endMonth = '9';
    } else {
        // Reset to all
        startSelect.value = '';
        endSelect.value = '';
        filterState[prefix].fiscalYear = '';
        filterState[prefix].startMonth = '';
        filterState[prefix].endMonth = '';
    }
}

/**
 * Set status filter for REP
 */
function setRepStatusFilter(status) {
    filterState.rep.status = status;

    // Update button styles
    document.querySelectorAll('.rep-status-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });

    var activeBtn = document.getElementById('rep-filter-status-' + status);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-blue-600', 'text-white');
    }
}

/**
 * Set status filter for Statement
 */
function setStmStatusFilter(status) {
    filterState.stm.status = status;

    document.querySelectorAll('.stm-status-btn').forEach(function(btn) {
        btn.classList.remove('bg-purple-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });

    var activeBtn = document.getElementById('stm-filter-status-' + status);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-purple-600', 'text-white');
    }
}

/**
 * Set status filter for SMT
 */
function setSmtStatusFilter(status) {
    filterState.smt.status = status;

    document.querySelectorAll('.smt-status-btn').forEach(function(btn) {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });

    var activeBtn = document.getElementById('smt-filter-status-' + status);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-green-600', 'text-white');
    }
}

/**
 * Build filter query params
 */
function buildFilterParams(prefix) {
    var params = new URLSearchParams();

    var fySelect = document.getElementById(prefix + '-filter-fiscal-year');
    var startSelect = document.getElementById(prefix + '-filter-start-month');
    var endSelect = document.getElementById(prefix + '-filter-end-month');

    if (fySelect && fySelect.value) {
        params.set('fiscal_year', fySelect.value);
    }
    if (startSelect && startSelect.value) {
        params.set('start_month', startSelect.value);
    }
    if (endSelect && endSelect.value) {
        params.set('end_month', endSelect.value);
    }

    // REP specific filters
    if (prefix === 'rep') {
        var schemeSelect = document.getElementById('rep-filter-scheme');
        var fileTypeSelect = document.getElementById('rep-filter-file-type');

        if (schemeSelect && schemeSelect.value) {
            params.set('scheme', schemeSelect.value);
        }
        if (fileTypeSelect && fileTypeSelect.value) {
            params.set('file_type', fileTypeSelect.value);
        }
    }

    // Status filter
    if (filterState[prefix] && filterState[prefix].status !== 'all') {
        params.set('status', filterState[prefix].status);
    }

    return params;
}

/**
 * Apply REP filter
 */
function applyRepFilter() {
    var params = buildFilterParams('rep');
    params.set('page', '1');

    // Reload page with filter params
    window.location.href = '/data-management?tab=rep&' + params.toString();
}

/**
 * Reset REP filter
 */
function resetRepFilter() {
    document.getElementById('rep-filter-fiscal-year').value = '';
    document.getElementById('rep-filter-start-month').value = '';
    document.getElementById('rep-filter-end-month').value = '';
    document.getElementById('rep-filter-scheme').value = '';
    document.getElementById('rep-filter-file-type').value = '';
    setRepStatusFilter('all');

    window.location.href = '/data-management?tab=rep';
}

/**
 * Apply Statement filter
 */
function applyStmFilter() {
    var params = buildFilterParams('stm');

    // Use AJAX to reload file list
    loadStatementFiles(params);
}

/**
 * Reset Statement filter
 */
function resetStmFilter() {
    document.getElementById('stm-filter-fiscal-year').value = '';
    document.getElementById('stm-filter-start-month').value = '';
    document.getElementById('stm-filter-end-month').value = '';
    setStmStatusFilter('all');

    loadStatementFiles();
}

/**
 * Apply SMT filter
 */
function applySmtFilter() {
    var params = buildFilterParams('smt');

    // Use AJAX to reload file list
    loadSmtFiles(params);
}

/**
 * Reset SMT filter
 */
function resetSmtFilter() {
    document.getElementById('smt-filter-fiscal-year').value = '';
    document.getElementById('smt-filter-start-month').value = '';
    document.getElementById('smt-filter-end-month').value = '';
    setSmtStatusFilter('all');

    loadSmtFiles();
}

/**
 * Initialize filters on page load
 */
function initFilters() {
    // Populate fiscal year dropdowns
    populateFiscalYearDropdown('rep');
    populateFiscalYearDropdown('stm');
    populateFiscalYearDropdown('smt');

    // Restore filter state from URL params
    var urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('fiscal_year')) {
        var fy = urlParams.get('fiscal_year');
        var tab = urlParams.get('tab') || 'rep';
        var fySelect = document.getElementById(tab + '-filter-fiscal-year');
        if (fySelect) fySelect.value = fy;
    }

    if (urlParams.get('start_month')) {
        var tab = urlParams.get('tab') || 'rep';
        var startSelect = document.getElementById(tab + '-filter-start-month');
        if (startSelect) startSelect.value = urlParams.get('start_month');
    }

    if (urlParams.get('end_month')) {
        var tab = urlParams.get('tab') || 'rep';
        var endSelect = document.getElementById(tab + '-filter-end-month');
        if (endSelect) endSelect.value = urlParams.get('end_month');
    }

    if (urlParams.get('scheme')) {
        var schemeSelect = document.getElementById('rep-filter-scheme');
        if (schemeSelect) schemeSelect.value = urlParams.get('scheme');
    }

    if (urlParams.get('file_type')) {
        var fileTypeSelect = document.getElementById('rep-filter-file-type');
        if (fileTypeSelect) fileTypeSelect.value = urlParams.get('file_type');
    }

    if (urlParams.get('status')) {
        var tab = urlParams.get('tab') || 'rep';
        var status = urlParams.get('status');
        if (tab === 'rep') setRepStatusFilter(status);
        else if (tab === 'stm' || tab === 'statement') setStmStatusFilter(status);
        else if (tab === 'smt') setSmtStatusFilter(status);
    }
}

// ==================== Tab Dropdown Functions ====================

// Tab group mapping - which tabs belong to which group
var tabGroups = {
    'files': ['rep', 'statement', 'smt'],
    'admin': ['settings', 'offices'],
    'monitor': ['jobs', 'health']
};

// Tab labels for indicator
var tabLabels = {
    'download': 'Download',
    'rep': 'REP Files',
    'statement': 'Statement',
    'smt': 'Smart Money Transfer',
    'settings': 'Settings',
    'offices': 'Health Offices',
    'jobs': 'Job History',
    'health': 'System Health'
};

/**
 * Toggle dropdown menu visibility
 */
function toggleTabDropdown(group) {
    var dropdown = document.getElementById('dropdown-' + group);
    var menu = dropdown.querySelector('.dropdown-menu');
    var isOpen = !menu.classList.contains('hidden');

    // Close all other dropdowns first
    closeAllDropdowns();

    // Toggle this dropdown
    if (!isOpen) {
        menu.classList.remove('hidden');
        dropdown.querySelector('.dropdown-arrow').classList.add('rotate-180');
    }
}

/**
 * Close all dropdown menus
 */
function closeAllDropdowns() {
    document.querySelectorAll('.tab-dropdown .dropdown-menu').forEach(function(menu) {
        menu.classList.add('hidden');
    });
    document.querySelectorAll('.tab-dropdown .dropdown-arrow').forEach(function(arrow) {
        arrow.classList.remove('rotate-180');
    });
}

/**
 * Get parent group for a tab
 */
function getTabGroup(tab) {
    for (var group in tabGroups) {
        if (tabGroups[group].includes(tab)) {
            return group;
        }
    }
    return null;
}

/**
 * Update dropdown group highlight based on active tab
 */
function updateGroupHighlight(tab) {
    // Reset all group buttons
    document.querySelectorAll('.tab-group-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-600', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });

    // Find parent group and highlight
    var group = getTabGroup(tab);
    if (group) {
        var groupBtn = document.querySelector('#dropdown-' + group + ' .tab-group-btn');
        if (groupBtn) {
            groupBtn.classList.remove('border-transparent', 'text-gray-500');
            groupBtn.classList.add('border-blue-600', 'text-blue-600');
        }
    }

    // Update tab indicator
    var indicator = document.getElementById('current-tab-indicator');
    var label = document.getElementById('current-tab-label');
    if (group && indicator && label) {
        indicator.classList.remove('hidden');
        label.textContent = tabLabels[tab] || tab;
    } else if (indicator) {
        indicator.classList.add('hidden');
    }
}

// Close dropdowns when clicking outside
document.addEventListener('click', function(e) {
    if (!e.target.closest('.tab-dropdown')) {
        closeAllDropdowns();
    }
});

// Tab switching
function switchTab(tab) {
    currentTab = tab;
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(function(el) {
        el.classList.add('hidden');
    });
    // Show selected tab content
    document.getElementById('content-' + tab).classList.remove('hidden');

    // Update standalone tab button styles (Download)
    var downloadBtn = document.getElementById('tab-download');
    if (tab === 'download') {
        downloadBtn.classList.remove('border-transparent', 'text-gray-500');
        downloadBtn.classList.add('border-blue-600', 'text-blue-600');
    } else {
        downloadBtn.classList.remove('border-blue-600', 'text-blue-600');
        downloadBtn.classList.add('border-transparent', 'text-gray-500');
    }

    // Update dropdown group highlight
    updateGroupHighlight(tab);

    // Load data for specific tabs
    if (tab === 'download' && typeof loadFailedDownloads === 'function') {
        loadFailedDownloads();
    } else if (tab === 'rep') {
        loadFileTypeStats();
    } else if (tab === 'smt' && typeof loadSmtFiles === 'function') {
        loadSmtFiles();
    } else if (tab === 'statement' && typeof loadStatementFiles === 'function') {
        loadStatementFiles();
    } else if (tab === 'jobs') {
        initJobDateFilters();
        loadJobStats();
        loadJobHistory();
    } else if (tab === 'health') {
        loadSystemHealth();
        startHealthAutoRefresh();
    }

    // Update URL without reload
    var url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);
}

// SMT Sub-tab switching
function switchSmtSubtab(subtab) {
    // Hide all SMT sub-tab contents
    document.getElementById('smt-subtab-files').classList.add('hidden');
    document.getElementById('smt-subtab-database').classList.add('hidden');

    // Show selected sub-tab content
    document.getElementById('smt-subtab-' + subtab).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.smt-subtab-btn').forEach(function(btn) {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-200');
    });
    var activeBtn = document.getElementById('smt-subtab-btn-' + subtab);
    activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-200');
    activeBtn.classList.add('bg-green-600', 'text-white');

    // Load data if switching to database tab
    if (subtab === 'database' && typeof loadSmtDbRecords === 'function') {
        loadSmtDbRecords(1);
    }
}

// REP Sub-tab switching
function switchRepSubtab(subtab) {
    // Hide all REP sub-tab contents
    document.getElementById('rep-subtab-files').classList.add('hidden');
    document.getElementById('rep-subtab-database').classList.add('hidden');

    // Show selected sub-tab content
    document.getElementById('rep-subtab-' + subtab).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.rep-subtab-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-200');
    });
    var activeBtn = document.getElementById('rep-subtab-btn-' + subtab);
    activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-200');
    activeBtn.classList.add('bg-blue-600', 'text-white');

    // Load data if switching to database tab
    if (subtab === 'database') {
        initRepDbFiscalYear();
        loadRepDbRecords(1);
    }
}

// ==================== File Type Stats ====================

/**
 * Load and display file type statistics
 */
async function loadFileTypeStats() {
    const grid = document.getElementById('file-type-grid');
    const badge = document.getElementById('file-type-count-badge');

    if (!grid) return;

    try {
        const response = await fetch('/api/rep/file-type-stats');
        const data = await response.json();

        if (!data.success) {
            grid.textContent = 'Error loading file types';
            return;
        }

        // Update badge
        if (badge) {
            badge.textContent = data.total_types + ' ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó';
        }

        // Build grid content
        if (data.file_types.length === 0) {
            grid.textContent = 'No files found';
            return;
        }

        let html = '';
        data.file_types.forEach(function(ft) {
            const pendingClass = ft.pending > 0 ? 'text-yellow-600' : 'text-green-600';
            const bgColor = getCategoryBgColor(ft.category);

            html += '<div class="' + bgColor + ' rounded-lg p-3 cursor-pointer hover:shadow-md transition-shadow" onclick="filterByFileType(\'' + ft.type + '\')">';
            html += '  <div class="flex items-center gap-2 mb-1">';
            html += '    <span class="text-lg">' + ft.icon + '</span>';
            html += '    <span class="font-semibold text-gray-800">' + ft.name + '</span>';
            html += '  </div>';
            html += '  <p class="text-xs text-gray-500 mb-2">' + ft.description + '</p>';
            html += '  <div class="flex items-center justify-between text-xs">';
            html += '    <span class="font-medium">' + ft.count + ' ‡πÑ‡∏ü‡∏•‡πå</span>';
            html += '    <div class="flex gap-2">';
            html += '      <span class="text-green-600" title="Imported">' + ft.imported + ' ‚úì</span>';
            if (ft.pending > 0) {
                html += '      <span class="' + pendingClass + '" title="Pending">' + ft.pending + ' ‡∏£‡∏≠</span>';
            }
            html += '    </div>';
            html += '  </div>';
            html += '</div>';
        });

        grid.innerHTML = html;

    } catch (error) {
        console.error('Error loading file type stats:', error);
        if (grid) grid.textContent = 'Error loading data';
    }
}

/**
 * Get background color class based on category
 */
function getCategoryBgColor(category) {
    const colors = {
        'ucs': 'bg-blue-50 border border-blue-100',
        'lgo': 'bg-purple-50 border border-purple-100',
        'sss': 'bg-orange-50 border border-orange-100',
        'special': 'bg-teal-50 border border-teal-100',
        'appeal': 'bg-amber-50 border border-amber-100',
        'unknown': 'bg-gray-50 border border-gray-100'
    };
    return colors[category] || colors['unknown'];
}

/**
 * Filter files by type and apply filter
 */
function filterByFileType(fileType) {
    // Set file type filter (add to URL or use hidden input)
    const url = new URL(window.location.href);
    url.searchParams.set('file_type', fileType);
    url.searchParams.set('tab', 'rep');
    url.searchParams.set('status', 'all');

    // Show toast and reload
    showToast('‡∏Å‡∏£‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ' + fileType, 'info');

    // For now, just show an alert with file type info
    // Later can implement actual filtering
    alert('‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ' + fileType + '\n‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï');
}

// REP Database Records
var currentRepDbPage = 1;

function initRepDbFiscalYear() {
    var select = document.getElementById('rep-db-fiscal-year');
    if (!select || select.options.length > 1) return;

    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;

    for (var fy = currentFiscalYear; fy >= 2566; fy--) {
        var option = document.createElement('option');
        option.value = fy;
        option.textContent = '‡∏õ‡∏µ ' + fy;
        select.appendChild(option);
    }

    // Always default to current fiscal year
    select.value = currentFiscalYear;
}

async function loadRepDbRecords(page) {
    currentRepDbPage = page || 1;

    var viewMode = document.getElementById('rep-db-view-mode').value;
    var fiscalYear = document.getElementById('rep-db-fiscal-year').value;
    var repNo = document.getElementById('rep-db-rep-no').value;
    var status = document.getElementById('rep-db-status').value;

    var params = new URLSearchParams({
        page: currentRepDbPage,
        limit: 50,
        view_mode: viewMode
    });
    if (fiscalYear) params.append('fiscal_year', fiscalYear);
    if (repNo) params.append('rep_no', repNo);
    if (status) params.append('status', status);

    var tbody = document.getElementById('rep-db-records-body');
    tbody.textContent = '';
    var loadingRow = document.createElement('tr');
    var loadingCell = document.createElement('td');
    loadingCell.colSpan = 7;
    loadingCell.className = 'px-4 py-8 text-center text-gray-500';
    loadingCell.textContent = 'Loading...';
    loadingRow.appendChild(loadingCell);
    tbody.appendChild(loadingRow);

    try {
        var response = await fetch('/api/rep/records?' + params.toString());
        var data = await response.json();

        if (data.success) {
            renderRepDbRecords(data.records, viewMode);
            updateRepDbStats(data.stats);
            updateRepDbPagination(data.pagination);
            document.getElementById('rep-db-result-count').textContent =
                '‡πÅ‡∏™‡∏î‡∏á ' + data.records.length + ' ‡∏à‡∏≤‡∏Å ' + data.pagination.total + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        } else {
            showErrorInTable(tbody, 7, data.error || 'Error loading data');
        }
    } catch (error) {
        showErrorInTable(tbody, 7, 'Error: ' + error.message);
    }
}

function showErrorInTable(tbody, cols, message) {
    tbody.textContent = '';
    var row = document.createElement('tr');
    var cell = document.createElement('td');
    cell.colSpan = cols;
    cell.className = 'px-4 py-8 text-center text-red-500';
    cell.textContent = message;
    row.appendChild(cell);
    tbody.appendChild(row);
}

function renderRepDbRecords(records, viewMode) {
    var tbody = document.getElementById('rep-db-records-body');
    tbody.textContent = '';

    if (!records || records.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 7;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    records.forEach(function(rec) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        var statusClass = 'bg-gray-100 text-gray-600';
        var statusText = rec.status || '-';

        if (rec.status === 'matched') {
            statusClass = 'bg-green-100 text-green-700';
            statusText = 'Matched';
        } else if (rec.status === 'diff_amount') {
            statusClass = 'bg-yellow-100 text-yellow-700';
            statusText = 'Diff';
        } else if (rec.status === 'rep_only') {
            statusClass = 'bg-red-100 text-red-700';
            statusText = 'REP Only';
        }

        var repAmount = parseFloat(rec.rep_amount || 0);
        var stmAmount = parseFloat(rec.stm_amount || 0);
        var diff = repAmount - stmAmount;

        if (viewMode === 'rep') {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium text-blue-600';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Count cell
            var countCell = document.createElement('td');
            countCell.className = 'px-3 py-2';
            countCell.textContent = (rec.count || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            row.appendChild(countCell);
        } else {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Transaction cell
            var tranCell = document.createElement('td');
            tranCell.className = 'px-3 py-2';
            var tranSpan = document.createElement('span');
            tranSpan.className = 'text-gray-500';
            tranSpan.textContent = rec.tran_id || '-';
            tranCell.appendChild(tranSpan);
            tranCell.appendChild(document.createTextNode(' ' + (rec.patient_name || '')));
            row.appendChild(tranCell);
        }

        // REP Amount cell
        var repAmtCell = document.createElement('td');
        repAmtCell.className = 'px-3 py-2 text-right';
        repAmtCell.textContent = formatNumber(repAmount);
        row.appendChild(repAmtCell);

        // STM Amount cell
        var stmCell = document.createElement('td');
        stmCell.className = 'px-3 py-2 text-right';
        stmCell.textContent = formatNumber(stmAmount);
        row.appendChild(stmCell);

        // Diff cell
        var diffCell = document.createElement('td');
        diffCell.className = 'px-3 py-2 text-right' + (diff !== 0 ? ' text-red-600' : '');
        diffCell.textContent = formatNumber(diff);
        row.appendChild(diffCell);

        // Status cell
        var statusCell = document.createElement('td');
        statusCell.className = 'px-3 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-0.5 rounded text-xs ' + statusClass;
        statusSpan.textContent = statusText;
        statusCell.appendChild(statusSpan);
        row.appendChild(statusCell);

        // Actions cell
        var actionsCell = document.createElement('td');
        actionsCell.className = 'px-3 py-2 text-center';
        if (viewMode === 'rep') {
            var detailBtn = document.createElement('button');
            detailBtn.className = 'text-blue-600 hover:text-blue-800 text-xs';
            detailBtn.textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            detailBtn.onclick = function() { viewRepDetail(rec.rep_no); };
            actionsCell.appendChild(detailBtn);
        } else if (rec.tran_id) {
            var analysisLink = document.createElement('a');
            analysisLink.href = '/data-analysis?tran_id=' + rec.tran_id;
            analysisLink.className = 'text-blue-600 hover:text-blue-800 text-xs';
            analysisLink.textContent = '‡∏î‡∏π Statement';
            actionsCell.appendChild(analysisLink);
        } else {
            actionsCell.textContent = '-';
        }
        row.appendChild(actionsCell);

        tbody.appendChild(row);
    });
}

function updateRepDbStats(stats) {
    if (!stats) return;
    document.getElementById('rep-db-stat-total').textContent = formatNumber(stats.total || 0, 0);
    document.getElementById('rep-db-stat-matched').textContent = formatNumber(stats.matched || 0, 0);
    document.getElementById('rep-db-stat-diff').textContent = formatNumber(stats.diff_amount || 0, 0);
    document.getElementById('rep-db-stat-unmatched').textContent = formatNumber(stats.rep_only || 0, 0);
}

function updateRepDbPagination(pagination) {
    var paginationDiv = document.getElementById('rep-db-pagination');
    if (!pagination || pagination.total_pages <= 1) {
        paginationDiv.classList.add('hidden');
        return;
    }

    paginationDiv.classList.remove('hidden');
    document.getElementById('rep-db-current-page').textContent = pagination.page;
    document.getElementById('rep-db-total-pages').textContent = pagination.total_pages;
    document.getElementById('rep-db-prev-btn').disabled = pagination.page <= 1;
    document.getElementById('rep-db-next-btn').disabled = pagination.page >= pagination.total_pages;
}

function viewRepDetail(repNo) {
    document.getElementById('rep-db-view-mode').value = 'tran';
    document.getElementById('rep-db-rep-no').value = repNo;
    loadRepDbRecords(1);
}

function refreshRepDbRecords() {
    loadRepDbRecords(currentRepDbPage);
}

function clearRepDbFilter() {
    document.getElementById('rep-db-view-mode').value = 'rep';
    // Reset to current fiscal year (not empty)
    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;
    document.getElementById('rep-db-fiscal-year').value = currentFiscalYear;
    document.getElementById('rep-db-rep-no').value = '';
    document.getElementById('rep-db-status').value = '';
    loadRepDbRecords(1);
}

async function clearRepDatabase() {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) return;

    try {
        var response = await fetch('/api/rep/clear-database', { method: 'POST' });
        var data = await response.json();
        if (data.success) {
            showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadRepDbRecords(1);
        } else {
            showToast(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Statement Sub-tab switching
function switchStatementSubtab(subtab) {
    // Hide all Statement sub-tab contents
    document.getElementById('stm-subtab-files').classList.add('hidden');
    document.getElementById('stm-subtab-database').classList.add('hidden');

    // Show selected sub-tab content
    document.getElementById('stm-subtab-' + subtab).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.stm-subtab-btn').forEach(function(btn) {
        btn.classList.remove('bg-purple-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-200');
    });
    var activeBtn = document.getElementById('stm-subtab-btn-' + subtab);
    activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-200');
    activeBtn.classList.add('bg-purple-600', 'text-white');

    // Load data if switching to database tab
    if (subtab === 'database') {
        initStmDbFiscalYear();
        loadStmDbRecords(1);
    }
}

// Statement Database Records
var currentStmDbPage = 1;

function initStmDbFiscalYear() {
    var select = document.getElementById('stm-db-fiscal-year');
    if (!select || select.options.length > 1) return;  // Already initialized

    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;

    for (var fy = currentFiscalYear; fy >= 2566; fy--) {
        var option = document.createElement('option');
        option.value = fy;
        option.textContent = '‡∏õ‡∏µ ' + fy;
        select.appendChild(option);
    }

    // Always default to current fiscal year
    select.value = currentFiscalYear;
}

async function loadStmDbRecords(page) {
    currentStmDbPage = page || 1;

    var viewMode = document.getElementById('stm-db-view-mode').value;
    var fiscalYear = document.getElementById('stm-db-fiscal-year').value;
    var repNo = document.getElementById('stm-db-rep-no').value;
    var status = document.getElementById('stm-db-status').value;

    var params = new URLSearchParams({
        page: currentStmDbPage,
        limit: 50,
        view_mode: viewMode
    });
    if (fiscalYear) params.append('fiscal_year', fiscalYear);
    if (repNo) params.append('rep_no', repNo);
    if (status) params.append('status', status);

    var tbody = document.getElementById('stm-db-records-body');
    tbody.textContent = '';
    var loadingRow = document.createElement('tr');
    var loadingCell = document.createElement('td');
    loadingCell.colSpan = 7;
    loadingCell.className = 'px-4 py-8 text-center text-gray-500';
    loadingCell.textContent = 'Loading...';
    loadingRow.appendChild(loadingCell);
    tbody.appendChild(loadingRow);

    try {
        var response = await fetch('/api/stm/records?' + params.toString());
        var data = await response.json();

        if (data.success) {
            renderStmDbRecords(data.records, viewMode);
            updateStmDbStats(data.stats);
            updateStmDbPagination(data.pagination);
            document.getElementById('stm-db-result-count').textContent =
                '‡πÅ‡∏™‡∏î‡∏á ' + data.records.length + ' ‡∏à‡∏≤‡∏Å ' + data.pagination.total + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        } else {
            tbody.textContent = '';
            var errorRow = document.createElement('tr');
            var errorCell = document.createElement('td');
            errorCell.colSpan = 7;
            errorCell.className = 'px-4 py-8 text-center text-red-500';
            errorCell.textContent = data.error || 'Error loading data';
            errorRow.appendChild(errorCell);
            tbody.appendChild(errorRow);
        }
    } catch (error) {
        tbody.textContent = '';
        var errorRow = document.createElement('tr');
        var errorCell = document.createElement('td');
        errorCell.colSpan = 7;
        errorCell.className = 'px-4 py-8 text-center text-red-500';
        errorCell.textContent = 'Error: ' + error.message;
        errorRow.appendChild(errorCell);
        tbody.appendChild(errorRow);
    }
}

function renderStmDbRecords(records, viewMode) {
    var tbody = document.getElementById('stm-db-records-body');
    tbody.textContent = '';

    if (!records || records.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 7;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    records.forEach(function(rec) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        var statusClass = 'bg-gray-100 text-gray-600';
        var statusText = rec.status || '-';

        if (rec.status === 'matched') {
            statusClass = 'bg-green-100 text-green-700';
            statusText = 'Matched';
        } else if (rec.status === 'diff_amount') {
            statusClass = 'bg-yellow-100 text-yellow-700';
            statusText = 'Diff';
        } else if (rec.status === 'stm_only') {
            statusClass = 'bg-red-100 text-red-700';
            statusText = 'STM Only';
        }

        var stmAmount = parseFloat(rec.stm_amount || 0);
        var repAmount = parseFloat(rec.rep_amount || 0);
        var diff = stmAmount - repAmount;

        if (viewMode === 'rep') {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium text-blue-600';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Count cell
            var countCell = document.createElement('td');
            countCell.className = 'px-3 py-2';
            countCell.textContent = (rec.count || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            row.appendChild(countCell);
        } else {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Transaction cell
            var tranCell = document.createElement('td');
            tranCell.className = 'px-3 py-2';
            var tranSpan = document.createElement('span');
            tranSpan.className = 'text-gray-500';
            tranSpan.textContent = rec.tran_id || '-';
            tranCell.appendChild(tranSpan);
            tranCell.appendChild(document.createTextNode(' ' + (rec.patient_name || '')));
            row.appendChild(tranCell);
        }

        // STM Amount cell
        var stmCell = document.createElement('td');
        stmCell.className = 'px-3 py-2 text-right';
        stmCell.textContent = formatNumber(stmAmount);
        row.appendChild(stmCell);

        // REP Amount cell
        var repAmtCell = document.createElement('td');
        repAmtCell.className = 'px-3 py-2 text-right';
        repAmtCell.textContent = formatNumber(repAmount);
        row.appendChild(repAmtCell);

        // Diff cell
        var diffCell = document.createElement('td');
        diffCell.className = 'px-3 py-2 text-right' + (diff !== 0 ? ' text-red-600' : '');
        diffCell.textContent = formatNumber(diff);
        row.appendChild(diffCell);

        // Status cell
        var statusCell = document.createElement('td');
        statusCell.className = 'px-3 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-0.5 rounded text-xs ' + statusClass;
        statusSpan.textContent = statusText;
        statusCell.appendChild(statusSpan);
        row.appendChild(statusCell);

        // Actions cell
        var actionsCell = document.createElement('td');
        actionsCell.className = 'px-3 py-2 text-center';
        if (viewMode === 'rep') {
            var detailBtn = document.createElement('button');
            detailBtn.className = 'text-blue-600 hover:text-blue-800 text-xs';
            detailBtn.textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            detailBtn.onclick = function() { viewStmRepDetail(rec.rep_no); };
            actionsCell.appendChild(detailBtn);
        } else if (rec.tran_id) {
            var repLink = document.createElement('a');
            repLink.href = '/data-analysis?tran_id=' + rec.tran_id;
            repLink.className = 'text-blue-600 hover:text-blue-800 text-xs';
            repLink.textContent = '‡∏î‡∏π REP';
            actionsCell.appendChild(repLink);
        } else {
            actionsCell.textContent = '-';
        }
        row.appendChild(actionsCell);

        tbody.appendChild(row);
    });
}

function updateStmDbStats(stats) {
    if (!stats) return;
    document.getElementById('stm-db-stat-total').textContent = formatNumber(stats.total || 0, 0);
    document.getElementById('stm-db-stat-matched').textContent = formatNumber(stats.matched || 0, 0);
    document.getElementById('stm-db-stat-diff').textContent = formatNumber(stats.diff_amount || 0, 0);
    document.getElementById('stm-db-stat-unmatched').textContent = formatNumber(stats.stm_only || 0, 0);
}

function updateStmDbPagination(pagination) {
    var paginationDiv = document.getElementById('stm-db-pagination');
    if (!pagination || pagination.total_pages <= 1) {
        paginationDiv.classList.add('hidden');
        return;
    }

    paginationDiv.classList.remove('hidden');
    document.getElementById('stm-db-current-page').textContent = pagination.page;
    document.getElementById('stm-db-total-pages').textContent = pagination.total_pages;
    document.getElementById('stm-db-prev-btn').disabled = pagination.page <= 1;
    document.getElementById('stm-db-next-btn').disabled = pagination.page >= pagination.total_pages;
}

function viewStmRepDetail(repNo) {
    document.getElementById('stm-db-view-mode').value = 'tran';
    document.getElementById('stm-db-rep-no').value = repNo;
    loadStmDbRecords(1);
}

function refreshStmDbRecords() {
    loadStmDbRecords(currentStmDbPage);
}

function clearStmDbFilter() {
    document.getElementById('stm-db-view-mode').value = 'rep';
    // Reset to current fiscal year (not empty)
    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;
    document.getElementById('stm-db-fiscal-year').value = currentFiscalYear;
    document.getElementById('stm-db-rep-no').value = '';
    document.getElementById('stm-db-status').value = '';
    loadStmDbRecords(1);
}

async function clearStmDatabase() {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) return;

    try {
        var response = await fetch('/api/stm/clear-database', { method: 'POST' });
        var data = await response.json();
        if (data.success) {
            showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadStmDbRecords(1);
        } else {
            showToast(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Initialize from URL params
function initFromUrl() {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab') || 'download';
    switchTab(tab);

    // Restore status filter from URL
    var status = params.get('status') || 'all';
    currentStatusFilter = status;

    // Update button styles
    document.querySelectorAll('.file-filter-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    var activeBtn = document.getElementById('filter-' + status);
    if (activeBtn) {
        activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
        activeBtn.classList.add('bg-blue-600', 'text-white');
    }
}

// Year dropdowns
function populateYearDropdowns() {
    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;

    // Determine current fiscal year (fiscal year starts in October)
    // If we're in Oct-Dec, fiscal year is next year BE
    // If we're in Jan-Sep, fiscal year is current year BE
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;

    var yearSelects = ['bulk-start-year', 'bulk-end-year', 'smt-fiscal-year'];

    yearSelects.forEach(function(id) {
        var select = document.getElementById(id);
        if (!select) return;

        while (select.firstChild) select.removeChild(select.firstChild);

        for (var i = 0; i <= 8; i++) {
            var yearBE = currentFiscalYear - i;
            var option = document.createElement('option');
            option.value = yearBE;
            option.textContent = yearBE;
            if (i === 0) option.selected = true;  // Current fiscal year as default
            select.appendChild(option);
        }
    });

    // REP: Default to current month (REP downloads one month at a time, no "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô")
    // Statement: Default to "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" (all months)
    var monthSelect = document.getElementById('bulk-start-month');
    var allMonthsOption = document.getElementById('opt-all-months');

    // On initial load, REP is default - hide "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" and set current month
    if (allMonthsOption) allMonthsOption.classList.add('hidden');
    if (monthSelect) monthSelect.value = currentMonth.toString();

    var bulkEndMonth = document.getElementById('bulk-end-month');
    if (bulkEndMonth) bulkEndMonth.value = '';
}

// Update bulk estimate
function updateBulkEstimate() {
    var startMonthVal = document.getElementById('bulk-start-month').value;
    var startYearVal = document.getElementById('bulk-start-year').value;
    var endMonthVal = document.getElementById('bulk-end-month').value;
    var endYearVal = document.getElementById('bulk-end-year').value;

    var schemes = getSelectedSchemes('bulk');
    var numSchemes = schemes.length || 1;

    // Handle "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" (all months) - full fiscal year
    var startMonth, startYear, endMonth, endYear;
    var fiscalYearText = '';

    if (startMonthVal === '' || startMonthVal === null) {
        // All months in fiscal year: Oct (year-1) to Sep (year)
        startMonth = 10;
        startYear = parseInt(startYearVal) - 1;
        endMonth = 9;
        endYear = parseInt(startYearVal);
        fiscalYearText = ' (‡∏õ‡∏µ‡∏á‡∏ö ' + startYearVal + ')';
    } else {
        startMonth = parseInt(startMonthVal);
        startYear = parseInt(startYearVal);
        endMonth = endMonthVal ? parseInt(endMonthVal) : startMonth;
        endYear = endYearVal ? parseInt(endYearVal) : startYear;
    }

    if (typeof calculateMonthsBetween === 'function') {
        var totalMonths = calculateMonthsBetween(startMonth, startYear, endMonth, endYear);
        var totalIterations = totalMonths * numSchemes;
        var estimatedMinutes = Math.ceil(totalIterations * 0.5); // ~30 sec per iteration
        document.getElementById('bulk-estimate').textContent =
            totalMonths + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô x ' + numSchemes + ' ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ = ' + totalIterations + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' + fiscalYearText + ' (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ' + estimatedMinutes + ' ‡∏ô‡∏≤‡∏ó‡∏µ)';
    }
}

// File filtering - now uses server-side filtering
function filterFilesStatus(status) {
    // Update button styles
    document.querySelectorAll('.file-filter-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    document.getElementById('filter-' + status).classList.remove('bg-gray-200', 'text-gray-700');
    document.getElementById('filter-' + status).classList.add('bg-blue-600', 'text-white');

    // Set current status and apply filter server-side
    currentStatusFilter = status;
    applyFilesFilter();
}

function filterFilesByMonth() {
    // Legacy function - redirect to applyFilesFilter
    applyFilesFilter();
}

// Track current status filter
var currentStatusFilter = 'all';

// Apply files filter with date range, scheme, and status
function applyFilesFilter() {
    var startSelect = document.getElementById('filter-start-month');
    var endSelect = document.getElementById('filter-end-month');
    var schemeSelect = document.getElementById('filter-scheme');

    var params = new URLSearchParams();
    params.set('tab', 'rep');
    params.set('page', '1');

    // Date range
    if (startSelect && startSelect.value) {
        var startParts = startSelect.value.split(',');
        params.set('start_month', startParts[0]);
        params.set('start_year', startParts[1]);
    }
    if (endSelect && endSelect.value) {
        var endParts = endSelect.value.split(',');
        params.set('end_month', endParts[0]);
        params.set('end_year', endParts[1]);
    }

    // Scheme filter
    if (schemeSelect && schemeSelect.value) {
        params.set('scheme', schemeSelect.value);
    }

    // Status filter (imported/pending)
    if (currentStatusFilter && currentStatusFilter !== 'all') {
        params.set('status', currentStatusFilter);
    }

    window.location.href = '?' + params.toString();
}

// Password toggle
function togglePasswordVisibility(inputId) {
    var input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Schedule management
async function loadScheduleSettings() {
    try {
        var response = await fetch('/api/schedule');
        var data = await response.json();

        if (data.success) {
            document.getElementById('schedule-enabled').checked = data.settings.schedule_enabled;
            document.getElementById('schedule-auto-import').checked = data.settings.schedule_auto_import;
            scheduleTimes = data.settings.schedule_times || [];
            renderScheduleTimes();
            displayScheduleStatus(data.jobs);
            // Load schedule schemes
            setScheduleSchemes(data.settings.schedule_schemes);
            // Load data type checkboxes
            var typeRepCheckbox = document.getElementById('schedule-type-rep');
            var typeStmCheckbox = document.getElementById('schedule-type-stm');
            var typeSmtCheckbox = document.getElementById('schedule-type-smt');
            var smtVendorInput = document.getElementById('schedule-smt-vendor-id');

            if (typeRepCheckbox) {
                typeRepCheckbox.checked = data.settings.schedule_type_rep !== false; // Default true
            }
            if (typeStmCheckbox) {
                typeStmCheckbox.checked = data.settings.schedule_type_stm === true; // Default false
            }
            if (typeSmtCheckbox) {
                typeSmtCheckbox.checked = data.settings.schedule_type_smt === true; // Default false
            }
            if (smtVendorInput) {
                smtVendorInput.value = data.settings.schedule_smt_vendor_id || '';
            }

            // Load parallel download settings
            var parallelCheckbox = document.getElementById('schedule-parallel-download');
            var parallelWorkersSelect = document.getElementById('schedule-parallel-workers');
            if (parallelCheckbox) {
                parallelCheckbox.checked = data.settings.schedule_parallel_download === true;
            }
            if (parallelWorkersSelect) {
                parallelWorkersSelect.value = data.settings.schedule_parallel_workers || 3;
            }
            // Initialize parallel workers section visibility
            toggleScheduleParallelWorkers();

            // Update card states based on loaded settings
            initScheduleCards();

            // Update summary text in header
            updateScheduleSummary(data.settings);
        }
    } catch (error) {
        console.error('Error loading schedule:', error);
    }
}

function updateScheduleSummary(settings) {
    var summary = document.getElementById('schedule-summary');
    if (!summary) return;

    if (!settings.schedule_enabled) {
        summary.textContent = '‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà';
        summary.className = 'ml-3 text-sm text-gray-400';
        return;
    }

    var times = settings.schedule_times || [];
    var types = [];
    if (settings.schedule_type_rep !== false) types.push('REP');
    if (settings.schedule_type_stm) types.push('STM');
    if (settings.schedule_type_smt) types.push('SMT');

    // Check parallel download mode
    var parallelInfo = '';
    if (settings.schedule_parallel_download) {
        var workers = settings.schedule_parallel_workers || 3;
        parallelInfo = ' [' + workers + 'x]';
    }

    if (times.length === 0) {
        summary.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ¬∑ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤';
        summary.className = 'ml-3 text-sm text-yellow-600';
    } else {
        var timeStr = times.map(function(t) {
            return String(t.hour).padStart(2, '0') + ':' + String(t.minute).padStart(2, '0');
        }).join(', ');
        summary.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ¬∑ ' + timeStr + ' ¬∑ ' + types.join(', ') + parallelInfo;
        summary.className = 'ml-3 text-sm text-green-600';
    }
}

function renderScheduleTimes() {
    var container = document.getElementById('schedule-times-container');
    var msg = document.getElementById('no-schedules-message');

    // Remove existing schedule items
    var existingItems = container.querySelectorAll('.schedule-time-chip');
    existingItems.forEach(function(el) { el.remove(); });

    if (scheduleTimes.length === 0) {
        if (msg) msg.style.display = 'block';
        return;
    }

    if (msg) msg.style.display = 'none';

    scheduleTimes.forEach(function(time, index) {
        // Create chip-style time display
        var chip = document.createElement('div');
        chip.className = 'schedule-time-chip inline-flex items-center gap-1 bg-purple-100 border border-purple-200 rounded-full px-3 py-1.5';

        // Time icon
        var icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        icon.setAttribute('class', 'w-4 h-4 text-purple-600');
        icon.setAttribute('fill', 'none');
        icon.setAttribute('stroke', 'currentColor');
        icon.setAttribute('viewBox', '0 0 24 24');
        var iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        iconPath.setAttribute('stroke-linecap', 'round');
        iconPath.setAttribute('stroke-linejoin', 'round');
        iconPath.setAttribute('stroke-width', '2');
        iconPath.setAttribute('d', 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z');
        icon.appendChild(iconPath);

        // Hour input
        var hourInput = document.createElement('input');
        hourInput.type = 'number';
        hourInput.min = '0';
        hourInput.max = '23';
        hourInput.value = String(time.hour).padStart(2, '0');
        hourInput.className = 'w-10 px-1 py-0 border-0 bg-transparent text-center text-sm font-medium text-purple-800 focus:ring-0';
        hourInput.onchange = function() { scheduleTimes[index].hour = parseInt(this.value) || 0; };

        var colon = document.createElement('span');
        colon.className = 'text-purple-800 font-medium';
        colon.textContent = ':';

        // Minute input
        var minuteInput = document.createElement('input');
        minuteInput.type = 'number';
        minuteInput.min = '0';
        minuteInput.max = '59';
        minuteInput.value = String(time.minute).padStart(2, '0');
        minuteInput.className = 'w-10 px-1 py-0 border-0 bg-transparent text-center text-sm font-medium text-purple-800 focus:ring-0';
        minuteInput.onchange = function() { scheduleTimes[index].minute = parseInt(this.value) || 0; };

        // Delete button
        var deleteBtn = document.createElement('button');
        deleteBtn.className = 'ml-1 text-purple-500 hover:text-red-600 transition-colors';
        deleteBtn.onclick = function(e) { e.stopPropagation(); removeScheduleTime(index); };
        deleteBtn.title = '‡∏•‡∏ö';

        var deleteIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        deleteIcon.setAttribute('class', 'w-4 h-4');
        deleteIcon.setAttribute('fill', 'none');
        deleteIcon.setAttribute('stroke', 'currentColor');
        deleteIcon.setAttribute('viewBox', '0 0 24 24');
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        deleteIcon.appendChild(path);
        deleteBtn.appendChild(deleteIcon);

        chip.appendChild(icon);
        chip.appendChild(hourInput);
        chip.appendChild(colon);
        chip.appendChild(minuteInput);
        chip.appendChild(deleteBtn);

        container.appendChild(chip);
    });
}

function addScheduleTime() {
    scheduleTimes.push({ hour: 9, minute: 0 });
    renderScheduleTimes();
}

function removeScheduleTime(index) {
    scheduleTimes.splice(index, 1);
    renderScheduleTimes();
}

function getScheduleSchemes() {
    var schemes = [];
    document.querySelectorAll('input[name="schedule-schemes"]:checked').forEach(function(cb) {
        schemes.push(cb.value);
    });
    return schemes;
}

function setScheduleSchemes(schemes) {
    if (!schemes || schemes.length === 0) {
        schemes = ['ucs', 'ofc', 'sss', 'lgo']; // Default
    }
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = schemes.includes(cb.value);
    });
}

// ===== NEW Card-Based Schedule UI Functions =====

function updateScheduleCardState(type) {
    var checkbox = document.getElementById('schedule-type-' + type);
    var card = document.getElementById('card-type-' + type);
    var settings = document.getElementById(type + '-settings');

    if (!checkbox || !card) return;

    var isChecked = checkbox.checked;

    // Update card opacity and border
    if (isChecked) {
        card.classList.remove('opacity-60');
        card.classList.add('border-' + getTypeColor(type) + '-300');
        card.classList.add('shadow-sm');
    } else {
        card.classList.add('opacity-60');
        card.classList.remove('border-' + getTypeColor(type) + '-300');
        card.classList.remove('shadow-sm');
    }

    // Show/hide settings panel
    if (settings) {
        if (isChecked) {
            settings.classList.remove('hidden');
        } else {
            settings.classList.add('hidden');
        }
    }
}

function getTypeColor(type) {
    switch(type) {
        case 'rep': return 'blue';
        case 'stm': return 'purple';
        case 'smt': return 'green';
        default: return 'gray';
    }
}

function toggleScheduleTypeCard(type) {
    var checkbox = document.getElementById('schedule-type-' + type);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateScheduleCardState(type);
    }
}

function toggleScheduleParallelWorkers() {
    var checkbox = document.getElementById('schedule-parallel-download');
    var section = document.getElementById('schedule-parallel-workers-section');
    if (section) {
        if (checkbox && checkbox.checked) {
            section.classList.remove('hidden');
        } else {
            section.classList.add('hidden');
        }
    }
}

function initScheduleCards() {
    // Initialize card states based on checkbox values
    ['rep', 'stm', 'smt'].forEach(function(type) {
        updateScheduleCardState(type);
    });
}

function selectAllScheduleSchemes() {
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = true;
    });
}

function selectMainScheduleSchemes() {
    var mainSchemes = ['ucs', 'ofc', 'sss', 'lgo'];
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = mainSchemes.includes(cb.value);
    });
}

function deselectAllScheduleSchemes() {
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = false;
    });
}

// Legacy function - now just calls initScheduleCards
function updateScheduleSchemeVisibility() {
    initScheduleCards();
}

async function saveScheduleSettings() {
    try {
        // Get data type checkboxes
        var typeRep = document.getElementById('schedule-type-rep');
        var typeStm = document.getElementById('schedule-type-stm');
        var typeSmt = document.getElementById('schedule-type-smt');
        var smtVendorInput = document.getElementById('schedule-smt-vendor-id');

        var scheduleTypeRep = typeRep ? typeRep.checked : true;
        var scheduleTypeStm = typeStm ? typeStm.checked : false;
        var scheduleTypeSmt = typeSmt ? typeSmt.checked : false;
        var smtVendorId = smtVendorInput ? smtVendorInput.value.trim() : '';

        // Get parallel download settings
        var parallelCheckbox = document.getElementById('schedule-parallel-download');
        var parallelWorkersSelect = document.getElementById('schedule-parallel-workers');
        var scheduleParallelDownload = parallelCheckbox ? parallelCheckbox.checked : false;
        var scheduleParallelWorkers = parallelWorkersSelect ? parseInt(parallelWorkersSelect.value) : 3;

        // Validate at least one data type is selected when enabling
        var scheduleEnabled = document.getElementById('schedule-enabled').checked;
        if (scheduleEnabled && !scheduleTypeRep && !scheduleTypeStm && !scheduleTypeSmt) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            return;
        }

        // Validate schemes only if REP is selected (Statement is UCS only)
        var scheduleSchemes = getScheduleSchemes();
        if (scheduleTypeRep && scheduleSchemes.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö REP Files', 'error');
            return;
        }

        var response = await fetch('/api/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                schedule_enabled: scheduleEnabled,
                schedule_times: scheduleTimes,
                schedule_auto_import: document.getElementById('schedule-auto-import').checked,
                schedule_parallel_download: scheduleParallelDownload,
                schedule_parallel_workers: scheduleParallelWorkers,
                schedule_schemes: scheduleSchemes,
                schedule_type_rep: scheduleTypeRep,
                schedule_type_stm: scheduleTypeStm,
                schedule_type_smt: scheduleTypeSmt,
                schedule_smt_vendor_id: smtVendorId
            })
        });

        var result = await response.json();
        if (result.success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadScheduleSettings();
        } else {
            showToast(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
        }
    } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    }
}

function displayScheduleStatus(jobs) {
    var statusDiv = document.getElementById('schedule-status');
    var statusBox = document.getElementById('schedule-status-box');
    var isEnabled = document.getElementById('schedule-enabled').checked;

    if (!isEnabled) {
        statusDiv.innerHTML = '<span class="text-gray-500">‚è∏Ô∏è ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
        if (statusBox) statusBox.className = 'mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200';
        return;
    }

    if (!jobs || jobs.length === 0) {
        statusDiv.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>';
        if (statusBox) statusBox.className = 'mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200';
        return;
    }

    // Find nearest next run
    var nextRunTimes = jobs
        .filter(function(job) { return job.next_run_time; })
        .map(function(job) { return new Date(job.next_run_time); })
        .sort(function(a, b) { return a - b; });

    var nextRunText = nextRunTimes.length > 0
        ? nextRunTimes[0].toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' })
        : '-';

    // Get selected data types
    var dataTypes = [];
    if (document.getElementById('schedule-type-rep').checked) {
        var schemes = getScheduleSchemes();
        dataTypes.push('REP (' + schemes.length + ' ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥)');
    }
    if (document.getElementById('schedule-type-stm').checked) {
        dataTypes.push('UC Statement');
    }
    if (document.getElementById('schedule-type-smt').checked) {
        dataTypes.push('SMT Budget');
    }

    statusDiv.innerHTML = '<span class="text-green-600 font-medium">‚úÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>' +
        '<span class="mx-2 text-gray-300">|</span>' +
        '<span class="text-gray-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ' + nextRunText + '</span>' +
        (dataTypes.length > 0 ? '<br><span class="text-xs text-gray-500 mt-1 block">üì¶ ' + dataTypes.join(', ') + '</span>' : '');

    if (statusBox) statusBox.className = 'mt-4 p-4 bg-green-50 rounded-lg border border-green-200';
}

// ===== Multiple Credentials Management =====

// Load credentials on page load
async function loadCredentials() {
    try {
        var response = await fetch('/api/settings/credentials');
        var result = await response.json();

        if (result.success) {
            renderCredentialsList(result.credentials);
            updateCredentialsCount(result.count);
        }
    } catch (error) {
        console.error('Error loading credentials:', error);
    }
}

function renderCredentialsList(credentials) {
    var container = document.getElementById('credentials-list');

    if (!credentials || credentials.length === 0) {
        container.innerHTML = '<div class="text-center py-6 text-gray-500 bg-gray-50 rounded-lg border border-dashed border-gray-300">' +
            '<svg class="w-8 h-8 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>' +
            '</svg>' +
            '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>' +
            '</div>';
        return;
    }

    var html = '';
    credentials.forEach(function(cred, index) {
        var enabledClass = cred.enabled ? 'bg-white' : 'bg-gray-100 opacity-60';
        var statusBadge = cred.enabled
            ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">Active</span>'
            : '<span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">Disabled</span>';

        html += '<div class="credential-item ' + enabledClass + ' border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow" data-username="' + cred.username + '">' +
            '<div class="flex items-center justify-between">' +
            '<div class="flex-1 grid grid-cols-12 gap-3 items-center">' +
            '<div class="col-span-4">' +
            '<div class="flex items-center gap-2">' +
            '<input type="checkbox" ' + (cred.enabled ? 'checked' : '') +
            ' onchange="toggleCredential(\'' + cred.username + '\', this.checked)"' +
            ' class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">' +
            '<div>' +
            '<p class="font-medium text-gray-900 text-sm">' + cred.username + '</p>' +
            '<p class="text-xs text-gray-500">' + (cred.note || 'No note') + '</p>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '<div class="col-span-3">' +
            '<input type="password" value="' + cred.password + '" readonly' +
            ' class="w-full bg-gray-50 border border-gray-200 rounded px-2 py-1 text-sm text-gray-600">' +
            '</div>' +
            '<div class="col-span-3">' + statusBadge + '</div>' +
            '<div class="col-span-2 text-right">' +
            '<button onclick="removeCredential(\'' + cred.username + '\')" class="text-red-500 hover:text-red-700 p-1" title="Remove">' +
            '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">' +
            '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>' +
            '</svg>' +
            '</button>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';
    });

    container.innerHTML = html;
}

function updateCredentialsCount(count) {
    var countEl = document.getElementById('credentials-count');
    if (count.total === 0) {
        countEl.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ';
        countEl.className = 'text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full';
    } else {
        countEl.textContent = count.enabled + '/' + count.total + ' ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ Active';
        countEl.className = 'text-sm text-green-700 bg-green-100 px-3 py-1 rounded-full';
    }
}

async function addCredential() {
    var username = document.getElementById('new-cred-username').value.trim();
    var password = document.getElementById('new-cred-password').value.trim();
    var note = document.getElementById('new-cred-note').value.trim();

    if (!username) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Username', 'error');
        return;
    }
    if (!password) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Password', 'error');
        return;
    }

    try {
        var response = await fetch('/api/settings/credentials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                username: username,
                password: password,
                note: note,
                enabled: true
            })
        });

        var result = await response.json();
        if (result.success) {
            showToast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            // Clear form
            document.getElementById('new-cred-username').value = '';
            document.getElementById('new-cred-password').value = '';
            document.getElementById('new-cred-note').value = '';
            // Reload list
            loadCredentials();
        } else {
            showToast(result.error || 'Failed to add credential', 'error');
        }
    } catch (error) {
        showToast('Error adding credential', 'error');
    }
}

async function removeCredential(username) {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ ' + username + ' ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) {
        return;
    }

    try {
        var response = await fetch('/api/settings/credentials/' + encodeURIComponent(username), {
            method: 'DELETE'
        });

        var result = await response.json();
        if (result.success) {
            showToast('‡∏•‡∏ö‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadCredentials();
        } else {
            showToast(result.error || 'Failed to remove credential', 'error');
        }
    } catch (error) {
        showToast('Error removing credential', 'error');
    }
}

async function toggleCredential(username, enabled) {
    try {
        var response = await fetch('/api/settings/credentials/' + encodeURIComponent(username), {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        });

        var result = await response.json();
        if (result.success) {
            showToast(enabled ? '‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' : '‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'success');
            loadCredentials();
        } else {
            showToast(result.error || 'Failed to update', 'error');
        }
    } catch (error) {
        showToast('Error updating credential', 'error');
    }
}

// Load credentials and update status when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadCredentials();
    loadUpdateStatus();  // Load file update status on page load
    initFilters();  // Initialize filter dropdowns
});

async function testConnection() {
    var statusDiv = document.getElementById('connection-status');
    statusDiv.classList.remove('hidden');
    statusDiv.className = 'mt-4 p-3 rounded-lg bg-blue-50 border border-blue-200';
    statusDiv.innerHTML = '<span class="text-blue-700">üîÑ Testing connection (random account)...</span>';

    try {
        var response = await fetch('/api/settings/test-connection', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-800 border border-green-200';
            statusDiv.innerHTML = '‚úÖ ' + result.message;
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800 border border-red-200';
            statusDiv.innerHTML = '‚ùå ' + result.error;
        }
    } catch (error) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800 border border-red-200';
        statusDiv.innerHTML = '‚ùå Network error';
    }
}

// SMT Fetch
async function fetchSmtData() {
    var fiscalYear = document.getElementById('smt-fiscal-year').value;
    var month = document.getElementById('smt-month').value;

    try {
        showToast('Fetching SMT data...', 'info');

        // Build date range from fiscal year and month
        var startDate = null;
        var endDate = null;

        if (month) {
            // Calculate start and end date for specific month
            var monthInt = parseInt(month);
            var yearInt = parseInt(fiscalYear);
            // Thai fiscal year: Oct (yearBE-1) to Sep (yearBE)
            // So for month 10-12, use yearBE-1, for month 1-9, use yearBE
            var gregorianYear = monthInt >= 10 ? yearInt - 544 : yearInt - 543;
            var daysInMonth = new Date(gregorianYear, monthInt, 0).getDate();
            startDate = '01/' + String(monthInt).padStart(2, '0') + '/' + yearInt;
            endDate = String(daysInMonth).padStart(2, '0') + '/' + String(monthInt).padStart(2, '0') + '/' + yearInt;
        }

        var response = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                budget_year: fiscalYear,
                start_date: startDate,
                end_date: endDate,
                save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('SMT data fetched successfully! ' + (result.records || 0) + ' records', 'success');
            document.getElementById('smt-last-sync').textContent = new Date().toLocaleString('th-TH');
            document.getElementById('smt-record-count').textContent = result.records || 0;
        } else {
            showToast(result.error || 'Failed to fetch', 'error');
        }
    } catch (error) {
        console.error('SMT fetch error:', error);
        showToast('Error fetching SMT data: ' + error.message, 'error');
    }
}

// SMT Settings
async function saveSmtSettings(event) {
    event.preventDefault();

    var vendorId = document.getElementById('smt-vendor-id').value.trim();
    var autoSave = document.getElementById('smt-auto-save').checked;
    var statusDiv = document.getElementById('smt-settings-status');

    if (!vendorId) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
        statusDiv.textContent = 'Vendor ID is required';
        statusDiv.classList.remove('hidden');
        return;
    }

    try {
        var response = await fetch('/api/smt/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                smt_vendor_id: vendorId,
                smt_schedule_enabled: false,
                smt_schedule_times: [],
                smt_auto_save_db: autoSave
            })
        });
        var result = await response.json();

        if (result.success) {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-700';
            statusDiv.textContent = 'SMT settings saved successfully!';
            showToast('SMT settings saved!', 'success');
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
            statusDiv.textContent = result.error || 'Failed to save settings';
        }
        statusDiv.classList.remove('hidden');
    } catch (error) {
        console.error('SMT settings error:', error);
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
        statusDiv.textContent = 'Error: ' + error.message;
        statusDiv.classList.remove('hidden');
    }
}

async function loadSmtSettings() {
    try {
        var response = await fetch('/api/smt/settings');
        var result = await response.json();

        if (result.success && result.settings) {
            // Settings tab fields
            var vendorInput = document.getElementById('smt-vendor-id');
            var autoSaveInput = document.getElementById('smt-auto-save');
            // Download tab SMT vendor field
            var dlVendorInput = document.getElementById('dl-vendor-id');
            // Schedule SMT vendor field
            var scheduleSmtVendorInput = document.getElementById('schedule-smt-vendor-id');

            if (vendorInput && result.settings.smt_vendor_id) {
                vendorInput.value = result.settings.smt_vendor_id;
            }
            if (dlVendorInput && result.settings.smt_vendor_id) {
                dlVendorInput.value = result.settings.smt_vendor_id;
            }
            if (scheduleSmtVendorInput && result.settings.smt_vendor_id && !scheduleSmtVendorInput.value) {
                // Only set if not already set (don't overwrite user input)
                scheduleSmtVendorInput.value = result.settings.smt_vendor_id;
            }
            if (autoSaveInput) {
                autoSaveInput.checked = result.settings.smt_auto_save_db !== false;
            }
        }
    } catch (error) {
        console.error('Failed to load SMT settings:', error);
    }
}

// Load SMT stats (record count and last sync time)
async function loadSmtStats() {
    try {
        var response = await fetch('/api/smt/stats');
        var result = await response.json();

        if (result.success) {
            var lastSyncEl = document.getElementById('smt-last-sync');
            var recordCountEl = document.getElementById('smt-record-count');

            if (lastSyncEl) {
                if (result.last_sync) {
                    lastSyncEl.textContent = new Date(result.last_sync).toLocaleString('th-TH');
                } else {
                    lastSyncEl.textContent = '-';
                }
            }
            if (recordCountEl) {
                recordCountEl.textContent = result.record_count ? result.record_count.toLocaleString() : '0';
            }
        }
    } catch (error) {
        console.error('Failed to load SMT stats:', error);
    }
}

// Clear SMT data
async function clearSmtData() {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
        return;
    }

    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
        return;
    }

    try {
        var response = await fetch('/api/smt/clear', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadSmtStats();
        } else {
            showToast(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    } catch (error) {
        console.error('Failed to clear SMT data:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Quick save vendor ID from SMT tab
async function saveSmtVendorId() {
    var vendorId = document.getElementById('smt-vendor-id-input').value.trim();

    if (!vendorId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Vendor ID', 'error');
        return;
    }

    try {
        var response = await fetch('/api/smt/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                smt_vendor_id: vendorId,
                smt_schedule_enabled: false,
                smt_schedule_times: [],
                smt_auto_save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('Vendor ID saved: ' + vendorId, 'success');
            // Sync to settings tab if it exists
            var settingsInput = document.getElementById('smt-vendor-id');
            if (settingsInput) settingsInput.value = vendorId;
        } else {
            showToast(result.error || 'Failed to save', 'error');
        }
    } catch (error) {
        console.error('Save vendor ID error:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== HEALTH OFFICES FUNCTIONS ====================
let hoCurrentPage = 1;
let hoSearchTimeout;

async function hoLoadStats() {
    try {
        var response = await fetch('/api/health-offices/stats');
        var result = await response.json();

        if (result.success) {
            var stats = result.stats;
            document.getElementById('ho-stat-total').textContent = stats.total.toLocaleString();

            var active = stats.by_status.find(function(s) { return s.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; });
            document.getElementById('ho-stat-active').textContent = active ? active.count.toLocaleString() : '0';
            document.getElementById('ho-stat-provinces').textContent = stats.provinces.length;
            document.getElementById('ho-stat-hospitals').textContent = stats.levels.length > 0 ? stats.levels.length + ' levels' : '0';

            hoPopulateFilter('ho-filter-province', stats.provinces);
            hoPopulateFilter('ho-filter-level', stats.levels);
        }
    } catch (e) {
        console.error('Error loading HO stats:', e);
    }
}

function hoPopulateFilter(elementId, options) {
    var select = document.getElementById(elementId);
    var firstOption = select.options[0];
    select.textContent = '';
    select.appendChild(firstOption);

    options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
    });
}

async function hoLoadData() {
    var search = document.getElementById('ho-search-input').value;
    var province = document.getElementById('ho-filter-province').value;
    var level = document.getElementById('ho-filter-level').value;
    var perPage = document.getElementById('ho-per-page').value;

    var params = new URLSearchParams();
    params.append('page', hoCurrentPage);
    params.append('per_page', perPage);
    if (search) params.append('search', search);
    if (province) params.append('province', province);
    if (level) params.append('level', level);

    try {
        var response = await fetch('/api/health-offices?' + params.toString());
        var result = await response.json();

        if (result.success) {
            hoRenderTable(result.data);
            document.getElementById('ho-showing-count').textContent = result.data.length;
            document.getElementById('ho-total-count').textContent = result.total.toLocaleString();
            hoRenderPagination(result.page, result.total_pages);
        }
    } catch (e) {
        console.error('Error loading HO data:', e);
    }
}

function hoRenderTable(data) {
    var tbody = document.getElementById('ho-data-tbody');
    tbody.textContent = '';

    if (!data || data.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 5;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = 'No data found';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    data.forEach(function(row) {
        var tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        // hcode5
        var td1 = document.createElement('td');
        td1.className = 'px-4 py-2 text-sm font-mono';
        td1.textContent = row.hcode5 || '-';
        tr.appendChild(td1);

        // name
        var td2 = document.createElement('td');
        td2.className = 'px-4 py-2 text-sm';
        td2.textContent = row.name || '-';
        tr.appendChild(td2);

        // hospital_level
        var td3 = document.createElement('td');
        td3.className = 'px-4 py-2 text-sm text-gray-600';
        td3.textContent = row.hospital_level || '-';
        tr.appendChild(td3);

        // province
        var td4 = document.createElement('td');
        td4.className = 'px-4 py-2 text-sm text-gray-600';
        td4.textContent = row.province || '-';
        tr.appendChild(td4);

        // status
        var td5 = document.createElement('td');
        td5.className = 'px-4 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-1 text-xs rounded-full ' +
            (row.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');
        statusSpan.textContent = row.status || '-';
        td5.appendChild(statusSpan);
        tr.appendChild(td5);

        tbody.appendChild(tr);
    });
}

function hoRenderPagination(page, totalPages) {
    var pagination = document.getElementById('ho-pagination');
    pagination.textContent = '';
    if (totalPages <= 1) return;

    function addBtn(text, pageNum, isActive) {
        var btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'px-3 py-1 border rounded text-sm ' + (isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-100');
        btn.onclick = function() { hoCurrentPage = pageNum; hoLoadData(); };
        pagination.appendChild(btn);
    }

    if (page > 1) addBtn('Prev', page - 1, false);
    for (var i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        addBtn(String(i), i, i === page);
    }
    if (page < totalPages) addBtn('Next', page + 1, false);
}

function hoDebounceSearch() {
    clearTimeout(hoSearchTimeout);
    hoSearchTimeout = setTimeout(function() {
        hoCurrentPage = 1;
        hoLoadData();
    }, 300);
}

function hoHandleFileSelect(input) {
    if (input.files && input.files[0]) {
        document.getElementById('ho-file-name').textContent = input.files[0].name;
        document.getElementById('ho-upload-area').classList.add('hidden');
        document.getElementById('ho-file-selected').classList.remove('hidden');
        document.getElementById('ho-btn-import').disabled = false;
    }
}

async function hoImportData() {
    var fileInput = document.getElementById('ho-import-file');
    if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select a file', 'error');
        return;
    }

    var mode = document.querySelector('input[name="ho-import-mode"]:checked').value;
    if (mode === 'replace' && !confirm('This will DELETE all existing data. Continue?')) return;

    var formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('mode', mode);

    document.getElementById('ho-btn-import').disabled = true;
    document.getElementById('ho-import-progress').classList.remove('hidden');
    document.getElementById('ho-import-result').classList.add('hidden');

    var progress = 0;
    var progressInterval = setInterval(function() {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        document.getElementById('ho-import-percent').textContent = Math.round(progress) + '%';
        document.getElementById('ho-import-bar').style.width = progress + '%';
    }, 500);

    try {
        var response = await fetch('/api/health-offices/import', {
            method: 'POST',
            body: formData
        });
        var result = await response.json();

        clearInterval(progressInterval);
        document.getElementById('ho-import-percent').textContent = '100%';
        document.getElementById('ho-import-bar').style.width = '100%';

        var resultDiv = document.getElementById('ho-import-result');
        resultDiv.textContent = '';

        if (result.success) {
            resultDiv.className = 'p-3 rounded-lg bg-green-100 text-green-800';
            resultDiv.textContent = 'Success! Imported: ' + result.imported.toLocaleString() +
                ' | Errors: ' + result.errors + ' | Time: ' + result.duration + 's';
            showToast('Import completed: ' + result.imported + ' records', 'success');
            hoLoadStats();
            hoLoadData();
        } else {
            resultDiv.className = 'p-3 rounded-lg bg-red-100 text-red-800';
            resultDiv.textContent = 'Error: ' + result.error;
            showToast('Import failed', 'error');
        }
        resultDiv.classList.remove('hidden');
    } catch (error) {
        clearInterval(progressInterval);
        showToast('Import error: ' + error.message, 'error');
    }

    document.getElementById('ho-btn-import').disabled = false;
    setTimeout(function() {
        document.getElementById('ho-import-progress').classList.add('hidden');
    }, 2000);
}

async function hoClearAllData() {
    if (!confirm('DELETE ALL health offices data? This cannot be undone.')) return;
    if (!confirm('Are you really sure?')) return;

    try {
        var response = await fetch('/api/health-offices/clear', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('All data cleared', 'success');
            hoLoadStats();
            hoLoadData();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== STATEMENT FUNCTIONS ====================

function initStatementYears() {
    var select = document.getElementById('stm-year');
    if (!select) return;

    var currentYear = new Date().getFullYear() + 543;
    select.textContent = '';

    for (var y = currentYear; y >= currentYear - 5; y--) {
        var option = document.createElement('option');
        option.value = y;
        option.textContent = '‡∏õ‡∏µ‡∏á‡∏ö ' + y;
        select.appendChild(option);
    }
}

async function downloadStatement() {
    var year = document.getElementById('bulk-start-year').value;
    var month = document.getElementById('bulk-start-month').value;  // Empty = all months
    var personType = document.getElementById('dl-patient-type').value;
    var autoImportCheckbox = document.getElementById('dl-stm-auto-import');
    var autoImport = autoImportCheckbox ? autoImportCheckbox.checked : false;

    // Disable button during download
    var downloadBtn = document.getElementById('download-btn');
    var btnText = document.getElementById('download-btn-text');
    var originalText = btnText.textContent;
    downloadBtn.disabled = true;
    btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...';

    try {
        var response = await fetch('/api/stm/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                year: year,
                month: month || null,  // null = all months
                scheme: 'ucs',  // Statement is UCS only
                person_type: personType,
                auto_import: autoImport
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('Statement download started' + (autoImport ? ' with auto-import' : ''), 'success');
            setTimeout(loadStatementFiles, 3000);
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Re-enable button
        downloadBtn.disabled = false;
        btnText.textContent = originalText;
    }
}

async function loadStatementFiles() {
    const listDiv = document.getElementById('stm-file-list');
    listDiv.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>';

    try {
        const response = await fetch('/api/stm/stats');
        const result = await response.json();

        // Update stats
        document.getElementById('stm-stat-total').textContent = result.total_files || 0;
        document.getElementById('stm-stat-imported').textContent = result.imported_count || 0;
        document.getElementById('stm-stat-pending').textContent = result.pending_count || 0;
        document.getElementById('stm-stat-size').textContent = result.total_size || '0 B';
        document.getElementById('stm-file-count').textContent = `‡πÅ‡∏™‡∏î‡∏á ${result.total_files || 0} ‡πÑ‡∏ü‡∏•‡πå`;

        // Show/hide action buttons
        const importAllBtn = document.getElementById('stm-import-all-btn');
        const clearBtn = document.getElementById('stm-clear-btn');
        const pendingCountSpan = document.getElementById('stm-pending-count');

        if (result.pending_count > 0) {
            importAllBtn.classList.remove('hidden');
            pendingCountSpan.textContent = result.pending_count;
        } else {
            importAllBtn.classList.add('hidden');
        }

        if (result.total_files > 0) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }

        listDiv.innerHTML = '';

        if (result.success && result.files && result.files.length > 0) {
            result.files.forEach(function(f) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Filename
                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-3';
                nameCell.innerHTML = `<span class="text-blue-600">&#9679;</span> ${f.filename}`;
                row.appendChild(nameCell);

                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-4 py-3 text-gray-600';
                const modDate = new Date(f.modified);
                dateCell.textContent = modDate.toLocaleString('th-TH');
                row.appendChild(dateCell);

                // Size
                const sizeCell = document.createElement('td');
                sizeCell.className = 'px-4 py-3 text-gray-600';
                sizeCell.textContent = f.size_formatted;
                row.appendChild(sizeCell);

                // Status
                const statusCell = document.createElement('td');
                statusCell.className = 'px-4 py-3';
                if (f.is_imported) {
                    let statusInfo = 'Imported';
                    if (f.imported_records) {
                        statusInfo += ` (${f.imported_records} records)`;
                    }
                    if (f.file_type) {
                        statusInfo = f.file_type.replace('_STM', '') + ' - ' + statusInfo;
                    }
                    statusCell.innerHTML = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">${statusInfo}</span>`;
                } else if (f.status === 'failed') {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Failed</span>';
                } else if (f.status === 'processing') {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Processing...</span>';
                } else {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Pending</span>';
                }
                row.appendChild(statusCell);

                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-4 py-3 text-right space-x-2';

                if (!f.is_imported) {
                    const importBtn = document.createElement('a');
                    importBtn.href = '#';
                    importBtn.className = 'text-blue-600 hover:text-blue-800 text-sm';
                    importBtn.textContent = 'Import';
                    importBtn.onclick = (e) => { e.preventDefault(); importStatementFile(f.filename); };
                    actionsCell.appendChild(importBtn);
                }

                const downloadBtn = document.createElement('a');
                downloadBtn.href = `/downloads/${f.filename}`;
                downloadBtn.className = 'text-purple-600 hover:text-purple-800 text-sm ml-2';
                downloadBtn.textContent = 'Download';
                downloadBtn.target = '_blank';
                actionsCell.appendChild(downloadBtn);

                const deleteBtn = document.createElement('a');
                deleteBtn.href = '#';
                deleteBtn.className = 'text-red-600 hover:text-red-800 text-sm ml-2';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = (e) => { e.preventDefault(); deleteStatementFile(f.filename); };
                actionsCell.appendChild(deleteBtn);

                row.appendChild(actionsCell);
                listDiv.appendChild(row);
            });
        } else {
            listDiv.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No Statement files found</td></tr>';
        }
    } catch (error) {
        listDiv.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Error loading files: ${error.message}</td></tr>`;
    }
}

async function importStatementFile(filename) {
    if (!confirm(`Import file: ${filename}?`)) return;

    try {
        showToast('Importing...', 'info');
        const response = await fetch(`/api/stm/import/${encodeURIComponent(filename)}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            const records = result.claim_records || result.imported_records || 0;
            const fileType = result.file_type ? ` (${result.file_type})` : '';
            showToast(`Imported ${records} records${fileType}`, 'success');
            loadStatementFiles();
        } else {
            showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function deleteStatementFile(filename) {
    if (!confirm(`Delete file: ${filename}?`)) return;

    try {
        const response = await fetch(`/api/stm/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
        const result = await response.json();

        if (result.success) {
            showToast('File deleted', 'success');
            loadStatementFiles();
        } else {
            showToast('Delete failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function importAllStatementFiles() {
    if (!confirm('Import all pending Statement files?')) return;

    try {
        showToast('Importing all files...', 'info');
        const response = await fetch('/api/stm/import-all', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(`Imported ${result.success} files, ${result.skipped} skipped`, 'success');
            loadStatementFiles();
        } else {
            showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function clearAllStatementFiles() {
    if (!confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå Statement ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) return;
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á - ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå Statement ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;

    try {
        const response = await fetch('/api/stm/clear', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            loadStatementFiles();
        } else {
            showToast('Clear failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== STM Schedule Functions ====================

function toggleStmSchedule() {
    const content = document.getElementById('stm-schedule-content');
    const arrow = document.getElementById('stm-schedule-arrow');
    content.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

function toggleStmScheduleEnabled() {
    const enabled = document.getElementById('stm-schedule-enabled').checked;
    // Just toggle the visual state, actual save happens on button click
}

async function loadStmScheduleSettings() {
    try {
        const response = await fetch('/api/stm/schedule');
        const result = await response.json();

        if (result.success) {
            // Set enabled toggle
            document.getElementById('stm-schedule-enabled').checked = result.stm_schedule_enabled;

            // Set schemes
            ['ucs', 'ofc', 'sss', 'lgo'].forEach(scheme => {
                const checkbox = document.getElementById('stm-scheme-' + scheme);
                if (checkbox) {
                    checkbox.checked = result.stm_schedule_schemes.includes(scheme);
                }
            });

            // Set auto import
            document.getElementById('stm-schedule-auto-import').checked = result.stm_schedule_auto_import;

            // Set times
            const timesContainer = document.getElementById('stm-schedule-times');
            timesContainer.innerHTML = '';
            if (result.stm_schedule_times && result.stm_schedule_times.length > 0) {
                result.stm_schedule_times.forEach(time => {
                    addStmScheduleTimeRow(time.hour, time.minute);
                });
            } else {
                addStmScheduleTimeRow(9, 0); // Default time
            }
        }
    } catch (error) {
        console.error('Error loading STM schedule settings:', error);
    }
}

function addStmScheduleTime() {
    addStmScheduleTimeRow(9, 0);
}

function addStmScheduleTimeRow(hour = 9, minute = 0) {
    const container = document.getElementById('stm-schedule-times');
    const row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    row.innerHTML = `
        <select class="stm-schedule-hour border rounded px-2 py-1 text-sm">
            ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === hour ? 'selected' : ''}>${String(i).padStart(2, '0')}</option>`).join('')}
        </select>
        <span>:</span>
        <select class="stm-schedule-minute border rounded px-2 py-1 text-sm">
            ${[0, 15, 30, 45].map(m => `<option value="${m}" ${m === minute ? 'selected' : ''}>${String(m).padStart(2, '0')}</option>`).join('')}
        </select>
        <span class="text-gray-500 text-sm">‡∏ô.</span>
        <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    container.appendChild(row);
}

async function saveStmSchedule() {
    try {
        const enabled = document.getElementById('stm-schedule-enabled').checked;
        const autoImport = document.getElementById('stm-schedule-auto-import').checked;

        // Get selected schemes
        const schemes = [];
        document.querySelectorAll('.stm-scheme-checkbox:checked').forEach(cb => {
            schemes.push(cb.value);
        });

        // Get times
        const times = [];
        document.querySelectorAll('#stm-schedule-times > div').forEach(row => {
            const hour = parseInt(row.querySelector('.stm-schedule-hour').value);
            const minute = parseInt(row.querySelector('.stm-schedule-minute').value);
            times.push({ hour, minute });
        });

        const response = await fetch('/api/stm/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stm_schedule_enabled: enabled,
                stm_schedule_times: times,
                stm_schedule_auto_import: autoImport,
                stm_schedule_schemes: schemes
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ STM ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function testStmSchedule() {
    if (!confirm('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ?')) return;

    try {
        showToast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info');
        const response = await fetch('/api/stm/schedule/test', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== Job History Functions ====================

function initJobDateFilters() {
    // Set default dates to current month (1st day to today)
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);

    const formatDate = (d) => d.toISOString().split('T')[0];

    const dateFromInput = document.getElementById('job-filter-date-from');
    const dateToInput = document.getElementById('job-filter-date-to');

    // Only set defaults if not already set
    if (dateFromInput && !dateFromInput.value) {
        dateFromInput.value = formatDate(firstDayOfMonth);
    }
    if (dateToInput && !dateToInput.value) {
        dateToInput.value = formatDate(today);
    }
}

function clearJobFilters() {
    document.getElementById('job-filter-type').value = '';
    document.getElementById('job-filter-status').value = '';
    document.getElementById('job-filter-date-from').value = '';
    document.getElementById('job-filter-date-to').value = '';
    loadJobHistory();
}

async function loadJobStats() {
    try {
        const response = await fetch('/api/jobs/stats?days=7');
        const data = await response.json();

        if (data.success) {
            const stats = data.stats;
            document.getElementById('stats-total').textContent = stats.total || 0;
            document.getElementById('stats-completed').textContent = stats.by_status?.completed || 0;
            document.getElementById('stats-failed').textContent = stats.by_status?.failed || 0;
            document.getElementById('stats-running').textContent = stats.by_status?.running || 0;
        }
    } catch (error) {
        console.error('Error loading job stats:', error);
    }
}

async function loadJobHistory() {
    const typeFilter = document.getElementById('job-filter-type')?.value || '';
    const statusFilter = document.getElementById('job-filter-status')?.value || '';
    const dateFromFilter = document.getElementById('job-filter-date-from')?.value || '';
    const dateToFilter = document.getElementById('job-filter-date-to')?.value || '';

    let url = '/api/jobs?limit=50';
    if (typeFilter) url += '&type=' + encodeURIComponent(typeFilter);
    if (statusFilter) url += '&status=' + encodeURIComponent(statusFilter);
    if (dateFromFilter) url += '&date_from=' + encodeURIComponent(dateFromFilter);
    if (dateToFilter) url += '&date_to=' + encodeURIComponent(dateToFilter);

    try {
        const response = await fetch(url);
        const data = await response.json();

        const tbody = document.getElementById('jobs-table-body');
        if (!tbody) return;

        // Clear existing content
        tbody.textContent = '';

        if (!data.success || !data.jobs || data.jobs.length === 0) {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '7');
            td.className = 'px-6 py-8 text-center text-gray-500';
            td.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏á‡∏≤‡∏ô';
            tr.appendChild(td);
            tbody.appendChild(tr);
            return;
        }

        data.jobs.forEach(function(job) {
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-50';

            // Job ID
            const tdId = document.createElement('td');
            tdId.className = 'px-4 py-3 whitespace-nowrap';
            const spanId = document.createElement('span');
            spanId.className = 'text-xs font-mono text-gray-600';
            spanId.textContent = job.job_id || '';
            tdId.appendChild(spanId);
            tr.appendChild(tdId);

            // Type
            const tdType = document.createElement('td');
            tdType.className = 'px-4 py-3 whitespace-nowrap';
            tdType.appendChild(createJobTypeElement(job.job_type, job.job_subtype));
            tr.appendChild(tdType);

            // Status
            const tdStatus = document.createElement('td');
            tdStatus.className = 'px-4 py-3 whitespace-nowrap';
            tdStatus.appendChild(createJobStatusBadge(job.status));
            tr.appendChild(tdStatus);

            // Started At
            const tdStarted = document.createElement('td');
            tdStarted.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-600';
            tdStarted.textContent = formatDateTime(job.started_at);
            tr.appendChild(tdStarted);

            // Duration
            const tdDuration = document.createElement('td');
            tdDuration.className = 'px-4 py-3 whitespace-nowrap text-sm text-gray-600';
            tdDuration.textContent = formatDuration(job.duration_seconds);
            tr.appendChild(tdDuration);

            // Results
            const tdResults = document.createElement('td');
            tdResults.className = 'px-4 py-3 text-sm text-gray-600';
            tdResults.textContent = formatJobResults(job.results);
            tr.appendChild(tdResults);

            // Triggered By
            const tdTriggered = document.createElement('td');
            tdTriggered.className = 'px-4 py-3 whitespace-nowrap';
            const spanTriggered = document.createElement('span');
            spanTriggered.className = 'text-xs px-2 py-1 rounded ' + (job.triggered_by === 'schedule' ? 'bg-purple-100 text-purple-700' : 'bg-gray-100 text-gray-600');
            spanTriggered.textContent = job.triggered_by === 'schedule' ? '‚è∞ Schedule' : 'üë§ Manual';
            tdTriggered.appendChild(spanTriggered);
            tr.appendChild(tdTriggered);

            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error('Error loading job history:', error);
        const tbody = document.getElementById('jobs-table-body');
        if (tbody) {
            tbody.textContent = '';
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.setAttribute('colspan', '7');
            td.className = 'px-6 py-8 text-center text-red-500';
            td.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
    }
}

function createJobStatusBadge(status) {
    const span = document.createElement('span');
    span.className = 'px-2 py-1 text-xs font-medium rounded-full';

    switch (status) {
        case 'running':
            span.className += ' bg-blue-100 text-blue-700 animate-pulse';
            span.textContent = 'üîÑ Running';
            break;
        case 'completed':
            span.className += ' bg-green-100 text-green-700';
            span.textContent = '‚úì Completed';
            break;
        case 'completed_with_errors':
            span.className += ' bg-yellow-100 text-yellow-700';
            span.textContent = '‚ö† With Errors';
            break;
        case 'failed':
            span.className += ' bg-red-100 text-red-700';
            span.textContent = '‚úó Failed';
            break;
        case 'cancelled':
            span.className += ' bg-gray-100 text-gray-700';
            span.textContent = '‚äò Cancelled';
            break;
        default:
            span.className += ' bg-gray-100 text-gray-600';
            span.textContent = status || 'Unknown';
    }
    return span;
}

function createJobTypeElement(type, subtype) {
    const typeIcons = {
        'download': 'üì•',
        'import': 'üì§',
        'schedule': '‚è∞'
    };
    const subtypeLabels = {
        'single': '‡πÄ‡∏î‡∏µ‡πà‡∏¢‡∏ß',
        'bulk': '‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå',
        'parallel': '‡∏Ç‡∏ô‡∏≤‡∏ô',
        'scheduled': '‡∏ï‡∏≤‡∏°‡∏Å‡∏≥‡∏´‡∏ô‡∏î'
    };

    const icon = typeIcons[type] || 'üìã';
    const typeName = type ? type.charAt(0).toUpperCase() + type.slice(1) : 'Unknown';
    const subtypeName = subtypeLabels[subtype] || subtype || '';

    const span = document.createElement('span');
    span.className = 'inline-flex items-center gap-1';
    span.textContent = icon + ' ' + typeName;

    if (subtypeName) {
        const subtypeSpan = document.createElement('span');
        subtypeSpan.className = 'text-xs text-gray-500';
        subtypeSpan.textContent = '(' + subtypeName + ')';
        span.appendChild(document.createTextNode(' '));
        span.appendChild(subtypeSpan);
    }

    return span;
}

function formatDuration(seconds) {
    if (!seconds && seconds !== 0) return '-';
    if (seconds < 60) return seconds + 's';
    if (seconds < 3600) return Math.floor(seconds / 60) + 'm ' + (seconds % 60) + 's';
    var hours = Math.floor(seconds / 3600);
    var mins = Math.floor((seconds % 3600) / 60);
    return hours + 'h ' + mins + 'm';
}

function formatDateTime(isoString) {
    if (!isoString) return '-';
    try {
        var date = new Date(isoString);
        return date.toLocaleString('th-TH', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    } catch (e) {
        return isoString;
    }
}

function formatJobResults(results) {
    if (!results) return '-';

    var parts = [];
    if (results.total_files !== undefined) {
        parts.push('üìÅ ' + results.total_files + ' files');
    }
    if (results.success_files !== undefined) {
        parts.push('‚úì ' + results.success_files);
    }
    if (results.failed_files !== undefined && results.failed_files > 0) {
        parts.push('‚úó ' + results.failed_files);
    }
    if (results.total_records !== undefined) {
        parts.push('üìä ' + results.total_records.toLocaleString() + ' records');
    }

    return parts.length > 0 ? parts.join(' | ') : JSON.stringify(results).substring(0, 50);
}

// ==================== System Health Functions ====================

var healthRefreshInterval = null;

async function loadSystemHealth() {
    try {
        var response = await fetch('/api/system/health');
        var data = await response.json();

        if (!data.success) {
            showToast('Error loading health: ' + (data.error || 'Unknown'), 'error');
            return;
        }

        // Update overall status banner
        updateOverallBanner(data);

        // Update each component card
        var components = data.components || {};
        updateHealthCard('database', components.database);
        updateHealthCard('disk', components.disk);
        updateHealthCard('memory', components.memory);
        updateHealthCard('processes', components.processes);
        updateHealthCard('jobs', components.jobs);
        updateHealthCard('files', components.files);

        // Show running processes detail if any
        updateProcessesDetail(components.processes);

        // Show stale PIDs warning if any
        updateStalePidsWarning(components.processes);

    } catch (error) {
        console.error('Error loading system health:', error);
    }
}

function updateOverallBanner(data) {
    var banner = document.getElementById('health-overall-banner');
    var icon = document.getElementById('health-overall-icon');
    var status = document.getElementById('health-overall-status');
    var time = document.getElementById('health-overall-time');
    var issuesBadge = document.getElementById('health-issues-badge');

    // Set icon and colors based on status
    var statusConfig = {
        'healthy': { icon: '‚úÖ', bg: 'bg-green-50', border: 'border-green-200', text: 'System Healthy' },
        'warning': { icon: '‚ö†Ô∏è', bg: 'bg-yellow-50', border: 'border-yellow-200', text: 'Warnings Detected' },
        'critical': { icon: 'üî¥', bg: 'bg-red-50', border: 'border-red-200', text: 'Critical Issues' }
    };

    var config = statusConfig[data.overall_status] || statusConfig.healthy;

    icon.textContent = config.icon;
    status.textContent = config.text;
    banner.className = 'mb-6 p-4 rounded-lg border-2 ' + config.bg + ' ' + config.border;

    // Format timestamp
    if (data.timestamp) {
        var ts = new Date(data.timestamp);
        time.textContent = 'Updated: ' + ts.toLocaleString('th-TH');
    }

    // Show issues badge if any
    var issues = data.issues || [];
    if (issues.length > 0) {
        issuesBadge.textContent = issues.length + ' issue' + (issues.length > 1 ? 's' : '');
        issuesBadge.classList.remove('hidden');
    } else {
        issuesBadge.classList.add('hidden');
    }
}

function updateHealthCard(componentName, componentData) {
    var card = document.getElementById('health-card-' + componentName);
    if (!card || !componentData) return;

    var badge = card.querySelector('.health-status-badge');
    var message = card.querySelector('.health-message');
    var progressBar = card.querySelector('.health-progress-bar');

    // Update badge
    var badgeConfig = {
        'healthy': { bg: 'bg-green-100', text: 'text-green-700', label: 'OK' },
        'warning': { bg: 'bg-yellow-100', text: 'text-yellow-700', label: 'Warning' },
        'critical': { bg: 'bg-red-100', text: 'text-red-700', label: 'Critical' }
    };
    var bc = badgeConfig[componentData.status] || badgeConfig.healthy;
    badge.className = 'health-status-badge px-2 py-1 rounded-full text-xs font-medium ' + bc.bg + ' ' + bc.text;
    badge.textContent = bc.label;

    // Update message
    message.textContent = componentData.message || '-';

    // Update progress bar for disk and memory
    if (progressBar) {
        var percent = 0;
        if (componentName === 'disk' && componentData.used_percent !== undefined) {
            percent = componentData.used_percent;
        } else if (componentName === 'memory' && componentData.used_percent !== undefined) {
            percent = componentData.used_percent;
        }

        progressBar.style.width = percent + '%';

        // Color based on percentage
        var barColor = 'bg-green-500';
        if (percent > 80) barColor = 'bg-yellow-500';
        if (percent > 90) barColor = 'bg-red-500';
        progressBar.className = 'health-progress-bar h-2 rounded-full ' + barColor;
    }
}

function updateProcessesDetail(processData) {
    var detail = document.getElementById('health-processes-detail');
    var list = document.getElementById('health-processes-list');

    if (!processData || !processData.running || processData.running.length === 0) {
        detail.classList.add('hidden');
        return;
    }

    detail.classList.remove('hidden');
    list.textContent = '';

    processData.running.forEach(function(proc) {
        var div = document.createElement('div');
        div.className = 'flex items-center justify-between p-2 bg-gray-50 rounded';

        var nameSpan = document.createElement('span');
        nameSpan.className = 'font-medium text-gray-700';
        nameSpan.textContent = proc.name;

        var infoSpan = document.createElement('span');
        infoSpan.className = 'text-sm text-gray-500';
        infoSpan.textContent = 'PID: ' + proc.pid + ' | Status: ' + proc.status;

        div.appendChild(nameSpan);
        div.appendChild(infoSpan);
        list.appendChild(div);
    });
}

function updateStalePidsWarning(processData) {
    var warning = document.getElementById('health-stale-pids');
    var staleList = document.getElementById('health-stale-list');

    if (!processData || !processData.stale_pids || processData.stale_pids.length === 0) {
        warning.classList.add('hidden');
        return;
    }

    warning.classList.remove('hidden');
    staleList.textContent = processData.stale_pids.join(', ');
}

function startHealthAutoRefresh() {
    // Stop any existing interval
    if (healthRefreshInterval) {
        clearInterval(healthRefreshInterval);
    }

    // Check if auto-refresh is enabled
    var checkbox = document.getElementById('health-auto-refresh');
    if (!checkbox || !checkbox.checked) return;

    // Start auto-refresh every 30 seconds
    healthRefreshInterval = setInterval(function() {
        // Only refresh if we're on the health tab
        if (currentTab === 'health') {
            var cb = document.getElementById('health-auto-refresh');
            if (cb && cb.checked) {
                loadSystemHealth();
            }
        }
    }, 30000);
}

function stopHealthAutoRefresh() {
    if (healthRefreshInterval) {
        clearInterval(healthRefreshInterval);
        healthRefreshInterval = null;
    }
}

async function runSystemSync() {
    if (!confirm('‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î Stale PIDs ‡πÅ‡∏•‡∏∞ Sync ‡∏£‡∏∞‡∏ö‡∏ö?')) return;

    try {
        showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ System Sync...', 'info');
        var response = await fetch('/api/system/sync-status', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('System Sync ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadSystemHealth();
        } else {
            showToast('Error: ' + (result.error || 'Unknown'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initFromUrl();
    populateYearDropdowns();
    initStatementYears();
    loadStatementFiles();
    loadScheduleSettings();
    loadStmScheduleSettings();
    loadSmtSettings();
    loadSmtStats();
    hoLoadStats();
    hoLoadData();

    // SMT settings form
    var smtForm = document.getElementById('smt-settings-form');
    if (smtForm) {
        smtForm.addEventListener('submit', saveSmtSettings);
    }

    // Bulk estimate listeners
    ['bulk-start-month', 'bulk-start-year', 'bulk-end-month', 'bulk-end-year'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', updateBulkEstimate);
    });

    // Scheme checkbox listeners for estimate update
    document.querySelectorAll('input[name="bulk-schemes"]').forEach(function(cb) {
        cb.addEventListener('change', updateBulkEstimate);
    });

    updateBulkEstimate();
});
</script>
{% endblock %}
