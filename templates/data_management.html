{% extends "base.html" %}

{% block title %}Data Management - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<!-- Header -->
<div class="mb-6">
    <h2 class="text-3xl font-bold text-gray-800 mb-2">Data Management</h2>
    <p class="text-gray-600">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• E-Claim: Download, Import, ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</p>
</div>

<!-- Tab Navigation -->
<div class="bg-white rounded-t-lg shadow-md border-b">
    <nav class="flex" id="tab-nav">
        <button onclick="switchTab('download')" id="tab-download" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
            </svg>
            Download
        </button>
        <button onclick="switchTab('rep')" id="tab-rep" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            REP Files ({{ stats.total_files }})
        </button>
        <button onclick="switchTab('statement')" id="tab-statement" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            Statement
        </button>
        <button onclick="switchTab('smt')" id="tab-smt" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            Smart Money Transfer
        </button>
        <button onclick="switchTab('settings')" id="tab-settings" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            Settings
        </button>
        <button onclick="switchTab('offices')" id="tab-offices" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
            <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
            </svg>
            Health Offices
        </button>
    </nav>
</div>

<!-- Tab Content Container -->
<div class="bg-white rounded-b-lg shadow-md">

    <!-- ==================== DOWNLOAD TAB ==================== -->
    <div id="content-download" class="tab-content p-6">
        <!-- Data Type Selector -->
        <div class="mb-6">
            <div class="flex gap-2 p-1 bg-gray-100 rounded-lg inline-flex">
                <button onclick="switchDownloadType('rep')" id="dl-type-rep" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm bg-blue-600 text-white">
                    üìÑ REP Files
                </button>
                <button onclick="switchDownloadType('statement')" id="dl-type-statement" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                    üìä Statement
                </button>
                <button onclick="switchDownloadType('smt')" id="dl-type-smt" class="dl-type-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                    üí∞ SMT Budget
                </button>
            </div>
        </div>

        <!-- Data Source Info -->
        <div id="dl-source-info" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <p class="text-sm text-blue-800">
                    <span id="dl-source-label" class="font-medium">REP (Request for Electronic Payment)</span> -
                    <a id="dl-source-link" href="https://eclaim.nhso.go.th/webComponent/" target="_blank" class="underline hover:text-blue-600">eclaim.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- Download Form -->
        <div class="border border-gray-200 rounded-lg p-6">
            <h3 id="dl-form-title" class="text-lg font-semibold mb-4 flex items-center text-blue-700">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP
            </h3>

            <div class="space-y-4">
                <!-- Basic Options: Year/Month (REP/Statement only) -->
                <div id="dl-year-month-section" class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="bulk-start-year" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</label>
                        <select id="bulk-start-month" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500">
                            <option value="" id="opt-all-months">‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</option>
                            <option value="1">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
                            <option value="2">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
                            <option value="3">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
                            <option value="4">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
                            <option value="5">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
                            <option value="6">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
                            <option value="7">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
                            <option value="8">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
                            <option value="9">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
                            <option value="10">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
                            <option value="11">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
                            <option value="12">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
                        </select>
                    </div>
                </div>

                <!-- Statement: Patient Type (hidden by default) -->
                <div id="dl-patient-type-section" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
                    <select id="dl-patient-type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        <option value="op">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)</option>
                        <option value="ip">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IP)</option>
                    </select>
                </div>

                <!-- Statement: UCS only (no scheme selection needed) -->
                <div id="dl-statement-scheme-section" class="hidden">
                    <div class="p-3 bg-purple-50 border border-purple-200 rounded-lg">
                        <p class="text-sm text-purple-800">
                            <strong>UC Statement</strong> - ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î UCS (‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                        </p>
                    </div>
                </div>

                <!-- Statement: Auto-import checkbox -->
                <div id="dl-statement-auto-import-section" class="hidden">
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" id="dl-stm-auto-import" class="w-4 h-4 text-purple-600 border-gray-300 rounded">
                        <span class="text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span>
                    </label>
                </div>

                <!-- SMT: Full Options (hidden by default) -->
                <div id="dl-vendor-section" class="hidden space-y-4">
                    <!-- Vendor ID + Fiscal Year (same row) -->
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Vendor ID (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)</label>
                            <input type="text" id="dl-vendor-id" placeholder="‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <p class="text-xs text-gray-500 mt-1">‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á = ‡∏ó‡∏±‡πâ‡∏á‡πÄ‡∏Ç‡∏ï</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                            <select id="dl-smt-fiscal-year" onchange="onSmtDownloadFiscalYearChange()" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </select>
                            <p class="text-xs text-gray-500 mt-1">‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                        </div>
                    </div>

                    <!-- Date Range -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
                                <input type="date" id="dl-smt-start-date" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                            <div>
                                <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                                <input type="date" id="dl-smt-end-date" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">‡∏õ‡∏µ‡∏á‡∏ö: 1 ‡∏ï.‡∏Ñ. ‡∏ñ‡∏∂‡∏á 30 ‡∏Å.‡∏¢. (‡∏õ‡∏µ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô = ‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ)</p>
                    </div>

                    <!-- Scheme (‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå</label>
                        <select id="dl-smt-scheme" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="UC">UC (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</option>
                            <option value="OF">OF (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</option>
                            <option value="SS">SS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                            <option value="LG">LG (‡∏≠‡∏õ‡∏ó.)</option>
                        </select>
                    </div>

                    <!-- Type (‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        <select id="dl-smt-type" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="OP">OP (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å)</option>
                            <option value="IP">IP (‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô)</option>
                            <option value="PP">PP (‡∏™‡πà‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô)</option>
                        </select>
                    </div>

                    <!-- SMT Auto Import -->
                    <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="dl-smt-auto-import" class="w-4 h-4 text-green-600 rounded mr-3" checked>
                            <div>
                                <span class="text-sm font-medium text-green-800">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>
                                <p class="text-xs text-green-600 mt-0.5">Import ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤ Database ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</p>
                            </div>
                        </label>
                    </div>
                </div>

                <!-- Advanced Settings (Collapsible) -->
                <details id="dl-advanced-settings" class="border border-gray-200 rounded-lg">
                    <summary class="px-4 py-3 cursor-pointer bg-gray-50 hover:bg-gray-100 rounded-t-lg font-medium text-gray-700 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                        </svg>
                        ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á
                    </summary>
                    <div class="p-4 space-y-4 border-t">
                        <!-- Hidden date range inputs (not needed since "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" downloads full fiscal year) -->
                        <input type="hidden" id="bulk-end-month" value="">
                        <input type="hidden" id="bulk-end-year" value="">

                        <!-- Insurance Schemes (REP only) -->
                        <div id="dl-schemes-section">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤</label>
                            <div class="grid grid-cols-4 gap-2 text-sm">
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="ucs" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="ofc" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="sss" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="lgo" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2">LGO (‡∏≠‡∏õ‡∏ó.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="nhs" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">NHS (‡∏™‡∏õ‡∏™‡∏ä.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="bkk" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">BKK (‡∏Å‡∏ó‡∏°.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="bmt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">BMT (‡∏Ç‡∏™‡∏°‡∏Å.)</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 hover:bg-gray-50 rounded border border-gray-100">
                                    <input type="checkbox" name="bulk-schemes" value="srt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2">SRT (‡∏£‡∏ü‡∏ó.)</span>
                                </label>
                            </div>
                            <div class="flex gap-2 mt-2">
                                <button type="button" onclick="selectAllSchemes('bulk')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <button type="button" onclick="selectDefaultSchemes('bulk')" class="text-xs px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded">‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å)</button>
                            </div>
                        </div>

                        <!-- Auto Import (REP only - Statement has its own checkbox) -->
                        <div id="dl-bulk-auto-import-section" class="border-t pt-4">
                            <label class="flex items-center cursor-pointer">
                                <input type="checkbox" id="bulk-auto-import" class="w-4 h-4 text-blue-600 rounded" checked>
                                <span class="ml-2 text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (Auto-import)</span>
                            </label>
                        </div>

                        <!-- Clear Download History -->
                        <div class="border-t pt-4">
                            <label class="block text-sm font-medium text-gray-700 mb-2">‡∏•‡πâ‡∏≤‡∏á Download History</label>
                            <p class="text-xs text-gray-500 mb-3">‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡πÑ‡∏°‡πà‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß)</p>
                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="clearDownloadHistory('rep')" class="px-3 py-1.5 bg-orange-100 hover:bg-orange-200 text-orange-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á REP History
                                </button>
                                <button type="button" onclick="clearDownloadHistory('stm')" class="px-3 py-1.5 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á Statement History
                                </button>
                                <button type="button" onclick="clearDownloadHistory('smt')" class="px-3 py-1.5 bg-green-100 hover:bg-green-200 text-green-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á SMT History
                                </button>
                                <button type="button" onclick="clearDownloadHistory('all')" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">
                                    ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                        </div>

                        <!-- Failed Downloads (Retry) -->
                        <div class="border-t pt-4">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700">Failed Downloads</label>
                                <button type="button" onclick="loadFailedDownloads()" class="text-blue-600 hover:text-blue-800 text-sm">
                                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                    </svg>
                                    ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä
                                </button>
                            </div>
                            <p class="text-xs text-gray-500 mb-3">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏ó‡∏µ‡πà‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ reset ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ</p>

                            <!-- Failed downloads count -->
                            <div id="failed-downloads-summary" class="mb-3 p-3 bg-gray-100 rounded-lg text-sm">
                                <span class="text-gray-500">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</span>
                            </div>

                            <!-- Failed downloads list (hidden by default) -->
                            <div id="failed-downloads-list" class="hidden mb-3 max-h-60 overflow-y-auto border border-gray-200 rounded-lg">
                                <!-- Populated by JavaScript -->
                            </div>

                            <div class="flex flex-wrap gap-2">
                                <button type="button" onclick="resetFailedDownloads('rep')" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-sm">
                                    Reset REP Failed
                                </button>
                                <button type="button" onclick="resetFailedDownloads('stm')" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-sm">
                                    Reset STM Failed
                                </button>
                                <button type="button" onclick="resetFailedDownloads()" class="px-3 py-1.5 bg-yellow-100 hover:bg-yellow-200 text-yellow-800 rounded text-sm">
                                    Reset All Failed
                                </button>
                                <button type="button" onclick="deleteFailedDownloads()" class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-800 rounded text-sm">
                                    ‡∏•‡∏ö Failed ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </button>
                            </div>
                        </div>
                    </div>
                </details>

                <!-- Estimate (REP only) -->
                <div id="dl-estimate-section" class="bg-gray-50 rounded-lg p-3">
                    <p id="bulk-estimate" class="text-sm text-gray-600"></p>
                </div>

                <!-- Download Button -->
                <button id="download-btn" onclick="downloadByType()" class="w-full bg-blue-600 hover:bg-blue-700 disabled:bg-gray-400 disabled:cursor-not-allowed text-white py-3 px-4 rounded-md font-medium transition-colors text-lg">
                    <svg id="download-icon" class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    <span id="download-btn-text">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </button>
            </div>
        </div>

        <!-- Bulk Progress -->
        <div id="bulk-progress" class="hidden mt-6 bg-blue-50 border border-blue-200 rounded-lg p-6">
            <h3 class="text-lg font-semibold text-blue-900 mb-4">Downloading...</h3>
            <div class="mb-4">
                <div class="flex justify-between text-sm text-blue-900 mb-2">
                    <span>Current: <span id="current-month" class="font-semibold"></span></span>
                    <span id="progress-count" class="font-semibold">0 / 0 months</span>
                </div>
                <div class="w-full bg-blue-200 rounded-full h-4 overflow-hidden">
                    <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                </div>
            </div>
            <span id="progress-percentage" class="text-lg font-bold text-blue-900">0%</span>
        </div>

        <!-- Scheduler Section (Collapsible) - REDESIGNED UI -->
        <details class="mt-6 border border-gray-200 rounded-lg shadow-sm" open>
            <summary class="p-4 cursor-pointer hover:bg-gray-50 rounded-lg flex items-center justify-between list-none">
                <div class="flex items-center">
                    <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span class="text-lg font-semibold text-gray-800">Auto Schedule</span>
                    <span id="schedule-summary" class="ml-3 text-sm text-gray-500"></span>
                </div>
                <div class="flex items-center gap-3">
                    <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                        <input type="checkbox" id="schedule-enabled" class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:ring-4 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-purple-600"></div>
                    </label>
                    <svg class="w-5 h-5 text-gray-400 transition-transform details-arrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>
            </summary>
            <div class="p-5 pt-3 border-t border-gray-100 bg-gray-50/50">

                <!-- ===== STEP 1: Schedule Times ===== -->
                <div class="mb-5">
                    <div class="flex items-center mb-3">
                        <span class="w-7 h-7 rounded-full bg-purple-600 text-white text-sm font-bold flex items-center justify-center mr-2">1</span>
                        <span class="font-semibold text-gray-800">‡πÄ‡∏ß‡∏•‡∏≤‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î</span>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <div id="schedule-times-container" class="flex flex-wrap gap-2 min-h-[40px] items-center">
                            <p class="text-sm text-gray-400" id="no-schedules-message">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ ‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤" ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á</p>
                        </div>
                        <button onclick="addScheduleTime()" class="mt-3 inline-flex items-center text-purple-600 hover:text-purple-800 text-sm font-medium transition-colors">
                            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                            </svg>
                            ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ß‡∏•‡∏≤
                        </button>
                    </div>
                </div>

                <!-- ===== STEP 2: Data Types Selection (Card Based) ===== -->
                <div class="mb-5">
                    <div class="flex items-center mb-3">
                        <span class="w-7 h-7 rounded-full bg-purple-600 text-white text-sm font-bold flex items-center justify-center mr-2">2</span>
                        <span class="font-semibold text-gray-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                        <span class="ml-2 text-xs text-gray-500">(‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó)</span>
                    </div>

                    <!-- REP Files Card -->
                    <div class="bg-white rounded-lg border border-gray-200 mb-3 overflow-hidden transition-all" id="card-type-rep">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleScheduleTypeCard('rep')">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">üìÑ</span>
                                <div>
                                    <span class="font-medium text-gray-800">REP Files</span>
                                    <span class="text-xs text-gray-500 ml-2">‡πÉ‡∏ö‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå</span>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                                <input type="checkbox" id="schedule-type-rep" class="sr-only peer" checked onchange="updateScheduleCardState('rep')">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-blue-600"></div>
                            </label>
                        </div>
                        <div id="rep-settings" class="px-4 pb-4 border-t border-gray-100 bg-blue-50/30">
                            <p class="text-xs text-gray-600 py-2 mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î:</p>
                            <div class="grid grid-cols-4 gap-2 text-sm">
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="ucs" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">UCS</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="ofc" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">OFC</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="sss" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">SSS</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="lgo" class="w-4 h-4 text-blue-600 rounded" checked>
                                    <span class="ml-2 text-gray-700">LGO</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="nhs" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">NHS</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="bkk" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">BKK</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="bmt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">BMT</span>
                                </label>
                                <label class="flex items-center cursor-pointer p-2 bg-white hover:bg-blue-50 rounded border border-gray-200 transition-colors schedule-scheme-item">
                                    <input type="checkbox" name="schedule-schemes" value="srt" class="w-4 h-4 text-blue-600 rounded">
                                    <span class="ml-2 text-gray-700">SRT</span>
                                </label>
                            </div>
                            <div class="mt-2 flex gap-2">
                                <button type="button" onclick="selectAllScheduleSchemes()" class="text-xs text-blue-600 hover:text-blue-800">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                                <span class="text-gray-300">|</span>
                                <button type="button" onclick="selectMainScheduleSchemes()" class="text-xs text-blue-600 hover:text-blue-800">4 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å</button>
                                <span class="text-gray-300">|</span>
                                <button type="button" onclick="deselectAllScheduleSchemes()" class="text-xs text-gray-500 hover:text-gray-700">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                            </div>
                        </div>
                    </div>

                    <!-- UC Statement Card -->
                    <div class="bg-white rounded-lg border border-gray-200 mb-3 overflow-hidden transition-all opacity-60" id="card-type-stm">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleScheduleTypeCard('stm')">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">üìä</span>
                                <div>
                                    <span class="font-medium text-gray-800">UC Statement</span>
                                    <span class="text-xs text-purple-600 ml-2 bg-purple-100 px-2 py-0.5 rounded">UCS ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</span>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                                <input type="checkbox" id="schedule-type-stm" class="sr-only peer" onchange="updateScheduleCardState('stm')">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-purple-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-purple-600"></div>
                            </label>
                        </div>
                        <div id="stm-settings" class="px-4 pb-3 border-t border-gray-100 bg-purple-50/30 hidden">
                            <p class="text-xs text-purple-700 py-2">‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î UCS (‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤)</p>
                        </div>
                    </div>

                    <!-- SMT Budget Card -->
                    <div class="bg-white rounded-lg border border-gray-200 overflow-hidden transition-all opacity-60" id="card-type-smt">
                        <div class="flex items-center justify-between p-3 cursor-pointer" onclick="toggleScheduleTypeCard('smt')">
                            <div class="flex items-center">
                                <span class="text-xl mr-2">üí∞</span>
                                <div>
                                    <span class="font-medium text-gray-800">SMT Budget</span>
                                    <span class="text-xs text-gray-500 ml-2">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</span>
                                </div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer" onclick="event.stopPropagation()">
                                <input type="checkbox" id="schedule-type-smt" class="sr-only peer" onchange="updateScheduleCardState('smt')">
                                <div class="w-9 h-5 bg-gray-300 peer-focus:ring-2 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-green-600"></div>
                            </label>
                        </div>
                        <div id="smt-settings" class="px-4 pb-3 border-t border-gray-100 bg-green-50/30 hidden">
                            <label class="block text-xs text-gray-600 py-2 mb-1">Vendor ID:</label>
                            <input type="text" id="schedule-smt-vendor-id" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670"
                                   class="w-full max-w-xs border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-green-500 focus:border-green-500">
                            <p class="text-xs text-gray-500 mt-1">‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏à‡∏≤‡∏Å Settings ‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</p>
                        </div>
                    </div>
                </div>

                <!-- ===== STEP 3: Options ===== -->
                <div class="mb-5">
                    <div class="flex items-center mb-3">
                        <span class="w-7 h-7 rounded-full bg-purple-600 text-white text-sm font-bold flex items-center justify-center mr-2">3</span>
                        <span class="font-semibold text-gray-800">‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</span>
                    </div>
                    <div class="bg-white rounded-lg border border-gray-200 p-4">
                        <label class="flex items-center cursor-pointer">
                            <input type="checkbox" id="schedule-auto-import" class="w-5 h-5 text-purple-600 rounded border-gray-300">
                            <span class="ml-3 text-sm text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏´‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à</span>
                        </label>
                    </div>
                </div>

                <!-- ===== Save Button ===== -->
                <button onclick="saveScheduleSettings()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 px-4 rounded-lg font-medium text-sm transition-colors flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                    </svg>
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
                </button>

                <!-- ===== Status Summary ===== -->
                <div id="schedule-status-box" class="mt-4 p-4 bg-white rounded-lg border border-gray-200">
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-gray-700">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>
                        <span id="schedule-status" class="text-sm">Loading...</span>
                    </div>
                </div>
            </div>
        </details>
    </div>

    <!-- ==================== REP FILES TAB ==================== -->
    <div id="content-rep" class="tab-content p-6 hidden">
        <!-- REP Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                REP Files (Request for Electronic Payment)
            </h2>
            <div class="mt-2 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-sm text-blue-800">
                    <strong>REP</strong> (Request for Electronic Payment) ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏ö‡∏Ç‡∏≠‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏≠‡∏¥‡πÄ‡∏•‡πá‡∏Å‡∏ó‡∏£‡∏≠‡∏ô‡∏¥‡∏Å‡∏™‡πå
                    ‡∏ó‡∏µ‡πà‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏°‡∏≤‡∏¢‡∏±‡∏á <strong>‡∏™‡∏õ‡∏™‡∏ä.</strong> (‡∏™‡∏≥‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡πÅ‡∏´‡πà‡∏á‡∏ä‡∏≤‡∏ï‡∏¥)
                    ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡πÄ‡∏ö‡∏¥‡∏Å‡∏Ñ‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏´‡∏•‡∏±‡∏Å‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û
                </p>
                <p class="text-xs text-blue-600 mt-1">
                    Data Source: <a href="https://eclaim.nhso.go.th/webComponent/" target="_blank" class="underline hover:text-blue-800">eclaim.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- REP Sub-tabs -->
        <div class="flex space-x-2 mb-6">
            <button onclick="switchRepSubtab('files')" id="rep-subtab-btn-files" class="rep-subtab-btn px-4 py-2 rounded-md font-medium text-sm bg-blue-600 text-white">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button onclick="switchRepSubtab('database')" id="rep-subtab-btn-database" class="rep-subtab-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- ===== REP Files Sub-tab ===== -->
        <div id="rep-subtab-files">
        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-blue-700">{{ stats.total_files }}</p>
                <p class="text-sm text-blue-600">Total Files</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-green-700">{{ stats.imported_count }}</p>
                <p class="text-sm text-green-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-yellow-700">{{ stats.not_imported_count }}</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p class="text-2xl font-bold text-gray-700">{{ stats.total_size }}</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="bg-gray-50 rounded-lg p-4 mb-4">
            <div class="flex flex-wrap items-end gap-4">
                <!-- Date Range Filter -->
                <div class="flex items-end gap-2">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏à‡∏≤‡∏Å</label>
                        <div class="flex gap-1">
                            <select id="filter-start-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                {% for date in available_dates %}
                                <option value="{{ date.month }},{{ date.year }}">{{ date.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <span class="text-gray-400 pb-1.5">-</span>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <div class="flex gap-1">
                            <select id="filter-end-month" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                                <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                                {% for date in available_dates %}
                                <option value="{{ date.month }},{{ date.year }}" {% if loop.first %}selected{% endif %}>{{ date.label }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Scheme Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</label>
                    <select id="filter-scheme" class="border border-gray-300 rounded-md px-2 py-1.5 text-sm">
                        <option value="">‡∏ó‡∏∏‡∏Å‡∏™‡∏¥‡∏ó‡∏ò‡∏¥</option>
                        <option value="ucs">UCS (‡∏ö‡∏±‡∏ï‡∏£‡∏ó‡∏≠‡∏á)</option>
                        <option value="ofc">OFC (‡∏Ç‡πâ‡∏≤‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£)</option>
                        <option value="sss">SSS (‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô‡∏™‡∏±‡∏á‡∏Ñ‡∏°)</option>
                        <option value="lgo">LGO (‡∏≠‡∏õ‡∏ó.)</option>
                        <option value="nhs">NHS (‡∏™‡∏õ‡∏™‡∏ä.)</option>
                        <option value="bkk">BKK (‡∏Å‡∏ó‡∏°.)</option>
                        <option value="bmt">BMT (‡∏Ç‡∏™‡∏°‡∏Å.)</option>
                        <option value="srt">SRT (‡∏£‡∏ü‡∏ó.)</option>
                    </select>
                </div>

                <!-- Status Filter -->
                <div>
                    <label class="block text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                    <div class="flex gap-1">
                        <button onclick="filterFilesStatus('all')" id="filter-all" class="file-filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-blue-600 text-white">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
                        <button onclick="filterFilesStatus('imported')" id="filter-imported" class="file-filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700">‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡πÅ‡∏•‡πâ‡∏ß</button>
                        <button onclick="filterFilesStatus('pending')" id="filter-pending" class="file-filter-btn px-3 py-1.5 text-sm font-medium rounded-md bg-gray-200 text-gray-700">‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤</button>
                    </div>
                </div>

                <!-- Apply Button -->
                <button onclick="applyFilesFilter()" class="bg-blue-600 hover:bg-blue-700 text-white py-1.5 px-4 rounded-md font-medium text-sm">
                    ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                </button>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á {{ files|length }} ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                {% if stats.not_imported_count > 0 %}
                <button onclick="importAllFiles()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ({{ stats.not_imported_count }})
                </button>
                {% endif %}
                {% if files|length > 0 %}
                <button onclick="clearAllData()" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                {% endif %}
            </div>
        </div>

        <!-- Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Filename</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Size</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200" id="files-table-body">
                    {% for file in files %}
                    <tr class="hover:bg-gray-50 file-row" data-status="{% if file.imported %}imported{% else %}pending{% endif %}">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                {% if '_OP_' in file.filename %}
                                <span class="w-2 h-2 bg-blue-500 rounded-full mr-2"></span>
                                {% elif '_IP_' in file.filename %}
                                <span class="w-2 h-2 bg-purple-500 rounded-full mr-2"></span>
                                {% elif '_ORF_' in file.filename %}
                                <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
                                {% else %}
                                <span class="w-2 h-2 bg-gray-500 rounded-full mr-2"></span>
                                {% endif %}
                                <span class="text-sm font-medium text-gray-900">{{ file.filename }}</span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ file.date_formatted }}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">{{ file.size_formatted }}</td>
                        <td class="px-4 py-3">
                            {% if file.imported %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                Imported ({{ file.import_status.imported_records }})
                            </span>
                            {% else %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                Pending
                            </span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3 text-right">
                            {% if not file.imported %}
                            <button onclick="importFile('{{ file.filename }}')" class="text-purple-600 hover:text-purple-800 text-sm font-medium mr-2">Import</button>
                            {% endif %}
                            <a href="{{ url_for('download_file', filename=file.filename) }}" class="text-blue-600 hover:text-blue-800 text-sm font-medium mr-2">Download</a>
                            <button onclick="deleteFile('{{ file.filename }}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">
                            No files found. Click Download tab to start downloading.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        {% if total_pages > 1 %}
        <div class="mt-4 flex items-center justify-between">
            <p class="text-sm text-gray-600">Page {{ page }} of {{ total_pages }}</p>
            <div class="flex gap-2">
                {% if page > 1 %}
                <a href="?tab=files&page={{ page - 1 }}&month={{ filter_month }}&year={{ filter_year }}" class="px-3 py-1 border rounded text-sm">Previous</a>
                {% endif %}
                {% if page < total_pages %}
                <a href="?tab=files&page={{ page + 1 }}&month={{ filter_month }}&year={{ filter_year }}" class="px-3 py-1 border rounded text-sm">Next</a>
                {% endif %}
            </div>
        </div>
        {% endif %}
        </div>
        <!-- End REP Files Sub-tab -->

        <!-- ===== REP Database Sub-tab ===== -->
        <div id="rep-subtab-database" class="hidden">
            <!-- Help/Info Section -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm">
                        <p class="font-semibold text-blue-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Reconciliation (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î REP ‡∏Å‡∏±‡∏ö Statement)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-700">
                            <div>
                                <p class="font-medium mb-1">Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</p>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î REP ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab Statement)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ <strong>tran_id</strong> ‡πÄ‡∏õ‡πá‡∏ô key</li>
                                </ol>
                            </div>
                            <div>
                                <p class="font-medium mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</p>
                                <ul class="space-y-1 text-xs">
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">Matched</span> - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (tran_id ‡∏ï‡∏£‡∏á, ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á)</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs">Diff</span> - ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">REP Only</span> - ‡∏°‡∏µ‡πÉ‡∏ô REP ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô Statement (‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Statement)</li>
                                </ul>
                                <p class="mt-2 text-xs text-blue-600">
                                    <strong>Note:</strong> ‡∏´‡∏≤‡∏Å Statement ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "REP Only" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-blue-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-total" class="text-2xl font-bold text-blue-700">0</p>
                    <p class="text-sm text-blue-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-matched" class="text-2xl font-bold text-green-700">0</p>
                    <p class="text-sm text-green-600">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Statement</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-diff" class="text-2xl font-bold text-yellow-700">0</p>
                    <p class="text-sm text-yellow-600">‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <p id="rep-db-stat-unmatched" class="text-2xl font-bold text-red-700">0</p>
                    <p class="text-sm text-red-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô Statement</p>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-end gap-4">
                    <!-- View Mode -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                        <select id="rep-db-view-mode" onchange="loadRepDbRecords(1)" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="rep">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° REP No</option>
                            <option value="tran">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transaction</option>
                        </select>
                    </div>

                    <!-- Fiscal Year -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="rep-db-fiscal-year" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-28">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>

                    <!-- REP No Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">REP No</label>
                        <input type="text" id="rep-db-rep-no" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ REP" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="rep-db-status" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="matched">Matched</option>
                            <option value="diff_amount">Amount Diff</option>
                            <option value="rep_only">REP Only</option>
                        </select>
                    </div>

                    <!-- Search Button -->
                    <button onclick="loadRepDbRecords(1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <!-- Clear -->
                    <button onclick="clearRepDbFilter()" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 text-sm">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>

                    <!-- Actions -->
                    <div class="ml-auto flex gap-2">
                        <button onclick="refreshRepDbRecords()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button onclick="clearRepDatabase()" class="bg-red-100 hover:bg-red-200 text-red-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="flex items-center justify-between mb-2">
                <div id="rep-db-result-count" class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <!-- Database Table -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="rep-db-table-header">
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">REP No</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î REP</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î STM</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="rep-db-records-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å Refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="rep-db-pagination" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    Page <span id="rep-db-current-page">1</span> of <span id="rep-db-total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadRepDbRecords(currentRepDbPage - 1)" id="rep-db-prev-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                    <button onclick="loadRepDbRecords(currentRepDbPage + 1)" id="rep-db-next-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
        <!-- End REP Database Sub-tab -->
    </div>

    <!-- ==================== STATEMENT TAB ==================== -->
    <div id="content-statement" class="tab-content p-6 hidden">
        <!-- Statement Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                UC Statement Files
            </h2>
            <div class="mt-2 p-3 bg-purple-50 border border-purple-200 rounded-lg">
                <p class="text-sm text-purple-800">
                    <strong>Statement</strong> ‡∏Ñ‡∏∑‡∏≠ ‡πÉ‡∏ö‡πÅ‡∏à‡πâ‡∏á‡∏¢‡∏≠‡∏î‡∏™‡∏£‡∏∏‡∏õ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ö‡∏¥‡∏Å‡∏à‡πà‡∏≤‡∏¢ ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.
                    ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏ô (IP) ‡πÅ‡∏•‡∏∞‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏≠‡∏Å (OP)
                </p>
                <p class="text-xs text-purple-600 mt-1">
                    Data Source: <a href="https://eclaim.nhso.go.th/webComponent/ucs/statementUCSAction.do" target="_blank" class="underline hover:text-purple-800">eclaim.nhso.go.th (Statement NHSO)</a>
                </p>
            </div>
        </div>

        <!-- Statement Sub-tabs -->
        <div class="flex space-x-2 mb-6">
            <button onclick="switchStatementSubtab('files')" id="stm-subtab-btn-files" class="stm-subtab-btn px-4 py-2 rounded-md font-medium text-sm bg-purple-600 text-white">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button onclick="switchStatementSubtab('database')" id="stm-subtab-btn-database" class="stm-subtab-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- ===== Statement Files Sub-tab ===== -->
        <div id="stm-subtab-files">
        <!-- File Stats -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-purple-50 rounded-lg p-4 text-center">
                <p id="stm-stat-total" class="text-2xl font-bold text-purple-700">0</p>
                <p class="text-sm text-purple-600">Total Files</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="stm-stat-imported" class="text-2xl font-bold text-green-700">0</p>
                <p class="text-sm text-green-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p id="stm-stat-pending" class="text-2xl font-bold text-yellow-700">0</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="stm-stat-size" class="text-2xl font-bold text-gray-700">0 B</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div id="stm-file-count" class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                <button id="stm-import-all-btn" onclick="importAllStatementFiles()" class="hidden bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="stm-pending-count">0</span>)
                </button>
                <button id="stm-clear-btn" onclick="clearAllStatementFiles()" class="hidden bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- Statement Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FILENAME</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SIZE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="stm-file-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        </div>
        <!-- End Statement Files Sub-tab -->

        <!-- ===== Statement Database Sub-tab ===== -->
        <div id="stm-subtab-database" class="hidden">
            <!-- Help/Info Section -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <div class="text-sm">
                        <p class="font-semibold text-blue-800 mb-2">‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô Reconciliation (‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î Statement ‡∏Å‡∏±‡∏ö REP)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-blue-700">
                            <div>
                                <p class="font-medium mb-1">Flow ‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô:</p>
                                <ol class="list-decimal list-inside space-y-1 text-xs">
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î REP ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. (tab REP Files)</li>
                                    <li>‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP ‡πÄ‡∏Ç‡πâ‡∏≤‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                                    <li>‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏±‡∏ö‡∏Ñ‡∏π‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ <strong>tran_id</strong> ‡πÄ‡∏õ‡πá‡∏ô key</li>
                                </ol>
                            </div>
                            <div>
                                <p class="font-medium mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</p>
                                <ul class="space-y-1 text-xs">
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">Matched</span> - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (tran_id ‡∏ï‡∏£‡∏á, ‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏á)</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-yellow-100 text-yellow-700 text-xs">Diff</span> - ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡∏¢‡∏≠‡∏î‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</li>
                                    <li><span class="inline-block px-2 py-0.5 rounded bg-red-100 text-red-700 text-xs">STM Only</span> - ‡∏°‡∏µ‡πÉ‡∏ô Statement ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô REP (‡∏£‡∏≠‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ REP)</li>
                                </ul>
                                <p class="mt-2 text-xs text-blue-600">
                                    <strong>Note:</strong> ‡∏´‡∏≤‡∏Å REP ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô "STM Only" ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
                <div class="bg-purple-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-total" class="text-2xl font-bold text-purple-700">0</p>
                    <p class="text-sm text-purple-600">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                </div>
                <div class="bg-green-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-matched" class="text-2xl font-bold text-green-700">0</p>
                    <p class="text-sm text-green-600">‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö REP</p>
                </div>
                <div class="bg-yellow-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-diff" class="text-2xl font-bold text-yellow-700">0</p>
                    <p class="text-sm text-yellow-600">‡∏¢‡∏≠‡∏î‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á</p>
                </div>
                <div class="bg-red-50 rounded-lg p-4 text-center">
                    <p id="stm-db-stat-unmatched" class="text-2xl font-bold text-red-700">0</p>
                    <p class="text-sm text-red-600">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÉ‡∏ô REP</p>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-end gap-4">
                    <!-- View Mode -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</label>
                        <select id="stm-db-view-mode" onchange="loadStmDbRecords(1)" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="rep">‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ï‡∏≤‡∏° REP No</option>
                            <option value="tran">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Transaction</option>
                        </select>
                    </div>

                    <!-- Fiscal Year -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="stm-db-fiscal-year" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-28">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>

                    <!-- REP No Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">REP No</label>
                        <input type="text" id="stm-db-rep-no" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ REP" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>

                    <!-- Status Filter -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</label>
                        <select id="stm-db-status" class="border border-gray-300 rounded px-3 py-1.5 text-sm">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                            <option value="matched">Matched</option>
                            <option value="diff_amount">Amount Diff</option>
                            <option value="stm_only">STM Only</option>
                        </select>
                    </div>

                    <!-- Search Button -->
                    <button onclick="loadStmDbRecords(1)" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-1.5 rounded text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <!-- Clear -->
                    <button onclick="clearStmDbFilter()" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 text-sm">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>

                    <!-- Actions -->
                    <div class="ml-auto flex gap-2">
                        <button onclick="refreshStmDbRecords()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Refresh
                        </button>
                        <button onclick="clearStmDatabase()" class="bg-red-100 hover:bg-red-200 text-red-700 py-1.5 px-3 rounded-md text-sm">
                            <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                            ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Count -->
            <div class="flex items-center justify-between mb-2">
                <div id="stm-db-result-count" class="text-sm text-gray-600">‡πÅ‡∏™‡∏î‡∏á 0 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>

            <!-- Database Table -->
            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr id="stm-db-table-header">
                            <!-- Headers will be set by JS based on view mode -->
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">REP No</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î STM</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏¢‡∏≠‡∏î REP</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">‡∏ú‡∏•‡∏ï‡πà‡∏≤‡∏á</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="stm-db-records-body" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">‡∏Ñ‡∏•‡∏¥‡∏Å Refresh ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="stm-db-pagination" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    Page <span id="stm-db-current-page">1</span> of <span id="stm-db-total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadStmDbRecords(currentStmDbPage - 1)" id="stm-db-prev-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                    <button onclick="loadStmDbRecords(currentStmDbPage + 1)" id="stm-db-next-btn" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
        <!-- End Statement Database Sub-tab -->
    </div>

    <!-- ==================== SMT TAB ==================== -->
    <div id="content-smt" class="tab-content p-6 hidden">
        <!-- SMT Header -->
        <div class="mb-6">
            <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Smart Money Transfer Files (SMT Budget)
            </h2>
            <div class="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                <p class="text-sm text-green-800">
                    <strong>SMT</strong> (Smart Money Transfer) ‡∏Ñ‡∏∑‡∏≠ ‡∏£‡∏∞‡∏ö‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.
                    ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏≤‡∏°‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏¢‡∏≠‡∏î‡∏Å‡∏±‡∏ö E-Claim
                </p>
                <p class="text-xs text-green-600 mt-1">
                    Data Source: <a href="https://smt.nhso.go.th" target="_blank" class="underline hover:text-green-800">smt.nhso.go.th</a>
                </p>
            </div>
        </div>

        <!-- SMT Sub-tabs -->
        <div class="flex space-x-2 mb-6">
            <button onclick="switchSmtSubtab('files')" id="smt-subtab-btn-files" class="smt-subtab-btn px-4 py-2 rounded-md font-medium text-sm bg-green-600 text-white">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå
            </button>
            <button onclick="switchSmtSubtab('database')" id="smt-subtab-btn-database" class="smt-subtab-btn px-4 py-2 rounded-md font-medium text-sm text-gray-600 hover:bg-gray-200">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                </svg>
                ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            </button>
        </div>

        <!-- ===== SMT Files Sub-tab ===== -->
        <div id="smt-subtab-files">
            <!-- File Stats -->
            <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="smt-stat-total" class="text-2xl font-bold text-green-700">0</p>
                <p class="text-sm text-green-600">Total Files</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p id="smt-stat-imported" class="text-2xl font-bold text-blue-700">0</p>
                <p class="text-sm text-blue-600">Imported</p>
            </div>
            <div class="bg-yellow-50 rounded-lg p-4 text-center">
                <p id="smt-stat-pending" class="text-2xl font-bold text-yellow-700">0</p>
                <p class="text-sm text-yellow-600">Pending</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="smt-stat-size" class="text-2xl font-bold text-gray-700">0 B</p>
                <p class="text-sm text-gray-600">Total Size</p>
            </div>
        </div>

        <!-- Actions Bar -->
        <div class="flex items-center justify-between mb-4">
            <div id="smt-file-count" class="text-sm text-gray-600">
                ‡πÅ‡∏™‡∏î‡∏á 0 ‡πÑ‡∏ü‡∏•‡πå
            </div>
            <div class="flex gap-2">
                <button id="smt-import-all-btn" onclick="importAllSmtFiles()" class="hidden bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium text-sm">
                    ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (<span id="smt-pending-count">0</span>)
                </button>
                <button id="smt-clear-btn" onclick="clearAllSmtFiles()" class="hidden bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium text-sm" title="‡∏•‡∏ö‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå CSV ‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
            </div>
        </div>

        <!-- SMT Files Table -->
        <div class="border border-gray-200 rounded-lg overflow-hidden">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">FILENAME</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">DATE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SIZE</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                        <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                    </tr>
                </thead>
                <tbody id="smt-file-list" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Files Pagination -->
        <div id="smt-files-pagination" class="mt-4 flex items-center justify-between hidden">
            <div class="text-sm text-gray-500">
                Page <span id="smt-files-page">1</span> of <span id="smt-files-total-pages">1</span>
            </div>
            <div class="flex gap-2">
                <button onclick="loadSmtFilesPage(currentSmtFilesPage - 1)" id="smt-files-prev" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                <button onclick="loadSmtFilesPage(currentSmtFilesPage + 1)" id="smt-files-next" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
            </div>
        </div>
        </div>
        <!-- End SMT Files Sub-tab -->

        <!-- ===== SMT Database Sub-tab ===== -->
        <div id="smt-subtab-database" class="hidden">
        <!-- Database Records Section -->
        <div>
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    Database Records
                    <span id="smt-db-count" class="ml-2 text-sm font-normal text-gray-500">0 records</span>
                </h3>
                <div class="flex gap-2">
                    <button onclick="refreshSmtDbRecords()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-1.5 px-3 rounded-md text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                    <button onclick="clearSmtDatabase()" class="bg-red-100 hover:bg-red-200 text-red-700 py-1.5 px-3 rounded-md text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
            </div>

            <!-- Filter Controls -->
            <div class="bg-gray-50 border border-gray-200 rounded-lg p-4 mb-4">
                <div class="flex flex-wrap items-end gap-4">
                    <!-- Fiscal Year -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</label>
                        <select id="smt-db-fiscal-year" onchange="onSmtFiscalYearChange()" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                            <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                        </select>
                    </div>

                    <!-- Date Range -->
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà</label>
                        <input type="text" id="smt-db-start-date" placeholder="dd/mm/yyyy" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">‡∏ñ‡∏∂‡∏á</label>
                        <input type="text" id="smt-db-end-date" placeholder="dd/mm/yyyy" class="border border-gray-300 rounded px-3 py-1.5 text-sm w-32">
                    </div>

                    <!-- Search Button -->
                    <button onclick="loadSmtDbRecords(1)" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-1.5 rounded text-sm">
                        <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                        ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
                    </button>

                    <!-- Clear Filter -->
                    <button onclick="clearSmtDbFilter()" class="text-gray-600 hover:text-gray-800 px-3 py-1.5 text-sm">
                        ‡∏•‡πâ‡∏≤‡∏á
                    </button>

                    <!-- Available Years Info -->
                    <div id="smt-db-years-info" class="ml-auto text-xs text-gray-500">
                        ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô: <span id="smt-db-available-years">-</span>
                    </div>
                </div>
            </div>

            <div class="border border-gray-200 rounded-lg overflow-hidden">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Posting Date</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Ref Doc</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Fund Group</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Amount</th>
                            <th class="px-3 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total</th>
                            <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Imported</th>
                        </tr>
                    </thead>
                    <tbody id="smt-db-records" class="bg-white divide-y divide-gray-200 text-sm">
                        <tr>
                            <td colspan="7" class="px-4 py-8 text-center text-gray-500">Click Refresh to load records</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div id="smt-db-pagination" class="mt-4 flex items-center justify-between hidden">
                <div class="text-sm text-gray-500">
                    Page <span id="smt-db-page">1</span> of <span id="smt-db-total-pages">1</span>
                </div>
                <div class="flex gap-2">
                    <button onclick="loadSmtDbRecords(currentSmtDbPage - 1)" id="smt-db-prev" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Previous</button>
                    <button onclick="loadSmtDbRecords(currentSmtDbPage + 1)" id="smt-db-next" class="px-3 py-1 border rounded text-sm hover:bg-gray-100 disabled:opacity-50" disabled>Next</button>
                </div>
            </div>
        </div>
        </div>
        <!-- End SMT Database Sub-tab -->
    </div>

    <!-- ==================== SETTINGS TAB ==================== -->
    <div id="content-settings" class="tab-content p-6 hidden">
        <div class="max-w-2xl">
            <!-- Credentials Section -->
            <div class="border border-gray-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
                    </svg>
                    E-Claim Credentials
                </h3>

                <form id="credentials-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Username</label>
                        <input type="text" id="eclaim-username" name="eclaim_username" value="{{ settings.eclaim_username }}"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <div class="relative">
                            <input type="password" id="eclaim-password" name="eclaim_password" value="{{ settings.eclaim_password }}"
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 pr-10 focus:ring-2 focus:ring-blue-500" required>
                            <button type="button" onclick="togglePasswordVisibility('eclaim-password')" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-md font-medium">
                            Save Credentials
                        </button>
                        <button type="button" onclick="testConnection()" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium">
                            Test Connection
                        </button>
                    </div>
                </form>

                <div id="connection-status" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>

            <!-- SMT Settings Section -->
            <div class="border border-gray-200 rounded-lg p-6 mb-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Smart Money Transfer Settings
                </h3>
                <p class="text-sm text-gray-600 mb-4">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä.</p>

                <form id="smt-settings-form" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">
                            Vendor ID (‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•)
                            <span class="text-red-500">*</span>
                        </label>
                        <input type="text" id="smt-vendor-id" name="smt_vendor_id"
                               value="{{ settings.smt_vendor_id | default('') }}"
                               placeholder="‡πÄ‡∏ä‡πà‡∏ô 10670 ‡∏´‡∏£‡∏∑‡∏≠ 0000010670"
                               class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-green-500">
                        <p class="text-xs text-gray-500 mt-1">‡∏£‡∏´‡∏±‡∏™‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£ 5 ‡∏´‡∏•‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠ 10 ‡∏´‡∏•‡∏±‡∏Å (Vendor ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÉ‡∏ô SMT)</p>
                    </div>

                    <div class="flex items-center">
                        <input type="checkbox" id="smt-auto-save" name="smt_auto_save_db"
                               {% if settings.smt_auto_save_db | default(true) %}checked{% endif %}
                               class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded">
                        <label for="smt-auto-save" class="ml-2 text-sm text-gray-700">
                            ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Database ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </label>
                    </div>

                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md font-medium">
                        Save SMT Settings
                    </button>
                </form>

                <div id="smt-settings-status" class="hidden mt-4 p-3 rounded-lg"></div>
            </div>

            <!-- Database Info -->
            <div class="border border-gray-200 rounded-lg p-6">
                <h3 class="text-lg font-semibold mb-4 flex items-center">
                    <svg class="w-6 h-6 mr-2 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                    </svg>
                    Database Status
                </h3>

                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Type</p>
                        <p class="font-medium">{{ db_info.type | default('PostgreSQL') }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Status</p>
                        <p class="font-medium text-green-600">Connected</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Claims Records</p>
                        <p class="font-medium">{{ db_info.claims_count | default(0) | number_format }}</p>
                    </div>
                    <div class="bg-gray-50 rounded p-3">
                        <p class="text-gray-500">Budget Records</p>
                        <p class="font-medium">{{ db_info.budget_count | default(0) | number_format }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ==================== HEALTH OFFICES TAB ==================== -->
    <div id="content-offices" class="tab-content p-6 hidden">
        <!-- Header and Source -->
        <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
            <p class="text-sm text-blue-800">
                <span class="font-medium">Data Source:</span>
                <a href="https://hcode.moph.go.th/code/" target="_blank" class="underline hover:text-blue-600">
                    https://hcode.moph.go.th
                </a>
                - ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏´‡∏±‡∏™‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏• ‡∏Å‡∏£‡∏∞‡∏ó‡∏£‡∏ß‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏™‡∏∏‡∏Ç
            </p>
        </div>

        <!-- Stats Cards -->
        <div class="grid grid-cols-4 gap-4 mb-6">
            <div class="bg-gray-50 rounded-lg p-4 text-center">
                <p id="ho-stat-total" class="text-2xl font-bold text-gray-700">-</p>
                <p class="text-sm text-gray-600">Total Records</p>
            </div>
            <div class="bg-blue-50 rounded-lg p-4 text-center">
                <p id="ho-stat-active" class="text-2xl font-bold text-blue-700">-</p>
                <p class="text-sm text-blue-600">Active</p>
            </div>
            <div class="bg-green-50 rounded-lg p-4 text-center">
                <p id="ho-stat-provinces" class="text-2xl font-bold text-green-700">-</p>
                <p class="text-sm text-green-600">Provinces</p>
            </div>
            <div class="bg-purple-50 rounded-lg p-4 text-center">
                <p id="ho-stat-hospitals" class="text-2xl font-bold text-purple-700">-</p>
                <p class="text-sm text-purple-600">Hospitals</p>
            </div>
        </div>

        <!-- Import Section -->
        <div class="border border-gray-200 rounded-lg p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4 flex items-center text-green-700">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                </svg>
                Import Health Offices Data
            </h3>

            <div class="grid grid-cols-2 gap-6">
                <!-- Upload Area -->
                <div class="border border-dashed border-gray-300 rounded-lg p-6 text-center">
                    <input type="file" id="ho-import-file" accept=".xlsx,.xls" class="hidden" onchange="hoHandleFileSelect(this)">
                    <div id="ho-upload-area" onclick="document.getElementById('ho-import-file').click()" class="cursor-pointer">
                        <svg class="w-12 h-12 mx-auto text-gray-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-gray-600">Click to upload Excel file</p>
                        <p class="text-sm text-gray-400 mt-1">.xlsx from hcode.moph.go.th</p>
                    </div>
                    <div id="ho-file-selected" class="hidden">
                        <div class="flex items-center justify-center gap-2 text-green-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <span id="ho-file-name">file.xlsx</span>
                        </div>
                    </div>
                </div>

                <!-- Import Options -->
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Import Mode</label>
                        <div class="space-y-2">
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ho-import-mode" value="upsert" checked class="w-4 h-4 text-blue-600">
                                <span class="ml-2">
                                    <span class="font-medium">Update/Insert</span>
                                    <span class="text-sm text-gray-500">- ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà</span>
                                </span>
                            </label>
                            <label class="flex items-center cursor-pointer">
                                <input type="radio" name="ho-import-mode" value="replace" class="w-4 h-4 text-red-600">
                                <span class="ml-2">
                                    <span class="font-medium text-red-600">Clear & Replace</span>
                                    <span class="text-sm text-gray-500">- ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</span>
                                </span>
                            </label>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="hoImportData()" id="ho-btn-import" disabled
                                class="flex-1 bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white py-2 px-4 rounded-md font-medium">
                            Import Data
                        </button>
                        <button onclick="hoClearAllData()"
                                class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded-md font-medium">
                            Clear All
                        </button>
                    </div>

                    <div id="ho-import-progress" class="hidden">
                        <div class="flex justify-between text-sm mb-1">
                            <span>Importing...</span>
                            <span id="ho-import-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="ho-import-bar" class="bg-green-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                    </div>

                    <div id="ho-import-result" class="hidden p-3 rounded-lg"></div>
                </div>
            </div>
        </div>

        <!-- Search and Data Table -->
        <div class="border border-gray-200 rounded-lg">
            <div class="p-4 border-b border-gray-200">
                <div class="grid grid-cols-5 gap-4">
                    <div class="col-span-2">
                        <input type="text" id="ho-search-input" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤: ‡∏ä‡∏∑‡πà‡∏≠, ‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å..."
                               onkeyup="hoDebounceSearch()"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500">
                    </div>
                    <select id="ho-filter-province" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Provinces</option>
                    </select>
                    <select id="ho-filter-level" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="">All Levels</option>
                    </select>
                    <select id="ho-per-page" onchange="hoLoadData()" class="px-3 py-2 border border-gray-300 rounded-md">
                        <option value="50">50 per page</option>
                        <option value="100">100 per page</option>
                    </select>
                </div>
            </div>

            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏ä‡∏∑‡πà‡∏≠</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏£‡∏∞‡∏î‡∏±‡∏ö</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î</th>
                        <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    </tr>
                </thead>
                <tbody id="ho-data-tbody" class="bg-white divide-y divide-gray-200">
                    <tr>
                        <td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td>
                    </tr>
                </tbody>
            </table>

            <div class="px-4 py-3 border-t border-gray-200 flex justify-between items-center">
                <div class="text-sm text-gray-500">
                    <span id="ho-showing-count">0</span> of <span id="ho-total-count">0</span>
                </div>
                <div id="ho-pagination" class="flex gap-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Import Progress Modal -->
<div id="import-progress-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
        <h3 class="text-lg font-medium text-gray-900 mb-4">Importing Files to Database</h3>
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-2">
                <span id="import-progress-text">Preparing...</span>
                <span id="import-progress-percentage">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="import-progress-bar" class="bg-blue-600 h-4 rounded-full transition-all" style="width: 0%"></div>
            </div>
            <div class="mt-2 text-sm text-gray-600">
                <span id="import-file-count">0 / 0 files</span> |
                <span id="import-record-count">0 records</span>
            </div>
        </div>
        <div class="bg-gray-50 rounded p-3 mb-4">
            <div class="text-xs text-gray-500">Current File:</div>
            <div id="import-current-file" class="text-sm font-mono truncate">-</div>
        </div>
        <button onclick="closeImportModal()" class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
            Run in Background
        </button>
    </div>
</div>

<script>
let scheduleTimes = [];
let currentTab = 'download';

// Number formatting helper
function formatNumber(num, decimals) {
    if (num === null || num === undefined) return '-';
    if (typeof decimals === 'number') {
        return parseFloat(num).toFixed(decimals).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    return parseFloat(num).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Scheme selection helpers
function selectAllSchemes(prefix) {
    document.querySelectorAll('input[name="' + prefix + '-schemes"]').forEach(function(cb) {
        cb.checked = true;
    });
    updateBulkEstimate();
}

function selectDefaultSchemes(prefix) {
    var defaultSchemes = ['ucs', 'ofc', 'sss', 'lgo'];
    document.querySelectorAll('input[name="' + prefix + '-schemes"]').forEach(function(cb) {
        cb.checked = defaultSchemes.includes(cb.value);
    });
    updateBulkEstimate();
}

function getSelectedSchemes(prefix) {
    var schemes = [];
    document.querySelectorAll('input[name="' + prefix + '-schemes"]:checked').forEach(function(cb) {
        schemes.push(cb.value);
    });
    return schemes;
}

// Tab switching
function switchTab(tab) {
    currentTab = tab;
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(function(el) {
        el.classList.add('hidden');
    });
    // Show selected tab content
    document.getElementById('content-' + tab).classList.remove('hidden');

    // Update tab button styles
    document.querySelectorAll('.tab-btn').forEach(function(btn) {
        btn.classList.remove('border-blue-600', 'text-blue-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    var activeBtn = document.getElementById('tab-' + tab);
    activeBtn.classList.remove('border-transparent', 'text-gray-500');
    activeBtn.classList.add('border-blue-600', 'text-blue-600');

    // Load data for specific tabs
    if (tab === 'download' && typeof loadFailedDownloads === 'function') {
        loadFailedDownloads();
    } else if (tab === 'smt' && typeof loadSmtFiles === 'function') {
        loadSmtFiles();
    } else if (tab === 'statement' && typeof loadStatementFiles === 'function') {
        loadStatementFiles();
    }

    // Update URL without reload
    var url = new URL(window.location);
    url.searchParams.set('tab', tab);
    window.history.pushState({}, '', url);
}

// SMT Sub-tab switching
function switchSmtSubtab(subtab) {
    // Hide all SMT sub-tab contents
    document.getElementById('smt-subtab-files').classList.add('hidden');
    document.getElementById('smt-subtab-database').classList.add('hidden');

    // Show selected sub-tab content
    document.getElementById('smt-subtab-' + subtab).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.smt-subtab-btn').forEach(function(btn) {
        btn.classList.remove('bg-green-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-200');
    });
    var activeBtn = document.getElementById('smt-subtab-btn-' + subtab);
    activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-200');
    activeBtn.classList.add('bg-green-600', 'text-white');

    // Load data if switching to database tab
    if (subtab === 'database' && typeof loadSmtDbRecords === 'function') {
        loadSmtDbRecords(1);
    }
}

// REP Sub-tab switching
function switchRepSubtab(subtab) {
    // Hide all REP sub-tab contents
    document.getElementById('rep-subtab-files').classList.add('hidden');
    document.getElementById('rep-subtab-database').classList.add('hidden');

    // Show selected sub-tab content
    document.getElementById('rep-subtab-' + subtab).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.rep-subtab-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-200');
    });
    var activeBtn = document.getElementById('rep-subtab-btn-' + subtab);
    activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-200');
    activeBtn.classList.add('bg-blue-600', 'text-white');

    // Load data if switching to database tab
    if (subtab === 'database') {
        initRepDbFiscalYear();
        loadRepDbRecords(1);
    }
}

// REP Database Records
var currentRepDbPage = 1;

function initRepDbFiscalYear() {
    var select = document.getElementById('rep-db-fiscal-year');
    if (!select || select.options.length > 1) return;

    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;

    for (var fy = currentFiscalYear; fy >= 2566; fy--) {
        var option = document.createElement('option');
        option.value = fy;
        option.textContent = '‡∏õ‡∏µ ' + fy;
        select.appendChild(option);
    }
}

async function loadRepDbRecords(page) {
    currentRepDbPage = page || 1;

    var viewMode = document.getElementById('rep-db-view-mode').value;
    var fiscalYear = document.getElementById('rep-db-fiscal-year').value;
    var repNo = document.getElementById('rep-db-rep-no').value;
    var status = document.getElementById('rep-db-status').value;

    var params = new URLSearchParams({
        page: currentRepDbPage,
        limit: 50,
        view_mode: viewMode
    });
    if (fiscalYear) params.append('fiscal_year', fiscalYear);
    if (repNo) params.append('rep_no', repNo);
    if (status) params.append('status', status);

    var tbody = document.getElementById('rep-db-records-body');
    tbody.textContent = '';
    var loadingRow = document.createElement('tr');
    var loadingCell = document.createElement('td');
    loadingCell.colSpan = 7;
    loadingCell.className = 'px-4 py-8 text-center text-gray-500';
    loadingCell.textContent = 'Loading...';
    loadingRow.appendChild(loadingCell);
    tbody.appendChild(loadingRow);

    try {
        var response = await fetch('/api/rep/records?' + params.toString());
        var data = await response.json();

        if (data.success) {
            renderRepDbRecords(data.records, viewMode);
            updateRepDbStats(data.stats);
            updateRepDbPagination(data.pagination);
            document.getElementById('rep-db-result-count').textContent =
                '‡πÅ‡∏™‡∏î‡∏á ' + data.records.length + ' ‡∏à‡∏≤‡∏Å ' + data.pagination.total + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        } else {
            showErrorInTable(tbody, 7, data.error || 'Error loading data');
        }
    } catch (error) {
        showErrorInTable(tbody, 7, 'Error: ' + error.message);
    }
}

function showErrorInTable(tbody, cols, message) {
    tbody.textContent = '';
    var row = document.createElement('tr');
    var cell = document.createElement('td');
    cell.colSpan = cols;
    cell.className = 'px-4 py-8 text-center text-red-500';
    cell.textContent = message;
    row.appendChild(cell);
    tbody.appendChild(row);
}

function renderRepDbRecords(records, viewMode) {
    var tbody = document.getElementById('rep-db-records-body');
    tbody.textContent = '';

    if (!records || records.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 7;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    records.forEach(function(rec) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        var statusClass = 'bg-gray-100 text-gray-600';
        var statusText = rec.status || '-';

        if (rec.status === 'matched') {
            statusClass = 'bg-green-100 text-green-700';
            statusText = 'Matched';
        } else if (rec.status === 'diff_amount') {
            statusClass = 'bg-yellow-100 text-yellow-700';
            statusText = 'Diff';
        } else if (rec.status === 'rep_only') {
            statusClass = 'bg-red-100 text-red-700';
            statusText = 'REP Only';
        }

        var repAmount = parseFloat(rec.rep_amount || 0);
        var stmAmount = parseFloat(rec.stm_amount || 0);
        var diff = repAmount - stmAmount;

        if (viewMode === 'rep') {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium text-blue-600';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Count cell
            var countCell = document.createElement('td');
            countCell.className = 'px-3 py-2';
            countCell.textContent = (rec.count || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            row.appendChild(countCell);
        } else {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Transaction cell
            var tranCell = document.createElement('td');
            tranCell.className = 'px-3 py-2';
            var tranSpan = document.createElement('span');
            tranSpan.className = 'text-gray-500';
            tranSpan.textContent = rec.tran_id || '-';
            tranCell.appendChild(tranSpan);
            tranCell.appendChild(document.createTextNode(' ' + (rec.patient_name || '')));
            row.appendChild(tranCell);
        }

        // REP Amount cell
        var repAmtCell = document.createElement('td');
        repAmtCell.className = 'px-3 py-2 text-right';
        repAmtCell.textContent = formatNumber(repAmount);
        row.appendChild(repAmtCell);

        // STM Amount cell
        var stmCell = document.createElement('td');
        stmCell.className = 'px-3 py-2 text-right';
        stmCell.textContent = formatNumber(stmAmount);
        row.appendChild(stmCell);

        // Diff cell
        var diffCell = document.createElement('td');
        diffCell.className = 'px-3 py-2 text-right' + (diff !== 0 ? ' text-red-600' : '');
        diffCell.textContent = formatNumber(diff);
        row.appendChild(diffCell);

        // Status cell
        var statusCell = document.createElement('td');
        statusCell.className = 'px-3 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-0.5 rounded text-xs ' + statusClass;
        statusSpan.textContent = statusText;
        statusCell.appendChild(statusSpan);
        row.appendChild(statusCell);

        // Actions cell
        var actionsCell = document.createElement('td');
        actionsCell.className = 'px-3 py-2 text-center';
        if (viewMode === 'rep') {
            var detailBtn = document.createElement('button');
            detailBtn.className = 'text-blue-600 hover:text-blue-800 text-xs';
            detailBtn.textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            detailBtn.onclick = function() { viewRepDetail(rec.rep_no); };
            actionsCell.appendChild(detailBtn);
        } else if (rec.tran_id) {
            var analysisLink = document.createElement('a');
            analysisLink.href = '/data-analysis?tran_id=' + rec.tran_id;
            analysisLink.className = 'text-blue-600 hover:text-blue-800 text-xs';
            analysisLink.textContent = '‡∏î‡∏π Statement';
            actionsCell.appendChild(analysisLink);
        } else {
            actionsCell.textContent = '-';
        }
        row.appendChild(actionsCell);

        tbody.appendChild(row);
    });
}

function updateRepDbStats(stats) {
    if (!stats) return;
    document.getElementById('rep-db-stat-total').textContent = formatNumber(stats.total || 0, 0);
    document.getElementById('rep-db-stat-matched').textContent = formatNumber(stats.matched || 0, 0);
    document.getElementById('rep-db-stat-diff').textContent = formatNumber(stats.diff_amount || 0, 0);
    document.getElementById('rep-db-stat-unmatched').textContent = formatNumber(stats.rep_only || 0, 0);
}

function updateRepDbPagination(pagination) {
    var paginationDiv = document.getElementById('rep-db-pagination');
    if (!pagination || pagination.total_pages <= 1) {
        paginationDiv.classList.add('hidden');
        return;
    }

    paginationDiv.classList.remove('hidden');
    document.getElementById('rep-db-current-page').textContent = pagination.page;
    document.getElementById('rep-db-total-pages').textContent = pagination.total_pages;
    document.getElementById('rep-db-prev-btn').disabled = pagination.page <= 1;
    document.getElementById('rep-db-next-btn').disabled = pagination.page >= pagination.total_pages;
}

function viewRepDetail(repNo) {
    document.getElementById('rep-db-view-mode').value = 'tran';
    document.getElementById('rep-db-rep-no').value = repNo;
    loadRepDbRecords(1);
}

function refreshRepDbRecords() {
    loadRepDbRecords(currentRepDbPage);
}

function clearRepDbFilter() {
    document.getElementById('rep-db-view-mode').value = 'rep';
    document.getElementById('rep-db-fiscal-year').value = '';
    document.getElementById('rep-db-rep-no').value = '';
    document.getElementById('rep-db-status').value = '';
    loadRepDbRecords(1);
}

async function clearRepDatabase() {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• REP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) return;

    try {
        var response = await fetch('/api/rep/clear-database', { method: 'POST' });
        var data = await response.json();
        if (data.success) {
            showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadRepDbRecords(1);
        } else {
            showToast(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Statement Sub-tab switching
function switchStatementSubtab(subtab) {
    // Hide all Statement sub-tab contents
    document.getElementById('stm-subtab-files').classList.add('hidden');
    document.getElementById('stm-subtab-database').classList.add('hidden');

    // Show selected sub-tab content
    document.getElementById('stm-subtab-' + subtab).classList.remove('hidden');

    // Update button styles
    document.querySelectorAll('.stm-subtab-btn').forEach(function(btn) {
        btn.classList.remove('bg-purple-600', 'text-white');
        btn.classList.add('text-gray-600', 'hover:bg-gray-200');
    });
    var activeBtn = document.getElementById('stm-subtab-btn-' + subtab);
    activeBtn.classList.remove('text-gray-600', 'hover:bg-gray-200');
    activeBtn.classList.add('bg-purple-600', 'text-white');

    // Load data if switching to database tab
    if (subtab === 'database') {
        initStmDbFiscalYear();
        loadStmDbRecords(1);
    }
}

// Statement Database Records
var currentStmDbPage = 1;

function initStmDbFiscalYear() {
    var select = document.getElementById('stm-db-fiscal-year');
    if (!select || select.options.length > 1) return;  // Already initialized

    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;

    for (var fy = currentFiscalYear; fy >= 2566; fy--) {
        var option = document.createElement('option');
        option.value = fy;
        option.textContent = '‡∏õ‡∏µ ' + fy;
        select.appendChild(option);
    }
}

async function loadStmDbRecords(page) {
    currentStmDbPage = page || 1;

    var viewMode = document.getElementById('stm-db-view-mode').value;
    var fiscalYear = document.getElementById('stm-db-fiscal-year').value;
    var repNo = document.getElementById('stm-db-rep-no').value;
    var status = document.getElementById('stm-db-status').value;

    var params = new URLSearchParams({
        page: currentStmDbPage,
        limit: 50,
        view_mode: viewMode
    });
    if (fiscalYear) params.append('fiscal_year', fiscalYear);
    if (repNo) params.append('rep_no', repNo);
    if (status) params.append('status', status);

    var tbody = document.getElementById('stm-db-records-body');
    tbody.textContent = '';
    var loadingRow = document.createElement('tr');
    var loadingCell = document.createElement('td');
    loadingCell.colSpan = 7;
    loadingCell.className = 'px-4 py-8 text-center text-gray-500';
    loadingCell.textContent = 'Loading...';
    loadingRow.appendChild(loadingCell);
    tbody.appendChild(loadingRow);

    try {
        var response = await fetch('/api/stm/records?' + params.toString());
        var data = await response.json();

        if (data.success) {
            renderStmDbRecords(data.records, viewMode);
            updateStmDbStats(data.stats);
            updateStmDbPagination(data.pagination);
            document.getElementById('stm-db-result-count').textContent =
                '‡πÅ‡∏™‡∏î‡∏á ' + data.records.length + ' ‡∏à‡∏≤‡∏Å ' + data.pagination.total + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
        } else {
            tbody.textContent = '';
            var errorRow = document.createElement('tr');
            var errorCell = document.createElement('td');
            errorCell.colSpan = 7;
            errorCell.className = 'px-4 py-8 text-center text-red-500';
            errorCell.textContent = data.error || 'Error loading data';
            errorRow.appendChild(errorCell);
            tbody.appendChild(errorRow);
        }
    } catch (error) {
        tbody.textContent = '';
        var errorRow = document.createElement('tr');
        var errorCell = document.createElement('td');
        errorCell.colSpan = 7;
        errorCell.className = 'px-4 py-8 text-center text-red-500';
        errorCell.textContent = 'Error: ' + error.message;
        errorRow.appendChild(errorCell);
        tbody.appendChild(errorRow);
    }
}

function renderStmDbRecords(records, viewMode) {
    var tbody = document.getElementById('stm-db-records-body');
    tbody.textContent = '';

    if (!records || records.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 7;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    records.forEach(function(rec) {
        var row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';

        var statusClass = 'bg-gray-100 text-gray-600';
        var statusText = rec.status || '-';

        if (rec.status === 'matched') {
            statusClass = 'bg-green-100 text-green-700';
            statusText = 'Matched';
        } else if (rec.status === 'diff_amount') {
            statusClass = 'bg-yellow-100 text-yellow-700';
            statusText = 'Diff';
        } else if (rec.status === 'stm_only') {
            statusClass = 'bg-red-100 text-red-700';
            statusText = 'STM Only';
        }

        var stmAmount = parseFloat(rec.stm_amount || 0);
        var repAmount = parseFloat(rec.rep_amount || 0);
        var diff = stmAmount - repAmount;

        if (viewMode === 'rep') {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium text-blue-600';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Count cell
            var countCell = document.createElement('td');
            countCell.className = 'px-3 py-2';
            countCell.textContent = (rec.count || 0) + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
            row.appendChild(countCell);
        } else {
            // REP No cell
            var repCell = document.createElement('td');
            repCell.className = 'px-3 py-2 font-medium';
            repCell.textContent = rec.rep_no || '-';
            row.appendChild(repCell);

            // Transaction cell
            var tranCell = document.createElement('td');
            tranCell.className = 'px-3 py-2';
            var tranSpan = document.createElement('span');
            tranSpan.className = 'text-gray-500';
            tranSpan.textContent = rec.tran_id || '-';
            tranCell.appendChild(tranSpan);
            tranCell.appendChild(document.createTextNode(' ' + (rec.patient_name || '')));
            row.appendChild(tranCell);
        }

        // STM Amount cell
        var stmCell = document.createElement('td');
        stmCell.className = 'px-3 py-2 text-right';
        stmCell.textContent = formatNumber(stmAmount);
        row.appendChild(stmCell);

        // REP Amount cell
        var repAmtCell = document.createElement('td');
        repAmtCell.className = 'px-3 py-2 text-right';
        repAmtCell.textContent = formatNumber(repAmount);
        row.appendChild(repAmtCell);

        // Diff cell
        var diffCell = document.createElement('td');
        diffCell.className = 'px-3 py-2 text-right' + (diff !== 0 ? ' text-red-600' : '');
        diffCell.textContent = formatNumber(diff);
        row.appendChild(diffCell);

        // Status cell
        var statusCell = document.createElement('td');
        statusCell.className = 'px-3 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-0.5 rounded text-xs ' + statusClass;
        statusSpan.textContent = statusText;
        statusCell.appendChild(statusSpan);
        row.appendChild(statusCell);

        // Actions cell
        var actionsCell = document.createElement('td');
        actionsCell.className = 'px-3 py-2 text-center';
        if (viewMode === 'rep') {
            var detailBtn = document.createElement('button');
            detailBtn.className = 'text-blue-600 hover:text-blue-800 text-xs';
            detailBtn.textContent = '‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î';
            detailBtn.onclick = function() { viewStmRepDetail(rec.rep_no); };
            actionsCell.appendChild(detailBtn);
        } else if (rec.tran_id) {
            var repLink = document.createElement('a');
            repLink.href = '/data-analysis?tran_id=' + rec.tran_id;
            repLink.className = 'text-blue-600 hover:text-blue-800 text-xs';
            repLink.textContent = '‡∏î‡∏π REP';
            actionsCell.appendChild(repLink);
        } else {
            actionsCell.textContent = '-';
        }
        row.appendChild(actionsCell);

        tbody.appendChild(row);
    });
}

function updateStmDbStats(stats) {
    if (!stats) return;
    document.getElementById('stm-db-stat-total').textContent = formatNumber(stats.total || 0, 0);
    document.getElementById('stm-db-stat-matched').textContent = formatNumber(stats.matched || 0, 0);
    document.getElementById('stm-db-stat-diff').textContent = formatNumber(stats.diff_amount || 0, 0);
    document.getElementById('stm-db-stat-unmatched').textContent = formatNumber(stats.stm_only || 0, 0);
}

function updateStmDbPagination(pagination) {
    var paginationDiv = document.getElementById('stm-db-pagination');
    if (!pagination || pagination.total_pages <= 1) {
        paginationDiv.classList.add('hidden');
        return;
    }

    paginationDiv.classList.remove('hidden');
    document.getElementById('stm-db-current-page').textContent = pagination.page;
    document.getElementById('stm-db-total-pages').textContent = pagination.total_pages;
    document.getElementById('stm-db-prev-btn').disabled = pagination.page <= 1;
    document.getElementById('stm-db-next-btn').disabled = pagination.page >= pagination.total_pages;
}

function viewStmRepDetail(repNo) {
    document.getElementById('stm-db-view-mode').value = 'tran';
    document.getElementById('stm-db-rep-no').value = repNo;
    loadStmDbRecords(1);
}

function refreshStmDbRecords() {
    loadStmDbRecords(currentStmDbPage);
}

function clearStmDbFilter() {
    document.getElementById('stm-db-view-mode').value = 'rep';
    document.getElementById('stm-db-fiscal-year').value = '';
    document.getElementById('stm-db-rep-no').value = '';
    document.getElementById('stm-db-status').value = '';
    loadStmDbRecords(1);
}

async function clearStmDatabase() {
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Statement ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ')) return;

    try {
        var response = await fetch('/api/stm/clear-database', { method: 'POST' });
        var data = await response.json();
        if (data.success) {
            showToast('‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadStmDbRecords(1);
        } else {
            showToast(data.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Initialize from URL params
function initFromUrl() {
    var params = new URLSearchParams(window.location.search);
    var tab = params.get('tab') || 'download';
    switchTab(tab);
}

// Year dropdowns
function populateYearDropdowns() {
    var currentYear = new Date().getFullYear();
    var currentYearBE = currentYear + 543;
    var currentMonth = new Date().getMonth() + 1;

    // Determine current fiscal year (fiscal year starts in October)
    // If we're in Oct-Dec, fiscal year is next year BE
    // If we're in Jan-Sep, fiscal year is current year BE
    var currentFiscalYear = currentMonth >= 10 ? currentYearBE + 1 : currentYearBE;

    var yearSelects = ['bulk-start-year', 'bulk-end-year', 'smt-fiscal-year'];

    yearSelects.forEach(function(id) {
        var select = document.getElementById(id);
        if (!select) return;

        while (select.firstChild) select.removeChild(select.firstChild);

        for (var i = 0; i <= 8; i++) {
            var yearBE = currentFiscalYear - i;
            var option = document.createElement('option');
            option.value = yearBE;
            option.textContent = yearBE;
            if (i === 0) option.selected = true;  // Current fiscal year as default
            select.appendChild(option);
        }
    });

    // REP: Default to current month (REP downloads one month at a time, no "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô")
    // Statement: Default to "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" (all months)
    var monthSelect = document.getElementById('bulk-start-month');
    var allMonthsOption = document.getElementById('opt-all-months');

    // On initial load, REP is default - hide "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" and set current month
    if (allMonthsOption) allMonthsOption.classList.add('hidden');
    if (monthSelect) monthSelect.value = currentMonth.toString();

    var bulkEndMonth = document.getElementById('bulk-end-month');
    if (bulkEndMonth) bulkEndMonth.value = '';
}

// Update bulk estimate
function updateBulkEstimate() {
    var startMonthVal = document.getElementById('bulk-start-month').value;
    var startYearVal = document.getElementById('bulk-start-year').value;
    var endMonthVal = document.getElementById('bulk-end-month').value;
    var endYearVal = document.getElementById('bulk-end-year').value;

    var schemes = getSelectedSchemes('bulk');
    var numSchemes = schemes.length || 1;

    // Handle "‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" (all months) - full fiscal year
    var startMonth, startYear, endMonth, endYear;
    var fiscalYearText = '';

    if (startMonthVal === '' || startMonthVal === null) {
        // All months in fiscal year: Oct (year-1) to Sep (year)
        startMonth = 10;
        startYear = parseInt(startYearVal) - 1;
        endMonth = 9;
        endYear = parseInt(startYearVal);
        fiscalYearText = ' (‡∏õ‡∏µ‡∏á‡∏ö ' + startYearVal + ')';
    } else {
        startMonth = parseInt(startMonthVal);
        startYear = parseInt(startYearVal);
        endMonth = endMonthVal ? parseInt(endMonthVal) : startMonth;
        endYear = endYearVal ? parseInt(endYearVal) : startYear;
    }

    if (typeof calculateMonthsBetween === 'function') {
        var totalMonths = calculateMonthsBetween(startMonth, startYear, endMonth, endYear);
        var totalIterations = totalMonths * numSchemes;
        var estimatedMinutes = Math.ceil(totalIterations * 0.5); // ~30 sec per iteration
        document.getElementById('bulk-estimate').textContent =
            totalMonths + ' ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô x ' + numSchemes + ' ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥ = ' + totalIterations + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£' + fiscalYearText + ' (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ' + estimatedMinutes + ' ‡∏ô‡∏≤‡∏ó‡∏µ)';
    }
}

// File filtering
function filterFilesStatus(status) {
    document.querySelectorAll('.file-filter-btn').forEach(function(btn) {
        btn.classList.remove('bg-blue-600', 'text-white');
        btn.classList.add('bg-gray-200', 'text-gray-700');
    });
    document.getElementById('filter-' + status).classList.remove('bg-gray-200', 'text-gray-700');
    document.getElementById('filter-' + status).classList.add('bg-blue-600', 'text-white');

    document.querySelectorAll('.file-row').forEach(function(row) {
        if (status === 'all') {
            row.style.display = '';
        } else {
            row.style.display = row.dataset.status === status ? '' : 'none';
        }
    });
}

function filterFilesByMonth() {
    // Legacy function - redirect to applyFilesFilter
    applyFilesFilter();
}

// Apply files filter with date range and scheme
function applyFilesFilter() {
    var startSelect = document.getElementById('filter-start-month');
    var endSelect = document.getElementById('filter-end-month');
    var schemeSelect = document.getElementById('filter-scheme');

    var params = new URLSearchParams();
    params.set('tab', 'rep');
    params.set('page', '1');

    // Date range
    if (startSelect && startSelect.value) {
        var startParts = startSelect.value.split(',');
        params.set('start_month', startParts[0]);
        params.set('start_year', startParts[1]);
    }
    if (endSelect && endSelect.value) {
        var endParts = endSelect.value.split(',');
        params.set('end_month', endParts[0]);
        params.set('end_year', endParts[1]);
    }

    // Scheme filter
    if (schemeSelect && schemeSelect.value) {
        params.set('scheme', schemeSelect.value);
    }

    window.location.href = '?' + params.toString();
}

// Password toggle
function togglePasswordVisibility(inputId) {
    var input = document.getElementById(inputId);
    input.type = input.type === 'password' ? 'text' : 'password';
}

// Schedule management
async function loadScheduleSettings() {
    try {
        var response = await fetch('/api/schedule');
        var data = await response.json();

        if (data.success) {
            document.getElementById('schedule-enabled').checked = data.settings.schedule_enabled;
            document.getElementById('schedule-auto-import').checked = data.settings.schedule_auto_import;
            scheduleTimes = data.settings.schedule_times || [];
            renderScheduleTimes();
            displayScheduleStatus(data.jobs);
            // Load schedule schemes
            setScheduleSchemes(data.settings.schedule_schemes);
            // Load data type checkboxes
            var typeRepCheckbox = document.getElementById('schedule-type-rep');
            var typeStmCheckbox = document.getElementById('schedule-type-stm');
            var typeSmtCheckbox = document.getElementById('schedule-type-smt');
            var smtVendorInput = document.getElementById('schedule-smt-vendor-id');

            if (typeRepCheckbox) {
                typeRepCheckbox.checked = data.settings.schedule_type_rep !== false; // Default true
            }
            if (typeStmCheckbox) {
                typeStmCheckbox.checked = data.settings.schedule_type_stm === true; // Default false
            }
            if (typeSmtCheckbox) {
                typeSmtCheckbox.checked = data.settings.schedule_type_smt === true; // Default false
            }
            if (smtVendorInput) {
                smtVendorInput.value = data.settings.schedule_smt_vendor_id || '';
            }

            // Update card states based on loaded settings
            initScheduleCards();

            // Update summary text in header
            updateScheduleSummary(data.settings);
        }
    } catch (error) {
        console.error('Error loading schedule:', error);
    }
}

function updateScheduleSummary(settings) {
    var summary = document.getElementById('schedule-summary');
    if (!summary) return;

    if (!settings.schedule_enabled) {
        summary.innerHTML = '<span class="text-gray-400">‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span>';
        return;
    }

    var times = settings.schedule_times || [];
    var types = [];
    if (settings.schedule_type_rep !== false) types.push('REP');
    if (settings.schedule_type_stm) types.push('STM');
    if (settings.schedule_type_smt) types.push('SMT');

    if (times.length === 0) {
        summary.innerHTML = '<span class="text-yellow-600">‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà ¬∑ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤</span>';
    } else {
        var timeStr = times.map(function(t) {
            return String(t.hour).padStart(2, '0') + ':' + String(t.minute).padStart(2, '0');
        }).join(', ');
        summary.innerHTML = '<span class="text-green-600">‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà</span> ¬∑ ' + timeStr + ' ¬∑ ' + types.join(', ');
    }
}

function renderScheduleTimes() {
    var container = document.getElementById('schedule-times-container');
    var msg = document.getElementById('no-schedules-message');

    // Remove existing schedule items
    var existingItems = container.querySelectorAll('.schedule-time-chip');
    existingItems.forEach(function(el) { el.remove(); });

    if (scheduleTimes.length === 0) {
        if (msg) msg.style.display = 'block';
        return;
    }

    if (msg) msg.style.display = 'none';

    scheduleTimes.forEach(function(time, index) {
        // Create chip-style time display
        var chip = document.createElement('div');
        chip.className = 'schedule-time-chip inline-flex items-center gap-1 bg-purple-100 border border-purple-200 rounded-full px-3 py-1.5';

        // Time icon
        var icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        icon.setAttribute('class', 'w-4 h-4 text-purple-600');
        icon.setAttribute('fill', 'none');
        icon.setAttribute('stroke', 'currentColor');
        icon.setAttribute('viewBox', '0 0 24 24');
        var iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        iconPath.setAttribute('stroke-linecap', 'round');
        iconPath.setAttribute('stroke-linejoin', 'round');
        iconPath.setAttribute('stroke-width', '2');
        iconPath.setAttribute('d', 'M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z');
        icon.appendChild(iconPath);

        // Hour input
        var hourInput = document.createElement('input');
        hourInput.type = 'number';
        hourInput.min = '0';
        hourInput.max = '23';
        hourInput.value = String(time.hour).padStart(2, '0');
        hourInput.className = 'w-10 px-1 py-0 border-0 bg-transparent text-center text-sm font-medium text-purple-800 focus:ring-0';
        hourInput.onchange = function() { scheduleTimes[index].hour = parseInt(this.value) || 0; };

        var colon = document.createElement('span');
        colon.className = 'text-purple-800 font-medium';
        colon.textContent = ':';

        // Minute input
        var minuteInput = document.createElement('input');
        minuteInput.type = 'number';
        minuteInput.min = '0';
        minuteInput.max = '59';
        minuteInput.value = String(time.minute).padStart(2, '0');
        minuteInput.className = 'w-10 px-1 py-0 border-0 bg-transparent text-center text-sm font-medium text-purple-800 focus:ring-0';
        minuteInput.onchange = function() { scheduleTimes[index].minute = parseInt(this.value) || 0; };

        // Delete button
        var deleteBtn = document.createElement('button');
        deleteBtn.className = 'ml-1 text-purple-500 hover:text-red-600 transition-colors';
        deleteBtn.onclick = function(e) { e.stopPropagation(); removeScheduleTime(index); };
        deleteBtn.title = '‡∏•‡∏ö';

        var deleteIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        deleteIcon.setAttribute('class', 'w-4 h-4');
        deleteIcon.setAttribute('fill', 'none');
        deleteIcon.setAttribute('stroke', 'currentColor');
        deleteIcon.setAttribute('viewBox', '0 0 24 24');
        var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', 'M6 18L18 6M6 6l12 12');
        deleteIcon.appendChild(path);
        deleteBtn.appendChild(deleteIcon);

        chip.appendChild(icon);
        chip.appendChild(hourInput);
        chip.appendChild(colon);
        chip.appendChild(minuteInput);
        chip.appendChild(deleteBtn);

        container.appendChild(chip);
    });
}

function addScheduleTime() {
    scheduleTimes.push({ hour: 9, minute: 0 });
    renderScheduleTimes();
}

function removeScheduleTime(index) {
    scheduleTimes.splice(index, 1);
    renderScheduleTimes();
}

function getScheduleSchemes() {
    var schemes = [];
    document.querySelectorAll('input[name="schedule-schemes"]:checked').forEach(function(cb) {
        schemes.push(cb.value);
    });
    return schemes;
}

function setScheduleSchemes(schemes) {
    if (!schemes || schemes.length === 0) {
        schemes = ['ucs', 'ofc', 'sss', 'lgo']; // Default
    }
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = schemes.includes(cb.value);
    });
}

// ===== NEW Card-Based Schedule UI Functions =====

function updateScheduleCardState(type) {
    var checkbox = document.getElementById('schedule-type-' + type);
    var card = document.getElementById('card-type-' + type);
    var settings = document.getElementById(type + '-settings');

    if (!checkbox || !card) return;

    var isChecked = checkbox.checked;

    // Update card opacity and border
    if (isChecked) {
        card.classList.remove('opacity-60');
        card.classList.add('border-' + getTypeColor(type) + '-300');
        card.classList.add('shadow-sm');
    } else {
        card.classList.add('opacity-60');
        card.classList.remove('border-' + getTypeColor(type) + '-300');
        card.classList.remove('shadow-sm');
    }

    // Show/hide settings panel
    if (settings) {
        if (isChecked) {
            settings.classList.remove('hidden');
        } else {
            settings.classList.add('hidden');
        }
    }
}

function getTypeColor(type) {
    switch(type) {
        case 'rep': return 'blue';
        case 'stm': return 'purple';
        case 'smt': return 'green';
        default: return 'gray';
    }
}

function toggleScheduleTypeCard(type) {
    var checkbox = document.getElementById('schedule-type-' + type);
    if (checkbox) {
        checkbox.checked = !checkbox.checked;
        updateScheduleCardState(type);
    }
}

function initScheduleCards() {
    // Initialize card states based on checkbox values
    ['rep', 'stm', 'smt'].forEach(function(type) {
        updateScheduleCardState(type);
    });
}

function selectAllScheduleSchemes() {
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = true;
    });
}

function selectMainScheduleSchemes() {
    var mainSchemes = ['ucs', 'ofc', 'sss', 'lgo'];
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = mainSchemes.includes(cb.value);
    });
}

function deselectAllScheduleSchemes() {
    document.querySelectorAll('input[name="schedule-schemes"]').forEach(function(cb) {
        cb.checked = false;
    });
}

// Legacy function - now just calls initScheduleCards
function updateScheduleSchemeVisibility() {
    initScheduleCards();
}

async function saveScheduleSettings() {
    try {
        // Get data type checkboxes
        var typeRep = document.getElementById('schedule-type-rep');
        var typeStm = document.getElementById('schedule-type-stm');
        var typeSmt = document.getElementById('schedule-type-smt');
        var smtVendorInput = document.getElementById('schedule-smt-vendor-id');

        var scheduleTypeRep = typeRep ? typeRep.checked : true;
        var scheduleTypeStm = typeStm ? typeStm.checked : false;
        var scheduleTypeSmt = typeSmt ? typeSmt.checked : false;
        var smtVendorId = smtVendorInput ? smtVendorInput.value.trim() : '';

        // Validate at least one data type is selected when enabling
        var scheduleEnabled = document.getElementById('schedule-enabled').checked;
        if (scheduleEnabled && !scheduleTypeRep && !scheduleTypeStm && !scheduleTypeSmt) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            return;
        }

        // Validate schemes only if REP is selected (Statement is UCS only)
        var scheduleSchemes = getScheduleSchemes();
        if (scheduleTypeRep && scheduleSchemes.length === 0) {
            showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö REP Files', 'error');
            return;
        }

        var response = await fetch('/api/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                schedule_enabled: scheduleEnabled,
                schedule_times: scheduleTimes,
                schedule_auto_import: document.getElementById('schedule-auto-import').checked,
                schedule_schemes: scheduleSchemes,
                schedule_type_rep: scheduleTypeRep,
                schedule_type_stm: scheduleTypeStm,
                schedule_type_smt: scheduleTypeSmt,
                schedule_smt_vendor_id: smtVendorId
            })
        });

        var result = await response.json();
        if (result.success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadScheduleSettings();
        } else {
            showToast(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏î‡πâ', 'error');
        }
    } catch (error) {
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å', 'error');
    }
}

function displayScheduleStatus(jobs) {
    var statusDiv = document.getElementById('schedule-status');
    var statusBox = document.getElementById('schedule-status-box');
    var isEnabled = document.getElementById('schedule-enabled').checked;

    if (!isEnabled) {
        statusDiv.innerHTML = '<span class="text-gray-500">‚è∏Ô∏è ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>';
        if (statusBox) statusBox.className = 'mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200';
        return;
    }

    if (!jobs || jobs.length === 0) {
        statusDiv.innerHTML = '<span class="text-yellow-600">‚ö†Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î</span>';
        if (statusBox) statusBox.className = 'mt-4 p-4 bg-yellow-50 rounded-lg border border-yellow-200';
        return;
    }

    // Find nearest next run
    var nextRunTimes = jobs
        .filter(function(job) { return job.next_run_time; })
        .map(function(job) { return new Date(job.next_run_time); })
        .sort(function(a, b) { return a - b; });

    var nextRunText = nextRunTimes.length > 0
        ? nextRunTimes[0].toLocaleString('th-TH', { dateStyle: 'short', timeStyle: 'short' })
        : '-';

    // Get selected data types
    var dataTypes = [];
    if (document.getElementById('schedule-type-rep').checked) {
        var schemes = getScheduleSchemes();
        dataTypes.push('REP (' + schemes.length + ' ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥)');
    }
    if (document.getElementById('schedule-type-stm').checked) {
        dataTypes.push('UC Statement');
    }
    if (document.getElementById('schedule-type-smt').checked) {
        dataTypes.push('SMT Budget');
    }

    statusDiv.innerHTML = '<span class="text-green-600 font-medium">‚úÖ ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà</span>' +
        '<span class="mx-2 text-gray-300">|</span>' +
        '<span class="text-gray-600">‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ñ‡∏±‡∏î‡πÑ‡∏õ: ' + nextRunText + '</span>' +
        (dataTypes.length > 0 ? '<br><span class="text-xs text-gray-500 mt-1 block">üì¶ ' + dataTypes.join(', ') + '</span>' : '');

    if (statusBox) statusBox.className = 'mt-4 p-4 bg-green-50 rounded-lg border border-green-200';
}

// Credentials form
document.getElementById('credentials-form').addEventListener('submit', async function(e) {
    e.preventDefault();

    var data = {
        eclaim_username: document.getElementById('eclaim-username').value,
        eclaim_password: document.getElementById('eclaim-password').value
    };

    try {
        var response = await fetch('/api/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        var result = await response.json();
        if (result.success) {
            showToast('Settings saved!', 'success');
        } else {
            showToast(result.error || 'Failed to save', 'error');
        }
    } catch (error) {
        showToast('Error saving settings', 'error');
    }
});

async function testConnection() {
    var statusDiv = document.getElementById('connection-status');
    statusDiv.classList.remove('hidden');
    statusDiv.className = 'mt-4 p-3 rounded-lg bg-gray-100';
    statusDiv.textContent = 'Testing connection...';

    try {
        var response = await fetch('/api/settings/test-connection', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-800';
            statusDiv.textContent = result.message;
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
            statusDiv.textContent = result.error;
        }
    } catch (error) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-800';
        statusDiv.textContent = 'Network error';
    }
}

// SMT Fetch
async function fetchSmtData() {
    var fiscalYear = document.getElementById('smt-fiscal-year').value;
    var month = document.getElementById('smt-month').value;

    try {
        showToast('Fetching SMT data...', 'info');

        // Build date range from fiscal year and month
        var startDate = null;
        var endDate = null;

        if (month) {
            // Calculate start and end date for specific month
            var monthInt = parseInt(month);
            var yearInt = parseInt(fiscalYear);
            // Thai fiscal year: Oct (yearBE-1) to Sep (yearBE)
            // So for month 10-12, use yearBE-1, for month 1-9, use yearBE
            var gregorianYear = monthInt >= 10 ? yearInt - 544 : yearInt - 543;
            var daysInMonth = new Date(gregorianYear, monthInt, 0).getDate();
            startDate = '01/' + String(monthInt).padStart(2, '0') + '/' + yearInt;
            endDate = String(daysInMonth).padStart(2, '0') + '/' + String(monthInt).padStart(2, '0') + '/' + yearInt;
        }

        var response = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                budget_year: fiscalYear,
                start_date: startDate,
                end_date: endDate,
                save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('SMT data fetched successfully! ' + (result.records || 0) + ' records', 'success');
            document.getElementById('smt-last-sync').textContent = new Date().toLocaleString('th-TH');
            document.getElementById('smt-record-count').textContent = result.records || 0;
        } else {
            showToast(result.error || 'Failed to fetch', 'error');
        }
    } catch (error) {
        console.error('SMT fetch error:', error);
        showToast('Error fetching SMT data: ' + error.message, 'error');
    }
}

// SMT Settings
async function saveSmtSettings(event) {
    event.preventDefault();

    var vendorId = document.getElementById('smt-vendor-id').value.trim();
    var autoSave = document.getElementById('smt-auto-save').checked;
    var statusDiv = document.getElementById('smt-settings-status');

    if (!vendorId) {
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
        statusDiv.textContent = 'Vendor ID is required';
        statusDiv.classList.remove('hidden');
        return;
    }

    try {
        var response = await fetch('/api/smt/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                smt_vendor_id: vendorId,
                smt_schedule_enabled: false,
                smt_schedule_times: [],
                smt_auto_save_db: autoSave
            })
        });
        var result = await response.json();

        if (result.success) {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-green-100 text-green-700';
            statusDiv.textContent = 'SMT settings saved successfully!';
            showToast('SMT settings saved!', 'success');
        } else {
            statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
            statusDiv.textContent = result.error || 'Failed to save settings';
        }
        statusDiv.classList.remove('hidden');
    } catch (error) {
        console.error('SMT settings error:', error);
        statusDiv.className = 'mt-4 p-3 rounded-lg bg-red-100 text-red-700';
        statusDiv.textContent = 'Error: ' + error.message;
        statusDiv.classList.remove('hidden');
    }
}

async function loadSmtSettings() {
    try {
        var response = await fetch('/api/smt/settings');
        var result = await response.json();

        if (result.success && result.settings) {
            // Settings tab fields
            var vendorInput = document.getElementById('smt-vendor-id');
            var autoSaveInput = document.getElementById('smt-auto-save');
            // Download tab SMT vendor field
            var dlVendorInput = document.getElementById('dl-vendor-id');
            // Schedule SMT vendor field
            var scheduleSmtVendorInput = document.getElementById('schedule-smt-vendor-id');

            if (vendorInput && result.settings.smt_vendor_id) {
                vendorInput.value = result.settings.smt_vendor_id;
            }
            if (dlVendorInput && result.settings.smt_vendor_id) {
                dlVendorInput.value = result.settings.smt_vendor_id;
            }
            if (scheduleSmtVendorInput && result.settings.smt_vendor_id && !scheduleSmtVendorInput.value) {
                // Only set if not already set (don't overwrite user input)
                scheduleSmtVendorInput.value = result.settings.smt_vendor_id;
            }
            if (autoSaveInput) {
                autoSaveInput.checked = result.settings.smt_auto_save_db !== false;
            }
        }
    } catch (error) {
        console.error('Failed to load SMT settings:', error);
    }
}

// Load SMT stats (record count and last sync time)
async function loadSmtStats() {
    try {
        var response = await fetch('/api/smt/stats');
        var result = await response.json();

        if (result.success) {
            var lastSyncEl = document.getElementById('smt-last-sync');
            var recordCountEl = document.getElementById('smt-record-count');

            if (lastSyncEl) {
                if (result.last_sync) {
                    lastSyncEl.textContent = new Date(result.last_sync).toLocaleString('th-TH');
                } else {
                    lastSyncEl.textContent = '-';
                }
            }
            if (recordCountEl) {
                recordCountEl.textContent = result.record_count ? result.record_count.toLocaleString() : '0';
            }
        }
    } catch (error) {
        console.error('Failed to load SMT stats:', error);
    }
}

// Clear SMT data
async function clearSmtData() {
    if (!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) {
        return;
    }

    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á: ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Smart Money Transfer ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
        return;
    }

    try {
        var response = await fetch('/api/smt/clear', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
            loadSmtStats();
        } else {
            showToast(result.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
        }
    } catch (error) {
        console.error('Failed to clear SMT data:', error);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 'error');
    }
}

// Quick save vendor ID from SMT tab
async function saveSmtVendorId() {
    var vendorId = document.getElementById('smt-vendor-id-input').value.trim();

    if (!vendorId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å Vendor ID', 'error');
        return;
    }

    try {
        var response = await fetch('/api/smt/settings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                smt_vendor_id: vendorId,
                smt_schedule_enabled: false,
                smt_schedule_times: [],
                smt_auto_save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('Vendor ID saved: ' + vendorId, 'success');
            // Sync to settings tab if it exists
            var settingsInput = document.getElementById('smt-vendor-id');
            if (settingsInput) settingsInput.value = vendorId;
        } else {
            showToast(result.error || 'Failed to save', 'error');
        }
    } catch (error) {
        console.error('Save vendor ID error:', error);
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== HEALTH OFFICES FUNCTIONS ====================
let hoCurrentPage = 1;
let hoSearchTimeout;

async function hoLoadStats() {
    try {
        var response = await fetch('/api/health-offices/stats');
        var result = await response.json();

        if (result.success) {
            var stats = result.stats;
            document.getElementById('ho-stat-total').textContent = stats.total.toLocaleString();

            var active = stats.by_status.find(function(s) { return s.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô'; });
            document.getElementById('ho-stat-active').textContent = active ? active.count.toLocaleString() : '0';
            document.getElementById('ho-stat-provinces').textContent = stats.provinces.length;
            document.getElementById('ho-stat-hospitals').textContent = stats.levels.length > 0 ? stats.levels.length + ' levels' : '0';

            hoPopulateFilter('ho-filter-province', stats.provinces);
            hoPopulateFilter('ho-filter-level', stats.levels);
        }
    } catch (e) {
        console.error('Error loading HO stats:', e);
    }
}

function hoPopulateFilter(elementId, options) {
    var select = document.getElementById(elementId);
    var firstOption = select.options[0];
    select.textContent = '';
    select.appendChild(firstOption);

    options.forEach(function(opt) {
        var option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
    });
}

async function hoLoadData() {
    var search = document.getElementById('ho-search-input').value;
    var province = document.getElementById('ho-filter-province').value;
    var level = document.getElementById('ho-filter-level').value;
    var perPage = document.getElementById('ho-per-page').value;

    var params = new URLSearchParams();
    params.append('page', hoCurrentPage);
    params.append('per_page', perPage);
    if (search) params.append('search', search);
    if (province) params.append('province', province);
    if (level) params.append('level', level);

    try {
        var response = await fetch('/api/health-offices?' + params.toString());
        var result = await response.json();

        if (result.success) {
            hoRenderTable(result.data);
            document.getElementById('ho-showing-count').textContent = result.data.length;
            document.getElementById('ho-total-count').textContent = result.total.toLocaleString();
            hoRenderPagination(result.page, result.total_pages);
        }
    } catch (e) {
        console.error('Error loading HO data:', e);
    }
}

function hoRenderTable(data) {
    var tbody = document.getElementById('ho-data-tbody');
    tbody.textContent = '';

    if (!data || data.length === 0) {
        var emptyRow = document.createElement('tr');
        var emptyCell = document.createElement('td');
        emptyCell.colSpan = 5;
        emptyCell.className = 'px-4 py-8 text-center text-gray-500';
        emptyCell.textContent = 'No data found';
        emptyRow.appendChild(emptyCell);
        tbody.appendChild(emptyRow);
        return;
    }

    data.forEach(function(row) {
        var tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        // hcode5
        var td1 = document.createElement('td');
        td1.className = 'px-4 py-2 text-sm font-mono';
        td1.textContent = row.hcode5 || '-';
        tr.appendChild(td1);

        // name
        var td2 = document.createElement('td');
        td2.className = 'px-4 py-2 text-sm';
        td2.textContent = row.name || '-';
        tr.appendChild(td2);

        // hospital_level
        var td3 = document.createElement('td');
        td3.className = 'px-4 py-2 text-sm text-gray-600';
        td3.textContent = row.hospital_level || '-';
        tr.appendChild(td3);

        // province
        var td4 = document.createElement('td');
        td4.className = 'px-4 py-2 text-sm text-gray-600';
        td4.textContent = row.province || '-';
        tr.appendChild(td4);

        // status
        var td5 = document.createElement('td');
        td5.className = 'px-4 py-2 text-center';
        var statusSpan = document.createElement('span');
        statusSpan.className = 'px-2 py-1 text-xs rounded-full ' +
            (row.status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800');
        statusSpan.textContent = row.status || '-';
        td5.appendChild(statusSpan);
        tr.appendChild(td5);

        tbody.appendChild(tr);
    });
}

function hoRenderPagination(page, totalPages) {
    var pagination = document.getElementById('ho-pagination');
    pagination.textContent = '';
    if (totalPages <= 1) return;

    function addBtn(text, pageNum, isActive) {
        var btn = document.createElement('button');
        btn.textContent = text;
        btn.className = 'px-3 py-1 border rounded text-sm ' + (isActive ? 'bg-blue-600 text-white' : 'hover:bg-gray-100');
        btn.onclick = function() { hoCurrentPage = pageNum; hoLoadData(); };
        pagination.appendChild(btn);
    }

    if (page > 1) addBtn('Prev', page - 1, false);
    for (var i = Math.max(1, page - 2); i <= Math.min(totalPages, page + 2); i++) {
        addBtn(String(i), i, i === page);
    }
    if (page < totalPages) addBtn('Next', page + 1, false);
}

function hoDebounceSearch() {
    clearTimeout(hoSearchTimeout);
    hoSearchTimeout = setTimeout(function() {
        hoCurrentPage = 1;
        hoLoadData();
    }, 300);
}

function hoHandleFileSelect(input) {
    if (input.files && input.files[0]) {
        document.getElementById('ho-file-name').textContent = input.files[0].name;
        document.getElementById('ho-upload-area').classList.add('hidden');
        document.getElementById('ho-file-selected').classList.remove('hidden');
        document.getElementById('ho-btn-import').disabled = false;
    }
}

async function hoImportData() {
    var fileInput = document.getElementById('ho-import-file');
    if (!fileInput.files || !fileInput.files[0]) {
        showToast('Please select a file', 'error');
        return;
    }

    var mode = document.querySelector('input[name="ho-import-mode"]:checked').value;
    if (mode === 'replace' && !confirm('This will DELETE all existing data. Continue?')) return;

    var formData = new FormData();
    formData.append('file', fileInput.files[0]);
    formData.append('mode', mode);

    document.getElementById('ho-btn-import').disabled = true;
    document.getElementById('ho-import-progress').classList.remove('hidden');
    document.getElementById('ho-import-result').classList.add('hidden');

    var progress = 0;
    var progressInterval = setInterval(function() {
        progress += Math.random() * 10;
        if (progress > 90) progress = 90;
        document.getElementById('ho-import-percent').textContent = Math.round(progress) + '%';
        document.getElementById('ho-import-bar').style.width = progress + '%';
    }, 500);

    try {
        var response = await fetch('/api/health-offices/import', {
            method: 'POST',
            body: formData
        });
        var result = await response.json();

        clearInterval(progressInterval);
        document.getElementById('ho-import-percent').textContent = '100%';
        document.getElementById('ho-import-bar').style.width = '100%';

        var resultDiv = document.getElementById('ho-import-result');
        resultDiv.textContent = '';

        if (result.success) {
            resultDiv.className = 'p-3 rounded-lg bg-green-100 text-green-800';
            resultDiv.textContent = 'Success! Imported: ' + result.imported.toLocaleString() +
                ' | Errors: ' + result.errors + ' | Time: ' + result.duration + 's';
            showToast('Import completed: ' + result.imported + ' records', 'success');
            hoLoadStats();
            hoLoadData();
        } else {
            resultDiv.className = 'p-3 rounded-lg bg-red-100 text-red-800';
            resultDiv.textContent = 'Error: ' + result.error;
            showToast('Import failed', 'error');
        }
        resultDiv.classList.remove('hidden');
    } catch (error) {
        clearInterval(progressInterval);
        showToast('Import error: ' + error.message, 'error');
    }

    document.getElementById('ho-btn-import').disabled = false;
    setTimeout(function() {
        document.getElementById('ho-import-progress').classList.add('hidden');
    }, 2000);
}

async function hoClearAllData() {
    if (!confirm('DELETE ALL health offices data? This cannot be undone.')) return;
    if (!confirm('Are you really sure?')) return;

    try {
        var response = await fetch('/api/health-offices/clear', { method: 'POST' });
        var result = await response.json();

        if (result.success) {
            showToast('All data cleared', 'success');
            hoLoadStats();
            hoLoadData();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== STATEMENT FUNCTIONS ====================

function initStatementYears() {
    var select = document.getElementById('stm-year');
    if (!select) return;

    var currentYear = new Date().getFullYear() + 543;
    select.textContent = '';

    for (var y = currentYear; y >= currentYear - 5; y--) {
        var option = document.createElement('option');
        option.value = y;
        option.textContent = '‡∏õ‡∏µ‡∏á‡∏ö ' + y;
        select.appendChild(option);
    }
}

async function downloadStatement() {
    var year = document.getElementById('bulk-start-year').value;
    var month = document.getElementById('bulk-start-month').value;  // Empty = all months
    var personType = document.getElementById('dl-patient-type').value;
    var autoImportCheckbox = document.getElementById('dl-stm-auto-import');
    var autoImport = autoImportCheckbox ? autoImportCheckbox.checked : false;

    // Disable button during download
    var downloadBtn = document.getElementById('download-btn');
    var btnText = document.getElementById('download-btn-text');
    var originalText = btnText.textContent;
    downloadBtn.disabled = true;
    btnText.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...';

    try {
        var response = await fetch('/api/stm/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                year: year,
                month: month || null,  // null = all months
                scheme: 'ucs',  // Statement is UCS only
                person_type: personType,
                auto_import: autoImport
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('Statement download started' + (autoImport ? ' with auto-import' : ''), 'success');
            setTimeout(loadStatementFiles, 3000);
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    } finally {
        // Re-enable button
        downloadBtn.disabled = false;
        btnText.textContent = originalText;
    }
}

async function loadStatementFiles() {
    const listDiv = document.getElementById('stm-file-list');
    listDiv.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>';

    try {
        const response = await fetch('/api/stm/stats');
        const result = await response.json();

        // Update stats
        document.getElementById('stm-stat-total').textContent = result.total_files || 0;
        document.getElementById('stm-stat-imported').textContent = result.imported_count || 0;
        document.getElementById('stm-stat-pending').textContent = result.pending_count || 0;
        document.getElementById('stm-stat-size').textContent = result.total_size || '0 B';
        document.getElementById('stm-file-count').textContent = `‡πÅ‡∏™‡∏î‡∏á ${result.total_files || 0} ‡πÑ‡∏ü‡∏•‡πå`;

        // Show/hide action buttons
        const importAllBtn = document.getElementById('stm-import-all-btn');
        const clearBtn = document.getElementById('stm-clear-btn');
        const pendingCountSpan = document.getElementById('stm-pending-count');

        if (result.pending_count > 0) {
            importAllBtn.classList.remove('hidden');
            pendingCountSpan.textContent = result.pending_count;
        } else {
            importAllBtn.classList.add('hidden');
        }

        if (result.total_files > 0) {
            clearBtn.classList.remove('hidden');
        } else {
            clearBtn.classList.add('hidden');
        }

        listDiv.innerHTML = '';

        if (result.success && result.files && result.files.length > 0) {
            result.files.forEach(function(f) {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50';

                // Filename
                const nameCell = document.createElement('td');
                nameCell.className = 'px-4 py-3';
                nameCell.innerHTML = `<span class="text-blue-600">&#9679;</span> ${f.filename}`;
                row.appendChild(nameCell);

                // Date
                const dateCell = document.createElement('td');
                dateCell.className = 'px-4 py-3 text-gray-600';
                const modDate = new Date(f.modified);
                dateCell.textContent = modDate.toLocaleString('th-TH');
                row.appendChild(dateCell);

                // Size
                const sizeCell = document.createElement('td');
                sizeCell.className = 'px-4 py-3 text-gray-600';
                sizeCell.textContent = f.size_formatted;
                row.appendChild(sizeCell);

                // Status
                const statusCell = document.createElement('td');
                statusCell.className = 'px-4 py-3';
                if (f.is_imported) {
                    let statusInfo = 'Imported';
                    if (f.imported_records) {
                        statusInfo += ` (${f.imported_records} records)`;
                    }
                    if (f.file_type) {
                        statusInfo = f.file_type.replace('_STM', '') + ' - ' + statusInfo;
                    }
                    statusCell.innerHTML = `<span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">${statusInfo}</span>`;
                } else if (f.status === 'failed') {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Failed</span>';
                } else if (f.status === 'processing') {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Processing...</span>';
                } else {
                    statusCell.innerHTML = '<span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Pending</span>';
                }
                row.appendChild(statusCell);

                // Actions
                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-4 py-3 text-right space-x-2';

                if (!f.is_imported) {
                    const importBtn = document.createElement('a');
                    importBtn.href = '#';
                    importBtn.className = 'text-blue-600 hover:text-blue-800 text-sm';
                    importBtn.textContent = 'Import';
                    importBtn.onclick = (e) => { e.preventDefault(); importStatementFile(f.filename); };
                    actionsCell.appendChild(importBtn);
                }

                const downloadBtn = document.createElement('a');
                downloadBtn.href = `/downloads/${f.filename}`;
                downloadBtn.className = 'text-purple-600 hover:text-purple-800 text-sm ml-2';
                downloadBtn.textContent = 'Download';
                downloadBtn.target = '_blank';
                actionsCell.appendChild(downloadBtn);

                const deleteBtn = document.createElement('a');
                deleteBtn.href = '#';
                deleteBtn.className = 'text-red-600 hover:text-red-800 text-sm ml-2';
                deleteBtn.textContent = 'Delete';
                deleteBtn.onclick = (e) => { e.preventDefault(); deleteStatementFile(f.filename); };
                actionsCell.appendChild(deleteBtn);

                row.appendChild(actionsCell);
                listDiv.appendChild(row);
            });
        } else {
            listDiv.innerHTML = '<tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">No Statement files found</td></tr>';
        }
    } catch (error) {
        listDiv.innerHTML = `<tr><td colspan="5" class="px-4 py-8 text-center text-red-500">Error loading files: ${error.message}</td></tr>`;
    }
}

async function importStatementFile(filename) {
    if (!confirm(`Import file: ${filename}?`)) return;

    try {
        showToast('Importing...', 'info');
        const response = await fetch(`/api/stm/import/${encodeURIComponent(filename)}`, { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            const records = result.claim_records || result.imported_records || 0;
            const fileType = result.file_type ? ` (${result.file_type})` : '';
            showToast(`Imported ${records} records${fileType}`, 'success');
            loadStatementFiles();
        } else {
            showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function deleteStatementFile(filename) {
    if (!confirm(`Delete file: ${filename}?`)) return;

    try {
        const response = await fetch(`/api/stm/delete/${encodeURIComponent(filename)}`, { method: 'DELETE' });
        const result = await response.json();

        if (result.success) {
            showToast('File deleted', 'success');
            loadStatementFiles();
        } else {
            showToast('Delete failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function importAllStatementFiles() {
    if (!confirm('Import all pending Statement files?')) return;

    try {
        showToast('Importing all files...', 'info');
        const response = await fetch('/api/stm/import-all', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(`Imported ${result.success} files, ${result.skipped} skipped`, 'success');
            loadStatementFiles();
        } else {
            showToast('Import failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function clearAllStatementFiles() {
    if (!confirm('‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå Statement ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?\n\n‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ!')) return;
    if (!confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á - ‡∏•‡∏ö‡πÑ‡∏ü‡∏•‡πå Statement ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) return;

    try {
        const response = await fetch('/api/stm/clear', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
            loadStatementFiles();
        } else {
            showToast('Clear failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// ==================== STM Schedule Functions ====================

function toggleStmSchedule() {
    const content = document.getElementById('stm-schedule-content');
    const arrow = document.getElementById('stm-schedule-arrow');
    content.classList.toggle('hidden');
    arrow.classList.toggle('rotate-180');
}

function toggleStmScheduleEnabled() {
    const enabled = document.getElementById('stm-schedule-enabled').checked;
    // Just toggle the visual state, actual save happens on button click
}

async function loadStmScheduleSettings() {
    try {
        const response = await fetch('/api/stm/schedule');
        const result = await response.json();

        if (result.success) {
            // Set enabled toggle
            document.getElementById('stm-schedule-enabled').checked = result.stm_schedule_enabled;

            // Set schemes
            ['ucs', 'ofc', 'sss', 'lgo'].forEach(scheme => {
                const checkbox = document.getElementById('stm-scheme-' + scheme);
                if (checkbox) {
                    checkbox.checked = result.stm_schedule_schemes.includes(scheme);
                }
            });

            // Set auto import
            document.getElementById('stm-schedule-auto-import').checked = result.stm_schedule_auto_import;

            // Set times
            const timesContainer = document.getElementById('stm-schedule-times');
            timesContainer.innerHTML = '';
            if (result.stm_schedule_times && result.stm_schedule_times.length > 0) {
                result.stm_schedule_times.forEach(time => {
                    addStmScheduleTimeRow(time.hour, time.minute);
                });
            } else {
                addStmScheduleTimeRow(9, 0); // Default time
            }
        }
    } catch (error) {
        console.error('Error loading STM schedule settings:', error);
    }
}

function addStmScheduleTime() {
    addStmScheduleTimeRow(9, 0);
}

function addStmScheduleTimeRow(hour = 9, minute = 0) {
    const container = document.getElementById('stm-schedule-times');
    const row = document.createElement('div');
    row.className = 'flex items-center gap-2';
    row.innerHTML = `
        <select class="stm-schedule-hour border rounded px-2 py-1 text-sm">
            ${Array.from({length: 24}, (_, i) => `<option value="${i}" ${i === hour ? 'selected' : ''}>${String(i).padStart(2, '0')}</option>`).join('')}
        </select>
        <span>:</span>
        <select class="stm-schedule-minute border rounded px-2 py-1 text-sm">
            ${[0, 15, 30, 45].map(m => `<option value="${m}" ${m === minute ? 'selected' : ''}>${String(m).padStart(2, '0')}</option>`).join('')}
        </select>
        <span class="text-gray-500 text-sm">‡∏ô.</span>
        <button onclick="this.parentElement.remove()" class="text-red-500 hover:text-red-700 text-sm">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </button>
    `;
    container.appendChild(row);
}

async function saveStmSchedule() {
    try {
        const enabled = document.getElementById('stm-schedule-enabled').checked;
        const autoImport = document.getElementById('stm-schedule-auto-import').checked;

        // Get selected schemes
        const schemes = [];
        document.querySelectorAll('.stm-scheme-checkbox:checked').forEach(cb => {
            schemes.push(cb.value);
        });

        // Get times
        const times = [];
        document.querySelectorAll('#stm-schedule-times > div').forEach(row => {
            const hour = parseInt(row.querySelector('.stm-schedule-hour').value);
            const minute = parseInt(row.querySelector('.stm-schedule-minute').value);
            times.push({ hour, minute });
        });

        const response = await fetch('/api/stm/schedule', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                stm_schedule_enabled: enabled,
                stm_schedule_times: times,
                stm_schedule_auto_import: autoImport,
                stm_schedule_schemes: schemes
            })
        });

        const result = await response.json();
        if (result.success) {
            showToast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ STM ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', 'success');
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

async function testStmSchedule() {
    if (!confirm('‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î Statement ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ?')) return;

    try {
        showToast('‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î...', 'info');
        const response = await fetch('/api/stm/schedule/test', { method: 'POST' });
        const result = await response.json();

        if (result.success) {
            showToast(result.message, 'success');
        } else {
            showToast('Error: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (error) {
        showToast('Error: ' + error.message, 'error');
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    initFromUrl();
    populateYearDropdowns();
    initStatementYears();
    loadStatementFiles();
    loadScheduleSettings();
    loadStmScheduleSettings();
    loadSmtSettings();
    loadSmtStats();
    hoLoadStats();
    hoLoadData();

    // SMT settings form
    var smtForm = document.getElementById('smt-settings-form');
    if (smtForm) {
        smtForm.addEventListener('submit', saveSmtSettings);
    }

    // Bulk estimate listeners
    ['bulk-start-month', 'bulk-start-year', 'bulk-end-month', 'bulk-end-year'].forEach(function(id) {
        var el = document.getElementById(id);
        if (el) el.addEventListener('change', updateBulkEstimate);
    });

    // Scheme checkbox listeners for estimate update
    document.querySelectorAll('input[name="bulk-schemes"]').forEach(function(cb) {
        cb.addEventListener('change', updateBulkEstimate);
    });

    updateBulkEstimate();
});
</script>
{% endblock %}
