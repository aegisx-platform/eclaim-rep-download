{% extends "base.html" %}

{% block title %}License Management - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <div class="bg-indigo-100 p-3 rounded-xl">
                <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                </svg>
            </div>
            License Management
        </h1>
        <p class="text-gray-600 mt-2">จัดการ license และตรวจสอบฟีเจอร์ที่ใช้งานได้</p>
    </div>

    <!-- Alert Notification -->
    <div id="alert-notification" class="hidden mb-6 rounded-lg p-4 shadow-md border-l-4" role="alert">
        <div class="flex items-start gap-3">
            <svg id="alert-icon" class="w-6 h-6 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"></svg>
            <div class="flex-1">
                <h3 id="alert-title" class="font-semibold mb-1"></h3>
                <p id="alert-message" class="text-sm"></p>
            </div>
            <button onclick="closeAlert()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Current License Status -->
    <div id="license-status-card" class="bg-white rounded-xl shadow-sm border mb-6">
        <div class="p-6 border-b">
            <h2 class="text-lg font-semibold text-gray-800">License Status</h2>
        </div>
        <div class="p-6">
            <!-- Loading state -->
            <div id="license-loading" class="text-center py-8">
                <div class="animate-spin w-8 h-8 border-4 border-indigo-600 border-t-transparent rounded-full mx-auto mb-3"></div>
                <p class="text-gray-500">Loading license information...</p>
            </div>

            <!-- License info (hidden by default) -->
            <div id="license-info" class="hidden">
                <!-- Status Badge -->
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-4">
                        <div id="status-icon" class="w-16 h-16 rounded-full flex items-center justify-center"></div>
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <h3 id="license-tier" class="text-2xl font-bold text-gray-800">-</h3>
                                <span id="license-status-badge" class="text-xs px-3 py-1 rounded-full">-</span>
                            </div>
                            <p id="license-key-display" class="text-sm text-gray-600">-</p>
                        </div>
                    </div>
                    <button onclick="removeLicense()" id="remove-license-btn" class="hidden text-red-600 hover:text-red-700 text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                        Remove License
                    </button>
                </div>

                <!-- License Details Grid -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Hospital</div>
                        <div id="hospital-name" class="font-medium text-gray-800">-</div>
                        <div id="hospital-code" class="text-xs text-gray-500">-</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Expiration</div>
                        <div id="expiry-date" class="font-medium text-gray-800">-</div>
                        <div id="days-remaining" class="text-xs text-gray-500">-</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Max Users</div>
                        <div id="max-users" class="font-medium text-gray-800">-</div>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="text-sm text-gray-600 mb-1">Records Limit</div>
                        <div id="max-records" class="font-medium text-gray-800">-</div>
                    </div>
                </div>

                <!-- Features List -->
                <div>
                    <h4 class="text-sm font-semibold text-gray-700 mb-3">Available Features</h4>
                    <div id="features-list" class="grid md:grid-cols-2 gap-2">
                        <!-- Features will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Install New License -->
    <div class="bg-white rounded-xl shadow-sm border mb-6">
        <div class="p-6 border-b">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Install / Update License</h2>
                <button onclick="toggleInstallForm()" id="toggle-install-btn" class="text-indigo-600 hover:text-indigo-700 text-sm font-medium">
                    Show Form
                </button>
            </div>
        </div>
        <div id="install-form" class="hidden p-6">
            <form onsubmit="installLicense(event)">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">License Key</label>
                        <input type="text" id="license-key-input" placeholder="NHSO-A1B2C3D4-E5F6G7H8"
                               class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" required>
                        <p class="text-xs text-gray-500 mt-1">รหัส license ที่ได้รับจากผู้ให้บริการ</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">License Token (JWT)</label>
                        <textarea id="license-token-input" rows="6" placeholder="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs" required></textarea>
                        <p class="text-xs text-gray-500 mt-1">JWT token ที่ได้รับจากผู้ให้บริการ</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Public Key (RSA)</label>
                        <textarea id="public-key-input" rows="8" placeholder="-----BEGIN PUBLIC KEY-----&#10;...&#10;-----END PUBLIC KEY-----"
                                  class="w-full border border-gray-300 rounded-lg px-4 py-2 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-xs" required></textarea>
                        <p class="text-xs text-gray-500 mt-1">RSA public key ในรูปแบบ PEM</p>
                    </div>

                    <div class="flex gap-3">
                        <button type="submit" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-2 rounded-lg font-medium transition-colors">
                            Install License
                        </button>
                        <button type="button" onclick="toggleInstallForm()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-6 py-2 rounded-lg font-medium transition-colors">
                            Cancel
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Tier Comparison (truncated for brevity - same as before) -->
</div>

<script>
    // Alert notification functions
    function showAlert(type, title, message) {
        const alert = document.getElementById('alert-notification');
        const icon = document.getElementById('alert-icon');
        const titleEl = document.getElementById('alert-title');
        const messageEl = document.getElementById('alert-message');

        // Set content
        titleEl.textContent = title;
        messageEl.textContent = message;

        // Reset classes
        alert.className = 'mb-6 rounded-lg p-4 shadow-md border-l-4';

        // Clear icon
        icon.textContent = '';

        // Set colors and icon based on type
        if (type === 'success') {
            alert.classList.add('bg-green-50', 'border-green-500');
            titleEl.className = 'font-semibold mb-1 text-green-800';
            messageEl.className = 'text-sm text-green-700';
            icon.className = 'w-6 h-6 flex-shrink-0 text-green-600';
            icon.appendChild(createSvgIcon('M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', 'w-6 h-6 text-green-600'));
        } else if (type === 'error') {
            alert.classList.add('bg-red-50', 'border-red-500');
            titleEl.className = 'font-semibold mb-1 text-red-800';
            messageEl.className = 'text-sm text-red-700';
            icon.className = 'w-6 h-6 flex-shrink-0 text-red-600';
            icon.appendChild(createSvgIcon('M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z', 'w-6 h-6 text-red-600'));
        } else if (type === 'warning') {
            alert.classList.add('bg-yellow-50', 'border-yellow-500');
            titleEl.className = 'font-semibold mb-1 text-yellow-800';
            messageEl.className = 'text-sm text-yellow-700';
            icon.className = 'w-6 h-6 flex-shrink-0 text-yellow-600';
            icon.appendChild(createSvgIcon('M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z', 'w-6 h-6 text-yellow-600'));
        }

        // Show alert
        alert.classList.remove('hidden');

        // Auto-hide after 10 seconds for success messages
        if (type === 'success') {
            setTimeout(() => {
                closeAlert();
            }, 10000);
        }

        // Scroll to top to show alert
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function closeAlert() {
        document.getElementById('alert-notification').classList.add('hidden');
    }

    // Load license info on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadLicenseInfo();
    });

    async function loadLicenseInfo() {
        try {
            const response = await fetch('/api/settings/license');
            const data = await response.json();

            if (data.success && data.license) {
                displayLicenseInfo(data.license);
            } else {
                displayNoLicense();
            }
        } catch (error) {
            console.error('Error loading license:', error);
            displayNoLicense();
        }
    }

    function createSvgIcon(pathD, className) {
        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('class', className);
        svg.setAttribute('fill', 'none');
        svg.setAttribute('stroke', 'currentColor');
        svg.setAttribute('viewBox', '0 0 24 24');

        const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        path.setAttribute('stroke-linecap', 'round');
        path.setAttribute('stroke-linejoin', 'round');
        path.setAttribute('stroke-width', '2');
        path.setAttribute('d', pathD);

        svg.appendChild(path);
        return svg;
    }

    function displayLicenseInfo(license) {
        document.getElementById('license-loading').classList.add('hidden');
        document.getElementById('license-info').classList.remove('hidden');

        const isValid = license.is_valid;
        const tier = license.tier || 'trial';
        const status = license.status || 'invalid';

        // Tier names in Thai
        const tierNames = {
            'trial': 'ทดลองใช้งาน',
            'basic': 'พื้นฐาน',
            'professional': 'มืออาชีพ',
            'enterprise': 'องค์กร'
        };

        // Status badge colors
        const statusColors = {
            'active': 'bg-green-100 text-green-800',
            'expiring_soon': 'bg-yellow-100 text-yellow-800',
            'grace_period': 'bg-orange-100 text-orange-800',
            'invalid': 'bg-red-100 text-red-800'
        };

        // Status icon
        const statusIcon = document.getElementById('status-icon');
        statusIcon.textContent = ''; // Clear existing content

        if (isValid) {
            statusIcon.className = 'w-16 h-16 rounded-full bg-green-100 flex items-center justify-center';
            statusIcon.appendChild(createSvgIcon('M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z', 'w-8 h-8 text-green-600'));
        } else {
            statusIcon.className = 'w-16 h-16 rounded-full bg-red-100 flex items-center justify-center';
            statusIcon.appendChild(createSvgIcon('M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z', 'w-8 h-8 text-red-600'));
        }

        // Tier and status
        document.getElementById('license-tier').textContent = tierNames[tier] || tier;
        const statusBadge = document.getElementById('license-status-badge');
        statusBadge.textContent = isValid ? (status === 'active' ? 'ใช้งานได้' : (status === 'grace_period' ? 'ช่วงผ่อนผัน' : 'ใกล้หมดอายุ')) : 'ไม่ถูกต้อง';
        statusBadge.className = 'text-xs px-3 py-1 rounded-full ' + (statusColors[status] || 'bg-gray-100 text-gray-800');

        // License key
        document.getElementById('license-key-display').textContent = license.license_key || 'No license key';

        // Hospital info
        document.getElementById('hospital-name').textContent = license.hospital_name || '-';
        document.getElementById('hospital-code').textContent = license.hospital_code ? 'รหัส: ' + license.hospital_code : '-';

        // Expiration
        if (license.expires_at) {
            const expiryDate = new Date(license.expires_at);
            document.getElementById('expiry-date').textContent = expiryDate.toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' });

            const daysLeft = license.days_until_expiry;
            if (daysLeft !== null && daysLeft !== undefined) {
                const daysEl = document.getElementById('days-remaining');
                if (daysLeft < 0) {
                    daysEl.textContent = 'หมดอายุแล้ว ' + Math.abs(daysLeft) + ' วัน';
                    daysEl.className = 'text-xs text-red-500';
                } else if (daysLeft <= 30) {
                    daysEl.textContent = 'เหลืออีก ' + daysLeft + ' วัน';
                    daysEl.className = 'text-xs text-orange-500';
                } else {
                    daysEl.textContent = 'เหลืออีก ' + daysLeft + ' วัน';
                    daysEl.className = 'text-xs text-green-500';
                }
            }

            if (license.grace_period) {
                const graceLeft = license.grace_days_left || 0;
                const daysEl = document.getElementById('days-remaining');
                daysEl.textContent = 'ช่วงผ่อนผันเหลือ ' + graceLeft + ' วัน';
                daysEl.className = 'text-xs text-orange-500 font-medium';
            }
        } else {
            document.getElementById('expiry-date').textContent = license.license_type === 'perpetual' ? 'ไม่มีวันหมดอายุ (Perpetual)' : '-';
            document.getElementById('days-remaining').textContent = '-';
        }

        // Limits
        const maxUsers = license.max_users || license.features?.max_users || 0;
        document.getElementById('max-users').textContent = maxUsers === 9999 ? 'Unlimited' : maxUsers.toLocaleString();

        const maxRecords = license.features?.max_records_per_import || 0;
        document.getElementById('max-records').textContent = maxRecords === 9999999 ? 'Unlimited' : maxRecords.toLocaleString();

        // Features
        const features = license.features || {};
        const featuresList = document.getElementById('features-list');
        featuresList.textContent = ''; // Clear existing

        const featureNames = {
            'smt_budget': 'SMT Budget Sync',
            'analytics_advanced': 'Advanced Analytics',
            'reconciliation': 'REP vs SMT Reconciliation',
            'api_access': 'API Access',
            'priority_support': 'Priority Support',
            'custom_reports': 'Custom Reports',
            'white_label': 'White Label',
            'dedicated_support': 'Dedicated Support'
        };

        Object.entries(featureNames).forEach(function([key, name]) {
            const enabled = features[key] || false;
            const div = document.createElement('div');
            div.className = 'flex items-center gap-2 text-sm';

            const iconPath = enabled ? 'M5 13l4 4L19 7' : 'M6 18L18 6M6 6l12 12';
            const iconClass = enabled ? 'w-4 h-4 text-green-500' : 'w-4 h-4 text-gray-300';
            div.appendChild(createSvgIcon(iconPath, iconClass));

            const span = document.createElement('span');
            span.className = enabled ? 'text-gray-700' : 'text-gray-400';
            span.textContent = name;
            div.appendChild(span);

            featuresList.appendChild(div);
        });

        // Show remove button if license is installed
        if (isValid || license.license_key) {
            document.getElementById('remove-license-btn').classList.remove('hidden');
        }
    }

    function displayNoLicense() {
        document.getElementById('license-loading').classList.add('hidden');
        document.getElementById('license-info').classList.remove('hidden');

        const statusIcon = document.getElementById('status-icon');
        statusIcon.textContent = '';
        statusIcon.className = 'w-16 h-16 rounded-full bg-gray-100 flex items-center justify-center';
        statusIcon.appendChild(createSvgIcon('M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z', 'w-8 h-8 text-gray-400'));

        document.getElementById('license-tier').textContent = 'ทดลองใช้งาน (Trial Mode)';
        document.getElementById('license-status-badge').textContent = 'No License';
        document.getElementById('license-status-badge').className = 'text-xs px-3 py-1 rounded-full bg-gray-100 text-gray-800';
        document.getElementById('license-key-display').textContent = 'ติดตั้ง license เพื่อปลดล็อกฟีเจอร์เพิ่มเติม';

        document.getElementById('hospital-name').textContent = '-';
        document.getElementById('hospital-code').textContent = '-';
        document.getElementById('expiry-date').textContent = '-';
        document.getElementById('days-remaining').textContent = '-';
        document.getElementById('max-users').textContent = '2';
        document.getElementById('max-records').textContent = '1,000';

        // Show trial features
        const featuresList = document.getElementById('features-list');
        featuresList.textContent = '';
        const p = document.createElement('p');
        p.className = 'text-sm text-gray-500 col-span-2';
        p.textContent = 'ฟีเจอร์พื้นฐานเท่านั้น - ติดตั้ง license เพื่อปลดล็อกฟีเจอร์เพิ่มเติม';
        featuresList.appendChild(p);

        document.getElementById('remove-license-btn').classList.add('hidden');
    }

    function toggleInstallForm() {
        const form = document.getElementById('install-form');
        const btn = document.getElementById('toggle-install-btn');

        if (form.classList.contains('hidden')) {
            form.classList.remove('hidden');
            btn.textContent = 'Hide Form';
        } else {
            form.classList.add('hidden');
            btn.textContent = 'Show Form';
        }
    }

    async function installLicense(event) {
        event.preventDefault();

        const licenseKey = document.getElementById('license-key-input').value.trim();
        const licenseToken = document.getElementById('license-token-input').value.trim();
        const publicKey = document.getElementById('public-key-input').value.trim();

        if (!licenseKey || !licenseToken || !publicKey) {
            showAlert('warning', 'ข้อมูลไม่ครบ', 'กรุณากรอกข้อมูลให้ครบทุกช่อง (License Key, Token และ Public Key)');
            return;
        }

        try {
            const response = await fetch('/api/settings/license', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token() }}'
                },
                body: JSON.stringify({
                    license_key: licenseKey,
                    license_token: licenseToken,
                    public_key: publicKey
                })
            });

            const data = await response.json();

            if (data.success) {
                const tierName = data.license?.tier || '-';
                const expiryDate = data.license?.expires_at || 'Never';
                showAlert(
                    'success',
                    'ติดตั้ง License สำเร็จ!',
                    `License ระดับ ${tierName} ถูกติดตั้งเรียบร้อยแล้ว - หมดอายุ: ${expiryDate}`
                );

                // Clear form
                document.getElementById('license-key-input').value = '';
                document.getElementById('license-token-input').value = '';
                document.getElementById('public-key-input').value = '';

                // Hide form
                toggleInstallForm();

                // Reload license info
                loadLicenseInfo();
            } else {
                // Check if it's a hospital code mismatch error
                const errorMsg = data.error || 'Failed to install license';
                if (errorMsg.includes('License mismatch') || errorMsg.includes('hospital code')) {
                    showAlert(
                        'error',
                        'รหัส รพ. ไม่ตรงกัน',
                        errorMsg + ' กรุณาติดต่อผู้ให้บริการเพื่อขอ license ที่ถูกต้องสำหรับรหัสโรงพยาบาลของท่าน'
                    );
                } else {
                    showAlert('error', 'ติดตั้ง License ไม่สำเร็จ', errorMsg);
                }
            }
        } catch (error) {
            showAlert('error', 'เกิดข้อผิดพลาด', 'ไม่สามารถติดตั้ง License ได้: ' + error.message);
        }
    }

    async function removeLicense() {
        if (!confirm('คุณต้องการลบ license ออกใช่หรือไม่?\n\nระบบจะกลับเป็น Trial Mode')) {
            return;
        }

        try {
            const response = await fetch('/api/settings/license', {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token() }}'
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('✅ License removed successfully');
                loadLicenseInfo();
            } else {
                alert('❌ Error: ' + (data.error || 'Failed to remove license'));
            }
        } catch (error) {
            alert('❌ Error: ' + error.message);
        }
    }
</script>
{% endblock %}
