{% extends "settings/layout.html" %}

{% block settings_content %}
<!-- Audit Log Viewer -->
<div class="space-y-6">
    <!-- Header -->
    <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-6 border border-purple-100">
        <h2 class="text-2xl font-bold text-gray-800 mb-2">Audit Log</h2>
        <p class="text-gray-600">ระบบติดตามและบันทึกการทำงานของผู้ใช้เพื่อความปลอดภัยและการตรวจสอบ</p>
    </div>

    <!-- Statistics Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4" id="stats-container">
        <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Total Events</p>
                    <p class="text-2xl font-bold text-gray-800" id="stat-total">-</p>
                </div>
                <div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Failed Events</p>
                    <p class="text-2xl font-bold text-red-600" id="stat-failed">-</p>
                </div>
                <div class="w-12 h-12 bg-red-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Last 24h</p>
                    <p class="text-2xl font-bold text-green-600" id="stat-24h">-</p>
                </div>
                <div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-sm border p-4">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm text-gray-500">Unique Users</p>
                    <p class="text-2xl font-bold text-purple-600" id="stat-users">-</p>
                </div>
                <div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center">
                    <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="bg-white rounded-xl shadow-sm border p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">ตัวกรอง</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
                <input type="text" id="filter-user" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500" placeholder="ค้นหาชื่อผู้ใช้">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Action</label>
                <select id="filter-action" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">All Actions</option>
                    <option value="LOGIN">LOGIN</option>
                    <option value="LOGIN_FAILED">LOGIN_FAILED</option>
                    <option value="LOGOUT">LOGOUT</option>
                    <option value="CREATE">CREATE</option>
                    <option value="UPDATE">UPDATE</option>
                    <option value="DELETE">DELETE</option>
                    <option value="EXPORT">EXPORT</option>
                    <option value="IMPORT">IMPORT</option>
                    <option value="DOWNLOAD">DOWNLOAD</option>
                    <option value="SETTINGS_CHANGE">SETTINGS_CHANGE</option>
                    <option value="PERMISSION_CHANGE">PERMISSION_CHANGE</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                <select id="filter-status" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
                    <option value="">All Status</option>
                    <option value="success">Success</option>
                    <option value="failed">Failed</option>
                    <option value="denied">Denied</option>
                </select>
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date From</label>
                <input type="date" id="filter-date-from" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>

            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Date To</label>
                <input type="date" id="filter-date-to" class="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500">
            </div>

            <div class="flex items-end">
                <button onclick="applyFilters()" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors">
                    Apply Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Audit Logs Table -->
    <div class="bg-white rounded-xl shadow-sm border">
        <div class="p-6 border-b">
            <h3 class="text-lg font-semibold text-gray-800">Audit Logs</h3>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="p-8 text-center hidden">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-600"></div>
            <p class="mt-2 text-gray-600">Loading...</p>
        </div>

        <!-- Empty State -->
        <div id="empty-state" class="p-8 text-center hidden">
            <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <p class="mt-2 text-gray-600">No audit logs found</p>
        </div>

        <!-- Table -->
        <div id="table-container" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Timestamp</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Resource</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">IP Address</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    </tr>
                </thead>
                <tbody id="logs-tbody" class="bg-white divide-y divide-gray-200">
                    <!-- Rows will be inserted here -->
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        <div id="pagination-container" class="px-6 py-4 border-t bg-gray-50 flex items-center justify-between">
            <div class="text-sm text-gray-700">
                Showing <span id="showing-from">0</span> to <span id="showing-to">0</span> of <span id="total-count">0</span> results
            </div>
            <div class="flex gap-2" id="pagination-buttons">
                <!-- Pagination buttons will be inserted here -->
            </div>
        </div>
    </div>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-xl max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="p-6 border-b flex justify-between items-center sticky top-0 bg-white">
            <h3 class="text-xl font-bold text-gray-800">Audit Log Details</h3>
            <button onclick="closeDetailModal()" class="text-gray-400 hover:text-gray-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
            </button>
        </div>
        <div class="p-6" id="detail-content">
            <!-- Content will be inserted here -->
        </div>
    </div>
</div>

<script>
let currentPage = 1;
let currentFilters = {};

// Load statistics
async function loadStats() {
    try {
        const response = await fetch('/api/audit/stats');
        const data = await response.json();

        if (data.success) {
            document.getElementById('stat-total').textContent = data.stats.total_events.toLocaleString();
            document.getElementById('stat-failed').textContent = data.stats.failed_events.toLocaleString();
            document.getElementById('stat-24h').textContent = data.stats.events_last_24h.toLocaleString();
            document.getElementById('stat-users').textContent = data.stats.unique_users.toLocaleString();
        }
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

// Create table row for log entry (using safe DOM methods)
function createLogRow(log) {
    const row = document.createElement('tr');
    row.className = 'hover:bg-gray-50 cursor-pointer';
    row.onclick = () => showLogDetail(log);

    const timestamp = new Date(log.timestamp);

    // Timestamp cell
    const timestampCell = document.createElement('td');
    timestampCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
    timestampCell.textContent = timestamp.toLocaleString('th-TH');
    row.appendChild(timestampCell);

    // User cell
    const userCell = document.createElement('td');
    userCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
    const userDiv = document.createElement('div');
    userDiv.className = 'font-medium';
    userDiv.textContent = log.user_id || '-';
    userCell.appendChild(userDiv);
    if (log.user_email) {
        const emailDiv = document.createElement('div');
        emailDiv.className = 'text-xs text-gray-500';
        emailDiv.textContent = log.user_email;
        userCell.appendChild(emailDiv);
    }
    row.appendChild(userCell);

    // Action cell
    const actionCell = document.createElement('td');
    actionCell.className = 'px-6 py-4 whitespace-nowrap';
    const actionBadge = document.createElement('span');
    actionBadge.className = 'px-2 py-1 text-xs font-medium rounded-full bg-indigo-100 text-indigo-800';
    actionBadge.textContent = log.action;
    actionCell.appendChild(actionBadge);
    row.appendChild(actionCell);

    // Resource cell
    const resourceCell = document.createElement('td');
    resourceCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
    const resourceTypeDiv = document.createElement('div');
    resourceTypeDiv.className = 'font-medium';
    resourceTypeDiv.textContent = log.resource_type || '-';
    resourceCell.appendChild(resourceTypeDiv);
    if (log.resource_id) {
        const resourceIdDiv = document.createElement('div');
        resourceIdDiv.className = 'text-xs text-gray-500';
        resourceIdDiv.textContent = log.resource_id;
        resourceCell.appendChild(resourceIdDiv);
    }
    row.appendChild(resourceCell);

    // Status cell
    const statusCell = document.createElement('td');
    statusCell.className = 'px-6 py-4 whitespace-nowrap';
    const statusBadge = document.createElement('span');
    statusBadge.className = 'px-2 py-1 text-xs font-medium rounded-full';
    if (log.status === 'success') {
        statusBadge.className += ' text-green-600 bg-green-100';
    } else if (log.status === 'failed') {
        statusBadge.className += ' text-red-600 bg-red-100';
    } else {
        statusBadge.className += ' text-gray-600 bg-gray-100';
    }
    statusBadge.textContent = log.status;
    statusCell.appendChild(statusBadge);
    row.appendChild(statusCell);

    // IP Address cell
    const ipCell = document.createElement('td');
    ipCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-900';
    ipCell.textContent = log.ip_address || '-';
    row.appendChild(ipCell);

    // Details cell
    const detailsCell = document.createElement('td');
    detailsCell.className = 'px-6 py-4 whitespace-nowrap text-sm text-gray-500';
    if (log.changes_summary) {
        detailsCell.textContent = log.changes_summary.substring(0, 50) + '...';
    } else {
        detailsCell.textContent = '-';
    }
    row.appendChild(detailsCell);

    return row;
}

// Load audit logs
async function loadLogs(page = 1) {
    const loadingEl = document.getElementById('loading-state');
    const emptyEl = document.getElementById('empty-state');
    const tableEl = document.getElementById('table-container');
    const tbody = document.getElementById('logs-tbody');

    loadingEl.classList.remove('hidden');
    tableEl.classList.add('hidden');
    emptyEl.classList.add('hidden');

    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            ...currentFilters
        });

        const response = await fetch(`/api/audit/logs?${params}`);
        const data = await response.json();

        loadingEl.classList.add('hidden');

        if (!data.success) {
            showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
            emptyEl.classList.remove('hidden');
            return;
        }

        if (data.logs.length === 0) {
            emptyEl.classList.remove('hidden');
            return;
        }

        tableEl.classList.remove('hidden');

        // Render table rows using safe DOM methods
        tbody.textContent = ''; // Clear existing rows
        data.logs.forEach(log => {
            const row = createLogRow(log);
            tbody.appendChild(row);
        });

        // Update pagination
        updatePagination(data.pagination);

    } catch (error) {
        console.error('Error loading logs:', error);
        loadingEl.classList.add('hidden');
        showAlert('เกิดข้อผิดพลาดในการโหลดข้อมูล', 'error');
        emptyEl.classList.add('hidden');
    }
}

// Update pagination
function updatePagination(pagination) {
    currentPage = pagination.page;

    document.getElementById('showing-from').textContent = ((pagination.page - 1) * pagination.per_page + 1).toLocaleString();
    document.getElementById('showing-to').textContent = Math.min(pagination.page * pagination.per_page, pagination.total).toLocaleString();
    document.getElementById('total-count').textContent = pagination.total.toLocaleString();

    const buttonsContainer = document.getElementById('pagination-buttons');
    buttonsContainer.textContent = ''; // Clear existing buttons

    // Previous button
    if (pagination.page > 1) {
        const prevBtn = document.createElement('button');
        prevBtn.textContent = 'Previous';
        prevBtn.className = 'px-4 py-2 border rounded-lg hover:bg-gray-50';
        prevBtn.onclick = () => loadLogs(pagination.page - 1);
        buttonsContainer.appendChild(prevBtn);
    }

    // Page numbers
    const maxVisiblePages = 5;
    let startPage = Math.max(1, pagination.page - Math.floor(maxVisiblePages / 2));
    let endPage = Math.min(pagination.pages, startPage + maxVisiblePages - 1);

    for (let i = startPage; i <= endPage; i++) {
        const pageBtn = document.createElement('button');
        pageBtn.textContent = i;
        pageBtn.className = i === pagination.page ?
            'px-4 py-2 bg-indigo-600 text-white rounded-lg' :
            'px-4 py-2 border rounded-lg hover:bg-gray-50';
        pageBtn.onclick = () => loadLogs(i);
        buttonsContainer.appendChild(pageBtn);
    }

    // Next button
    if (pagination.page < pagination.pages) {
        const nextBtn = document.createElement('button');
        nextBtn.textContent = 'Next';
        nextBtn.className = 'px-4 py-2 border rounded-lg hover:bg-gray-50';
        nextBtn.onclick = () => loadLogs(pagination.page + 1);
        buttonsContainer.appendChild(nextBtn);
    }
}

// Apply filters
function applyFilters() {
    currentFilters = {
        user: document.getElementById('filter-user').value,
        action: document.getElementById('filter-action').value,
        status: document.getElementById('filter-status').value,
        date_from: document.getElementById('filter-date-from').value,
        date_to: document.getElementById('filter-date-to').value
    };

    // Remove empty filters
    Object.keys(currentFilters).forEach(key => {
        if (!currentFilters[key]) {
            delete currentFilters[key];
        }
    });

    loadLogs(1);
}

// Create detail row (safe DOM method)
function createDetailRow(label, value, valueClass = 'text-sm text-gray-900') {
    const div = document.createElement('div');

    const labelP = document.createElement('p');
    labelP.className = 'text-sm font-medium text-gray-500';
    labelP.textContent = label;
    div.appendChild(labelP);

    const valueP = document.createElement('p');
    valueP.className = valueClass;
    valueP.textContent = value || '-';
    div.appendChild(valueP);

    return div;
}

// Show log detail
function showLogDetail(log) {
    const modal = document.getElementById('detail-modal');
    const content = document.getElementById('detail-content');

    const timestamp = new Date(log.timestamp);

    // Clear existing content
    content.textContent = '';

    // Create container
    const container = document.createElement('div');
    container.className = 'space-y-4';

    // Grid for basic info
    const grid = document.createElement('div');
    grid.className = 'grid grid-cols-2 gap-4';

    grid.appendChild(createDetailRow('Timestamp', timestamp.toLocaleString('th-TH')));
    grid.appendChild(createDetailRow('Action', log.action));
    grid.appendChild(createDetailRow('User', log.user_id));
    grid.appendChild(createDetailRow('User Email', log.user_email));
    grid.appendChild(createDetailRow('Resource Type', log.resource_type));
    grid.appendChild(createDetailRow('Resource ID', log.resource_id));
    grid.appendChild(createDetailRow('Status', log.status));
    grid.appendChild(createDetailRow('IP Address', log.ip_address));

    container.appendChild(grid);

    // Changes summary
    if (log.changes_summary) {
        const changesDiv = document.createElement('div');
        const changesLabel = document.createElement('p');
        changesLabel.className = 'text-sm font-medium text-gray-500 mb-2';
        changesLabel.textContent = 'Changes Summary';
        changesDiv.appendChild(changesLabel);

        const changesValue = document.createElement('p');
        changesValue.className = 'text-sm text-gray-900 bg-gray-50 p-3 rounded-lg';
        changesValue.textContent = log.changes_summary;
        changesDiv.appendChild(changesValue);

        container.appendChild(changesDiv);
    }

    // Error message
    if (log.error_message) {
        const errorDiv = document.createElement('div');
        const errorLabel = document.createElement('p');
        errorLabel.className = 'text-sm font-medium text-gray-500 mb-2';
        errorLabel.textContent = 'Error Message';
        errorDiv.appendChild(errorLabel);

        const errorValue = document.createElement('p');
        errorValue.className = 'text-sm text-red-600 bg-red-50 p-3 rounded-lg';
        errorValue.textContent = log.error_message;
        errorDiv.appendChild(errorValue);

        container.appendChild(errorDiv);
    }

    // User agent
    if (log.user_agent) {
        const uaDiv = document.createElement('div');
        const uaLabel = document.createElement('p');
        uaLabel.className = 'text-sm font-medium text-gray-500 mb-2';
        uaLabel.textContent = 'User Agent';
        uaDiv.appendChild(uaLabel);

        const uaValue = document.createElement('p');
        uaValue.className = 'text-xs text-gray-900 bg-gray-50 p-3 rounded-lg font-mono';
        uaValue.textContent = log.user_agent;
        uaDiv.appendChild(uaValue);

        container.appendChild(uaDiv);
    }

    // Request path
    if (log.request_path) {
        const reqDiv = document.createElement('div');
        const reqLabel = document.createElement('p');
        reqLabel.className = 'text-sm font-medium text-gray-500 mb-2';
        reqLabel.textContent = 'Request Path';
        reqDiv.appendChild(reqLabel);

        const reqValue = document.createElement('p');
        reqValue.className = 'text-sm text-gray-900 bg-gray-50 p-3 rounded-lg font-mono';
        reqValue.textContent = (log.request_method || '') + ' ' + log.request_path;
        reqDiv.appendChild(reqValue);

        container.appendChild(reqDiv);
    }

    // Session ID
    if (log.session_id) {
        const sessionDiv = document.createElement('div');
        const sessionLabel = document.createElement('p');
        sessionLabel.className = 'text-sm font-medium text-gray-500 mb-2';
        sessionLabel.textContent = 'Session ID';
        sessionDiv.appendChild(sessionLabel);

        const sessionValue = document.createElement('p');
        sessionValue.className = 'text-xs text-gray-900 bg-gray-50 p-3 rounded-lg font-mono';
        sessionValue.textContent = log.session_id;
        sessionDiv.appendChild(sessionValue);

        container.appendChild(sessionDiv);
    }

    content.appendChild(container);
    modal.classList.remove('hidden');
}

// Close detail modal
function closeDetailModal() {
    document.getElementById('detail-modal').classList.add('hidden');
}

// Show alert
function showAlert(message, type) {
    // Create alert element using DOM methods
    const alert = document.createElement('div');
    alert.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500' : 'bg-red-500'
    } text-white`;

    const text = document.createTextNode(message);
    alert.appendChild(text);

    document.body.appendChild(alert);

    setTimeout(() => {
        alert.remove();
    }, 3000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadStats();
    loadLogs(1);
});

// Allow Enter key on filter inputs
document.querySelectorAll('#filter-user, #filter-date-from, #filter-date-to').forEach(input => {
    input.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            applyFilters();
        }
    });
});
</script>

{% endblock %}
