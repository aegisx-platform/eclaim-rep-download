{% extends "settings/layout.html" %}

{% block title %}Credentials - NHSO Revenue Intelligence{% endblock %}

{% block settings_content %}
<!-- E-Claim Credentials Section -->
<div class="bg-white rounded-xl shadow-sm border">
    <div class="px-6 py-4 border-b flex items-center justify-between">
        <div class="flex items-center gap-3">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 7a2 2 0 012 2m4 0a6 6 0 01-7.743 5.743L11 17H9v2H7v2H4a1 1 0 01-1-1v-2.586a1 1 0 01.293-.707l5.964-5.964A6 6 0 1121 9z"></path>
            </svg>
            <div>
                <h3 class="text-xl font-bold text-gray-800">E-Claim Credentials</h3>
                <p class="text-sm text-gray-600">เพิ่มบัญชีได้หลายบัญชี ระบบจะสุ่มเลือกใช้ชดเชื้อเมื่อมีติด บัญชีหนึ่งติด สปสช. block</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span class="text-sm text-gray-600">สถานะ:</span>
            <span id="credentials-status-badge" class="px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600">Loading...</span>
        </div>
    </div>

    <div class="p-6">
        <!-- Existing Credentials List -->
        <div id="credentials-list" class="space-y-3 mb-6">
            <!-- Credentials will be loaded here -->
            <div class="text-center py-8">
                <div class="animate-spin w-8 h-8 border-4 border-blue-600 border-t-transparent rounded-full mx-auto mb-3"></div>
                <p class="text-gray-500">Loading credentials...</p>
            </div>
        </div>

        <!-- Add New Credential Form -->
        <div class="border-t pt-6">
            <h4 class="text-lg font-semibold text-gray-800 mb-4">เพิ่มบัญชีใหม่</h4>
            <form id="add-credential-form" class="grid grid-cols-12 gap-3">
                <div class="col-span-3">
                    <input type="text" id="new-username" placeholder="Username (เลขบัตรประชาชน)"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                           required>
                </div>
                <div class="col-span-3">
                    <div class="relative">
                        <input type="password" id="new-password" placeholder="Password"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 pr-10"
                               required>
                        <button type="button" onclick="toggleNewPasswordVisibility()"
                                class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="col-span-4">
                    <input type="text" id="new-note" placeholder="หมายเหตุ (ไม่บังคับ)"
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div class="col-span-2">
                    <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-2 rounded-lg transition-colors flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                        </svg>
                        เพิ่ม
                    </button>
                </div>
            </form>
        </div>

        <!-- Test Connection Button -->
        <div class="border-t mt-6 pt-6">
            <button type="button" onclick="testRandomConnection()" id="test-random-btn"
                    class="bg-green-600 hover:bg-green-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                <span id="test-random-text">Test Connection (Random Account)</span>
            </button>
            <p class="text-xs text-gray-500 mt-2">ทดสอบการเชื่อมต่อด้วยบัญชีที่สุ่มเลือก</p>
        </div>

        <!-- Connection Status -->
        <div id="connection-status" class="hidden mt-4 p-4 rounded-lg">
            <div class="flex items-center">
                <span id="connection-status-icon" class="mr-3"></span>
                <span id="connection-status-message"></span>
            </div>
        </div>
    </div>
</div>

<script>
let credentials = [];

// Load credentials on page load
document.addEventListener('DOMContentLoaded', function() {
    loadCredentials();
});

async function loadCredentials() {
    try {
        const response = await fetch('/api/settings/credentials');
        const data = await response.json();

        if (data.success && data.credentials) {
            credentials = data.credentials;
            renderCredentialsList();
            updateStatusBadge();
        } else {
            credentials = [];
            showEmptyState();
            updateStatusBadge();
        }
    } catch (error) {
        console.error('Error loading credentials:', error);
        showErrorState();
    }
}

function renderCredentialsList() {
    const listContainer = document.getElementById('credentials-list');

    if (credentials.length === 0) {
        showEmptyState();
        return;
    }

    listContainer.textContent = '';

    credentials.forEach((cred, index) => {
        const item = document.createElement('div');
        item.className = 'flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:border-blue-300 transition-colors';

        // Checkbox
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = cred.enabled;
        checkbox.className = 'w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500';
        checkbox.onchange = () => toggleCredentialStatus(cred.username, checkbox.checked);

        // Username and note
        const infoDiv = document.createElement('div');
        infoDiv.className = 'flex-1';
        infoDiv.innerHTML = `
            <div class="font-semibold text-gray-800">${escapeHtml(cred.username)}</div>
            <div class="text-sm text-gray-500">${escapeHtml(cred.note || 'No note')}</div>
        `;

        // Password (masked)
        const passwordDiv = document.createElement('input');
        passwordDiv.type = 'password';
        passwordDiv.value = cred.password || '********';
        passwordDiv.readOnly = true;
        passwordDiv.className = 'w-40 px-3 py-2 bg-gray-50 border border-gray-200 rounded text-sm text-gray-600';

        // Status badge
        const statusBadge = document.createElement('span');
        statusBadge.className = `px-3 py-1 text-xs rounded-full ${cred.enabled ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-500'}`;
        statusBadge.textContent = cred.enabled ? 'Active' : 'Inactive';

        // Delete button
        const deleteBtn = document.createElement('button');
        deleteBtn.type = 'button';
        deleteBtn.className = 'text-red-600 hover:text-red-800 transition-colors';
        deleteBtn.onclick = () => deleteCredential(cred.username);
        deleteBtn.innerHTML = `
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
            </svg>
        `;

        item.appendChild(checkbox);
        item.appendChild(infoDiv);
        item.appendChild(passwordDiv);
        item.appendChild(statusBadge);
        item.appendChild(deleteBtn);

        listContainer.appendChild(item);
    });
}

function showEmptyState() {
    const listContainer = document.getElementById('credentials-list');
    listContainer.innerHTML = `
        <div class="text-center py-8 text-gray-500">
            <svg class="w-16 h-16 mx-auto mb-3 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>
            </svg>
            <p class="font-medium">ยังไม่มีบัญชีที่เพิ่มไว้</p>
            <p class="text-sm">เพิ่มบัญชีด้านล่างเพื่อเริ่มใช้งาน</p>
        </div>
    `;
}

function showErrorState() {
    const listContainer = document.getElementById('credentials-list');
    listContainer.innerHTML = `
        <div class="text-center py-8 text-red-500">
            <p class="font-medium">เกิดข้อผิดพลาดในการโหลดข้อมูล</p>
            <button onclick="loadCredentials()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">ลองอีกครั้ง</button>
        </div>
    `;
}

function updateStatusBadge() {
    const badge = document.getElementById('credentials-status-badge');
    const activeCount = credentials.filter(c => c.enabled).length;
    const totalCount = credentials.length;

    badge.textContent = `${activeCount}/${totalCount} บัญชี Active`;

    if (activeCount > 0) {
        badge.className = 'px-3 py-1 text-xs rounded-full bg-green-100 text-green-700';
    } else {
        badge.className = 'px-3 py-1 text-xs rounded-full bg-amber-100 text-amber-700';
    }
}

// Add new credential
document.getElementById('add-credential-form').addEventListener('submit', async (e) => {
    e.preventDefault();

    const username = document.getElementById('new-username').value.trim();
    const password = document.getElementById('new-password').value;
    const note = document.getElementById('new-note').value.trim();

    if (!username || !password) {
        showToast('กรุณากรอก Username และ Password', 'error');
        return;
    }

    try {
        const response = await fetch('/api/settings/credentials', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password, note, enabled: true })
        });

        const result = await response.json();

        if (result.success) {
            showToast('เพิ่มบัญชีสำเร็จ', 'success');
            document.getElementById('add-credential-form').reset();
            loadCredentials();
        } else {
            showToast(result.error || 'เพิ่มบัญชีไม่สำเร็จ', 'error');
        }
    } catch (error) {
        console.error('Error adding credential:', error);
        showToast('เกิดข้อผิดพลาด', 'error');
    }
});

// Toggle credential status
async function toggleCredentialStatus(username, enabled) {
    try {
        const response = await fetch(`/api/settings/credentials/${username}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ enabled: enabled })
        });

        const result = await response.json();

        if (result.success) {
            showToast(`${enabled ? 'เปิด' : 'ปิด'}ใช้งานบัญชีแล้ว`, 'success');
            loadCredentials();
        } else {
            showToast(result.error || 'อัพเดทสถานะไม่สำเร็จ', 'error');
            loadCredentials(); // Reload to reset checkbox
        }
    } catch (error) {
        console.error('Error toggling credential:', error);
        showToast('เกิดข้อผิดพลาด', 'error');
        loadCredentials();
    }
}

// Delete credential
async function deleteCredential(username) {
    if (!confirm(`ต้องการลบบัญชี ${username} ใช่หรือไม่?`)) {
        return;
    }

    try {
        const response = await fetch(`/api/settings/credentials/${username}`, {
            method: 'DELETE'
        });

        const result = await response.json();

        if (result.success) {
            showToast('ลบบัญชีสำเร็จ', 'success');
            loadCredentials();
        } else {
            showToast(result.error || 'ลบบัญชีไม่สำเร็จ', 'error');
        }
    } catch (error) {
        console.error('Error deleting credential:', error);
        showToast('เกิดข้อผิดพลาด', 'error');
    }
}

// Test random connection
async function testRandomConnection() {
    const btn = document.getElementById('test-random-btn');
    const btnText = document.getElementById('test-random-text');
    const statusDiv = document.getElementById('connection-status');
    const statusIcon = document.getElementById('connection-status-icon');
    const statusMessage = document.getElementById('connection-status-message');

    btn.disabled = true;
    btn.classList.add('opacity-75', 'cursor-not-allowed');
    btnText.textContent = 'Testing...';
    statusDiv.classList.add('hidden');

    try {
        const response = await fetch('/api/settings/test-connection', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });

        const result = await response.json();

        statusDiv.classList.remove('hidden');

        if (result.success) {
            statusDiv.className = 'mt-4 p-4 rounded-lg bg-green-50 border border-green-200';
            setStatusIcon(statusIcon, 'success');
            statusMessage.className = 'text-green-700 font-medium';
            statusMessage.textContent = result.message;
            showToast(result.message, 'success');
        } else {
            statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 border border-red-200';
            setStatusIcon(statusIcon, 'error');
            statusMessage.className = 'text-red-700 font-medium';
            statusMessage.textContent = result.error;
            showToast(result.error, 'error');
        }
    } catch (error) {
        console.error('Error testing connection:', error);
        statusDiv.classList.remove('hidden');
        statusDiv.className = 'mt-4 p-4 rounded-lg bg-red-50 border border-red-200';
        setStatusIcon(statusIcon, 'error');
        statusMessage.className = 'text-red-700 font-medium';
        statusMessage.textContent = 'Network error - could not reach server';
        showToast('Network error', 'error');
    } finally {
        btn.disabled = false;
        btn.classList.remove('opacity-75', 'cursor-not-allowed');
        btnText.textContent = 'Test Connection (Random Account)';
    }
}

function toggleNewPasswordVisibility() {
    const input = document.getElementById('new-password');
    input.type = input.type === 'password' ? 'text' : 'password';
}

function setStatusIcon(container, type) {
    while (container.firstChild) {
        container.removeChild(container.firstChild);
    }

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('class', 'w-6 h-6');
    svg.setAttribute('fill', 'none');
    svg.setAttribute('stroke', 'currentColor');
    svg.setAttribute('viewBox', '0 0 24 24');

    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    path.setAttribute('stroke-linecap', 'round');
    path.setAttribute('stroke-linejoin', 'round');
    path.setAttribute('stroke-width', '2');

    if (type === 'success') {
        svg.classList.add('text-green-500');
        path.setAttribute('d', 'M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z');
    } else {
        svg.classList.add('text-red-500');
        path.setAttribute('d', 'M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z');
    }

    svg.appendChild(path);
    container.appendChild(svg);
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}
</script>
{% endblock %}
