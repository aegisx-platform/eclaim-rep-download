{% extends "base.html" %}

{% block title %}System Setup - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 flex items-center gap-3">
            <div class="bg-blue-100 p-3 rounded-xl">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
            </div>
            System Setup
        </h1>
        <p class="text-gray-600 mt-2">Initialize seed data and import files to get started</p>
    </div>

    <!-- Overall Progress -->
    <div id="overall-status" class="mb-8 bg-white rounded-xl shadow-sm border p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-800">Setup Progress</h2>
            <span id="overall-progress-text" class="text-sm text-gray-500">Checking...</span>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div id="overall-progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
        </div>
        <div id="setup-complete-message" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center gap-2 text-green-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                <span class="font-medium">Setup Complete! You can now use the system.</span>
            </div>
            <a href="{{ url_for('dashboard') }}" class="mt-3 inline-block bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                Go to Dashboard
            </a>
        </div>
    </div>

    <!-- Section 1: Seed Data -->
    <div class="bg-white rounded-xl shadow-sm border mb-6">
        <div class="p-6 border-b">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-purple-100 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">1. Seed Data</h2>
                        <p class="text-sm text-gray-500">Reference data required for system operation</p>
                    </div>
                </div>
                <button onclick="initializeAllSeeds()" id="init-all-seeds-btn" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Initialize All
                </button>
            </div>
        </div>
        <div class="p-6">
            <div id="seed-tables-list" class="space-y-3">
                <!-- Seed tables will be populated here -->
                <div class="animate-pulse flex items-center gap-3 p-3 bg-gray-50 rounded-lg">
                    <div class="w-5 h-5 bg-gray-300 rounded-full"></div>
                    <div class="flex-1">
                        <div class="h-4 bg-gray-300 rounded w-1/3"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 2: Data Files -->
    <div class="bg-white rounded-xl shadow-sm border mb-6">
        <div class="p-6 border-b">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="bg-green-100 p-2 rounded-lg">
                        <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                    </div>
                    <div>
                        <h2 class="text-lg font-semibold text-gray-800">2. Data Files</h2>
                        <p class="text-sm text-gray-500">Import REP, STM, and SMT data files</p>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button onclick="importAllData()" id="import-all-data-btn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Import All Data
                    </button>
                    <button onclick="scanFiles()" id="scan-files-btn" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
        </div>
        <div class="p-6">
            <!-- File Type Tabs -->
            <div class="flex gap-2 mb-4 border-b">
                <button onclick="showFileTab('rep')" id="tab-rep" class="px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600">
                    REP Files
                </button>
                <button onclick="showFileTab('stm')" id="tab-stm" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    STM Files
                </button>
                <button onclick="showFileTab('smt')" id="tab-smt" class="px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    SMT Budget
                </button>
            </div>

            <!-- REP Files Tab -->
            <div id="files-rep" class="file-tab">
                <div class="flex items-center justify-between mb-4">
                    <div id="rep-summary" class="text-sm text-gray-600">Loading...</div>
                    <button onclick="importAllFiles('rep')" id="import-all-rep-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Import All
                    </button>
                </div>
                <div id="rep-files-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="animate-pulse p-3 bg-gray-50 rounded-lg">Loading...</div>
                </div>
            </div>

            <!-- STM Files Tab -->
            <div id="files-stm" class="file-tab hidden">
                <div class="flex items-center justify-between mb-4">
                    <div id="stm-summary" class="text-sm text-gray-600">Loading...</div>
                    <button onclick="importAllFiles('stm')" id="import-all-stm-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Import All
                    </button>
                </div>
                <div id="stm-files-list" class="space-y-2 max-h-64 overflow-y-auto">
                    <div class="animate-pulse p-3 bg-gray-50 rounded-lg">Loading...</div>
                </div>
            </div>

            <!-- SMT Tab -->
            <div id="files-smt" class="file-tab hidden">
                <div class="flex items-center justify-between mb-4">
                    <div id="smt-summary" class="text-sm text-gray-600">Loading...</div>
                    <button onclick="fetchSMTData()" id="fetch-smt-btn" class="bg-green-600 hover:bg-green-700 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition-colors flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                        </svg>
                        Fetch from API
                    </button>
                </div>

                <!-- SMT Status Card -->
                <div id="smt-data-card" class="p-4 rounded-lg border">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div id="smt-status-icon" class="w-10 h-10 rounded-full bg-gray-100 flex items-center justify-center">
                                <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                </svg>
                            </div>
                            <div>
                                <div class="font-medium text-gray-800">SMT Budget Transfers</div>
                                <div id="smt-record-count" class="text-sm text-gray-500">Loading...</div>
                            </div>
                        </div>
                        <div id="smt-status-badge" class="text-xs px-2 py-1 rounded-full bg-gray-200 text-gray-800">
                            Checking...
                        </div>
                    </div>
                    <div id="smt-vendor-info" class="mt-3 text-sm text-gray-600"></div>
                </div>

                <!-- Info message -->
                <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div class="flex items-start gap-2">
                        <svg class="w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        <p class="text-xs text-blue-800">SMT Budget data is fetched from NHSO API using your Vendor ID. Configure Vendor ID in the Settings section below if needed.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Section 3: Configuration -->
    <div class="bg-white rounded-xl shadow-sm border mb-6">
        <div class="p-6 border-b">
            <div class="flex items-center gap-3">
                <div class="bg-amber-100 p-2 rounded-lg">
                    <svg class="w-6 h-6 text-amber-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path>
                    </svg>
                </div>
                <div>
                    <h2 class="text-lg font-semibold text-gray-800">3. Configuration</h2>
                    <p class="text-sm text-gray-500">System settings (optional)</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
                <!-- SMT Vendor ID -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">SMT Vendor ID</label>
                    <div class="flex gap-2">
                        <input type="text" id="smt-vendor-id" placeholder="e.g. 10670" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                        <button onclick="saveVendorId()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">Save</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">5-digit hospital code for SMT API</p>
                </div>

                <!-- Quick Actions -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Quick Actions</label>
                    <div class="flex flex-wrap gap-2">
                        <a href="{{ url_for('data_management') }}?tab=download" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            Download Files
                        </a>
                        <a href="{{ url_for('data_management') }}?tab=settings" class="bg-gray-100 hover:bg-gray-200 text-gray-700 px-3 py-2 rounded-lg text-sm font-medium transition-colors">
                            NHSO Credentials
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Skip Setup -->
    <div class="text-center">
        <a href="{{ url_for('dashboard') }}" class="text-gray-500 hover:text-gray-700 text-sm">
            Skip setup and go to Dashboard
        </a>
    </div>
</div>

<!-- Progress Modal -->
<div id="progress-modal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg mx-4 p-6">
        <div class="flex items-center gap-3 mb-4">
            <svg id="progress-spinner" class="w-6 h-6 text-blue-600 animate-spin" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <div>
                <h3 id="progress-title" class="text-lg font-semibold text-gray-800">Processing...</h3>
                <p id="progress-counter" class="text-sm text-gray-500"></p>
            </div>
        </div>

        <!-- Current file being processed -->
        <div id="progress-current-file" class="hidden mb-4 p-3 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-2 text-blue-800">
                <svg class="w-4 h-4 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <span id="progress-filename" class="text-sm font-medium truncate"></span>
            </div>
        </div>

        <!-- Progress bar with percentage -->
        <div class="mb-4">
            <div class="flex justify-between text-sm text-gray-600 mb-1">
                <span id="progress-message">Please wait...</span>
                <span id="progress-percent">0%</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-3">
                <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all duration-300 relative" style="width: 0%">
                    <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/20 to-transparent animate-shimmer"></div>
                </div>
            </div>
        </div>

        <!-- Statistics -->
        <div id="progress-stats" class="hidden grid grid-cols-3 gap-3 mb-4 p-3 bg-gray-50 rounded-lg text-center">
            <div>
                <div id="progress-stat-imported" class="text-lg font-bold text-green-600">0</div>
                <div class="text-xs text-gray-500">Imported</div>
            </div>
            <div>
                <div id="progress-stat-failed" class="text-lg font-bold text-red-600">0</div>
                <div class="text-xs text-gray-500">Failed</div>
            </div>
            <div>
                <div id="progress-stat-records" class="text-lg font-bold text-blue-600">0</div>
                <div class="text-xs text-gray-500">Records</div>
            </div>
        </div>

        <div id="progress-details" class="text-sm text-gray-500 whitespace-pre-line"></div>
        <button id="progress-close-btn" onclick="closeProgressModal()" class="hidden mt-4 w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-medium transition-colors">
            Close
        </button>
    </div>
</div>

<style>
@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}
.animate-shimmer {
    animation: shimmer 1.5s infinite;
}
</style>

<script>
    // State
    let seedStatus = {};
    let fileStatus = { rep: [], stm: [] };
    let currentTab = 'rep';

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadSeedStatus();
        loadFileStatus();
        loadSettings();
    });

    // === Seed Data Functions ===
    async function loadSeedStatus() {
        try {
            const response = await fetch('/api/system/seed-status');
            const data = await response.json();

            if (data.success) {
                seedStatus = data.tables;
                renderSeedTables(data.tables, data.needs_initialization);
                updateOverallProgress();

                // If seed is running, start polling
                if (data.seed_running) {
                    showProgressModal('Initializing Seed Data', 'Please wait...');
                    pollSeedProgress();
                }
            }
        } catch (error) {
            console.error('Error loading seed status:', error);
        }
    }

    function renderSeedTables(tables, needsInit) {
        const container = document.getElementById('seed-tables-list');
        // Clear container safely
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        const tableOrder = ['dim_date', 'health_offices', 'nhso_error_codes', 'fund_types', 'service_types'];

        tableOrder.forEach(function(key) {
            const table = tables[key];
            if (!table) return;

            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-3 rounded-lg ' +
                (table.is_empty ? 'bg-amber-50 border border-amber-200' : 'bg-green-50 border border-green-200');

            const leftDiv = document.createElement('div');
            leftDiv.className = 'flex items-center gap-3';

            // Status icon
            const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            iconSvg.setAttribute('class', 'w-5 h-5 ' + (table.is_empty ? 'text-amber-500' : 'text-green-500'));
            iconSvg.setAttribute('fill', 'none');
            iconSvg.setAttribute('stroke', 'currentColor');
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            iconPath.setAttribute('stroke-linecap', 'round');
            iconPath.setAttribute('stroke-linejoin', 'round');
            iconPath.setAttribute('stroke-width', '2');
            iconPath.setAttribute('d', table.is_empty ? 'M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z' : 'M5 13l4 4L19 7');
            iconSvg.appendChild(iconPath);
            leftDiv.appendChild(iconSvg);

            // Table info
            const infoDiv = document.createElement('div');
            const nameSpan = document.createElement('span');
            nameSpan.className = 'font-medium ' + (table.is_empty ? 'text-amber-800' : 'text-green-800');
            nameSpan.textContent = table.name;
            infoDiv.appendChild(nameSpan);

            const countSpan = document.createElement('span');
            countSpan.className = 'text-sm ' + (table.is_empty ? 'text-amber-600' : 'text-green-600') + ' ml-2';
            countSpan.textContent = '(' + table.count.toLocaleString() + ' records)';
            infoDiv.appendChild(countSpan);

            leftDiv.appendChild(infoDiv);
            div.appendChild(leftDiv);

            // Status badge
            const badge = document.createElement('span');
            badge.className = 'text-xs px-2 py-1 rounded-full ' +
                (table.is_empty ? 'bg-amber-200 text-amber-800' : 'bg-green-200 text-green-800');
            badge.textContent = table.is_empty ? 'Needs Init' : 'Ready';
            div.appendChild(badge);

            container.appendChild(div);
        });

        // Update init button visibility
        const initBtn = document.getElementById('init-all-seeds-btn');
        if (!needsInit) {
            initBtn.textContent = 'Re-initialize All';
            initBtn.className = 'bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-medium transition-colors flex items-center gap-2';
        }
    }

    async function initializeAllSeeds() {
        showProgressModal('Initializing Seed Data', 'Starting initialization...');

        try {
            const response = await fetch('/api/system/seed-init', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' }
            });
            const data = await response.json();

            if (data.success) {
                pollSeedProgress();
            } else {
                updateProgressModal('Error', data.error || 'Failed to start initialization', true);
            }
        } catch (error) {
            updateProgressModal('Error', error.message, true);
        }
    }

    async function pollSeedProgress() {
        try {
            const response = await fetch('/api/system/seed-progress');
            const data = await response.json();

            if (data.success) {
                const progress = data.progress;
                const percent = progress.total > 0 ? Math.round((progress.completed / progress.total) * 100) : 0;

                document.getElementById('progress-bar').style.width = percent + '%';
                document.getElementById('progress-message').textContent = progress.current_task ?
                    'Processing: ' + getTaskName(progress.current_task) : 'Finishing...';

                // Update details
                const details = progress.tasks.map(function(t) {
                    const icon = t.status === 'completed' ? '\u2713' : (t.status === 'running' ? '\u27F3' : '\u25CB');
                    return icon + ' ' + t.name + (t.records ? ' (' + t.records.toLocaleString() + ')' : '');
                }).join('\n');
                document.getElementById('progress-details').textContent = details;

                if (progress.running) {
                    setTimeout(pollSeedProgress, 500);
                } else {
                    if (progress.error) {
                        updateProgressModal('Error', progress.error, true);
                    } else {
                        updateProgressModal('Complete', 'Seed data initialized successfully!', true);
                        loadSeedStatus();
                    }
                }
            }
        } catch (error) {
            setTimeout(pollSeedProgress, 1000);
        }
    }

    function getTaskName(taskId) {
        const names = {
            'dim': 'Dimension Tables',
            'health': 'Health Offices',
            'errors': 'NHSO Error Codes'
        };
        return names[taskId] || taskId;
    }

    // === File Functions ===
    async function loadFileStatus() {
        try {
            // Load REP files
            const repResponse = await fetch('/api/files?type=rep&per_page=1000');
            const repData = await repResponse.json();
            if (repData.success) {
                fileStatus.rep = repData.files || [];
                renderFileList('rep', fileStatus.rep);
            }

            // Load STM files
            const stmResponse = await fetch('/api/files?type=stm&per_page=1000');
            const stmData = await stmResponse.json();
            if (stmData.success) {
                fileStatus.stm = stmData.files || [];
                renderFileList('stm', fileStatus.stm);
            }

            // Load SMT status
            loadSMTStatus();

            updateOverallProgress();
        } catch (error) {
            console.error('Error loading file status:', error);
        }
    }

    function renderFileList(type, files) {
        const container = document.getElementById(type + '-files-list');
        const summaryEl = document.getElementById(type + '-summary');

        // Clear container
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }

        if (files.length === 0) {
            const emptyDiv = document.createElement('div');
            emptyDiv.className = 'p-4 text-center text-gray-500 bg-gray-50 rounded-lg';
            emptyDiv.textContent = 'No ' + type.toUpperCase() + ' files found in downloads/' + type + '/';
            container.appendChild(emptyDiv);
            summaryEl.textContent = '0 files';
            return;
        }

        const imported = files.filter(function(f) { return f.imported; }).length;
        summaryEl.textContent = files.length + ' files (' + imported + ' imported)';

        files.forEach(function(file) {
            const div = document.createElement('div');
            div.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-50 border ' +
                (file.imported ? 'border-green-200 bg-green-50/50' : 'border-gray-200');

            const leftDiv = document.createElement('div');
            leftDiv.className = 'flex items-center gap-2 flex-1 min-w-0';

            // Status icon
            const iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            iconSvg.setAttribute('class', 'w-4 h-4 flex-shrink-0 ' + (file.imported ? 'text-green-500' : 'text-gray-400'));
            iconSvg.setAttribute('fill', 'none');
            iconSvg.setAttribute('stroke', 'currentColor');
            iconSvg.setAttribute('viewBox', '0 0 24 24');
            const iconPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            iconPath.setAttribute('stroke-linecap', 'round');
            iconPath.setAttribute('stroke-linejoin', 'round');
            iconPath.setAttribute('stroke-width', '2');
            iconPath.setAttribute('d', file.imported ? 'M5 13l4 4L19 7' : 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z');
            iconSvg.appendChild(iconPath);
            leftDiv.appendChild(iconSvg);

            const nameSpan = document.createElement('span');
            nameSpan.className = 'text-sm truncate';
            nameSpan.textContent = file.filename;
            nameSpan.title = file.filename;
            leftDiv.appendChild(nameSpan);

            div.appendChild(leftDiv);

            // Import button
            const btn = document.createElement('button');
            btn.className = 'text-xs px-2 py-1 rounded ' +
                (file.imported ? 'bg-gray-100 hover:bg-gray-200 text-gray-600' : 'bg-blue-100 hover:bg-blue-200 text-blue-700');
            btn.textContent = file.imported ? 'Re-import' : 'Import';
            btn.onclick = function() { importFile(type, file.filename); };
            div.appendChild(btn);

            container.appendChild(div);
        });
    }

    async function loadSMTStatus() {
        try {
            const summaryEl = document.getElementById('smt-summary');
            const recordCountEl = document.getElementById('smt-record-count');
            const statusBadgeEl = document.getElementById('smt-status-badge');
            const vendorInfoEl = document.getElementById('smt-vendor-info');
            const statusIconEl = document.getElementById('smt-status-icon');
            const dataCardEl = document.getElementById('smt-data-card');

            // Get vendor settings
            const settingsResponse = await fetch('/api/smt/settings');
            const settingsData = await settingsResponse.json();
            let vendorId = null;

            if (settingsData.success && settingsData.settings && settingsData.settings.smt_vendor_id) {
                vendorId = settingsData.settings.smt_vendor_id;
                document.getElementById('smt-vendor-id').value = vendorId;
            }

            // Get SMT files status from smt/files endpoint
            const smtResponse = await fetch('/api/smt/files');
            const smtData = await smtResponse.json();

            // API returns files array with stats
            if (smtData.success && smtData.total > 0) {
                const totalFiles = smtData.total;
                const importedFiles = smtData.stats ? smtData.stats.imported : 0;
                const lastFile = smtData.files && smtData.files[0];

                summaryEl.textContent = totalFiles + ' files (' + importedFiles + ' imported)';
                recordCountEl.textContent = totalFiles + ' SMT budget files';
                statusBadgeEl.textContent = importedFiles > 0 ? 'Ready' : 'Needs Import';
                statusBadgeEl.className = 'text-xs px-2 py-1 rounded-full ' +
                    (importedFiles > 0 ? 'bg-green-200 text-green-800' : 'bg-amber-200 text-amber-800');
                dataCardEl.className = 'p-4 rounded-lg border ' +
                    (importedFiles > 0 ? 'border-green-200 bg-green-50' : 'border-amber-200 bg-amber-50');

                // Update icon based on import status
                statusIconEl.className = 'w-10 h-10 rounded-full flex items-center justify-center ' +
                    (importedFiles > 0 ? 'bg-green-100' : 'bg-amber-100');
                while (statusIconEl.firstChild) statusIconEl.removeChild(statusIconEl.firstChild);
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('class', 'w-5 h-5 ' + (importedFiles > 0 ? 'text-green-500' : 'text-amber-500'));
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                svg.setAttribute('viewBox', '0 0 24 24');
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                path.setAttribute('stroke-linecap', 'round');
                path.setAttribute('stroke-linejoin', 'round');
                path.setAttribute('stroke-width', '2');
                path.setAttribute('d', importedFiles > 0 ? 'M5 13l4 4L19 7' : 'M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z');
                svg.appendChild(path);
                statusIconEl.appendChild(svg);

                if (vendorId) {
                    vendorInfoEl.textContent = 'Vendor ID: ' + vendorId + (lastFile ? ' | Latest: ' + lastFile.modified : '');
                }
            } else {
                summaryEl.textContent = 'No data';
                recordCountEl.textContent = 'No files yet';
                statusBadgeEl.textContent = vendorId ? 'Needs Fetch' : 'No Vendor ID';
                statusBadgeEl.className = 'text-xs px-2 py-1 rounded-full bg-amber-200 text-amber-800';
                dataCardEl.className = 'p-4 rounded-lg border border-amber-200 bg-amber-50';

                if (vendorId) {
                    vendorInfoEl.textContent = 'Vendor ID: ' + vendorId + ' | Click "Fetch from API" to download data';
                } else {
                    vendorInfoEl.textContent = 'Please configure Vendor ID in Settings section below';
                }
            }
        } catch (error) {
            console.error('Error loading SMT status:', error);
        }
    }

    async function fetchSMTData() {
        const vendorId = document.getElementById('smt-vendor-id').value.trim();
        if (!vendorId) {
            alert('Please enter Vendor ID first');
            return;
        }

        showProgressModal('Fetching SMT Data', 'Connecting to NHSO API...');

        try {
            const response = await fetch('/api/smt/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vendor_id: vendorId, save_to_db: true })
            });
            const data = await response.json();

            if (data.success) {
                updateProgressModal('Complete', 'Fetched ' + (data.total_records || 0).toLocaleString() + ' SMT records', true);
                loadSMTStatus();
                updateOverallProgress();
            } else {
                updateProgressModal('Error', data.error || 'Failed to fetch SMT data', true);
            }
        } catch (error) {
            updateProgressModal('Error', error.message, true);
        }
    }

    function showFileTab(tab) {
        currentTab = tab;

        // Update tab styles
        ['rep', 'stm', 'smt'].forEach(function(t) {
            const tabEl = document.getElementById('tab-' + t);
            const contentEl = document.getElementById('files-' + t);

            if (t === tab) {
                tabEl.className = 'px-4 py-2 font-medium border-b-2 border-blue-600 text-blue-600';
                contentEl.classList.remove('hidden');
            } else {
                tabEl.className = 'px-4 py-2 font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700';
                contentEl.classList.add('hidden');
            }
        });
    }

    async function scanFiles() {
        const btn = document.getElementById('scan-files-btn');
        btn.disabled = true;
        btn.textContent = 'Scanning...';

        try {
            await fetch('/api/files/scan', { method: 'POST' });
            await loadFileStatus();
        } catch (error) {
            console.error('Error scanning files:', error);
        } finally {
            btn.disabled = false;
            btn.textContent = 'Refresh';
        }
    }

    async function importFile(type, filename) {
        showProgressModal('Importing File', 'Importing ' + filename + '...');

        try {
            const response = await fetch('/api/import/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    files: [filename],
                    download_type: type
                })
            });
            const data = await response.json();

            if (data.success) {
                pollImportProgress();
            } else {
                updateProgressModal('Error', data.error || 'Failed to start import', true);
            }
        } catch (error) {
            updateProgressModal('Error', error.message, true);
        }
    }

    async function importAllFiles(type) {
        const files = fileStatus[type].filter(function(f) { return !f.imported; });
        if (files.length === 0) {
            alert('All files are already imported');
            return;
        }

        showProgressModal('Importing ' + type.toUpperCase() + ' Files', 'Importing ' + files.length + ' ' + type.toUpperCase() + ' files...');

        try {
            const filenames = files.map(function(f) { return f.filename; });
            const response = await fetch('/api/import/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    files: filenames,
                    download_type: type
                })
            });
            const data = await response.json();

            if (data.success) {
                pollImportProgress();
            } else {
                updateProgressModal('Error', data.error || 'Failed to start import', true);
            }
        } catch (error) {
            updateProgressModal('Error', error.message, true);
        }
    }

    async function importAllData() {
        // Collect all unimported files from REP and STM
        const repFiles = fileStatus.rep.filter(function(f) { return !f.imported; });
        const stmFiles = fileStatus.stm.filter(function(f) { return !f.imported; });

        const totalFiles = repFiles.length + stmFiles.length;

        if (totalFiles === 0) {
            alert('All files are already imported!');
            return;
        }

        // Confirm with user
        const confirmMsg = 'Import all data?\n\n' +
            '• REP Files: ' + repFiles.length + ' files\n' +
            '• STM Files: ' + stmFiles.length + ' files\n\n' +
            'Total: ' + totalFiles + ' files';

        if (!confirm(confirmMsg)) {
            return;
        }

        showProgressModal('Importing All Data', 'Starting import of ' + totalFiles + ' files...');

        try {
            // Combine all files with their types
            const allFiles = [];
            repFiles.forEach(function(f) {
                allFiles.push({ filename: f.filename, type: 'rep' });
            });
            stmFiles.forEach(function(f) {
                allFiles.push({ filename: f.filename, type: 'stm' });
            });

            // Start with REP files first
            if (repFiles.length > 0) {
                document.getElementById('progress-message').textContent = 'Importing REP files...';
                const repResponse = await fetch('/api/import/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: repFiles.map(function(f) { return f.filename; }),
                        download_type: 'rep'
                    })
                });
                const repData = await repResponse.json();

                if (repData.success) {
                    // Wait for REP import to complete
                    await waitForImportComplete();
                }
            }

            // Then import STM files
            if (stmFiles.length > 0) {
                document.getElementById('progress-message').textContent = 'Importing STM files...';
                const stmResponse = await fetch('/api/import/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        files: stmFiles.map(function(f) { return f.filename; }),
                        download_type: 'stm'
                    })
                });
                const stmData = await stmResponse.json();

                if (stmData.success) {
                    // Poll for STM import progress
                    pollImportProgress();
                    return;
                }
            }

            // If only REP was imported
            updateProgressModal('Import Complete', 'All data imported successfully!', true);
            setTimeout(function() {
                loadFileStatus();
                updateOverallProgress();
            }, 500);

        } catch (error) {
            updateProgressModal('Error', error.message, true);
        }
    }

    function waitForImportComplete() {
        return new Promise(function(resolve) {
            function checkProgress() {
                fetch('/import/progress')
                    .then(function(response) { return response.json(); })
                    .then(function(data) {
                        const progress = data.progress || data;
                        const isRunning = progress.running || progress.is_running || progress.status === 'running';

                        if (isRunning) {
                            // Update progress display
                            const totalFiles = progress.total_files || progress.total || 0;
                            const completedFiles = progress.completed_files || progress.processed || 0;
                            const percent = totalFiles > 0 ? Math.round((completedFiles / totalFiles) * 100) : 0;

                            document.getElementById('progress-bar').style.width = percent + '%';
                            document.getElementById('progress-percent').textContent = percent + '%';
                            document.getElementById('progress-counter').textContent = '[' + completedFiles + '/' + totalFiles + '] files';

                            setTimeout(checkProgress, 500);
                        } else {
                            resolve();
                        }
                    })
                    .catch(function() {
                        setTimeout(checkProgress, 1000);
                    });
            }
            checkProgress();
        });
    }

    async function pollImportProgress() {
        try {
            const response = await fetch('/import/progress');
            const data = await response.json();

            // Handle both legacy format and new format
            const progress = data.progress || data;
            const totalFiles = progress.total_files || progress.total || 0;
            const completedFiles = progress.completed_files || progress.processed || 0;
            const percent = totalFiles > 0 ? Math.round((completedFiles / totalFiles) * 100) : 0;
            const isRunning = progress.running || progress.is_running || progress.status === 'running';

            // Update progress bar and percentage
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').textContent = percent + '%';

            // Update counter [current/total]
            if (totalFiles > 0) {
                document.getElementById('progress-counter').textContent = '[' + completedFiles + '/' + totalFiles + '] files';
            }

            // Update current file
            const currentFile = progress.current_file || '';
            if (currentFile) {
                document.getElementById('progress-current-file').classList.remove('hidden');
                document.getElementById('progress-filename').textContent = currentFile;
                document.getElementById('progress-message').textContent = 'Importing...';
            } else {
                document.getElementById('progress-current-file').classList.add('hidden');
                document.getElementById('progress-message').textContent = 'Processing...';
            }

            // Update statistics
            const recordsImported = progress.records_imported || progress.total_records || 0;
            const failedFiles = progress.failed_files || 0;
            if (recordsImported > 0 || failedFiles > 0 || completedFiles > 0) {
                document.getElementById('progress-stats').classList.remove('hidden');
                document.getElementById('progress-stat-imported').textContent = completedFiles.toLocaleString();
                document.getElementById('progress-stat-failed').textContent = failedFiles.toLocaleString();
                document.getElementById('progress-stat-records').textContent = recordsImported.toLocaleString();
            }

            if (isRunning) {
                setTimeout(pollImportProgress, 500);
            } else {
                // Import completed
                const message = failedFiles > 0
                    ? 'Imported ' + completedFiles + ' files, ' + failedFiles + ' failed'
                    : 'Imported ' + completedFiles + ' files successfully';
                updateProgressModal('Import Complete', message, true);
                // Delay to ensure database commits are complete, then reload file status
                setTimeout(function() {
                    loadFileStatus();
                    updateOverallProgress();
                }, 500);
            }
        } catch (error) {
            console.error('Error polling import progress:', error);
            setTimeout(pollImportProgress, 1000);
        }
    }

    // === Settings Functions ===
    async function loadSettings() {
        try {
            const response = await fetch('/api/smt/settings');
            const data = await response.json();
            if (data.success && data.settings && data.settings.smt_vendor_id) {
                document.getElementById('smt-vendor-id').value = data.settings.smt_vendor_id;
            }
        } catch (error) {
            console.error('Error loading settings:', error);
        }
    }

    async function saveVendorId() {
        const vendorId = document.getElementById('smt-vendor-id').value.trim();
        if (!vendorId) {
            alert('Please enter a Vendor ID');
            return;
        }

        try {
            const response = await fetch('/api/smt/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ smt_vendor_id: vendorId })
            });
            const data = await response.json();

            if (data.success) {
                alert('Vendor ID saved successfully');
                loadSMTStatus();
            } else {
                alert('Error: ' + (data.error || 'Failed to save'));
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }

    // === Progress Modal Functions ===
    function showProgressModal(title, message) {
        document.getElementById('progress-title').textContent = title;
        document.getElementById('progress-message').textContent = message;
        document.getElementById('progress-bar').style.width = '0%';
        document.getElementById('progress-percent').textContent = '0%';
        document.getElementById('progress-counter').textContent = '';
        document.getElementById('progress-details').textContent = '';
        document.getElementById('progress-current-file').classList.add('hidden');
        document.getElementById('progress-stats').classList.add('hidden');
        document.getElementById('progress-stat-imported').textContent = '0';
        document.getElementById('progress-stat-failed').textContent = '0';
        document.getElementById('progress-stat-records').textContent = '0';
        document.getElementById('progress-close-btn').classList.add('hidden');
        document.getElementById('progress-spinner').classList.remove('hidden');
        document.getElementById('progress-modal').classList.remove('hidden');
    }

    function updateProgressModal(title, message, showClose) {
        document.getElementById('progress-title').textContent = title;
        document.getElementById('progress-message').textContent = message;
        if (showClose) {
            document.getElementById('progress-close-btn').classList.remove('hidden');
            document.getElementById('progress-spinner').classList.add('hidden');
            document.getElementById('progress-current-file').classList.add('hidden');
            document.getElementById('progress-bar').style.width = '100%';
            document.getElementById('progress-percent').textContent = '100%';
        }
    }

    function closeProgressModal() {
        document.getElementById('progress-modal').classList.add('hidden');
        updateOverallProgress();
    }

    // === Overall Progress ===
    function updateOverallProgress() {
        let totalSteps = 0;
        let completedSteps = 0;

        // Check seed tables (5 tables)
        Object.values(seedStatus).forEach(function(table) {
            totalSteps++;
            if (!table.is_empty) completedSteps++;
        });

        // Check files (at least some imported)
        if (fileStatus.rep.length > 0) {
            totalSteps++;
            const repImported = fileStatus.rep.filter(function(f) { return f.imported; }).length;
            if (repImported > 0) completedSteps++;
        }

        if (fileStatus.stm.length > 0) {
            totalSteps++;
            const stmImported = fileStatus.stm.filter(function(f) { return f.imported; }).length;
            if (stmImported > 0) completedSteps++;
        }

        const percent = totalSteps > 0 ? Math.round((completedSteps / totalSteps) * 100) : 0;
        document.getElementById('overall-progress-bar').style.width = percent + '%';
        document.getElementById('overall-progress-text').textContent = completedSteps + '/' + totalSteps + ' steps complete';

        // Show complete message if all done
        if (percent === 100) {
            document.getElementById('setup-complete-message').classList.remove('hidden');
        } else {
            document.getElementById('setup-complete-message').classList.add('hidden');
        }
    }
</script>
{% endblock %}
