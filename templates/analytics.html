{% extends "base.html" %}

{% block title %}Analytics Dashboard - E-Claim{% endblock %}

{% block content %}
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<div class="space-y-6">
    <!-- Page Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-3xl font-bold text-gray-800">Analytics Dashboard</h1>
            <p class="text-gray-600 mt-1">วิเคราะห์ข้อมูลการเบิกจ่าย E-Claim</p>
        </div>
        <button onclick="refreshAllData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
            </svg>
            Refresh
        </button>
    </div>

    <!-- Filter Section -->
    <div class="bg-white rounded-xl shadow-md p-4">
        <div class="flex flex-wrap items-center gap-4">
            <!-- Fiscal Year Filter -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">ปีงบประมาณ:</label>
                <select id="fiscal-year-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">ทั้งหมด</option>
                </select>
            </div>

            <!-- Or separator -->
            <span class="text-gray-400 text-sm">หรือ</span>

            <!-- Date Range Filter -->
            <div class="flex items-center gap-2">
                <label class="text-sm font-medium text-gray-700">ช่วงวันที่:</label>
                <input type="date" id="start-date-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                <span class="text-gray-500">-</span>
                <input type="date" id="end-date-filter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Apply Button -->
            <button onclick="applyFilters()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg text-sm flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path>
                </svg>
                กรองข้อมูล
            </button>

            <!-- Clear Button -->
            <button onclick="clearFilters()" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                ล้าง
            </button>

            <!-- Current Filter Display -->
            <div id="current-filter-display" class="ml-auto text-sm text-gray-600 hidden">
                <span class="bg-blue-100 text-blue-800 px-2 py-1 rounded" id="filter-badge"></span>
            </div>
        </div>
    </div>

    <!-- KPI Overview Cards - Clean & Minimal -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3" id="overview-cards">
        <!-- Total Claims -->
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide">Claims</p>
            <p class="text-2xl font-bold text-gray-800 mt-1" id="total-claims">-</p>
            <p class="text-xs text-gray-400"><span id="unique-patients">-</span> ผู้ป่วย</p>
        </div>

        <!-- Total Reimbursement -->
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide">ชดเชย</p>
            <p class="text-2xl font-bold text-green-600 mt-1" id="total-reimb">-</p>
            <div class="flex items-center gap-2 mt-1">
                <div class="flex-1 bg-gray-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full transition-all duration-500" id="reimb-rate-bar" style="width: 0%;"></div>
                </div>
                <span class="text-xs font-semibold" id="reimb-rate-value">-</span>
            </div>
        </div>

        <!-- Drug Cost -->
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide">ค่ายา</p>
            <p class="text-2xl font-bold text-purple-600 mt-1" id="total-drug-cost">-</p>
            <div class="flex items-center gap-2 mt-1">
                <div class="flex-1 bg-gray-200 rounded-full h-1.5">
                    <div class="h-1.5 rounded-full transition-all duration-500" id="drug-reimb-rate-bar" style="width: 0%;"></div>
                </div>
                <span class="text-xs font-semibold" id="drug-reimb-rate-value">-</span>
            </div>
        </div>

        <!-- Denials -->
        <div class="bg-white rounded-lg shadow p-4">
            <p class="text-xs text-gray-500 uppercase tracking-wide">ปฏิเสธ</p>
            <p class="text-2xl font-bold text-red-600 mt-1" id="total-denials">-</p>
            <p class="text-xs text-red-400">ต้องตรวจสอบ</p>
        </div>
    </div>

    <!-- Hidden elements for JS compatibility -->
    <div class="hidden">
        <span id="total-claim-drg">-</span>
        <span id="avg-claim-per-case">-</span>
        <span id="avg-reimb-per-case">-</span>
        <span id="total-drug-claim">-</span>
        <span id="total-drug-items">-</span>
        <span id="total-drug-cases">-</span>
        <span id="drug-avg-claim">-</span>
        <span id="drug-avg-reimb">-</span>
    </div>

    <!-- OPD/IPD Detail Cards - Clean & Organized -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <!-- OPD Card -->
        <div class="bg-white rounded-lg shadow p-5">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-100 p-2 rounded-lg">
                        <svg class="w-5 h-5 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">OPD ผู้ป่วยนอก</p>
                        <p class="text-sm text-gray-500"><span id="opd-claims" class="font-medium text-blue-600">-</span> / <span id="opd-total-claims">-</span> claims</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400">ไม่ผ่าน</p>
                    <p class="text-sm text-red-500 font-medium"><span id="opd-fail-claims">-</span></p>
                </div>
            </div>

            <!-- Progress Bars -->
            <div class="space-y-3 mb-4">
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-500">สำเร็จ</span>
                        <span class="font-semibold" id="opd-success-rate-value">-</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500" id="opd-success-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-500">ชดเชย</span>
                        <span class="font-semibold" id="opd-reimb-rate-value">-</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500" id="opd-reimb-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- Money Stats -->
            <div class="grid grid-cols-3 gap-2 pt-3 border-t border-gray-100">
                <div class="text-center">
                    <p class="text-xs text-gray-400">เรียกเก็บ</p>
                    <p class="text-sm font-semibold text-gray-600" id="opd-total-claim">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ผ่าน</p>
                    <p class="text-sm font-semibold text-blue-500" id="opd-claim">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ชดเชย</p>
                    <p class="text-sm font-semibold text-green-600" id="opd-reimb">-</p>
                </div>
            </div>

            <!-- Hidden elements for JS -->
            <div class="hidden">
                <span id="opd-avg-claim">-</span>
                <span id="opd-avg-reimb">-</span>
                <span id="opd-fail-claim">-</span>
            </div>
        </div>

        <!-- IPD Card -->
        <div class="bg-white rounded-lg shadow p-5">
            <!-- Header -->
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <div class="bg-orange-100 p-2 rounded-lg">
                        <svg class="w-5 h-5 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="font-semibold text-gray-800">IPD ผู้ป่วยใน</p>
                        <p class="text-sm text-gray-500"><span id="ipd-claims" class="font-medium text-orange-600">-</span> / <span id="ipd-total-claims">-</span> claims</p>
                    </div>
                </div>
                <div class="text-right">
                    <p class="text-xs text-gray-400">ไม่ผ่าน</p>
                    <p class="text-sm text-red-500 font-medium"><span id="ipd-fail-claims">-</span></p>
                </div>
            </div>

            <!-- Progress Bars -->
            <div class="space-y-3 mb-4">
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-500">สำเร็จ</span>
                        <span class="font-semibold" id="ipd-success-rate-value">-</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500" id="ipd-success-bar" style="width: 0%;"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span class="text-gray-500">ชดเชย</span>
                        <span class="font-semibold" id="ipd-reimb-rate-value">-</span>
                    </div>
                    <div class="w-full bg-gray-100 rounded-full h-2">
                        <div class="h-2 rounded-full transition-all duration-500" id="ipd-reimb-bar" style="width: 0%;"></div>
                    </div>
                </div>
            </div>

            <!-- Money Stats -->
            <div class="grid grid-cols-3 gap-2 pt-3 border-t border-gray-100">
                <div class="text-center">
                    <p class="text-xs text-gray-400">เรียกเก็บ</p>
                    <p class="text-sm font-semibold text-gray-600" id="ipd-total-claim">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ผ่าน</p>
                    <p class="text-sm font-semibold text-orange-500" id="ipd-claim">-</p>
                </div>
                <div class="text-center">
                    <p class="text-xs text-gray-400">ชดเชย</p>
                    <p class="text-sm font-semibold text-green-600" id="ipd-reimb">-</p>
                </div>
            </div>

            <!-- Hidden elements for JS -->
            <div class="hidden">
                <span id="ipd-avg-claim">-</span>
                <span id="ipd-avg-reimb">-</span>
                <span id="ipd-fail-claim">-</span>
            </div>
        </div>
    </div>

    <!-- Charts Row 1 -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Monthly Trend Chart -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">แนวโน้มรายเดือน</h3>
            <div class="h-80">
                <canvas id="monthlyTrendChart"></canvas>
            </div>
        </div>

        <!-- Claim vs Payment Comparison -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">เปรียบเทียบ เบิก vs จ่าย</h3>
            <div class="h-80">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Charts Row 2 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Service Type Pie Chart -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ตามประเภทบริการ</h3>
            <div class="h-64">
                <canvas id="serviceTypeChart"></canvas>
            </div>
        </div>

        <!-- Fund Distribution -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">ตามกองทุน</h3>
            <div class="h-64">
                <canvas id="fundChart"></canvas>
            </div>
        </div>

        <!-- RW Distribution -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">การกระจาย RW (IP)</h3>
            <div class="h-64">
                <canvas id="rwChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Tables Row -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Top Drugs Table -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 10 ยาที่เบิกมากสุด</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-gray-600">#</th>
                            <th class="px-4 py-2 text-left text-gray-600">ชื่อยา</th>
                            <th class="px-4 py-2 text-right text-gray-600">จำนวนครั้ง</th>
                            <th class="px-4 py-2 text-right text-gray-600">มูลค่า (บาท)</th>
                        </tr>
                    </thead>
                    <tbody id="drug-table-body">
                        <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Top DRG Table -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Top 10 DRG</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-gray-600">DRG</th>
                            <th class="px-4 py-2 text-right text-gray-600">Cases</th>
                            <th class="px-4 py-2 text-right text-gray-600">Avg RW</th>
                            <th class="px-4 py-2 text-right text-gray-600">Total Paid</th>
                        </tr>
                    </thead>
                    <tbody id="drg-table-body">
                        <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Service Type & Fund Details -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Service Type Details -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">รายละเอียดตามประเภทบริการ</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-gray-600">ประเภท</th>
                            <th class="px-4 py-2 text-right text-gray-600">Claims</th>
                            <th class="px-4 py-2 text-right text-gray-600">ผู้ป่วย</th>
                            <th class="px-4 py-2 text-right text-gray-600">ยอดเบิก</th>
                        </tr>
                    </thead>
                    <tbody id="service-table-body">
                        <tr><td colspan="4" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Denial Analysis -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">สาเหตุการปฏิเสธ</h3>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-gray-600">สาเหตุ</th>
                            <th class="px-4 py-2 text-right text-gray-600">จำนวน</th>
                            <th class="px-4 py-2 text-right text-gray-600">มูลค่า (บาท)</th>
                        </tr>
                    </thead>
                    <tbody id="denial-table-body">
                        <tr><td colspan="3" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Instrument Table -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Top อุปกรณ์/หัตถการ</h3>
        <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-gray-600">#</th>
                        <th class="px-4 py-2 text-left text-gray-600">ชื่อ</th>
                        <th class="px-4 py-2 text-right text-gray-600">จำนวนครั้ง</th>
                        <th class="px-4 py-2 text-right text-gray-600">จำนวนชิ้น</th>
                        <th class="px-4 py-2 text-right text-gray-600">มูลค่า (บาท)</th>
                    </tr>
                </thead>
                <tbody id="instrument-table-body">
                    <tr><td colspan="5" class="px-4 py-8 text-center text-gray-500">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// Chart instances
let monthlyTrendChart, comparisonChart, serviceTypeChart, fundChart, rwChart;

// Build filter query string from current form values
function getFilterQueryString() {
    const fiscalYear = document.getElementById('fiscal-year-filter').value;
    const startDate = document.getElementById('start-date-filter').value;
    const endDate = document.getElementById('end-date-filter').value;

    const params = new URLSearchParams();
    if (fiscalYear) {
        params.append('fiscal_year', fiscalYear);
    } else {
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
    }
    const qs = params.toString();
    return qs ? '?' + qs : '';
}

// Load fiscal years for dropdown
async function loadFiscalYears() {
    try {
        const response = await fetch('/api/analytics/fiscal-years');
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const select = document.getElementById('fiscal-year-filter');
            result.data.forEach(fy => {
                const option = document.createElement('option');
                option.value = fy;
                option.textContent = 'ปี ' + fy;
                select.appendChild(option);
            });
        }
    } catch (error) {
        console.error('Error loading fiscal years:', error);
    }
}

// Apply filters - just refresh all data (filter values read directly from form)
function applyFilters() {
    // Update filter badge
    updateFilterBadge();

    // Refresh all data with new filters
    refreshAllData();
}

// Clear filters
function clearFilters() {
    document.getElementById('fiscal-year-filter').value = '';
    document.getElementById('start-date-filter').value = '';
    document.getElementById('end-date-filter').value = '';

    // Hide filter badge
    document.getElementById('current-filter-display').classList.add('hidden');

    // Refresh all data
    refreshAllData();
}

// Update filter badge display
function updateFilterBadge() {
    const display = document.getElementById('current-filter-display');
    const badge = document.getElementById('filter-badge');

    const fiscalYear = document.getElementById('fiscal-year-filter').value;
    const startDate = document.getElementById('start-date-filter').value;
    const endDate = document.getElementById('end-date-filter').value;

    if (fiscalYear) {
        badge.textContent = 'ปีงบ ' + fiscalYear;
        display.classList.remove('hidden');
    } else if (startDate || endDate) {
        let text = '';
        if (startDate) text += startDate;
        if (startDate && endDate) text += ' - ';
        if (endDate) text += endDate;
        badge.textContent = text;
        display.classList.remove('hidden');
    } else {
        display.classList.add('hidden');
    }
}

// Format number with commas
function formatNumber(num) {
    if (num === null || num === undefined) return '-';
    return new Intl.NumberFormat('th-TH').format(Math.round(num));
}

// Format currency
function formatCurrency(num) {
    if (num === null || num === undefined) return '-';
    return new Intl.NumberFormat('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num);
}

// Get color for progress bar based on rate value
function getRateColor(rate) {
    if (rate >= 80) return '#10b981'; // Green (emerald-500)
    if (rate >= 50) return '#f59e0b'; // Yellow (amber-500)
    return '#ef4444'; // Red (red-500)
}

// Get text color class for rate value
function getRateTextClass(rate) {
    if (rate >= 80) return 'text-green-600';
    if (rate >= 50) return 'text-amber-600';
    return 'text-red-600';
}

// Update progress bar with animation
function updateProgressBar(barId, valueId, rate, showPercent = true) {
    const bar = document.getElementById(barId);
    const valueEl = document.getElementById(valueId);

    if (bar && rate !== null && rate !== undefined) {
        const color = getRateColor(rate);
        bar.style.backgroundColor = color;
        bar.style.width = Math.min(rate, 100) + '%';
    }

    if (valueEl && rate !== null && rate !== undefined) {
        valueEl.textContent = rate.toFixed(1) + (showPercent ? '%' : '');
        valueEl.className = valueEl.className.replace(/text-\w+-\d+/g, '').trim();
        valueEl.classList.add(getRateTextClass(rate));
    }
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    if (text === null || text === undefined) return '';
    const div = document.createElement('div');
    div.textContent = String(text);
    return div.innerHTML;
}

// Create table row using DOM methods
function createTableRow(cells, classes) {
    const tr = document.createElement('tr');
    tr.className = classes || 'border-b';
    cells.forEach(cell => {
        const td = document.createElement('td');
        td.className = cell.className || 'px-4 py-2';
        td.textContent = cell.text;
        if (cell.title) td.title = cell.title;
        tr.appendChild(td);
    });
    return tr;
}

// Clear table body and add rows
function updateTable(tbodyId, rows) {
    const tbody = document.getElementById(tbodyId);
    tbody.replaceChildren();
    rows.forEach(row => tbody.appendChild(row));
}

// Load overview data
async function loadOverview() {
    try {
        const url = '/api/analytics/overview' + getFilterQueryString();
        const response = await fetch(url);
        const result = await response.json();

        if (result.success) {
            const data = result.data;
            document.getElementById('total-claims').textContent = formatNumber(data.total_claims);
            document.getElementById('unique-patients').textContent = formatNumber(data.unique_patients);
            document.getElementById('total-reimb').textContent = formatNumber(data.total_reimb) + ' B';
            document.getElementById('total-claim-drg').textContent = formatNumber(data.total_claim_drg) + ' B';
            document.getElementById('avg-claim-per-case').textContent = formatNumber(data.avg_claim_per_case) + ' B';
            document.getElementById('avg-reimb-per-case').textContent = formatNumber(data.avg_reimb_per_case) + ' B';
            document.getElementById('total-drug-cost').textContent = formatNumber(data.total_drug_cost) + ' B';
            document.getElementById('total-drug-claim').textContent = formatNumber(data.total_drug_claim) + ' B';
            document.getElementById('total-drug-items').textContent = formatNumber(data.total_drug_items);
            document.getElementById('total-drug-cases').textContent = formatNumber(data.total_drug_cases);
            document.getElementById('drug-avg-claim').textContent = formatNumber(data.drug_avg_claim_per_case) + ' B';
            document.getElementById('drug-avg-reimb').textContent = formatNumber(data.drug_avg_reimb_per_case) + ' B';
            document.getElementById('total-denials').textContent = formatNumber(data.total_denials);

            // Update main progress bars
            updateProgressBar('reimb-rate-bar', 'reimb-rate-value', data.reimb_rate);
            updateProgressBar('drug-reimb-rate-bar', 'drug-reimb-rate-value', data.drug_reimb_rate);

            // OPD Stats
            if (data.opd) {
                document.getElementById('opd-claims').textContent = formatNumber(data.opd.claims);
                document.getElementById('opd-total-claims').textContent = formatNumber(data.opd.total_claims);
                document.getElementById('opd-total-claim').textContent = formatNumber(data.opd.total_claim) + ' B';
                document.getElementById('opd-claim').textContent = formatNumber(data.opd.claim) + ' B';
                document.getElementById('opd-reimb').textContent = formatNumber(data.opd.reimb) + ' B';
                document.getElementById('opd-avg-claim').textContent = formatNumber(data.opd.avg_claim) + ' B';
                document.getElementById('opd-avg-reimb').textContent = formatNumber(data.opd.avg_reimb) + ' B';
                document.getElementById('opd-fail-claims').textContent = formatNumber(data.opd.fail_claims);
                document.getElementById('opd-fail-claim').textContent = formatNumber(data.opd.fail_claim) + ' B';

                // OPD Progress bars
                updateProgressBar('opd-success-bar', 'opd-success-rate-value', data.opd.success_rate);
                updateProgressBar('opd-reimb-bar', 'opd-reimb-rate-value', data.opd.reimb_rate);
            }

            // IPD Stats
            if (data.ipd) {
                document.getElementById('ipd-claims').textContent = formatNumber(data.ipd.claims);
                document.getElementById('ipd-total-claims').textContent = formatNumber(data.ipd.total_claims);
                document.getElementById('ipd-total-claim').textContent = formatNumber(data.ipd.total_claim) + ' B';
                document.getElementById('ipd-claim').textContent = formatNumber(data.ipd.claim) + ' B';
                document.getElementById('ipd-reimb').textContent = formatNumber(data.ipd.reimb) + ' B';
                document.getElementById('ipd-avg-claim').textContent = formatNumber(data.ipd.avg_claim) + ' B';
                document.getElementById('ipd-avg-reimb').textContent = formatNumber(data.ipd.avg_reimb) + ' B';
                document.getElementById('ipd-fail-claims').textContent = formatNumber(data.ipd.fail_claims);
                document.getElementById('ipd-fail-claim').textContent = formatNumber(data.ipd.fail_claim) + ' B';

                // IPD Progress bars
                updateProgressBar('ipd-success-bar', 'ipd-success-rate-value', data.ipd.success_rate);
                updateProgressBar('ipd-reimb-bar', 'ipd-reimb-rate-value', data.ipd.reimb_rate);
            }
        }
    } catch (error) {
        console.error('Error loading overview:', error);
    }
}

// Load monthly trend chart
async function loadMonthlyTrend() {
    try {
        const response = await fetch('/api/analytics/monthly-trend' + getFilterQueryString());
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const ctx = document.getElementById('monthlyTrendChart').getContext('2d');

            if (monthlyTrendChart) monthlyTrendChart.destroy();

            monthlyTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: result.data.map(d => d.month),
                    datasets: [{
                        label: 'ยอดเบิก (แสน)',
                        data: result.data.map(d => d.reimb / 100000),
                        borderColor: '#10B981',
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        fill: true,
                        tension: 0.4
                    }, {
                        label: 'จ่ายจริง (แสน)',
                        data: result.data.map(d => d.paid / 100000),
                        borderColor: '#3B82F6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'แสนบาท' }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading monthly trend:', error);
    }
}

// Load comparison chart
async function loadComparison() {
    try {
        const response = await fetch('/api/analytics/comparison' + getFilterQueryString());
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            if (comparisonChart) comparisonChart.destroy();

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: result.data.map(d => d.month),
                    datasets: [{
                        label: 'เบิก',
                        data: result.data.map(d => d.claimed / 100000),
                        backgroundColor: '#94A3B8'
                    }, {
                        label: 'อนุมัติ',
                        data: result.data.map(d => d.approved / 100000),
                        backgroundColor: '#10B981'
                    }, {
                        label: 'จ่าย',
                        data: result.data.map(d => d.paid / 100000),
                        backgroundColor: '#3B82F6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom' }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'แสนบาท' }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading comparison:', error);
    }
}

// Load service type chart
async function loadServiceType() {
    try {
        const response = await fetch('/api/analytics/service-type' + getFilterQueryString());
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const ctx = document.getElementById('serviceTypeChart').getContext('2d');

            if (serviceTypeChart) serviceTypeChart.destroy();

            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];

            serviceTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: result.data.map(d => d.name),
                    datasets: [{
                        data: result.data.map(d => d.reimb),
                        backgroundColor: colors.slice(0, result.data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12 } }
                    }
                }
            });

            // Update table using DOM methods
            const rows = result.data.map(d => createTableRow([
                { text: d.name, className: 'px-4 py-2' },
                { text: formatNumber(d.claims), className: 'px-4 py-2 text-right' },
                { text: formatNumber(d.patients), className: 'px-4 py-2 text-right' },
                { text: formatCurrency(d.reimb), className: 'px-4 py-2 text-right' }
            ]));
            updateTable('service-table-body', rows);
        }
    } catch (error) {
        console.error('Error loading service type:', error);
    }
}

// Load fund chart
async function loadFund() {
    try {
        const response = await fetch('/api/analytics/fund' + getFilterQueryString());
        const result = await response.json();

        if (result.success && result.data.length > 0) {
            const ctx = document.getElementById('fundChart').getContext('2d');

            if (fundChart) fundChart.destroy();

            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#06B6D4', '#84CC16', '#F97316', '#6366F1'];

            fundChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: result.data.map(d => d.fund.substring(0, 20)),
                    datasets: [{
                        data: result.data.map(d => d.reimb),
                        backgroundColor: colors.slice(0, result.data.length)
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error loading fund:', error);
    }
}

// Load DRG data
async function loadDRG() {
    try {
        const response = await fetch('/api/analytics/drg' + getFilterQueryString());
        const result = await response.json();

        if (result.success) {
            // RW distribution chart
            if (result.data.rw_distribution && result.data.rw_distribution.length > 0) {
                const ctx = document.getElementById('rwChart').getContext('2d');

                if (rwChart) rwChart.destroy();

                rwChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: result.data.rw_distribution.map(d => d.range),
                        datasets: [{
                            label: 'Cases',
                            data: result.data.rw_distribution.map(d => d.cases),
                            backgroundColor: '#8B5CF6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });
            }

            // DRG table using DOM methods
            if (result.data.top_drg && result.data.top_drg.length > 0) {
                const rows = result.data.top_drg.slice(0, 10).map(d => createTableRow([
                    { text: d.drg, className: 'px-4 py-2 font-mono' },
                    { text: formatNumber(d.cases), className: 'px-4 py-2 text-right' },
                    { text: d.avg_rw.toFixed(4), className: 'px-4 py-2 text-right' },
                    { text: formatCurrency(d.total_paid), className: 'px-4 py-2 text-right' }
                ]));
                updateTable('drg-table-body', rows);
            } else {
                const emptyRow = createTableRow([
                    { text: 'ไม่มีข้อมูล DRG', className: 'px-4 py-8 text-center text-gray-500' }
                ]);
                emptyRow.firstChild.colSpan = 4;
                updateTable('drg-table-body', [emptyRow]);
            }
        }
    } catch (error) {
        console.error('Error loading DRG:', error);
    }
}

// Load drug data
async function loadDrug() {
    try {
        const response = await fetch('/api/analytics/drug' + getFilterQueryString());
        const result = await response.json();

        if (result.success && result.data.top_drugs && result.data.top_drugs.length > 0) {
            const rows = result.data.top_drugs.slice(0, 10).map((d, i) => createTableRow([
                { text: String(i + 1), className: 'px-4 py-2' },
                { text: d.name, className: 'px-4 py-2', title: d.name },
                { text: formatNumber(d.prescriptions), className: 'px-4 py-2 text-right' },
                { text: formatCurrency(d.total_cost), className: 'px-4 py-2 text-right' }
            ]));
            updateTable('drug-table-body', rows);
        } else {
            const emptyRow = createTableRow([
                { text: 'ไม่มีข้อมูลยา', className: 'px-4 py-8 text-center text-gray-500' }
            ]);
            emptyRow.firstChild.colSpan = 4;
            updateTable('drug-table-body', [emptyRow]);
        }
    } catch (error) {
        console.error('Error loading drug:', error);
    }
}

// Load instrument data
async function loadInstrument() {
    try {
        const response = await fetch('/api/analytics/instrument' + getFilterQueryString());
        const result = await response.json();

        if (result.success && result.data && result.data.length > 0) {
            const rows = result.data.slice(0, 10).map((d, i) => createTableRow([
                { text: String(i + 1), className: 'px-4 py-2' },
                { text: d.name, className: 'px-4 py-2', title: d.name },
                { text: formatNumber(d.uses), className: 'px-4 py-2 text-right' },
                { text: formatNumber(d.total_qty), className: 'px-4 py-2 text-right' },
                { text: formatCurrency(d.total_cost), className: 'px-4 py-2 text-right' }
            ]));
            updateTable('instrument-table-body', rows);
        } else {
            const emptyRow = createTableRow([
                { text: 'ไม่มีข้อมูลอุปกรณ์', className: 'px-4 py-8 text-center text-gray-500' }
            ]);
            emptyRow.firstChild.colSpan = 5;
            updateTable('instrument-table-body', [emptyRow]);
        }
    } catch (error) {
        console.error('Error loading instrument:', error);
    }
}

// Load denial data
async function loadDenial() {
    try {
        const response = await fetch('/api/analytics/denial' + getFilterQueryString());
        const result = await response.json();

        if (result.success) {
            if (result.data.denials && result.data.denials.length > 0) {
                const rows = result.data.denials.map(d => createTableRow([
                    { text: d.reason, className: 'px-4 py-2' },
                    { text: formatNumber(d.cases), className: 'px-4 py-2 text-right' },
                    { text: formatCurrency(d.total_amount), className: 'px-4 py-2 text-right' }
                ]));
                updateTable('denial-table-body', rows);
            } else {
                const emptyRow = createTableRow([
                    { text: 'ไม่มีข้อมูลการปฏิเสธ', className: 'px-4 py-8 text-center text-gray-500' }
                ]);
                emptyRow.firstChild.colSpan = 3;
                updateTable('denial-table-body', [emptyRow]);
            }
        }
    } catch (error) {
        console.error('Error loading denial:', error);
    }
}

// Refresh all data
function refreshAllData() {
    loadOverview();
    loadMonthlyTrend();
    loadComparison();
    loadServiceType();
    loadFund();
    loadDRG();
    loadDrug();
    loadInstrument();
    loadDenial();
}

// Handle fiscal year selection - auto-fill date range
function onFiscalYearChange() {
    const fiscalYear = parseInt(document.getElementById('fiscal-year-filter').value);
    const startDateInput = document.getElementById('start-date-filter');
    const endDateInput = document.getElementById('end-date-filter');

    if (fiscalYear) {
        // Thai fiscal year: October 1 of previous year to September 30 of current year
        // ปีงบ 2569 = 1 ต.ค. 2568 ถึง 30 ก.ย. 2569
        const startYear = fiscalYear - 1 - 543; // Convert BE to CE and subtract 1 for October
        const endYear = fiscalYear - 543;       // Convert BE to CE

        // Format: YYYY-MM-DD for date input
        const startDate = `${startYear}-10-01`;  // October 1
        const endDate = `${endYear}-09-30`;       // September 30

        startDateInput.value = startDate;
        endDateInput.value = endDate;
    } else {
        // Clear dates if "ทั้งหมด" selected
        startDateInput.value = '';
        endDateInput.value = '';
    }
}

// Get current Thai fiscal year
function getCurrentFiscalYear() {
    const now = new Date();
    const currentMonth = now.getMonth() + 1; // 1-12
    const currentYear = now.getFullYear();
    const beYear = currentYear + 543;

    // Thai fiscal year: Oct-Sep
    // If Oct-Dec, fiscal year is next BE year
    // If Jan-Sep, fiscal year is current BE year
    if (currentMonth >= 10) {
        return beYear + 1;
    } else {
        return beYear;
    }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', async function() {
    // Load fiscal years dropdown first
    await loadFiscalYears();

    // Add change event listener for fiscal year dropdown
    document.getElementById('fiscal-year-filter').addEventListener('change', onFiscalYearChange);

    // Set default to current fiscal year
    const currentFY = getCurrentFiscalYear();
    const fySelect = document.getElementById('fiscal-year-filter');

    // Check if current fiscal year exists in options
    const options = Array.from(fySelect.options);
    const hasCurrentFY = options.some(opt => opt.value === String(currentFY));

    if (hasCurrentFY) {
        fySelect.value = String(currentFY);
        onFiscalYearChange(); // Trigger to fill date fields
    }

    // Then load all data
    refreshAllData();
});
</script>
{% endblock %}
