{% extends "base.html" %}

{% block title %}My Hospital Analytics - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header with Hospital Selector -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My Hospital Analytics</h1>
                <p class="text-gray-600 mt-1">วิเคราะห์ข้อมูล SMT Budget ของโรงพยาบาล</p>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <!-- Hospital Selector -->
                <div class="flex-1 min-w-64">
                    <label class="block text-sm font-medium text-gray-700 mb-1">เลือกโรงพยาบาล</label>
                    <div class="relative">
                        <input type="text" id="search-hospital" placeholder="พิมพ์ชื่อหรือรหัสโรงพยาบาล..."
                               onkeyup="searchHospitals()"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <div id="search-results" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>
                <!-- Fiscal Year -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ปีงบประมาณ</label>
                    <select id="fiscal-year" onchange="loadMyHospital()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    </select>
                </div>
                <!-- Refresh Button -->
                <div class="pt-5">
                    <button onclick="loadMyHospital()" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        Refresh
                    </button>
                </div>
            </div>
        </div>

        <!-- Selected Hospital Info -->
        <div id="selected-hospital" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <div>
                    <div class="font-semibold text-lg text-gray-800" id="hospital-name">-</div>
                    <div class="text-sm text-gray-600 flex flex-wrap gap-3">
                        <span id="hospital-code" class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">-</span>
                        <span id="hospital-level">-</span>
                        <span id="hospital-province">-</span>
                        <span id="hospital-region">-</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden">
        <div class="flex justify-center items-center py-12">
            <svg class="animate-spin h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3 text-gray-600">กำลังโหลดข้อมูล...</span>
        </div>
    </div>

    <!-- No Data State -->
    <div id="no-data-state" class="hidden">
        <div class="bg-white rounded-xl shadow-md p-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">ยังไม่มีข้อมูล SMT Budget</h3>
            <p class="text-gray-500 mb-4">กรุณาเลือกโรงพยาบาลและ Fetch ข้อมูลจาก SMT สปสช.</p>
            <button onclick="fetchSMTData()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Fetch SMT Data
            </button>
        </div>
    </div>

    <!-- Main Analytics Content -->
    <div id="analytics-content" class="hidden space-y-6">
        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total Revenue -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">รายได้รวม</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-revenue">-</p>
                        <p class="text-xs mt-1" id="growth-badge">-</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Wait Amount -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">ยอดรอจ่าย</p>
                        <p class="text-2xl font-bold text-orange-600" id="wait-amount">-</p>
                        <p class="text-xs text-gray-500 mt-1" id="wait-ratio">-</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Debt Amount -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">ยอดหนี้สิน</p>
                        <p class="text-2xl font-bold text-red-600" id="debt-amount">-</p>
                        <p class="text-xs text-gray-500 mt-1" id="debt-ratio">-</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Risk Score -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-gray-500">Risk Score</p>
                        <p class="text-2xl font-bold" id="risk-score">-</p>
                        <p class="text-xs mt-1" id="risk-level-badge">-</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center" id="risk-icon-bg">
                        <svg class="w-6 h-6" id="risk-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Risk Indicators
            </h3>
            <div id="risk-indicators" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Fund Breakdown -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-teal-50">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                    </svg>
                    รายได้ตามกองทุน
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">กองทุน</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">จำนวนเงิน</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">สัดส่วน</th>
                        </tr>
                    </thead>
                    <tbody id="fund-breakdown-tbody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Monthly Trend Chart with Year Comparison -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        แนวโน้มรายเดือน
                    </h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <!-- Metric Selector -->
                        <select id="trend-metric" onchange="updateTrendChart()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg">
                            <option value="total_amount">ยอดรวม</option>
                            <option value="wait_amount">ยอดรอจ่าย</option>
                            <option value="debt_amount">ยอดหนี้สิน</option>
                        </select>
                        <!-- Year Comparison Checkboxes -->
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">เปรียบเทียบปี:</span>
                            <div id="year-checkboxes" class="flex flex-wrap gap-2">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="relative" style="height: 350px;">
                    <canvas id="trend-chart"></canvas>
                </div>
                <!-- Year Legend -->
                <div id="year-legend" class="mt-4 flex flex-wrap justify-center gap-4 text-sm">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Comparison Section (Collapsible) -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <button onclick="toggleComparison()" class="w-full px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-blue-50 flex justify-between items-center hover:bg-indigo-100 transition-colors">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    เปรียบเทียบกับโรงพยาบาลอื่น (Optional)
                </h3>
                <svg id="comparison-chevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="comparison-content" class="hidden p-6">
                <!-- Quick Add Buttons -->
                <div class="mb-4 flex flex-wrap gap-2">
                    <span class="text-sm text-gray-500 py-1">เพิ่มด่วน:</span>
                    <button onclick="addSameProvince()" class="px-3 py-1 text-sm bg-blue-100 text-blue-700 rounded-full hover:bg-blue-200">+ จังหวัดเดียวกัน</button>
                    <button onclick="addSameRegion()" class="px-3 py-1 text-sm bg-green-100 text-green-700 rounded-full hover:bg-green-200">+ เขตสุขภาพเดียวกัน</button>
                    <button onclick="addSameLevel()" class="px-3 py-1 text-sm bg-purple-100 text-purple-700 rounded-full hover:bg-purple-200">+ ระดับเดียวกัน</button>
                </div>

                <!-- Search and Add Hospital -->
                <div class="flex gap-3 mb-4">
                    <div class="flex-1 relative">
                        <input type="text" id="compare-search" placeholder="ค้นหาโรงพยาบาลเพื่อเปรียบเทียบ..."
                               onkeyup="searchCompareHospitals()"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <div id="compare-search-results" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-48 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>

                <!-- Comparison Hospitals List -->
                <div id="comparison-list" class="space-y-2 mb-4">
                    <p class="text-sm text-gray-500 text-center py-4">ยังไม่ได้เลือกโรงพยาบาลเปรียบเทียบ</p>
                </div>

                <!-- Comparison Table -->
                <div id="comparison-table-wrapper" class="hidden overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">โรงพยาบาล</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">รายได้รวม</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Wait %</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Debt %</th>
                                <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Growth YoY</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="comparison-tbody" class="bg-white divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Source Note -->
    <div class="text-sm text-gray-500 text-center">
        <p>ข้อมูลจาก <a href="https://smt.nhso.go.th" target="_blank" class="text-blue-600 hover:underline">SMT สปสช.</a> | ข้อมูลสถานพยาบาลจาก <a href="https://hcode.moph.go.th" target="_blank" class="text-blue-600 hover:underline">hcode.moph.go.th</a></p>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// State
let currentVendorId = null;
let currentHospitalData = null;
let trendChart = null;
let searchTimeout = null;
let comparisonHospitals = [];
let comparisonYearsData = {}; // { year: monthlyData[] }

// Chart colors for year comparison
const yearColors = [
    { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },      // Blue (current year)
    { border: 'rgb(34, 197, 94)', bg: 'rgba(34, 197, 94, 0.1)' },        // Green
    { border: 'rgb(249, 115, 22)', bg: 'rgba(249, 115, 22, 0.1)' },      // Orange
    { border: 'rgb(168, 85, 247)', bg: 'rgba(168, 85, 247, 0.1)' },      // Purple
    { border: 'rgb(236, 72, 153)', bg: 'rgba(236, 72, 153, 0.1)' },      // Pink
    { border: 'rgb(20, 184, 166)', bg: 'rgba(20, 184, 166, 0.1)' }       // Teal
];

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    populateFiscalYears();
    loadDefaultHospital();

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        ['search-results', 'compare-search-results'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el && !el.contains(e.target)) {
                el.classList.add('hidden');
            }
        });
    });
});

function populateFiscalYears() {
    var currentYear = new Date().getFullYear() + 543;
    var month = new Date().getMonth() + 1;
    // If before October, fiscal year is current BE year, else next BE year
    if (month < 10) {
        currentYear = currentYear;
    } else {
        currentYear = currentYear + 1;
    }

    var select = document.getElementById('fiscal-year');
    for (var y = currentYear; y >= currentYear - 5; y--) {
        var option = document.createElement('option');
        option.value = y;
        option.textContent = 'ปีงบ ' + y;
        if (y === currentYear) option.selected = true;
        select.appendChild(option);
    }
}

async function loadDefaultHospital() {
    try {
        // Get default from SMT settings
        var response = await fetch('/api/smt/settings');
        var result = await response.json();

        if (result.success && result.settings && result.settings.smt_vendor_id) {
            currentVendorId = result.settings.smt_vendor_id;

            // Try to get hospital name from localStorage
            var savedName = localStorage.getItem('my_hospital_name');
            if (savedName) {
                document.getElementById('search-hospital').value = savedName;
            }

            loadMyHospital();
        } else {
            // Check localStorage
            var savedVendor = localStorage.getItem('my_hospital_vendor');
            if (savedVendor) {
                currentVendorId = savedVendor;
                var savedName = localStorage.getItem('my_hospital_name');
                if (savedName) {
                    document.getElementById('search-hospital').value = savedName;
                }
                loadMyHospital();
            } else {
                showNoDataState();
            }
        }
    } catch (e) {
        console.error('Error loading default hospital:', e);
        showNoDataState();
    }
}

function showLoading() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('no-data-state').classList.add('hidden');
    document.getElementById('analytics-content').classList.add('hidden');
}

function showNoDataState() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('no-data-state').classList.remove('hidden');
    document.getElementById('analytics-content').classList.add('hidden');
}

function showAnalytics() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('no-data-state').classList.add('hidden');
    document.getElementById('analytics-content').classList.remove('hidden');
}

async function loadMyHospital() {
    if (!currentVendorId) {
        showNoDataState();
        return;
    }

    showLoading();

    var fiscalYear = document.getElementById('fiscal-year').value;

    try {
        // Fetch hospital data
        var hospitalRes = await fetch('/api/benchmark/my-hospital?vendor_id=' + currentVendorId + '&fiscal_year=' + fiscalYear);
        var hospitalResult = await hospitalRes.json();

        if (!hospitalResult.success) {
            console.error('Error:', hospitalResult.error);
            showNoDataState();
            return;
        }

        currentHospitalData = hospitalResult;
        comparisonYearsData = {}; // Reset comparison data

        // Update hospital info
        updateHospitalInfo(hospitalResult.hospital);

        // Update UI
        updateSummaryCards(hospitalResult.summary);
        updateRiskAssessment(hospitalResult.risk_score);
        updateFundBreakdown(hospitalResult.fund_breakdown);
        populateYearCheckboxes();
        updateTrendChart();

        showAnalytics();

    } catch (e) {
        console.error('Error loading hospital data:', e);
        showNoDataState();
    }
}

function updateHospitalInfo(hospital) {
    if (!hospital) return;

    document.getElementById('hospital-name').textContent = hospital.name || '-';
    document.getElementById('hospital-code').textContent = 'รหัส: ' + (hospital.vendor_no || '').replace(/^0+/, '');
    document.getElementById('hospital-level').textContent = hospital.level || '-';
    document.getElementById('hospital-province').textContent = hospital.province || '-';
    document.getElementById('hospital-region').textContent = hospital.health_region || '-';

    document.getElementById('selected-hospital').classList.remove('hidden');

    // Save to localStorage
    localStorage.setItem('my_hospital_vendor', currentVendorId);
    localStorage.setItem('my_hospital_name', hospital.name || '');
}

function populateYearCheckboxes() {
    var container = document.getElementById('year-checkboxes');
    container.textContent = '';

    var currentYear = parseInt(document.getElementById('fiscal-year').value);

    // Create checkboxes for previous years (up to 4 years back)
    for (var i = 1; i <= 4; i++) {
        var year = currentYear - i;
        var label = document.createElement('label');
        label.className = 'flex items-center gap-1 px-2 py-1 rounded cursor-pointer hover:bg-gray-100 transition-colors';

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'year-' + year;
        checkbox.value = year;
        checkbox.className = 'rounded text-purple-600 focus:ring-purple-500';
        checkbox.onchange = function() { toggleComparisonYear(this.value, this.checked); };

        var span = document.createElement('span');
        span.className = 'text-sm text-gray-700';
        span.textContent = year;

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
    }
}

async function toggleComparisonYear(year, isChecked) {
    if (isChecked) {
        // Fetch data for this year
        await fetchYearData(year);
    } else {
        // Remove from comparison
        delete comparisonYearsData[year];
    }
    updateTrendChart();
}

async function fetchYearData(year) {
    if (!currentVendorId) return;

    try {
        var res = await fetch('/api/benchmark/my-hospital?vendor_id=' + currentVendorId + '&fiscal_year=' + year);
        var result = await res.json();

        if (result.success && result.monthly_trend) {
            comparisonYearsData[year] = result.monthly_trend;
        }
    } catch (e) {
        console.error('Error fetching year data for ' + year + ':', e);
    }
}

function updateSummaryCards(summary) {
    if (!summary) return;

    // Total Revenue
    document.getElementById('total-revenue').textContent = formatMoney(summary.total_amount);

    // Growth badge
    var growthBadge = document.getElementById('growth-badge');
    var growth = summary.growth_yoy || 0;
    growthBadge.textContent = '';

    var growthSpan = document.createElement('span');
    if (growth > 0) {
        growthSpan.className = 'text-green-600';
        growthSpan.textContent = '\u25B2 ' + growth.toFixed(1) + '% YoY';
    } else if (growth < 0) {
        growthSpan.className = 'text-red-600';
        growthSpan.textContent = '\u25BC ' + Math.abs(growth).toFixed(1) + '% YoY';
    } else {
        growthSpan.className = 'text-gray-500';
        growthSpan.textContent = '- 0% YoY';
    }
    growthBadge.appendChild(growthSpan);

    // Wait Amount
    document.getElementById('wait-amount').textContent = formatMoney(summary.wait_amount);
    document.getElementById('wait-ratio').textContent = (summary.wait_ratio || 0).toFixed(1) + '% ของยอดรวม';

    // Debt Amount
    document.getElementById('debt-amount').textContent = formatMoney(summary.debt_amount);
    document.getElementById('debt-ratio').textContent = (summary.debt_ratio || 0).toFixed(1) + '% ของยอดรวม';
}

function updateRiskAssessment(riskScore) {
    if (!riskScore) return;

    var score = Math.min(100, Math.max(0, riskScore.score || 0));
    var level = riskScore.level || 'medium';

    document.getElementById('risk-score').textContent = score.toFixed(0) + '/100';

    var levelBadge = document.getElementById('risk-level-badge');
    var iconBg = document.getElementById('risk-icon-bg');
    var icon = document.getElementById('risk-icon');

    levelBadge.textContent = '';
    var badge = document.createElement('span');

    if (level === 'low') {
        badge.className = 'text-green-600 bg-green-100 px-2 py-0.5 rounded';
        badge.textContent = 'ความเสี่ยงต่ำ';
        iconBg.className = 'w-12 h-12 bg-green-100 rounded-full flex items-center justify-center';
        icon.className = 'w-6 h-6 text-green-600';
    } else if (level === 'medium') {
        badge.className = 'text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded';
        badge.textContent = 'ความเสี่ยงปานกลาง';
        iconBg.className = 'w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center';
        icon.className = 'w-6 h-6 text-yellow-600';
    } else {
        badge.className = 'text-red-600 bg-red-100 px-2 py-0.5 rounded';
        badge.textContent = 'ความเสี่ยงสูง';
        iconBg.className = 'w-12 h-12 bg-red-100 rounded-full flex items-center justify-center';
        icon.className = 'w-6 h-6 text-red-600';
    }
    levelBadge.appendChild(badge);

    // Update indicators
    var indicatorsDiv = document.getElementById('risk-indicators');
    indicatorsDiv.textContent = '';

    if (riskScore.indicators) {
        riskScore.indicators.forEach(function(ind) {
            var div = document.createElement('div');
            div.className = 'p-4 rounded-lg ' + (ind.status === 'pass' ? 'bg-green-50' : 'bg-red-50');

            var nameSpan = document.createElement('div');
            nameSpan.className = 'text-sm text-gray-600 mb-1';
            nameSpan.textContent = ind.name;
            div.appendChild(nameSpan);

            var valueDiv = document.createElement('div');
            valueDiv.className = 'flex items-center justify-between';

            var valueSpan = document.createElement('span');
            valueSpan.className = 'text-xl font-bold ' + (ind.status === 'pass' ? 'text-green-700' : 'text-red-700');
            valueSpan.textContent = (ind.value || 0).toFixed(1) + '%';
            valueDiv.appendChild(valueSpan);

            var thresholdSpan = document.createElement('span');
            thresholdSpan.className = 'text-xs text-gray-500';
            thresholdSpan.textContent = 'เกณฑ์: ' + (ind.threshold || 0) + '%';
            valueDiv.appendChild(thresholdSpan);

            div.appendChild(valueDiv);

            var statusDiv = document.createElement('div');
            statusDiv.className = 'text-xs mt-2 flex items-center gap-1';
            if (ind.status === 'pass') {
                statusDiv.className += ' text-green-600';
                statusDiv.innerHTML = '<span>✓</span> ผ่านเกณฑ์';
            } else {
                statusDiv.className += ' text-red-600';
                statusDiv.innerHTML = '<span>✗</span> เกินเกณฑ์';
            }
            div.appendChild(statusDiv);

            indicatorsDiv.appendChild(div);
        });
    }
}

function updateFundBreakdown(fundBreakdown) {
    var tbody = document.getElementById('fund-breakdown-tbody');
    tbody.textContent = '';

    if (!fundBreakdown || fundBreakdown.length === 0) {
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'px-6 py-4 text-center text-gray-500';
        td.textContent = 'ไม่มีข้อมูล';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    fundBreakdown.forEach(function(fund) {
        var tr = document.createElement('tr');

        // Fund name
        var tdName = document.createElement('td');
        tdName.className = 'px-6 py-4 whitespace-nowrap';

        var fundNameDiv = document.createElement('div');
        fundNameDiv.className = 'font-medium text-gray-800';
        fundNameDiv.textContent = fund.fund_name;
        tdName.appendChild(fundNameDiv);

        var fundGroupDiv = document.createElement('div');
        fundGroupDiv.className = 'text-xs text-gray-500';
        fundGroupDiv.textContent = fund.fund_group_desc || '';
        tdName.appendChild(fundGroupDiv);

        tr.appendChild(tdName);

        // Amount
        var tdAmount = document.createElement('td');
        tdAmount.className = 'px-6 py-4 whitespace-nowrap text-right font-medium text-gray-900';
        tdAmount.textContent = formatMoney(fund.amount);
        tr.appendChild(tdAmount);

        // Percentage
        var tdPct = document.createElement('td');
        tdPct.className = 'px-6 py-4 whitespace-nowrap text-right text-gray-600';
        tdPct.textContent = (fund.percentage || 0).toFixed(1) + '%';
        tr.appendChild(tdPct);

        tbody.appendChild(tr);
    });
}

async function updateTrendChart() {
    if (!currentHospitalData || !currentHospitalData.monthly_trend) return;

    var ctx = document.getElementById('trend-chart').getContext('2d');
    var metric = document.getElementById('trend-metric').value;
    var currentYear = document.getElementById('fiscal-year').value;

    // Destroy existing chart
    if (trendChart) {
        trendChart.destroy();
    }

    // Fiscal year months (Oct-Sep)
    var fiscalMonthOrder = ['10', '11', '12', '01', '02', '03', '04', '05', '06', '07', '08', '09'];
    var monthNames = {
        '01': 'ม.ค.', '02': 'ก.พ.', '03': 'มี.ค.', '04': 'เม.ย.',
        '05': 'พ.ค.', '06': 'มิ.ย.', '07': 'ก.ค.', '08': 'ส.ค.',
        '09': 'ก.ย.', '10': 'ต.ค.', '11': 'พ.ย.', '12': 'ธ.ค.'
    };

    // Labels are fiscal month names
    var labels = fiscalMonthOrder.map(function(m) { return monthNames[m]; });

    // Helper to get value for a month
    function getMonthValue(monthlyData, monthNum, metric) {
        if (!monthlyData) return null;
        var found = monthlyData.find(function(m) {
            var parts = m.month.split('-');
            return parts[1] === monthNum;
        });
        return found ? (found[metric] || 0) : null;
    }

    // Current year dataset
    var currentYearData = fiscalMonthOrder.map(function(m) {
        return getMonthValue(currentHospitalData.monthly_trend, m, metric);
    });

    var datasets = [{
        label: 'ปีงบ ' + currentYear,
        data: currentYearData,
        borderColor: yearColors[0].border,
        backgroundColor: yearColors[0].bg,
        borderWidth: 3,
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
    }];

    // Add comparison years
    var colorIndex = 1;
    var sortedYears = Object.keys(comparisonYearsData).sort(function(a, b) { return b - a; });

    sortedYears.forEach(function(year) {
        var yearData = fiscalMonthOrder.map(function(m) {
            return getMonthValue(comparisonYearsData[year], m, metric);
        });

        var color = yearColors[colorIndex % yearColors.length];
        datasets.push({
            label: 'ปีงบ ' + year,
            data: yearData,
            borderColor: color.border,
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            tension: 0.3,
            fill: false,
            pointRadius: 3,
            pointHoverRadius: 5
        });
        colorIndex++;
    });

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var value = context.parsed.y;
                            if (value === null) return context.dataset.label + ': ไม่มีข้อมูล';
                            return context.dataset.label + ': ' + formatMoneyShort(value);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatMoneyShort(value);
                        }
                    }
                }
            }
        }
    });

    // Update year legend
    updateYearLegend(currentYear, sortedYears);
}

function updateYearLegend(currentYear, comparisonYears) {
    var legendDiv = document.getElementById('year-legend');
    legendDiv.textContent = '';

    // Current year
    var currentSpan = document.createElement('span');
    currentSpan.className = 'flex items-center gap-2';
    currentSpan.innerHTML = '<span class="w-4 h-1 rounded" style="background-color: ' + yearColors[0].border + '"></span>' +
                           '<span>ปีงบ ' + currentYear + ' (ปัจจุบัน)</span>';
    legendDiv.appendChild(currentSpan);

    // Comparison years
    comparisonYears.forEach(function(year, index) {
        var color = yearColors[(index + 1) % yearColors.length];
        var span = document.createElement('span');
        span.className = 'flex items-center gap-2';
        span.innerHTML = '<span class="w-4 h-1 rounded border-dashed border-2" style="border-color: ' + color.border + '"></span>' +
                        '<span>ปีงบ ' + year + '</span>';
        legendDiv.appendChild(span);
    });
}

// Search functions
function searchHospitals() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doSearch, 300);
}

async function doSearch() {
    var query = document.getElementById('search-hospital').value.trim();
    var resultsDiv = document.getElementById('search-results');

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    try {
        var response = await fetch('/api/health-offices?search=' + encodeURIComponent(query) + '&per_page=15');
        var result = await response.json();

        resultsDiv.textContent = '';

        if (result.success && result.data.length > 0) {
            result.data.forEach(function(h) {
                var div = document.createElement('div');
                div.className = 'px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100';
                div.onclick = function() { selectHospital(h); };

                var nameDiv = document.createElement('div');
                nameDiv.className = 'font-medium text-gray-800';
                nameDiv.textContent = h.name;
                div.appendChild(nameDiv);

                var infoDiv = document.createElement('div');
                infoDiv.className = 'text-sm text-gray-500 flex gap-2';

                if (h.hcode5) {
                    var codeSpan = document.createElement('span');
                    codeSpan.className = 'bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs';
                    codeSpan.textContent = h.hcode5;
                    infoDiv.appendChild(codeSpan);
                }

                var levelSpan = document.createElement('span');
                levelSpan.textContent = h.hospital_level || '';
                infoDiv.appendChild(levelSpan);

                var provSpan = document.createElement('span');
                provSpan.textContent = h.province || '';
                infoDiv.appendChild(provSpan);

                div.appendChild(infoDiv);
                resultsDiv.appendChild(div);
            });
            resultsDiv.classList.remove('hidden');
        } else {
            var noResult = document.createElement('div');
            noResult.className = 'px-4 py-3 text-gray-500';
            noResult.textContent = 'ไม่พบข้อมูล';
            resultsDiv.appendChild(noResult);
            resultsDiv.classList.remove('hidden');
        }
    } catch (e) {
        console.error('Search error:', e);
    }
}

function selectHospital(h) {
    document.getElementById('search-hospital').value = h.name;
    document.getElementById('search-results').classList.add('hidden');

    if (h.hcode5) {
        currentVendorId = h.hcode5;
        localStorage.setItem('my_hospital_vendor', h.hcode5);
        localStorage.setItem('my_hospital_name', h.name);
        loadMyHospital();
    } else {
        showToast('โรงพยาบาลนี้ไม่มีรหัส 5 หลัก', 'warning');
    }
}

// Fetch SMT Data
async function fetchSMTData() {
    if (!currentVendorId) {
        showToast('กรุณาเลือกโรงพยาบาลก่อน', 'warning');
        return;
    }

    var fiscalYear = document.getElementById('fiscal-year').value;

    showToast('กำลังดึงข้อมูล SMT...', 'info');

    try {
        var response = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                vendor_id: currentVendorId,
                budget_year: fiscalYear,
                save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('ดึงข้อมูลสำเร็จ! ' + result.records + ' records', 'success');
            loadMyHospital();
        } else {
            showToast(result.error || 'Failed to fetch data', 'error');
        }
    } catch (e) {
        console.error('Fetch error:', e);
        showToast('Error: ' + e.message, 'error');
    }
}

// Comparison functions
function toggleComparison() {
    var content = document.getElementById('comparison-content');
    var chevron = document.getElementById('comparison-chevron');

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

function searchCompareHospitals() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doCompareSearch, 300);
}

async function doCompareSearch() {
    var query = document.getElementById('compare-search').value.trim();
    var resultsDiv = document.getElementById('compare-search-results');

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    try {
        var response = await fetch('/api/health-offices?search=' + encodeURIComponent(query) + '&per_page=10');
        var result = await response.json();

        resultsDiv.textContent = '';

        if (result.success && result.data.length > 0) {
            result.data.forEach(function(h) {
                if (!h.hcode5 || h.hcode5 === currentVendorId) return;

                var div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 text-sm';
                div.onclick = function() { addComparisonHospital(h); };

                var nameDiv = document.createElement('div');
                nameDiv.className = 'font-medium';
                nameDiv.textContent = h.name;
                div.appendChild(nameDiv);

                var infoDiv = document.createElement('div');
                infoDiv.className = 'text-xs text-gray-500';
                infoDiv.textContent = h.hcode5 + ' | ' + (h.province || '');
                div.appendChild(infoDiv);

                resultsDiv.appendChild(div);
            });
            resultsDiv.classList.remove('hidden');
        } else {
            var noResult = document.createElement('div');
            noResult.className = 'px-4 py-2 text-gray-500 text-sm';
            noResult.textContent = 'ไม่พบข้อมูล';
            resultsDiv.appendChild(noResult);
            resultsDiv.classList.remove('hidden');
        }
    } catch (e) {
        console.error('Search error:', e);
    }
}

async function addComparisonHospital(h) {
    document.getElementById('compare-search').value = '';
    document.getElementById('compare-search-results').classList.add('hidden');

    // Check if already added
    if (comparisonHospitals.find(function(c) { return c.vendor_id === h.hcode5; })) {
        showToast('โรงพยาบาลนี้ถูกเพิ่มแล้ว', 'warning');
        return;
    }

    showToast('กำลังดึงข้อมูล ' + h.name + '...', 'info');

    var fiscalYear = document.getElementById('fiscal-year').value;

    try {
        var response = await fetch('/api/benchmark/my-hospital?vendor_id=' + h.hcode5 + '&fiscal_year=' + fiscalYear);
        var result = await response.json();

        if (result.success) {
            comparisonHospitals.push({
                vendor_id: h.hcode5,
                name: h.name,
                data: result
            });
            updateComparisonUI();
            showToast('เพิ่ม ' + h.name + ' สำเร็จ', 'success');
        } else {
            showToast('ไม่พบข้อมูล SMT สำหรับ ' + h.name, 'warning');
        }
    } catch (e) {
        console.error('Error:', e);
        showToast('Error: ' + e.message, 'error');
    }
}

function removeComparisonHospital(vendorId) {
    comparisonHospitals = comparisonHospitals.filter(function(c) { return c.vendor_id !== vendorId; });
    updateComparisonUI();
}

function updateComparisonUI() {
    var listDiv = document.getElementById('comparison-list');
    var tableWrapper = document.getElementById('comparison-table-wrapper');
    var tbody = document.getElementById('comparison-tbody');

    listDiv.textContent = '';
    tbody.textContent = '';

    if (comparisonHospitals.length === 0) {
        var msg = document.createElement('p');
        msg.className = 'text-sm text-gray-500 text-center py-4';
        msg.textContent = 'ยังไม่ได้เลือกโรงพยาบาลเปรียบเทียบ';
        listDiv.appendChild(msg);
        tableWrapper.classList.add('hidden');
        return;
    }

    tableWrapper.classList.remove('hidden');

    // Add my hospital first
    if (currentHospitalData) {
        addComparisonTableRow(tbody, {
            vendor_id: currentVendorId,
            name: currentHospitalData.hospital.name,
            data: currentHospitalData
        }, true);
    }

    // Add comparison hospitals
    comparisonHospitals.forEach(function(h) {
        addComparisonTableRow(tbody, h, false);
    });
}

function addComparisonTableRow(tbody, hospital, isMyHospital) {
    var tr = document.createElement('tr');
    tr.className = isMyHospital ? 'bg-blue-50' : '';

    var summary = hospital.data.summary || {};

    // Name
    var tdName = document.createElement('td');
    tdName.className = 'px-4 py-3 whitespace-nowrap';

    var nameDiv = document.createElement('div');
    nameDiv.className = 'font-medium text-gray-800';
    nameDiv.textContent = hospital.name;
    tdName.appendChild(nameDiv);

    if (isMyHospital) {
        var badge = document.createElement('span');
        badge.className = 'text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded';
        badge.textContent = 'รพ. ของฉัน';
        tdName.appendChild(badge);
    }
    tr.appendChild(tdName);

    // Total
    var tdTotal = document.createElement('td');
    tdTotal.className = 'px-4 py-3 text-right font-medium';
    tdTotal.textContent = formatMoney(summary.total_amount);
    tr.appendChild(tdTotal);

    // Wait %
    var tdWait = document.createElement('td');
    tdWait.className = 'px-4 py-3 text-right text-orange-600';
    tdWait.textContent = (summary.wait_ratio || 0).toFixed(1) + '%';
    tr.appendChild(tdWait);

    // Debt %
    var tdDebt = document.createElement('td');
    tdDebt.className = 'px-4 py-3 text-right text-red-600';
    tdDebt.textContent = (summary.debt_ratio || 0).toFixed(1) + '%';
    tr.appendChild(tdDebt);

    // Growth
    var tdGrowth = document.createElement('td');
    tdGrowth.className = 'px-4 py-3 text-right';
    var growth = summary.growth_yoy || 0;
    var growthSpan = document.createElement('span');
    if (growth >= 0) {
        growthSpan.className = 'text-green-600';
        growthSpan.textContent = '+' + growth.toFixed(1) + '%';
    } else {
        growthSpan.className = 'text-red-600';
        growthSpan.textContent = growth.toFixed(1) + '%';
    }
    tdGrowth.appendChild(growthSpan);
    tr.appendChild(tdGrowth);

    // Actions
    var tdActions = document.createElement('td');
    tdActions.className = 'px-4 py-3 text-center';
    if (!isMyHospital) {
        var btn = document.createElement('button');
        btn.className = 'text-red-500 hover:text-red-700';
        btn.textContent = '\u2715';
        btn.onclick = function() { removeComparisonHospital(hospital.vendor_id); };
        tdActions.appendChild(btn);
    }
    tr.appendChild(tdActions);

    tbody.appendChild(tr);
}

// Quick add functions
function addSameProvince() {
    if (!currentHospitalData || !currentHospitalData.hospital) return;
    showToast('กำลังพัฒนา...', 'info');
}

function addSameRegion() {
    if (!currentHospitalData || !currentHospitalData.hospital) return;
    showToast('กำลังพัฒนา...', 'info');
}

function addSameLevel() {
    if (!currentHospitalData || !currentHospitalData.hospital) return;
    showToast('กำลังพัฒนา...', 'info');
}

// Utility functions
function formatMoney(amount) {
    if (!amount) return '0 บาท';
    if (amount >= 1000000000) {
        return (amount / 1000000000).toFixed(2) + ' พันล้าน';
    } else if (amount >= 1000000) {
        return (amount / 1000000).toFixed(2) + ' ล้าน';
    }
    return amount.toLocaleString() + ' บาท';
}

function formatMoneyShort(amount) {
    if (!amount) return '0';
    if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'M';
    }
    return amount.toLocaleString();
}

function showToast(message, type) {
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}
