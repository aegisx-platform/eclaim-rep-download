{% extends "base.html" %}

{% block title %}My Hospital Analytics - NHSO Revenue Intelligence{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Page Header with Hospital Selector -->
    <div class="bg-white rounded-xl shadow-md p-6">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">My Hospital Analytics</h1>
                <p class="text-gray-600 mt-1">‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT Budget ‡∏Ç‡∏≠‡∏á‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</p>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <!-- Hospital Selector -->
                <div class="flex-1 min-w-64">
                    <label class="block text-sm font-medium text-gray-700 mb-1">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</label>
                    <div class="relative">
                        <input type="text" id="search-hospital" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏´‡∏±‡∏™‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•..."
                               onkeyup="searchHospitals()"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <div id="search-results" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-64 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Selected Hospital Info -->
        <div id="selected-hospital" class="hidden mt-4 p-4 bg-blue-50 rounded-lg">
            <div class="flex items-center gap-3">
                <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path>
                </svg>
                <div>
                    <div class="font-semibold text-lg text-gray-800" id="hospital-name">-</div>
                    <div class="text-sm text-gray-600 flex flex-wrap gap-3">
                        <span id="hospital-code" class="bg-blue-100 text-blue-800 px-2 py-0.5 rounded">-</span>
                        <span id="hospital-level">-</span>
                        <span id="hospital-province">-</span>
                        <span id="hospital-region">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Year Selector with Data Status -->
        <div id="year-selector-section" class="hidden mt-4">
            <div class="border border-gray-200 rounded-lg p-4 bg-gray-50">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="text-sm font-medium text-gray-700 flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                        </svg>
                        ‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏µ)
                    </h3>
                    <span class="text-xs text-gray-500">üü¢ ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• | üî¥ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>
                </div>
                <div id="year-checkboxes-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-5 gap-2">
                    <!-- Year checkboxes populated by JS -->
                </div>
                <div class="mt-3 pt-3 border-t border-gray-200 flex items-center justify-between">
                    <p class="text-xs text-gray-500">
                        <span id="selected-years-count">0</span>/5 ‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å |
                        <span id="total-records-count">0</span> records
                    </p>
                    <button onclick="loadSelectedYears()" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium flex items-center gap-1">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                        </svg>
                        ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div id="loading-state" class="hidden">
        <div class="flex justify-center items-center py-12">
            <svg class="animate-spin h-10 w-10 text-blue-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="ml-3 text-gray-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>
        </div>
    </div>

    <!-- No Data State -->
    <div id="no-data-state" class="hidden">
        <div class="bg-white rounded-xl shadow-md p-12 text-center">
            <svg class="w-16 h-16 mx-auto mb-4 text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
            </svg>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT Budget</h3>
            <p class="text-gray-500 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÅ‡∏•‡∏∞ Fetch ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å SMT ‡∏™‡∏õ‡∏™‡∏ä.</p>
            <button onclick="fetchSMTData()" class="px-6 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium">
                <svg class="w-5 h-5 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                </svg>
                Fetch SMT Data
            </button>
        </div>
    </div>

    <!-- Main Analytics Content -->
    <div id="analytics-content" class="hidden space-y-6">
        <!-- Summary Cards Header with Year Selector Pills -->
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex items-center gap-3">
                <h3 class="text-lg font-semibold text-gray-700">‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏µ‡∏á‡∏ö</h3>
                <!-- Year Pills - Click to switch primary year -->
                <div id="year-pills-container" class="flex flex-wrap gap-2">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div id="yoy-compare-label" class="text-sm text-gray-500 hidden">
                ‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡∏õ‡∏µ <span id="compare-year-display" class="font-medium">-</span>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total Revenue -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</p>
                        <p class="text-2xl font-bold text-gray-800" id="total-revenue">-</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="growth-badge" class="text-xs">-</span>
                        </div>
                        <p id="total-revenue-prev" class="text-xs text-gray-400 mt-1 hidden">vs -</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Wait Amount -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</p>
                        <p class="text-2xl font-bold text-orange-600" id="wait-amount">-</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="wait-ratio" class="text-xs text-gray-500">-</span>
                            <span id="wait-yoy" class="text-xs hidden">-</span>
                        </div>
                        <p id="wait-amount-prev" class="text-xs text-gray-400 mt-1 hidden">vs -</p>
                    </div>
                    <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Debt Amount -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</p>
                        <p class="text-2xl font-bold text-red-600" id="debt-amount">-</p>
                        <div class="flex items-center gap-2 mt-1">
                            <span id="debt-ratio" class="text-xs text-gray-500">-</span>
                            <span id="debt-yoy" class="text-xs hidden">-</span>
                        </div>
                        <p id="debt-amount-prev" class="text-xs text-gray-400 mt-1 hidden">vs -</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Risk Score -->
            <div class="bg-white rounded-xl shadow-md p-6">
                <div class="flex items-center justify-between">
                    <div class="flex-1">
                        <p class="text-sm text-gray-500">Risk Score</p>
                        <p class="text-2xl font-bold" id="risk-score">-</p>
                        <p class="text-xs mt-1" id="risk-level-badge">-</p>
                        <p id="risk-score-prev" class="text-xs text-gray-400 mt-1 hidden">vs -</p>
                    </div>
                    <div class="w-12 h-12 rounded-full flex items-center justify-center" id="risk-icon-bg">
                        <svg class="w-6 h-6" id="risk-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"></path>
                        </svg>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi-Year Comparison Table (shows when multiple years selected) -->
        <div id="multi-year-comparison" class="hidden bg-white rounded-xl shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-purple-50">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏ú‡∏•‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏´‡∏•‡∏≤‡∏¢‡∏õ‡∏µ
                    </h3>
                    <span id="comparison-years-badge" class="text-sm text-indigo-600 bg-indigo-100 px-3 py-1 rounded-full">
                        0 ‡∏õ‡∏µ
                    </span>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</th>
                            <!-- Year columns populated by JS -->
                        </tr>
                    </thead>
                    <tbody id="comparison-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Rows populated by JS -->
                    </tbody>
                </table>
            </div>

            <!-- Multi-Year Chart Section -->
            <div class="p-6 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-4">
                    <h4 class="text-md font-medium text-gray-700 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                        </svg>
                        ‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏£‡∏≤‡∏¢‡∏õ‡∏µ
                    </h4>
                    <div class="flex items-center gap-2 bg-gray-100 rounded-lg p-1">
                        <button id="chart-type-grouped" onclick="switchYearChartType('grouped')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white text-indigo-600 shadow-sm">
                            Grouped Bar
                        </button>
                        <button id="chart-type-mixed" onclick="switchYearChartType('mixed')" class="px-3 py-1.5 text-sm font-medium rounded-md transition-all text-gray-500 hover:text-gray-700">
                            Bar + Line
                        </button>
                    </div>
                </div>
                <div class="relative" style="height: 350px;">
                    <canvas id="multi-year-chart"></canvas>
                </div>
            </div>
        </div>

        <!-- Risk Assessment -->
        <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-gray-800 mb-4 flex items-center">
                <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
                Risk Indicators
            </h3>
            <div id="risk-indicators" class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Populated by JS -->
            </div>
        </div>

        <!-- Fund Breakdown -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-green-50 to-teal-50">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path>
                    </svg>
                    ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô
                </h3>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏Å‡∏≠‡∏á‡∏ó‡∏∏‡∏ô</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô</th>
                        </tr>
                    </thead>
                    <tbody id="fund-breakdown-tbody" class="bg-white divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Monthly Trend Chart with Year Comparison -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-purple-50 to-pink-50">
                <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
                    <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                        <svg class="w-5 h-5 mr-2 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path>
                        </svg>
                        ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
                    </h3>
                    <div class="flex flex-wrap items-center gap-4">
                        <!-- Metric Selector -->
                        <select id="trend-metric" onchange="updateTrendChartWithAllYears()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg">
                            <option value="total_amount">‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°</option>
                            <option value="wait_amount">‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢</option>
                            <option value="debt_amount">‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô</option>
                        </select>
                        <!-- Auto Year Info -->
                        <div id="chart-years-info" class="flex items-center gap-2 text-sm text-gray-500">
                            <svg class="w-4 h-4 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            ‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
                        </div>
                        <!-- Hidden container for backward compatibility -->
                        <div id="year-checkboxes" class="hidden"></div>
                    </div>
                </div>
            </div>
            <div class="p-6">
                <div class="relative" style="height: 350px;">
                    <canvas id="trend-chart"></canvas>
                </div>
                <!-- Year Legend -->
                <div id="year-legend" class="mt-4 flex flex-wrap justify-center gap-4 text-sm">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Comparison Section (Collapsible) -->
        <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <button onclick="toggleComparison()" class="w-full px-6 py-4 border-b border-gray-200 bg-gradient-to-r from-indigo-50 to-blue-50 flex justify-between items-center hover:bg-indigo-100 transition-colors">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                    </svg>
                    ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Å‡∏±‡∏ö‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏≠‡∏∑‡πà‡∏ô (Optional)
                </h3>
                <svg id="comparison-chevron" class="w-5 h-5 text-gray-500 transform transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                </svg>
            </button>
            <div id="comparison-content" class="hidden p-6">
                <!-- Info about fetching -->
                <div class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏£‡∏û. ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Å‡∏î‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡πÑ‡∏î‡πâ
                </div>

                <!-- Search and Add Hospital -->
                <div class="flex gap-3 mb-4">
                    <div class="flex-1 relative">
                        <input type="text" id="compare-search" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö..."
                               onkeyup="searchCompareHospitals()"
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        <div id="compare-search-results" class="absolute z-20 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 max-h-80 overflow-y-auto hidden">
                        </div>
                    </div>
                </div>

                <!-- Pending Hospital Cards (when fetching) -->
                <div id="pending-hospitals-container" class="space-y-2 mb-4"></div>

                <!-- Comparison Table -->
                <div id="comparison-table-wrapper" class="hidden">
                    <!-- Year Selector for Comparison -->
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-sm font-medium text-gray-700">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h4>
                        <div class="flex items-center gap-2">
                            <span class="text-sm text-gray-500">‡∏õ‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì:</span>
                            <select id="comparison-year" onchange="updateComparisonTable()" class="px-3 py-1.5 text-sm border border-gray-300 rounded-lg">
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Wait %</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Debt %</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Growth YoY</th>
                                    <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-tbody" class="bg-white divide-y divide-gray-200">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Source Note -->
    <div class="text-sm text-gray-500 text-center">
        <p>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å <a href="https://smt.nhso.go.th" target="_blank" class="text-blue-600 hover:underline">SMT ‡∏™‡∏õ‡∏™‡∏ä.</a> | ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏ñ‡∏≤‡∏ô‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏à‡∏≤‡∏Å <a href="https://hcode.moph.go.th" target="_blank" class="text-blue-600 hover:underline">hcode.moph.go.th</a></p>
    </div>
</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
// State
let currentVendorId = null;
let currentHospitalData = null;
let currentHospitalInfo = null;
let trendChart = null;
let multiYearChart = null;
let currentYearChartType = 'grouped';
let searchTimeout = null;
let comparisonHospitals = [];
let hospitalYearsData = []; // { year, has_data, records, total_amount }
let selectedYears = []; // Years selected by user
let yearsDataCache = {}; // { year: apiResponse }
let primaryYear = null; // Currently displayed year in summary

// Chart colors for year comparison
const yearColors = [
    { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.1)' },      // Blue
    { border: 'rgb(34, 197, 94)', bg: 'rgba(34, 197, 94, 0.1)' },        // Green
    { border: 'rgb(249, 115, 22)', bg: 'rgba(249, 115, 22, 0.1)' },      // Orange
    { border: 'rgb(168, 85, 247)', bg: 'rgba(168, 85, 247, 0.1)' },      // Purple
    { border: 'rgb(236, 72, 153)', bg: 'rgba(236, 72, 153, 0.1)' },      // Pink
    { border: 'rgb(20, 184, 166)', bg: 'rgba(20, 184, 166, 0.1)' }       // Teal
];

// Initialize
document.addEventListener('DOMContentLoaded', async function() {
    loadDefaultHospital();

    // Close search results when clicking outside
    document.addEventListener('click', function(e) {
        ['search-results', 'compare-search-results'].forEach(function(id) {
            var el = document.getElementById(id);
            if (el && !el.contains(e.target)) {
                el.classList.add('hidden');
            }
        });
    });
});

async function loadDefaultHospital() {
    try {
        // Priority 1: Check localStorage for user's last selected hospital
        var savedVendor = localStorage.getItem('my_hospital_vendor');
        var savedName = localStorage.getItem('my_hospital_name');

        if (savedVendor) {
            currentVendorId = savedVendor;
            if (savedName) {
                document.getElementById('search-hospital').value = savedName;
            }
            await loadHospitalYears();
            return;
        }

        // Priority 2: Get default from SMT settings
        var response = await fetch('/api/smt/settings');
        var result = await response.json();

        if (result.success && result.settings && result.settings.smt_vendor_id) {
            currentVendorId = result.settings.smt_vendor_id;
            await loadHospitalYears();
        } else {
            showNoDataState();
        }
    } catch (e) {
        console.error('Error loading default hospital:', e);
        showNoDataState();
    }
}

// Load available years for the selected hospital
async function loadHospitalYears() {
    if (!currentVendorId) {
        showNoDataState();
        return;
    }

    try {
        var response = await fetch('/api/benchmark/hospital-years?vendor_id=' + currentVendorId);
        var result = await response.json();

        if (result.success && result.years) {
            hospitalYearsData = result.years;
            renderYearCheckboxes();

            // Try to restore previous selection from localStorage
            var hasRestoredSelection = loadSelectedYearsFromStorage();

            if (hasRestoredSelection) {
                // Use restored selection
                updateYearCheckboxStates();
                await loadSelectedYears();
            } else {
                // Auto-select the most recent year with data
                var yearsWithData = hospitalYearsData.filter(function(y) { return y.has_data; });
                if (yearsWithData.length > 0) {
                    selectedYears = [yearsWithData[0].year];
                    updateYearCheckboxStates();
                    await loadSelectedYears();
                } else {
                    // No data at all - show year selector but no analytics
                    document.getElementById('year-selector-section').classList.remove('hidden');
                    showNoDataState();
                }
            }
        } else {
            showNoDataState();
        }
    } catch (e) {
        console.error('Error loading hospital years:', e);
        showNoDataState();
    }
}

// Render year checkboxes with data status
function renderYearCheckboxes() {
    var container = document.getElementById('year-checkboxes-container');
    container.innerHTML = '';

    hospitalYearsData.forEach(function(yearInfo) {
        var div = document.createElement('div');
        div.className = 'flex items-center gap-2 p-2 rounded-lg border ' +
            (yearInfo.has_data ? 'border-green-200 bg-green-50' : 'border-gray-200 bg-white');

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'year-cb-' + yearInfo.year;
        checkbox.value = yearInfo.year;
        checkbox.className = 'rounded text-blue-600 focus:ring-blue-500';
        checkbox.disabled = !yearInfo.has_data;
        checkbox.onchange = function() { toggleYearSelection(yearInfo.year, this.checked); };

        var label = document.createElement('label');
        label.htmlFor = 'year-cb-' + yearInfo.year;
        label.className = 'flex-1 cursor-pointer';

        var yearSpan = document.createElement('span');
        yearSpan.className = 'font-medium ' + (yearInfo.has_data ? 'text-gray-800' : 'text-gray-400');
        yearSpan.textContent = (yearInfo.has_data ? 'üü¢ ' : 'üî¥ ') + yearInfo.year;
        label.appendChild(yearSpan);

        if (yearInfo.has_data) {
            var recordsSpan = document.createElement('span');
            recordsSpan.className = 'block text-xs text-gray-500';
            recordsSpan.textContent = yearInfo.records.toLocaleString() + ' records';
            label.appendChild(recordsSpan);
        }

        div.appendChild(checkbox);
        div.appendChild(label);

        // Add fetch button if no data
        if (!yearInfo.has_data) {
            var fetchBtn = document.createElement('button');
            fetchBtn.className = 'px-2 py-1 text-xs bg-green-600 hover:bg-green-700 text-white rounded';
            fetchBtn.textContent = '+ ‡∏î‡∏∂‡∏á';
            fetchBtn.onclick = function(e) {
                e.preventDefault();
                fetchYearSMTData(yearInfo.year);
            };
            div.appendChild(fetchBtn);
        }

        container.appendChild(div);
    });

    // Show year selector section
    document.getElementById('year-selector-section').classList.remove('hidden');
    document.getElementById('selected-hospital').classList.remove('hidden');
    updateSelectedYearsCount();
}

const MAX_SELECTED_YEARS = 5;

function toggleYearSelection(year, isSelected) {
    if (isSelected) {
        // Check max limit
        if (selectedYears.length >= MAX_SELECTED_YEARS) {
            showToast('‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ' + MAX_SELECTED_YEARS + ' ‡∏õ‡∏µ', 'warning');
            // Uncheck the checkbox
            var cb = document.getElementById('year-cb-' + year);
            if (cb) cb.checked = false;
            return;
        }
        if (!selectedYears.includes(year)) {
            selectedYears.push(year);
        }
    } else {
        selectedYears = selectedYears.filter(function(y) { return y !== year; });
    }
    updateSelectedYearsCount();
}

function updateYearCheckboxStates() {
    hospitalYearsData.forEach(function(yearInfo) {
        var cb = document.getElementById('year-cb-' + yearInfo.year);
        if (cb) {
            cb.checked = selectedYears.includes(yearInfo.year);
        }
    });
    updateSelectedYearsCount();
}

function updateSelectedYearsCount() {
    document.getElementById('selected-years-count').textContent = selectedYears.length;

    var totalRecords = 0;
    selectedYears.forEach(function(year) {
        var yearInfo = hospitalYearsData.find(function(y) { return y.year === year; });
        if (yearInfo) totalRecords += yearInfo.records;
    });
    document.getElementById('total-records-count').textContent = totalRecords.toLocaleString();

    // Save selected years to localStorage
    saveSelectedYearsToStorage();
}

// Save selected years to localStorage
function saveSelectedYearsToStorage() {
    if (currentVendorId) {
        localStorage.setItem('my_hospital_selected_years_' + currentVendorId, JSON.stringify(selectedYears));
    }
}

// Load selected years from localStorage
function loadSelectedYearsFromStorage() {
    if (currentVendorId) {
        var saved = localStorage.getItem('my_hospital_selected_years_' + currentVendorId);
        if (saved) {
            try {
                var years = JSON.parse(saved);
                // Filter to only include years that have data
                selectedYears = years.filter(function(y) {
                    var yearInfo = hospitalYearsData.find(function(info) { return info.year === y; });
                    return yearInfo && yearInfo.has_data;
                });
                return selectedYears.length > 0;
            } catch (e) {
                console.error('Error loading selected years:', e);
            }
        }
    }
    return false;
}

// Fetch SMT data for a specific year
async function fetchYearSMTData(year) {
    if (!currentVendorId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    console.log('fetchYearSMTData: vendor=' + currentVendorId + ', year=' + year);

    var btn = event.target;
    var originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = '...';

    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏õ‡∏µ ' + year + '...', 'info');

    try {
        var response = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                vendor_id: currentVendorId,
                budget_year: year,
                save_db: true
            })
        });
        var result = await response.json();
        console.log('SMT fetch result:', result);

        if (result.success) {
            if (result.records > 0) {
                showToast('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ' + result.records + ' records', 'success');

                // Add this year to selectedYears if not already there
                if (!selectedYears.includes(year)) {
                    selectedYears.push(year);
                }

                // Remember current selected years before refresh
                var previousSelection = selectedYears.slice();

                // Refresh hospital years data
                console.log('Refreshing hospital years UI...');
                await refreshHospitalYearsUI();
                console.log('After refresh, hospitalYearsData:', hospitalYearsData);

                // Restore selection including the new year
                selectedYears = previousSelection;
                updateYearCheckboxStates();

                // Reload data if analytics is visible
                if (!document.getElementById('analytics-content').classList.contains('hidden')) {
                    await loadSelectedYears();
                }
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ' + year, 'warning');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        } else {
            showToast(result.error || 'Failed to fetch data', 'error');
            btn.disabled = false;
            btn.textContent = originalText;
        }
    } catch (e) {
        console.error('Fetch error:', e);
        showToast('Error: ' + e.message, 'error');
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

// Refresh year checkboxes UI without changing selection
async function refreshHospitalYearsUI() {
    if (!currentVendorId) return;

    try {
        var response = await fetch('/api/benchmark/hospital-years?vendor_id=' + currentVendorId);
        var result = await response.json();
        console.log('hospital-years API response:', result);

        if (result.success && result.years) {
            hospitalYearsData = result.years;
            // Log which years have data
            var yearsWithData = hospitalYearsData.filter(function(y) { return y.has_data; }).map(function(y) { return y.year; });
            console.log('Years with data:', yearsWithData);
            renderYearCheckboxes();
        }
    } catch (e) {
        console.error('Error refreshing hospital years:', e);
    }
}

// Load data for selected years
async function loadSelectedYears() {
    if (!currentVendorId || selectedYears.length === 0) {
        showNoDataState();
        return;
    }

    showLoading();

    // Sort years descending
    selectedYears.sort(function(a, b) { return b - a; });

    // Fetch data for each selected year
    yearsDataCache = {};
    for (var i = 0; i < selectedYears.length; i++) {
        var year = selectedYears[i];
        try {
            var response = await fetch('/api/benchmark/my-hospital?vendor_id=' + currentVendorId + '&fiscal_year=' + year);
            var result = await response.json();
            if (result.success) {
                yearsDataCache[year] = result;
                // Set hospital info from first result
                if (!currentHospitalInfo && result.hospital) {
                    currentHospitalInfo = result.hospital;
                    updateHospitalInfo(result.hospital);
                }
            }
        } catch (e) {
            console.error('Error loading year ' + year + ':', e);
        }
    }

    // Use the most recent year as primary display (or keep current if still valid)
    if (!primaryYear || !selectedYears.includes(primaryYear)) {
        primaryYear = selectedYears[0];
    }
    currentHospitalData = yearsDataCache[primaryYear];

    if (currentHospitalData) {
        renderYearPills(); // Render clickable year pills
        updateSummaryCards(currentHospitalData.summary);
        updateSummaryCardsWithYoY(); // Add YoY comparison to summary cards
        updateRiskAssessment(currentHospitalData.risk_score);
        updateFundBreakdown(currentHospitalData.fund_breakdown);
        updateMultiYearComparisonTable(); // Show multi-year comparison table
        populateYearComparisonCheckboxes();
        updateTrendChartWithAllYears(); // Auto-include all selected years
        showAnalytics();
    } else {
        showNoDataState();
    }
}

function showLoading() {
    document.getElementById('loading-state').classList.remove('hidden');
    document.getElementById('no-data-state').classList.add('hidden');
    document.getElementById('analytics-content').classList.add('hidden');
}

function showNoDataState() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('no-data-state').classList.remove('hidden');
    document.getElementById('analytics-content').classList.add('hidden');
}

function showAnalytics() {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('no-data-state').classList.add('hidden');
    document.getElementById('analytics-content').classList.remove('hidden');
}

// Render clickable year pills for switching primary year
function renderYearPills() {
    var container = document.getElementById('year-pills-container');
    if (!container) return;

    container.innerHTML = '';

    // Sort years descending
    var years = selectedYears.slice().sort(function(a, b) { return b - a; });

    years.forEach(function(year) {
        var pill = document.createElement('button');
        pill.className = 'px-3 py-1 rounded-full text-sm font-medium transition-all ';

        if (year === primaryYear) {
            // Active pill
            pill.className += 'bg-blue-600 text-white shadow-md';
        } else {
            // Inactive pill - clickable
            pill.className += 'bg-gray-100 text-gray-600 hover:bg-blue-100 hover:text-blue-700';
        }

        pill.textContent = year;
        pill.onclick = function() { switchPrimaryYear(year); };
        container.appendChild(pill);
    });
}

// Switch the primary year displayed in summary
function switchPrimaryYear(year) {
    if (year === primaryYear) return;
    if (!yearsDataCache[year]) {
        showToast('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ ' + year, 'warning');
        return;
    }

    primaryYear = year;
    currentHospitalData = yearsDataCache[year];

    // Update UI
    renderYearPills();
    updateSummaryCards(currentHospitalData.summary);
    updateSummaryCardsWithYoY();
    updateRiskAssessment(currentHospitalData.risk_score);
    updateFundBreakdown(currentHospitalData.fund_breakdown);

    showToast('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏µ‡∏á‡∏ö ' + year, 'info');
}

function updateHospitalInfo(hospital) {
    if (!hospital) return;

    document.getElementById('hospital-name').textContent = hospital.name || '-';
    document.getElementById('hospital-code').textContent = '‡∏£‡∏´‡∏±‡∏™: ' + (hospital.vendor_no || '').replace(/^0+/, '');
    document.getElementById('hospital-level').textContent = hospital.level ? (hospital.level + ' - ‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏®‡∏π‡∏ô‡∏¢‡πå') : '-';
    document.getElementById('hospital-province').textContent = hospital.province || '-';
    document.getElementById('hospital-region').textContent = hospital.health_region ? ('‡πÄ‡∏Ç‡∏ï‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà ' + hospital.health_region) : '-';

    document.getElementById('selected-hospital').classList.remove('hidden');

    // Save to localStorage
    localStorage.setItem('my_hospital_vendor', currentVendorId);
    localStorage.setItem('my_hospital_name', hospital.name || '');
}

// Populate year comparison checkboxes in the Monthly Trend section
function populateYearComparisonCheckboxes() {
    var container = document.getElementById('year-checkboxes');
    if (!container) return;

    container.innerHTML = '';

    // Get years with data excluding the primary year
    var primaryYear = selectedYears.length > 0 ? selectedYears[0] : null;
    var yearsWithData = hospitalYearsData.filter(function(y) {
        return y.has_data && y.year !== primaryYear;
    });

    if (yearsWithData.length === 0) {
        var span = document.createElement('span');
        span.className = 'text-sm text-gray-400';
        span.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏µ‡∏≠‡∏∑‡πà‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö';
        container.appendChild(span);
        return;
    }

    // Create checkboxes for comparison years
    yearsWithData.forEach(function(yearInfo) {
        var label = document.createElement('label');
        label.className = 'flex items-center gap-1 px-2 py-1 rounded cursor-pointer hover:bg-gray-100 transition-colors';

        var checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'trend-year-' + yearInfo.year;
        checkbox.value = yearInfo.year;
        checkbox.className = 'rounded text-purple-600 focus:ring-purple-500';
        // Pre-check if already in selectedYears (but not primary)
        checkbox.checked = selectedYears.includes(yearInfo.year) && yearInfo.year !== primaryYear;
        checkbox.onchange = function() { toggleTrendYear(yearInfo.year, this.checked); };

        var span = document.createElement('span');
        span.className = 'text-sm text-gray-700';
        span.textContent = yearInfo.year;

        label.appendChild(checkbox);
        label.appendChild(span);
        container.appendChild(label);
    });
}

async function toggleTrendYear(year, isChecked) {
    if (isChecked) {
        // Fetch data for this year if not in cache
        if (!yearsDataCache[year]) {
            try {
                var res = await fetch('/api/benchmark/my-hospital?vendor_id=' + currentVendorId + '&fiscal_year=' + year);
                var result = await res.json();
                if (result.success) {
                    yearsDataCache[year] = result;
                }
            } catch (e) {
                console.error('Error fetching year data for ' + year + ':', e);
            }
        }
    }
    updateTrendChart();
}

function updateSummaryCards(summary) {
    if (!summary) return;

    // Total Revenue
    document.getElementById('total-revenue').textContent = formatMoney(summary.total_amount);

    // Growth badge
    var growthBadge = document.getElementById('growth-badge');
    var growth = summary.growth_yoy || 0;
    growthBadge.textContent = '';

    var growthSpan = document.createElement('span');
    if (growth > 0) {
        growthSpan.className = 'text-green-600';
        growthSpan.textContent = '\u25B2 ' + growth.toFixed(1) + '% YoY';
    } else if (growth < 0) {
        growthSpan.className = 'text-red-600';
        growthSpan.textContent = '\u25BC ' + Math.abs(growth).toFixed(1) + '% YoY';
    } else {
        growthSpan.className = 'text-gray-500';
        growthSpan.textContent = '- 0% YoY';
    }
    growthBadge.appendChild(growthSpan);

    // Wait Amount
    document.getElementById('wait-amount').textContent = formatMoney(summary.wait_amount);
    document.getElementById('wait-ratio').textContent = (summary.wait_ratio || 0).toFixed(1) + '% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°';

    // Debt Amount
    document.getElementById('debt-amount').textContent = formatMoney(summary.debt_amount);
    document.getElementById('debt-ratio').textContent = (summary.debt_ratio || 0).toFixed(1) + '% ‡∏Ç‡∏≠‡∏á‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°';
}

function updateRiskAssessment(riskScore) {
    if (!riskScore) return;

    var score = Math.min(100, Math.max(0, riskScore.score || 0));
    var level = riskScore.level || 'medium';

    document.getElementById('risk-score').textContent = score.toFixed(0) + '/100';

    var levelBadge = document.getElementById('risk-level-badge');
    var iconBg = document.getElementById('risk-icon-bg');
    var icon = document.getElementById('risk-icon');

    levelBadge.textContent = '';
    var badge = document.createElement('span');

    if (level === 'low') {
        badge.className = 'text-green-600 bg-green-100 px-2 py-0.5 rounded';
        badge.textContent = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏ï‡πà‡∏≥';
        iconBg.className = 'w-12 h-12 bg-green-100 rounded-full flex items-center justify-center';
        icon.className = 'w-6 h-6 text-green-600';
    } else if (level === 'medium') {
        badge.className = 'text-yellow-600 bg-yellow-100 px-2 py-0.5 rounded';
        badge.textContent = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á';
        iconBg.className = 'w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center';
        icon.className = 'w-6 h-6 text-yellow-600';
    } else {
        badge.className = 'text-red-600 bg-red-100 px-2 py-0.5 rounded';
        badge.textContent = '‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏™‡∏π‡∏á';
        iconBg.className = 'w-12 h-12 bg-red-100 rounded-full flex items-center justify-center';
        icon.className = 'w-6 h-6 text-red-600';
    }
    levelBadge.appendChild(badge);

    // Update indicators
    var indicatorsDiv = document.getElementById('risk-indicators');
    indicatorsDiv.textContent = '';

    if (riskScore.indicators) {
        riskScore.indicators.forEach(function(ind) {
            var div = document.createElement('div');
            div.className = 'p-4 rounded-lg ' + (ind.status === 'pass' ? 'bg-green-50' : 'bg-red-50');

            var nameSpan = document.createElement('div');
            nameSpan.className = 'text-sm text-gray-600 mb-1';
            nameSpan.textContent = ind.name;
            div.appendChild(nameSpan);

            var valueDiv = document.createElement('div');
            valueDiv.className = 'flex items-center justify-between';

            var valueSpan = document.createElement('span');
            valueSpan.className = 'text-xl font-bold ' + (ind.status === 'pass' ? 'text-green-700' : 'text-red-700');
            valueSpan.textContent = (ind.value || 0).toFixed(1) + '%';
            valueDiv.appendChild(valueSpan);

            var thresholdSpan = document.createElement('span');
            thresholdSpan.className = 'text-xs text-gray-500';
            thresholdSpan.textContent = '‡πÄ‡∏Å‡∏ì‡∏ë‡πå: ' + (ind.threshold || 0) + '%';
            valueDiv.appendChild(thresholdSpan);

            div.appendChild(valueDiv);

            var statusDiv = document.createElement('div');
            statusDiv.className = 'text-xs mt-2 flex items-center gap-1';
            if (ind.status === 'pass') {
                statusDiv.className += ' text-green-600';
                statusDiv.innerHTML = '<span>‚úì</span> ‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå';
            } else {
                statusDiv.className += ' text-red-600';
                statusDiv.innerHTML = '<span>‚úó</span> ‡πÄ‡∏Å‡∏¥‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå';
            }
            div.appendChild(statusDiv);

            indicatorsDiv.appendChild(div);
        });
    }
}

function updateFundBreakdown(fundBreakdown) {
    var tbody = document.getElementById('fund-breakdown-tbody');
    tbody.textContent = '';

    if (!fundBreakdown || fundBreakdown.length === 0) {
        var tr = document.createElement('tr');
        var td = document.createElement('td');
        td.colSpan = 3;
        td.className = 'px-6 py-4 text-center text-gray-500';
        td.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
    }

    fundBreakdown.forEach(function(fund) {
        var tr = document.createElement('tr');

        // Fund name
        var tdName = document.createElement('td');
        tdName.className = 'px-6 py-4 whitespace-nowrap';

        var fundNameDiv = document.createElement('div');
        fundNameDiv.className = 'font-medium text-gray-800';
        fundNameDiv.textContent = fund.fund_name;
        tdName.appendChild(fundNameDiv);

        var fundGroupDiv = document.createElement('div');
        fundGroupDiv.className = 'text-xs text-gray-500';
        fundGroupDiv.textContent = fund.fund_group_desc || '';
        tdName.appendChild(fundGroupDiv);

        tr.appendChild(tdName);

        // Amount
        var tdAmount = document.createElement('td');
        tdAmount.className = 'px-6 py-4 whitespace-nowrap text-right font-medium text-gray-900';
        tdAmount.textContent = formatMoney(fund.amount);
        tr.appendChild(tdAmount);

        // Percentage
        var tdPct = document.createElement('td');
        tdPct.className = 'px-6 py-4 whitespace-nowrap text-right text-gray-600';
        tdPct.textContent = (fund.percentage || 0).toFixed(1) + '%';
        tr.appendChild(tdPct);

        tbody.appendChild(tr);
    });
}

function updateTrendChart() {
    if (!currentHospitalData || !currentHospitalData.monthly_trend) return;

    var ctx = document.getElementById('trend-chart').getContext('2d');
    var metric = document.getElementById('trend-metric').value;

    // Primary year is the first selected year
    var primaryYear = selectedYears.length > 0 ? selectedYears[0] : null;
    if (!primaryYear) return;

    // Destroy existing chart
    if (trendChart) {
        trendChart.destroy();
    }

    // Fiscal year months (Oct-Sep)
    var fiscalMonthOrder = ['10', '11', '12', '01', '02', '03', '04', '05', '06', '07', '08', '09'];
    var monthNames = {
        '01': '‡∏°.‡∏Ñ.', '02': '‡∏Å.‡∏û.', '03': '‡∏°‡∏µ.‡∏Ñ.', '04': '‡πÄ‡∏°.‡∏¢.',
        '05': '‡∏û.‡∏Ñ.', '06': '‡∏°‡∏¥.‡∏¢.', '07': '‡∏Å.‡∏Ñ.', '08': '‡∏™.‡∏Ñ.',
        '09': '‡∏Å.‡∏¢.', '10': '‡∏ï.‡∏Ñ.', '11': '‡∏û.‡∏¢.', '12': '‡∏ò.‡∏Ñ.'
    };

    // Labels are fiscal month names
    var labels = fiscalMonthOrder.map(function(m) { return monthNames[m]; });

    // Helper to get value for a month
    function getMonthValue(monthlyData, monthNum, metric) {
        if (!monthlyData) return null;
        var found = monthlyData.find(function(m) {
            var parts = m.month.split('-');
            return parts[1] === monthNum;
        });
        return found ? (found[metric] || 0) : null;
    }

    // Primary year dataset
    var primaryYearData = fiscalMonthOrder.map(function(m) {
        return getMonthValue(currentHospitalData.monthly_trend, m, metric);
    });

    var datasets = [{
        label: '‡∏õ‡∏µ‡∏á‡∏ö ' + primaryYear,
        data: primaryYearData,
        borderColor: yearColors[0].border,
        backgroundColor: yearColors[0].bg,
        borderWidth: 3,
        tension: 0.3,
        fill: true,
        pointRadius: 4,
        pointHoverRadius: 6
    }];

    // Add comparison years from yearsDataCache (excluding primary year)
    var colorIndex = 1;
    var comparisonYearsList = [];

    // Get checked comparison checkboxes
    var checkboxes = document.querySelectorAll('#year-checkboxes input[type="checkbox"]:checked');
    checkboxes.forEach(function(cb) {
        var year = parseInt(cb.value);
        if (year !== primaryYear && yearsDataCache[year] && yearsDataCache[year].monthly_trend) {
            comparisonYearsList.push(year);
        }
    });

    comparisonYearsList.sort(function(a, b) { return b - a; });

    comparisonYearsList.forEach(function(year) {
        var yearData = fiscalMonthOrder.map(function(m) {
            return getMonthValue(yearsDataCache[year].monthly_trend, m, metric);
        });

        var color = yearColors[colorIndex % yearColors.length];
        datasets.push({
            label: '‡∏õ‡∏µ‡∏á‡∏ö ' + year,
            data: yearData,
            borderColor: color.border,
            backgroundColor: 'transparent',
            borderWidth: 2,
            borderDash: [5, 5],
            tension: 0.3,
            fill: false,
            pointRadius: 3,
            pointHoverRadius: 5
        });
        colorIndex++;
    });

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var value = context.parsed.y;
                            if (value === null) return context.dataset.label + ': ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                            return context.dataset.label + ': ' + formatMoneyShort(value);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatMoneyShort(value);
                        }
                    }
                }
            }
        }
    });

    // Update year legend
    updateYearLegend(primaryYear, comparisonYearsList);
}

function updateYearLegend(currentYear, comparisonYears) {
    var legendDiv = document.getElementById('year-legend');
    legendDiv.textContent = '';

    // Current year
    var currentSpan = document.createElement('span');
    currentSpan.className = 'flex items-center gap-2';
    currentSpan.innerHTML = '<span class="w-4 h-1 rounded" style="background-color: ' + yearColors[0].border + '"></span>' +
                           '<span>‡∏õ‡∏µ‡∏á‡∏ö ' + currentYear + ' (‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô)</span>';
    legendDiv.appendChild(currentSpan);

    // Comparison years
    comparisonYears.forEach(function(year, index) {
        var color = yearColors[(index + 1) % yearColors.length];
        var span = document.createElement('span');
        span.className = 'flex items-center gap-2';
        span.innerHTML = '<span class="w-4 h-1 rounded border-dashed border-2" style="border-color: ' + color.border + '"></span>' +
                        '<span>‡∏õ‡∏µ‡∏á‡∏ö ' + year + '</span>';
        legendDiv.appendChild(span);
    });
}

// Search functions
function searchHospitals() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doSearch, 300);
}

async function doSearch() {
    var query = document.getElementById('search-hospital').value.trim();
    var resultsDiv = document.getElementById('search-results');

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    try {
        var response = await fetch('/api/health-offices?search=' + encodeURIComponent(query) + '&per_page=15');
        var result = await response.json();

        resultsDiv.textContent = '';

        if (result.success && result.data.length > 0) {
            result.data.forEach(function(h) {
                var div = document.createElement('div');
                div.className = 'px-4 py-3 hover:bg-blue-50 cursor-pointer border-b border-gray-100';
                div.onclick = function() { selectHospital(h); };

                var nameDiv = document.createElement('div');
                nameDiv.className = 'font-medium text-gray-800';
                nameDiv.textContent = h.name;
                div.appendChild(nameDiv);

                var infoDiv = document.createElement('div');
                infoDiv.className = 'text-sm text-gray-500 flex gap-2';

                if (h.hcode5) {
                    var codeSpan = document.createElement('span');
                    codeSpan.className = 'bg-blue-100 text-blue-800 px-2 py-0.5 rounded text-xs';
                    codeSpan.textContent = h.hcode5;
                    infoDiv.appendChild(codeSpan);
                }

                var levelSpan = document.createElement('span');
                levelSpan.textContent = h.hospital_level || '';
                infoDiv.appendChild(levelSpan);

                var provSpan = document.createElement('span');
                provSpan.textContent = h.province || '';
                infoDiv.appendChild(provSpan);

                div.appendChild(infoDiv);
                resultsDiv.appendChild(div);
            });
            resultsDiv.classList.remove('hidden');
        } else {
            var noResult = document.createElement('div');
            noResult.className = 'px-4 py-3 text-gray-500';
            noResult.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            resultsDiv.appendChild(noResult);
            resultsDiv.classList.remove('hidden');
        }
    } catch (e) {
        console.error('Search error:', e);
    }
}

function selectHospital(h) {
    document.getElementById('search-hospital').value = h.name;
    document.getElementById('search-results').classList.add('hidden');

    if (h.hcode5) {
        currentVendorId = h.hcode5;
        currentHospitalInfo = null; // Reset hospital info
        selectedYears = []; // Reset selected years
        yearsDataCache = {}; // Reset cache
        localStorage.setItem('my_hospital_vendor', h.hcode5);
        localStorage.setItem('my_hospital_name', h.name);
        loadHospitalYears();
    } else {
        showToast('‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏´‡∏±‡∏™ 5 ‡∏´‡∏•‡∏±‡∏Å', 'warning');
    }
}

// Fetch SMT Data for all years (from no-data state)
async function fetchSMTData() {
    if (!currentVendorId) {
        showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }

    // Get current fiscal year
    var today = new Date();
    var fiscalYear = today.getMonth() >= 9 ? today.getFullYear() + 544 : today.getFullYear() + 543;

    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏õ‡∏µ ' + fiscalYear + '...', 'info');

    try {
        var response = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                vendor_id: currentVendorId,
                budget_year: fiscalYear,
                save_db: true
            })
        });
        var result = await response.json();

        if (result.success) {
            showToast('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ' + (result.records || 0) + ' records', 'success');
            await loadHospitalYears();
        } else {
            showToast(result.error || 'Failed to fetch data', 'error');
        }
    } catch (e) {
        console.error('Fetch error:', e);
        showToast('Error: ' + e.message, 'error');
    }
}

// Comparison functions
function toggleComparison() {
    var content = document.getElementById('comparison-content');
    var chevron = document.getElementById('comparison-chevron');

    if (content.classList.contains('hidden')) {
        content.classList.remove('hidden');
        chevron.classList.add('rotate-180');
    } else {
        content.classList.add('hidden');
        chevron.classList.remove('rotate-180');
    }
}

function searchCompareHospitals() {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(doCompareSearch, 300);
}

async function doCompareSearch() {
    var query = document.getElementById('compare-search').value.trim();
    var resultsDiv = document.getElementById('compare-search-results');

    if (query.length < 2) {
        resultsDiv.classList.add('hidden');
        return;
    }

    try {
        var response = await fetch('/api/health-offices?search=' + encodeURIComponent(query) + '&per_page=10');
        var result = await response.json();

        resultsDiv.textContent = '';

        if (result.success && result.data.length > 0) {
            result.data.forEach(function(h) {
                if (!h.hcode5 || h.hcode5 === currentVendorId) return;

                var div = document.createElement('div');
                div.className = 'px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b border-gray-100 text-sm';
                div.onclick = function() { addComparisonHospital(h); };

                var nameDiv = document.createElement('div');
                nameDiv.className = 'font-medium';
                nameDiv.textContent = h.name;
                div.appendChild(nameDiv);

                var infoDiv = document.createElement('div');
                infoDiv.className = 'text-xs text-gray-500';
                infoDiv.textContent = h.hcode5 + ' | ' + (h.province || '');
                div.appendChild(infoDiv);

                resultsDiv.appendChild(div);
            });
            resultsDiv.classList.remove('hidden');
        } else {
            var noResult = document.createElement('div');
            noResult.className = 'px-4 py-2 text-gray-500 text-sm';
            noResult.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            resultsDiv.appendChild(noResult);
            resultsDiv.classList.remove('hidden');
        }
    } catch (e) {
        console.error('Search error:', e);
    }
}

async function addComparisonHospital(h) {
    document.getElementById('compare-search').value = '';
    document.getElementById('compare-search-results').classList.add('hidden');

    // Check if already added
    if (comparisonHospitals.find(function(c) { return c.vendor_id === h.hcode5; })) {
        showToast('‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏•‡πâ‡∏ß', 'warning');
        return;
    }

    showToast('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + h.name + ' ‡∏ó‡∏∏‡∏Å‡∏õ‡∏µ...', 'info');

    // Fetch data for years that my hospital has data
    var yearData = {};
    var hasAnyData = false;
    var yearsToFetch = hospitalYearsData.filter(function(y) { return y.has_data; }).map(function(y) { return y.year; });

    for (var i = 0; i < yearsToFetch.length; i++) {
        var year = yearsToFetch[i];
        try {
            var response = await fetch('/api/benchmark/my-hospital?vendor_id=' + h.hcode5 + '&fiscal_year=' + year);
            var result = await response.json();

            if (result.success && result.summary && result.summary.total_amount > 0) {
                yearData[year] = result;
                hasAnyData = true;
            }
        } catch (e) {
            console.error('Error fetching year ' + year + ':', e);
        }
    }

    if (hasAnyData) {
        comparisonHospitals.push({
            vendor_id: h.hcode5,
            name: h.name,
            yearData: yearData  // Store data for all years
        });
        updateComparisonUI();
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏° ' + h.name + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + Object.keys(yearData).length + ' ‡∏õ‡∏µ)', 'success');
    } else {
        // No data found - offer to fetch SMT data
        showNoDataDialog(h);
    }
}

// Show dialog when comparison hospital has no SMT data
function showNoDataDialog(hospital) {
    var listDiv = document.getElementById('pending-hospitals-container');

    // Create pending card with fetch option
    var card = document.createElement('div');
    card.className = 'p-4 bg-yellow-50 border border-yellow-200 rounded-lg';
    card.id = 'pending-hospital-' + hospital.hcode5;

    card.innerHTML = '\
        <div class="flex items-start justify-between gap-3">\
            <div class="flex-1">\
                <div class="font-medium text-gray-800">' + hospital.name + '</div>\
                <div class="text-sm text-yellow-700 mt-1">\
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">\
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>\
                    </svg>\
                    ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö - ‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä. ‡∏Å‡πà‡∏≠‡∏ô\
                </div>\
            </div>\
            <div class="flex gap-2">\
                <button onclick="fetchComparisonHospitalSMT(\'' + hospital.hcode5 + '\', \'' + hospital.name.replace(/'/g, "\\'") + '\')" \
                        class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded text-sm font-medium flex items-center gap-1">\
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">\
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>\
                    </svg>\
                    ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT\
                </button>\
                <button onclick="removePendingHospital(\'' + hospital.hcode5 + '\')" \
                        class="px-2 py-1.5 text-gray-500 hover:text-red-600 text-sm">\
                    ‚úï\
                </button>\
            </div>\
        </div>\
    ';

    listDiv.appendChild(card);
}

// Remove pending hospital card
function removePendingHospital(vendorId) {
    var card = document.getElementById('pending-hospital-' + vendorId);
    if (card) {
        card.remove();
    }
}

// Fetch SMT data for comparison hospital
async function fetchComparisonHospitalSMT(vendorId, hospitalName) {
    var card = document.getElementById('pending-hospital-' + vendorId);
    if (!card) return;

    // Update card to show loading
    card.className = 'p-4 bg-blue-50 border border-blue-200 rounded-lg';
    card.innerHTML = '\
        <div class="flex items-center gap-3">\
            <svg class="animate-spin h-5 w-5 text-blue-600" fill="none" viewBox="0 0 24 24">\
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>\
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>\
            </svg>\
            <div>\
                <div class="font-medium text-gray-800">' + hospitalName + '</div>\
                <div class="text-sm text-blue-600">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏à‡∏≤‡∏Å ‡∏™‡∏õ‡∏™‡∏ä....</div>\
            </div>\
        </div>\
    ';

    // Get years to fetch (same as my hospital)
    var yearsToFetch = hospitalYearsData.filter(function(y) { return y.has_data; }).map(function(y) { return y.year; });
    var yearData = {};
    var hasAnyData = false;
    var fetchedYears = 0;

    for (var i = 0; i < yearsToFetch.length; i++) {
        var year = yearsToFetch[i];
        try {
            // First, fetch SMT data from NHSO
            var fetchResponse = await fetch('/api/smt/fetch', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    vendor_id: vendorId,
                    budget_year: year,
                    save_db: true
                })
            });
            var fetchResult = await fetchResponse.json();

            if (fetchResult.success && fetchResult.records > 0) {
                fetchedYears++;

                // Now get the processed data
                var dataResponse = await fetch('/api/benchmark/my-hospital?vendor_id=' + vendorId + '&fiscal_year=' + year);
                var dataResult = await dataResponse.json();

                if (dataResult.success && dataResult.summary && dataResult.summary.total_amount > 0) {
                    yearData[year] = dataResult;
                    hasAnyData = true;
                }
            }
        } catch (e) {
            console.error('Error fetching year ' + year + ':', e);
        }
    }

    // Remove the card
    card.remove();

    if (hasAnyData) {
        comparisonHospitals.push({
            vendor_id: vendorId,
            name: hospitalName,
            yearData: yearData
        });
        updateComparisonUI();
        showToast('‡πÄ‡∏û‡∏¥‡πà‡∏° ' + hospitalName + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (' + Object.keys(yearData).length + ' ‡∏õ‡∏µ)', 'success');
    } else {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SMT ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ' + hospitalName + ' ‡πÑ‡∏î‡πâ', 'error');
    }
}

function removeComparisonHospital(vendorId) {
    comparisonHospitals = comparisonHospitals.filter(function(c) { return c.vendor_id !== vendorId; });
    updateComparisonUI();
}

// Fetch SMT data for a specific year of a comparison hospital
async function fetchComparisonYearData(vendorId, hospitalName, year) {
    console.log('fetchComparisonYearData called:', { vendorId, hospitalName, year });
    console.log('comparisonHospitals:', comparisonHospitals.map(function(h) { return h.vendor_id; }));

    var row = document.getElementById('comparison-row-' + vendorId);
    if (!row) {
        console.error('Row not found for vendor:', vendorId);
        return;
    }

    // Find the button cell and show loading
    var btnCell = row.querySelector('td[colspan="4"]');
    if (btnCell) {
        btnCell.innerHTML = '<span class="text-blue-600 text-sm flex items-center justify-center gap-2"><svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</span>';
    }

    try {
        // Fetch SMT data from NHSO
        var fetchResponse = await fetch('/api/smt/fetch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                vendor_id: vendorId,
                budget_year: year,
                save_db: true
            })
        });
        var fetchResult = await fetchResponse.json();
        console.log('SMT fetch result:', fetchResult);

        if (fetchResult.success && fetchResult.records > 0) {
            // Get the processed data
            var dataResponse = await fetch('/api/benchmark/my-hospital?vendor_id=' + vendorId + '&fiscal_year=' + year);
            var dataResult = await dataResponse.json();
            console.log('Hospital data result:', dataResult);

            if (dataResult.success && dataResult.summary) {
                // Update the comparison hospital's yearData
                // Try to find with exact match first, then try with normalized vendor_id
                var hospital = comparisonHospitals.find(function(h) {
                    return h.vendor_id === vendorId ||
                           h.vendor_id === vendorId.replace(/^0+/, '') ||
                           vendorId === h.vendor_id.replace(/^0+/, '');
                });

                console.log('Found hospital:', hospital);

                if (hospital) {
                    if (!hospital.yearData) {
                        hospital.yearData = {};
                    }
                    hospital.yearData[year] = dataResult;
                    console.log('Updated yearData for year ' + year);
                } else {
                    console.error('Hospital not found in comparisonHospitals!');
                }

                // Refresh the comparison table
                updateComparisonTable();
                showToast('‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + hospitalName + ' ‡∏õ‡∏µ ' + year + ' ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', 'success');
            } else {
                showToast('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏µ ' + year, 'warning');
                updateComparisonTable();
            }
        } else {
            showToast(fetchResult.error || '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
            updateComparisonTable();
        }
    } catch (e) {
        console.error('Error fetching comparison year data:', e);
        showToast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'error');
        updateComparisonTable();
    }
}

function updateComparisonUI() {
    var tableWrapper = document.getElementById('comparison-table-wrapper');

    if (comparisonHospitals.length === 0) {
        tableWrapper.classList.add('hidden');
        return;
    }

    tableWrapper.classList.remove('hidden');

    // Populate year dropdown
    populateComparisonYearDropdown();

    // Render table
    updateComparisonTable();
}

function populateComparisonYearDropdown() {
    var select = document.getElementById('comparison-year');
    var primaryYear = selectedYears.length > 0 ? selectedYears[0] : null;
    select.innerHTML = '';

    // Add years that my hospital has data
    var yearsWithData = hospitalYearsData.filter(function(y) { return y.has_data; });
    yearsWithData.forEach(function(yearInfo) {
        var option = document.createElement('option');
        option.value = yearInfo.year;
        option.textContent = '‡∏õ‡∏µ‡∏á‡∏ö ' + yearInfo.year;
        if (yearInfo.year === primaryYear) option.selected = true;
        select.appendChild(option);
    });
}

function updateComparisonTable() {
    var tbody = document.getElementById('comparison-tbody');
    var selectedYear = parseInt(document.getElementById('comparison-year').value);
    tbody.innerHTML = '';

    var primaryYear = selectedYears.length > 0 ? selectedYears[0] : null;

    // Add my hospital first
    if (currentHospitalData && currentHospitalInfo) {
        // Use cached data if available
        if (yearsDataCache[selectedYear]) {
            addComparisonTableRow(tbody, {
                vendor_id: currentVendorId,
                name: currentHospitalInfo.name,
                summary: yearsDataCache[selectedYear].summary
            }, true);
        } else if (selectedYear === primaryYear) {
            addComparisonTableRow(tbody, {
                vendor_id: currentVendorId,
                name: currentHospitalInfo.name,
                summary: currentHospitalData.summary
            }, true);
        } else {
            // Fetch and add
            fetchAndAddMyHospitalRow(tbody, selectedYear);
        }
    }

    // Add comparison hospitals
    comparisonHospitals.forEach(function(h) {
        var yearData = h.yearData[selectedYear];
        addComparisonTableRow(tbody, {
            vendor_id: h.vendor_id,
            name: h.name,
            summary: yearData ? yearData.summary : null
        }, false, selectedYear);
    });
}

async function fetchAndAddMyHospitalRow(tbody, year) {
    try {
        var response = await fetch('/api/benchmark/my-hospital?vendor_id=' + currentVendorId + '&fiscal_year=' + year);
        var result = await response.json();
        if (result.success) {
            // Cache the result
            yearsDataCache[year] = result;

            // Insert at beginning
            var firstRow = tbody.firstChild;
            var tr = createComparisonRow({
                vendor_id: currentVendorId,
                name: currentHospitalInfo ? currentHospitalInfo.name : '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô',
                summary: result.summary
            }, true);
            if (firstRow) {
                tbody.insertBefore(tr, firstRow);
            } else {
                tbody.appendChild(tr);
            }
        }
    } catch (e) {
        console.error('Error fetching my hospital data:', e);
    }
}

function addComparisonTableRow(tbody, hospital, isMyHospital, year) {
    var tr = createComparisonRow(hospital, isMyHospital, year);
    tbody.appendChild(tr);
}

function createComparisonRow(hospital, isMyHospital, year) {
    var tr = document.createElement('tr');
    tr.className = isMyHospital ? 'bg-blue-50' : '';
    tr.id = 'comparison-row-' + hospital.vendor_id;

    var summary = hospital.summary || {};
    var hasData = summary && summary.total_amount;

    // Name
    var tdName = document.createElement('td');
    tdName.className = 'px-4 py-3 whitespace-nowrap';

    var nameDiv = document.createElement('div');
    nameDiv.className = 'font-medium text-gray-800';
    nameDiv.textContent = hospital.name;
    tdName.appendChild(nameDiv);

    if (isMyHospital) {
        var badge = document.createElement('span');
        badge.className = 'text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded';
        badge.textContent = '‡∏£‡∏û. ‡∏Ç‡∏≠‡∏á‡∏â‡∏±‡∏ô';
        tdName.appendChild(badge);
    }
    tr.appendChild(tdName);

    if (!hasData) {
        // No data for this year - show fetch button for comparison hospitals
        var tdNoData = document.createElement('td');
        tdNoData.colSpan = 4;
        tdNoData.className = 'px-4 py-3 text-center';

        if (!isMyHospital && year) {
            // Add fetch button
            var fetchBtn = document.createElement('button');
            fetchBtn.className = 'px-3 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded text-sm font-medium inline-flex items-center gap-1';
            fetchBtn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏µ ' + year;
            fetchBtn.onclick = function() { fetchComparisonYearData(hospital.vendor_id, hospital.name, year); };
            tdNoData.appendChild(fetchBtn);
        } else {
            tdNoData.className += ' text-gray-400 text-sm';
            tdNoData.textContent = '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏õ‡∏µ‡∏ô‡∏µ‡πâ';
        }
        tr.appendChild(tdNoData);
    } else {
        // Total
        var tdTotal = document.createElement('td');
        tdTotal.className = 'px-4 py-3 text-right font-medium';
        tdTotal.textContent = formatMoney(summary.total_amount);
        tr.appendChild(tdTotal);

        // Wait %
        var tdWait = document.createElement('td');
        tdWait.className = 'px-4 py-3 text-right text-orange-600';
        tdWait.textContent = (summary.wait_ratio || 0).toFixed(1) + '%';
        tr.appendChild(tdWait);

        // Debt %
        var tdDebt = document.createElement('td');
        tdDebt.className = 'px-4 py-3 text-right text-red-600';
        tdDebt.textContent = (summary.debt_ratio || 0).toFixed(1) + '%';
        tr.appendChild(tdDebt);

        // Growth
        var tdGrowth = document.createElement('td');
        tdGrowth.className = 'px-4 py-3 text-right';
        var growth = summary.growth_yoy || 0;
        var growthSpan = document.createElement('span');
        if (growth >= 0) {
            growthSpan.className = 'text-green-600';
            growthSpan.textContent = '+' + growth.toFixed(1) + '%';
        } else {
            growthSpan.className = 'text-red-600';
            growthSpan.textContent = growth.toFixed(1) + '%';
        }
        tdGrowth.appendChild(growthSpan);
        tr.appendChild(tdGrowth);
    }

    // Actions
    var tdActions = document.createElement('td');
    tdActions.className = 'px-4 py-3 text-center';
    if (!isMyHospital) {
        var btn = document.createElement('button');
        btn.className = 'text-red-500 hover:text-red-700';
        btn.textContent = '‚úï';
        btn.onclick = function() { removeComparisonHospital(hospital.vendor_id); };
        tdActions.appendChild(btn);
    }
    tr.appendChild(tdActions);

    return tr;
}

// Auto-include all selected years in trend chart
function updateTrendChartWithAllYears() {
    if (selectedYears.length === 0) return;

    var ctx = document.getElementById('trend-chart').getContext('2d');
    var metric = document.getElementById('trend-metric').value;

    // Sort years descending
    var years = selectedYears.slice().sort(function(a, b) { return b - a; });
    var primaryYear = years[0];

    // Destroy existing chart
    if (trendChart) {
        trendChart.destroy();
    }

    // Fiscal year months (Oct-Sep)
    var fiscalMonthOrder = ['10', '11', '12', '01', '02', '03', '04', '05', '06', '07', '08', '09'];
    var monthNames = {
        '01': '‡∏°.‡∏Ñ.', '02': '‡∏Å.‡∏û.', '03': '‡∏°‡∏µ.‡∏Ñ.', '04': '‡πÄ‡∏°.‡∏¢.',
        '05': '‡∏û.‡∏Ñ.', '06': '‡∏°‡∏¥.‡∏¢.', '07': '‡∏Å.‡∏Ñ.', '08': '‡∏™.‡∏Ñ.',
        '09': '‡∏Å.‡∏¢.', '10': '‡∏ï.‡∏Ñ.', '11': '‡∏û.‡∏¢.', '12': '‡∏ò.‡∏Ñ.'
    };

    // Labels are fiscal month names
    var labels = fiscalMonthOrder.map(function(m) { return monthNames[m]; });

    // Helper to get value for a month
    function getMonthValue(monthlyData, monthNum, metric) {
        if (!monthlyData) return null;
        var found = monthlyData.find(function(m) {
            var parts = m.month.split('-');
            return parts[1] === monthNum;
        });
        return found ? (found[metric] || 0) : null;
    }

    // Create datasets for ALL selected years
    var datasets = [];
    years.forEach(function(year, index) {
        var yearData = yearsDataCache[year];
        if (!yearData || !yearData.monthly_trend) return;

        var monthlyData = fiscalMonthOrder.map(function(m) {
            return getMonthValue(yearData.monthly_trend, m, metric);
        });

        var color = yearColors[index % yearColors.length];
        var isPrimary = index === 0;

        datasets.push({
            label: '‡∏õ‡∏µ‡∏á‡∏ö ' + year + (isPrimary ? ' (‡∏´‡∏•‡∏±‡∏Å)' : ''),
            data: monthlyData,
            borderColor: color.border,
            backgroundColor: isPrimary ? color.bg : 'transparent',
            borderWidth: isPrimary ? 3 : 2,
            borderDash: isPrimary ? [] : [5, 5],
            tension: 0.3,
            fill: isPrimary,
            pointRadius: isPrimary ? 4 : 3,
            pointHoverRadius: isPrimary ? 6 : 5
        });
    });

    if (datasets.length === 0) return;

    trendChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'bottom'
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            var value = context.parsed.y;
                            if (value === null) return context.dataset.label + ': ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
                            return context.dataset.label + ': ' + formatMoneyShort(value);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            return formatMoneyShort(value);
                        }
                    }
                }
            }
        }
    });

    // Update year legend (shows all selected years)
    updateYearLegendAll(years);
}

// Update year legend to show all selected years
function updateYearLegendAll(years) {
    var legendDiv = document.getElementById('year-legend');
    legendDiv.innerHTML = '';

    years.forEach(function(year, index) {
        var color = yearColors[index % yearColors.length];
        var isPrimary = index === 0;

        var span = document.createElement('span');
        span.className = 'flex items-center gap-2';

        var lineStyle = isPrimary
            ? '<span class="w-4 h-1 rounded" style="background-color: ' + color.border + '"></span>'
            : '<span class="w-4 h-0 border-t-2 border-dashed" style="border-color: ' + color.border + '"></span>';

        span.innerHTML = lineStyle + '<span>‡∏õ‡∏µ‡∏á‡∏ö ' + year + (isPrimary ? ' (‡∏´‡∏•‡∏±‡∏Å)' : '') + '</span>';
        legendDiv.appendChild(span);
    });
}

// Multi-Year Comparison Table
function updateMultiYearComparisonTable() {
    var container = document.getElementById('multi-year-comparison');
    var badge = document.getElementById('comparison-years-badge');
    var tbody = document.getElementById('comparison-table-body');
    var thead = container.querySelector('thead tr');

    // Only show if 2+ years selected
    if (selectedYears.length < 2) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');
    badge.textContent = selectedYears.length + ' ‡∏õ‡∏µ';

    // Sort years descending
    var years = selectedYears.slice().sort(function(a, b) { return b - a; });

    // Build header
    thead.innerHTML = '<th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50 z-10">‡∏ï‡∏±‡∏ß‡∏ä‡∏µ‡πâ‡∏ß‡∏±‡∏î</th>';
    years.forEach(function(year, index) {
        var th = document.createElement('th');
        th.className = 'px-4 py-3 text-right text-xs font-medium uppercase tracking-wider min-w-32';
        if (index === 0) {
            // Primary year
            th.className += ' text-indigo-700 bg-indigo-50';
            th.innerHTML = '<span class="bg-indigo-600 text-white px-2 py-0.5 rounded text-xs mr-1">‡∏´‡∏•‡∏±‡∏Å</span>' + year;
        } else {
            th.className += ' text-gray-500';
            th.textContent = year;
        }
        thead.appendChild(th);
    });
    // Add YoY column
    var thYoy = document.createElement('th');
    thYoy.className = 'px-4 py-3 text-right text-xs font-medium text-purple-700 uppercase tracking-wider min-w-24 bg-purple-50';
    thYoy.textContent = 'YoY %';
    thead.appendChild(thYoy);

    // Build rows
    tbody.innerHTML = '';

    var metrics = [
        { key: 'total_amount', label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°', format: 'money', positive: 'up' },
        { key: 'wait_amount', label: '‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢', format: 'money', positive: 'down' },
        { key: 'wait_ratio', label: 'Wait Ratio', format: 'percent', positive: 'down' },
        { key: 'debt_amount', label: '‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô', format: 'money', positive: 'down' },
        { key: 'debt_ratio', label: 'Debt Ratio', format: 'percent', positive: 'down' },
        { key: 'record_count', label: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô Records', format: 'number', positive: 'up' }
    ];

    metrics.forEach(function(metric) {
        var tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';

        // Metric name
        var tdName = document.createElement('td');
        tdName.className = 'px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-800 sticky left-0 bg-white z-10';
        tdName.textContent = metric.label;
        tr.appendChild(tdName);

        // Value for each year
        var values = [];
        years.forEach(function(year, index) {
            var td = document.createElement('td');
            td.className = 'px-4 py-3 whitespace-nowrap text-sm text-right';

            var data = yearsDataCache[year];
            var value = data && data.summary ? data.summary[metric.key] : null;
            values.push(value);

            if (value === null || value === undefined) {
                td.className += ' text-gray-300';
                td.textContent = '-';
            } else {
                if (index === 0) {
                    td.className += ' font-semibold text-indigo-700 bg-indigo-50';
                } else {
                    td.className += ' text-gray-600';
                }

                if (metric.format === 'money') {
                    td.textContent = formatMoney(value);
                } else if (metric.format === 'percent') {
                    td.textContent = value.toFixed(1) + '%';
                } else {
                    td.textContent = value.toLocaleString();
                }
            }
            tr.appendChild(td);
        });

        // YoY calculation (compare first and second year)
        var tdYoy = document.createElement('td');
        tdYoy.className = 'px-4 py-3 whitespace-nowrap text-sm text-right font-medium bg-purple-50';

        if (values.length >= 2 && values[0] !== null && values[1] !== null && values[1] !== 0) {
            var yoy = ((values[0] - values[1]) / Math.abs(values[1])) * 100;
            var isPositive = (metric.positive === 'up' && yoy >= 0) || (metric.positive === 'down' && yoy <= 0);

            if (yoy >= 0) {
                tdYoy.innerHTML = '<span class="' + (isPositive ? 'text-green-600' : 'text-red-600') + '">‚ñ≤ ' + yoy.toFixed(1) + '%</span>';
            } else {
                tdYoy.innerHTML = '<span class="' + (isPositive ? 'text-green-600' : 'text-red-600') + '">‚ñº ' + Math.abs(yoy).toFixed(1) + '%</span>';
            }
        } else {
            tdYoy.className += ' text-gray-300';
            tdYoy.textContent = '-';
        }
        tr.appendChild(tdYoy);

        tbody.appendChild(tr);
    });

    // Update the multi-year chart
    updateMultiYearChart();
}

// Switch between chart types
function switchYearChartType(type) {
    currentYearChartType = type;

    // Update button styles
    var groupedBtn = document.getElementById('chart-type-grouped');
    var mixedBtn = document.getElementById('chart-type-mixed');

    if (type === 'grouped') {
        groupedBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white text-indigo-600 shadow-sm';
        mixedBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-all text-gray-500 hover:text-gray-700';
    } else {
        groupedBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-all text-gray-500 hover:text-gray-700';
        mixedBtn.className = 'px-3 py-1.5 text-sm font-medium rounded-md transition-all bg-white text-indigo-600 shadow-sm';
    }

    updateMultiYearChart();
}

// Multi-Year Bar Chart colors
const barChartColors = {
    total: { border: 'rgb(59, 130, 246)', bg: 'rgba(59, 130, 246, 0.7)' },      // Blue
    wait: { border: 'rgb(251, 191, 36)', bg: 'rgba(251, 191, 36, 0.7)' },       // Amber
    debt: { border: 'rgb(239, 68, 68)', bg: 'rgba(239, 68, 68, 0.7)' }          // Red
};

// Update Multi-Year Chart
function updateMultiYearChart() {
    var canvas = document.getElementById('multi-year-chart');
    if (!canvas) return;

    var ctx = canvas.getContext('2d');

    // Destroy existing chart
    if (multiYearChart) {
        multiYearChart.destroy();
        multiYearChart = null;
    }

    // Need at least 2 years
    if (selectedYears.length < 2) return;

    // Sort years ascending for chart display
    var years = selectedYears.slice().sort(function(a, b) { return a - b; });
    var labels = years.map(function(y) { return '‡∏õ‡∏µ ' + y; });

    // Gather data
    var totalData = [];
    var waitData = [];
    var debtData = [];
    var waitRatioData = [];
    var debtRatioData = [];

    years.forEach(function(year) {
        var data = yearsDataCache[year];
        if (data && data.summary) {
            totalData.push(data.summary.total_amount || 0);
            waitData.push(data.summary.wait_amount || 0);
            debtData.push(data.summary.debt_amount || 0);
            waitRatioData.push(data.summary.wait_ratio || 0);
            debtRatioData.push(data.summary.debt_ratio || 0);
        } else {
            totalData.push(0);
            waitData.push(0);
            debtData.push(0);
            waitRatioData.push(0);
            debtRatioData.push(0);
        }
    });

    if (currentYearChartType === 'grouped') {
        // Grouped Bar Chart
        multiYearChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°',
                        data: totalData,
                        backgroundColor: barChartColors.total.bg,
                        borderColor: barChartColors.total.border,
                        borderWidth: 1
                    },
                    {
                        label: '‡∏¢‡∏≠‡∏î‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢',
                        data: waitData,
                        backgroundColor: barChartColors.wait.bg,
                        borderColor: barChartColors.wait.border,
                        borderWidth: 1
                    },
                    {
                        label: '‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô',
                        data: debtData,
                        backgroundColor: barChartColors.debt.bg,
                        borderColor: barChartColors.debt.border,
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ' + formatMoney(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
                                if (value >= 1000000) return (value / 1000000).toFixed(0) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                return value;
                            }
                        }
                    }
                }
            }
        });
    } else {
        // Mixed Bar + Line Chart
        multiYearChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        type: 'bar',
                        label: '‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏£‡∏ß‡∏°',
                        data: totalData,
                        backgroundColor: barChartColors.total.bg,
                        borderColor: barChartColors.total.border,
                        borderWidth: 1,
                        yAxisID: 'y'
                    },
                    {
                        type: 'line',
                        label: '% ‡∏£‡∏≠‡∏à‡πà‡∏≤‡∏¢',
                        data: waitRatioData,
                        borderColor: barChartColors.wait.border,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointBackgroundColor: barChartColors.wait.border,
                        tension: 0.3,
                        yAxisID: 'y1'
                    },
                    {
                        type: 'line',
                        label: '% ‡∏´‡∏ô‡∏µ‡πâ‡∏™‡∏¥‡∏ô',
                        data: debtRatioData,
                        borderColor: barChartColors.debt.border,
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 5,
                        pointBackgroundColor: barChartColors.debt.border,
                        tension: 0.3,
                        yAxisID: 'y1'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { usePointStyle: true, padding: 20 }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                if (context.dataset.type === 'line' || context.datasetIndex > 0) {
                                    return context.dataset.label + ': ' + context.raw.toFixed(1) + '%';
                                }
                                return context.dataset.label + ': ' + formatMoney(context.raw);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false }
                    },
                    y: {
                        type: 'linear',
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ö‡∏≤‡∏ó)',
                            color: barChartColors.total.border
                        },
                        ticks: {
                            callback: function(value) {
                                if (value >= 1000000000) return (value / 1000000000).toFixed(1) + 'B';
                                if (value >= 1000000) return (value / 1000000).toFixed(0) + 'M';
                                if (value >= 1000) return (value / 1000).toFixed(0) + 'K';
                                return value;
                            }
                        }
                    },
                    y1: {
                        type: 'linear',
                        position: 'right',
                        beginAtZero: true,
                        max: 30,
                        title: {
                            display: true,
                            text: '‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô (%)',
                            color: barChartColors.debt.border
                        },
                        grid: {
                            drawOnChartArea: false
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        }
                    }
                }
            }
        });
    }
}

// Update Summary Cards with YoY comparison
function updateSummaryCardsWithYoY() {
    var primaryYear = selectedYears.length > 0 ? selectedYears[0] : null;
    var compareYear = selectedYears.length > 1 ? selectedYears[1] : null;

    // Update primary year display
    var primaryDisplay = document.getElementById('primary-year-display');
    if (primaryDisplay) {
        primaryDisplay.textContent = primaryYear || '-';
    }

    var primaryData = yearsDataCache[primaryYear];
    var compareData = compareYear ? yearsDataCache[compareYear] : null;

    // Update YoY compare label
    var yoyLabel = document.getElementById('yoy-compare-label');
    var compareYearDisplay = document.getElementById('compare-year-display');
    if (compareYear && compareData) {
        yoyLabel.classList.remove('hidden');
        compareYearDisplay.textContent = compareYear;
    } else {
        yoyLabel.classList.add('hidden');
    }

    if (!primaryData || !primaryData.summary) return;

    var summary = primaryData.summary;
    var prevSummary = compareData ? compareData.summary : null;

    // Total Revenue with previous year
    var totalPrev = document.getElementById('total-revenue-prev');
    if (totalPrev && prevSummary) {
        totalPrev.classList.remove('hidden');
        totalPrev.textContent = '‡∏õ‡∏µ ' + compareYear + ': ' + formatMoney(prevSummary.total_amount);
    } else if (totalPrev) {
        totalPrev.classList.add('hidden');
    }

    // Wait Amount with YoY
    var waitYoy = document.getElementById('wait-yoy');
    var waitPrev = document.getElementById('wait-amount-prev');
    if (prevSummary && prevSummary.wait_amount > 0) {
        var waitChange = ((summary.wait_amount - prevSummary.wait_amount) / prevSummary.wait_amount) * 100;
        if (waitYoy) {
            waitYoy.classList.remove('hidden');
            if (waitChange >= 0) {
                waitYoy.innerHTML = '<span class="text-red-600">‚ñ≤ ' + waitChange.toFixed(1) + '%</span>';
            } else {
                waitYoy.innerHTML = '<span class="text-green-600">‚ñº ' + Math.abs(waitChange).toFixed(1) + '%</span>';
            }
        }
        if (waitPrev) {
            waitPrev.classList.remove('hidden');
            waitPrev.textContent = '‡∏õ‡∏µ ' + compareYear + ': ' + formatMoney(prevSummary.wait_amount);
        }
    } else {
        if (waitYoy) waitYoy.classList.add('hidden');
        if (waitPrev) waitPrev.classList.add('hidden');
    }

    // Debt Amount with YoY
    var debtYoy = document.getElementById('debt-yoy');
    var debtPrev = document.getElementById('debt-amount-prev');
    if (prevSummary && prevSummary.debt_amount > 0) {
        var debtChange = ((summary.debt_amount - prevSummary.debt_amount) / prevSummary.debt_amount) * 100;
        if (debtYoy) {
            debtYoy.classList.remove('hidden');
            if (debtChange >= 0) {
                debtYoy.innerHTML = '<span class="text-red-600">‚ñ≤ ' + debtChange.toFixed(1) + '%</span>';
            } else {
                debtYoy.innerHTML = '<span class="text-green-600">‚ñº ' + Math.abs(debtChange).toFixed(1) + '%</span>';
            }
        }
        if (debtPrev) {
            debtPrev.classList.remove('hidden');
            debtPrev.textContent = '‡∏õ‡∏µ ' + compareYear + ': ' + formatMoney(prevSummary.debt_amount);
        }
    } else {
        if (debtYoy) debtYoy.classList.add('hidden');
        if (debtPrev) debtPrev.classList.add('hidden');
    }

    // Risk Score with previous year
    var riskPrev = document.getElementById('risk-score-prev');
    if (riskPrev && compareData && compareData.risk_score) {
        riskPrev.classList.remove('hidden');
        riskPrev.textContent = '‡∏õ‡∏µ ' + compareYear + ': ' + (compareData.risk_score.score || 0).toFixed(0) + '/100';
    } else if (riskPrev) {
        riskPrev.classList.add('hidden');
    }
}

// Utility functions
function formatMoney(amount) {
    if (!amount) return '0 ‡∏ö‡∏≤‡∏ó';
    if (amount >= 1000000000) {
        return (amount / 1000000000).toFixed(2) + ' ‡∏û‡∏±‡∏ô‡∏•‡πâ‡∏≤‡∏ô';
    } else if (amount >= 1000000) {
        return (amount / 1000000).toFixed(2) + ' ‡∏•‡πâ‡∏≤‡∏ô';
    }
    return amount.toLocaleString() + ' ‡∏ö‡∏≤‡∏ó';
}

function formatMoneyShort(amount) {
    if (!amount) return '0';
    if (amount >= 1000000) {
        return (amount / 1000000).toFixed(1) + 'M';
    }
    return amount.toLocaleString();
}

function showToast(message, type) {
    if (typeof window.showToast === 'function') {
        window.showToast(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}
